---
title: "Waning VE of Nirsevimab"
output: 
  html_document:
    toc: true
    toc_float: true
---

#### Date: `r Sys.Date()`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(dplyr)
library(tidyr)
library(tidyverse)
library(readxl)
library(writexl)
library(reactable)
library(ggplot2)
library(stringr)
library(flextable)
library(lubridate)
library(rjags)


library(gtsummary) # for table 1
library(multcomp)
library(survival) # for matched case-control

fig.counter <- 1
tab.counter <- 1

source("utils_mAb_VE.R")
source("jags_waning.R")

rerun <- FALSE
```


```{r}
# read in dataset
df <- read.csv("../data/clean_data/df.mab.csv") %>% 
  mutate(collection_date = as.Date(collection_date))
colnames <- as.data.frame(colnames(df))

# add some variables 
df <- process_df(df)
```

<br>

#### Based on the preliminary results of waning of VE, look at Nirsevimab's time-varying effect against these outcomes:
  * RSV infection (case: RSV+; control: RSV-)
  * RSV-related LRTI (case: RSV+ LRTI; control: RSV-)

<br>

```{r}
df <- df %>% 
  # recode confounders
  mutate(cf_birth_weight = birth_weight) %>% # about 25% missing 
  mutate(cf_age = case_when(age_at_test_in_months_cat_2 == "under 3m" ~ 1,
                            age_at_test_in_months_cat_2 == "3-6m" ~ 2,
                            age_at_test_in_months_cat_2 == "6-9m" ~ 3,
                            age_at_test_in_months_cat_2 == "9-12m" ~ 4,
                            age_at_test_in_months_cat_2 == "above 1 yo" ~ 5)) %>%
  mutate(cf_month_tested = case_when(month_when_tested_cat == "Oct-Nov" ~ 1,
                                     month_when_tested_cat == "Dec-Jan" ~ 2,
                                     month_when_tested_cat == "Feb-Mar" ~ 3,
                                     month_when_tested_cat == "April and after" ~ 4)) %>%
  # convert confounders to dummy variables
  mutate(cf_age_1 = ifelse(cf_age == 1, 1, 0),
         cf_age_2 = ifelse(cf_age == 2, 1, 0),
         cf_age_3 = ifelse(cf_age == 3, 1, 0),
         cf_age_4 = ifelse(cf_age == 4, 1, 0),
         cf_age_5 = ifelse(cf_age == 5, 1, 0))  %>%
  mutate(cf_month_tested_1 = ifelse(cf_month_tested == 1, 1, 0),
         cf_month_tested_2 = ifelse(cf_month_tested == 2, 1, 0),
         cf_month_tested_3 = ifelse(cf_month_tested == 3, 1, 0),
         cf_month_tested_4 = ifelse(cf_month_tested == 4, 1, 0)) %>%
  # mutate(cf_age = age_at_test_in_months) %>%  # continuous in months
  # mutate(cf_month_tested_1 = ifelse(month_when_tested == "Oct", 1, 0),
  #        cf_month_tested_2 = ifelse(month_when_tested == "Nov", 1, 0),
  #        cf_month_tested_3 = ifelse(month_when_tested == "Dec", 1, 0),
  #        cf_month_tested_4 = ifelse(month_when_tested == "Jan", 1, 0),
  #        cf_month_tested_5 = ifelse(month_when_tested == "Feb", 1, 0),
  #        cf_month_tested_6 = ifelse(month_when_tested == "Mar", 1, 0),
  #        cf_month_tested_7 = ifelse(month_when_tested == "Apr", 1, 0),
  #        cf_month_tested_8 = ifelse(month_when_tested == "May", 1, 0)
  #        ) %>%
  mutate(cf_gestage = risk_factor_gestagelessthan37wks)
  
  # # calculate time_since_vax (number of months since vaccination), and convert NA --> 0
  # mutate(time_since_vax = (-days_btw_mab_collection)/30.44) %>%
  # mutate(time_since_vax = ifelse(rsv_mab == 0, 0, time_since_vax)) 


# generate inverse of time since vaccaintion 
df <- df %>%
  mutate(inverse_t = case_when(days_btw_mab_collection >= 0 | 
                                              is.na(days_btw_mab_collection) ~ 0,
                                            days_btw_mab_collection < 0 ~ 1/(-days_btw_mab_collection/1)))  %>%
  # create square and cubic form of inverse time since vax
  mutate(square_inverse_t = inverse_t^2,
         cubic_inverse_t = inverse_t^3)


  
```

### glm first 

Seems that using different endpoint, fitting glm with inverse_time_since_vax has very different waning curves.

```{r warning=FALSE}
# before using bayesian models, first run through glm
t <- c(1/30, 1/60, 1/90, 1/120, 1/150)

###################################
# Against RSV-associated hospitalization
################################
df.glm <- df %>% 
  filter(encounter_type == "inpatient") %>%
  mutate(case_control = positive_rsv)

# # unadjusted
# model <- glm(case_control ~ inverse_t, data = df.glm, family = binomial)
# beta_median <- model$coefficients[2]
# beta_lb <- confint(model)[c(-1),][1]
# beta_ub <- confint(model)[c(-1),][2]
# median <- (1- exp(t * beta))*100
# ub <- (1- exp(t * beta_lb))*100
# lb <- (1- exp(t * beta_ub))*100
# ve <- paste0(round(median), " (", round(lb), "-", round(ub), ")")
# aic <- AIC(model) 
# ve.wane <- data.frame(against = "RSV-associated hospitalizations", 
#            formula = "case_control ~ inverse_t", 
#            ve_1m = ve[1], ve_2m = ve[2], ve_3m = ve[3], ve_4m = ve[4], ve_5m = ve[5],
#            AIC = aic
#            )
# 
# 
# # add square term
# model <- glm(case_control ~ inverse_t + square_inverse_t, data = df.glm, family = binomial)
# beta_median <- model$coefficients[c(-1)]
# beta_lb <- confint(model)[c(-1),][1]
# beta_ub <- confint(model)[c(-1),][2]
# median <- (1- exp(t * beta))*100
# ub <- (1- exp(t * beta_lb))*100
# lb <- (1- exp(t * beta_ub))*100
# ve <- paste0(round(median), " (", round(lb), "-", round(ub), ")")
# aic <- AIC(model) 
# ve.wane <- data.frame(against = "RSV-associated hospitalizations", 
#            formula = "case_control ~ inverse_t", 
#            ve_1m = ve[1], ve_2m = ve[2], ve_3m = ve[3], ve_4m = ve[4], ve_5m = ve[5],
#            AIC = aic
#            )
# 
# # add cubic term
# model <- glm(case_control ~ inverse_t + cubic_inverse_t, data = df.glm, family = binomial)
# beta <- model$coefficients[2]
# beta_cubic <- model$coefficients[3]
# 1 - exp(1/30 * beta + (1/30)^3 * beta_cubic) # 76
# 1 - exp(1/60 * beta + (1/60)^3 * beta_cubic) # 51
# 1 - exp(1/90 * beta + (1/90)^3 * beta_cubic) # 37
# AIC(model) # 667
# 
# # add square and cubic term (not working)
# model <- glm(case_control ~ inverse_t + square_inverse_t + cubic_inverse_t, data = df.glm, family = binomial)
# beta <- model$coefficients[2]
# beta_square <- model$coefficients[3]
# beta_cubic <- model$coefficients[4]
# 1 - exp(1/30 * beta + (1/30)^2 * beta_square + (1/30)^3 * beta_cubic) # -inf
# 1 - exp(1/60 * beta + (1/60)^2 * beta_square + (1/60)^3 * beta_cubic) # -inf
# 1 - exp(1/90 * beta + (1/90)^2 * beta_square + (1/90)^3 * beta_cubic) # -inf
# AIC(model) # 12190


##  adjusted
model <- glm(case_control ~ inverse_t +
               age_at_test_in_months_cat_2 + month_when_tested_cat, 
             data = df.glm, family = binomial)
beta_median <- model$coefficients[2]
beta_lb <- confint(model)[2,][1]
beta_ub <- confint(model)[2,][2]
median <- (1- exp(t * beta_median))*100
ub <- (1- exp(t * beta_lb))*100
lb <- (1- exp(t * beta_ub))*100
ve <- paste0(round(median,1), " (", round(lb,1), "-", round(ub,1), ")")
aic <- AIC(model)
ve.wane <- data.frame(against = "RSV-associated hospitalization",
           formula = "case_control ~ inverse_t",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )


# add square term 
model <- glm(case_control ~ inverse_t + square_inverse_t +
               age_at_test_in_months_cat_2 + month_when_tested_cat, data = df.glm, family = binomial)
beta <- model$coefficients[2]
beta_square <- model$coefficients[3]
median <- (1- exp(beta * t + beta_square * t^2)) * 100
aic <- AIC(model) 
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated hospitalization",
           formula = "case_control ~ inverse_t + (inverse_t)^2",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)


# add cubic term 
model <- glm(case_control ~ inverse_t + cubic_inverse_t +
               age_at_test_in_months_cat_2 + month_when_tested_cat, data = df.glm, family = binomial)
beta <- model$coefficients[2]
beta_cubic <- model$coefficients[3]
median <- (1 - exp(beta *t + beta_cubic * t^3))*100
aic <- AIC(model) 
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated hospitalization",
           formula = "case_control ~ inverse_t + (inverse_t)^3",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)

# add square and cubic term 
model <- glm(case_control ~ inverse_t + square_inverse_t + cubic_inverse_t + 
               age_at_test_in_months_cat_2 + month_when_tested_cat, data = df.glm, family = binomial)
beta <- model$coefficients[2]
beta_lb <- confint(model)[,1][2:4][1]
beta_ub <- confint(model)[,2][2:4][1]
beta_square <- model$coefficients[3]
beta_square_lb <- confint(model)[,1][2:4][2]
beta_square_ub <- confint(model)[,2][2:4][2]
beta_cubic <- model$coefficients[4]
beta_cubic_lb <- confint(model)[,1][2:4][3]
beta_cubic_ub <- confint(model)[,2][2:4][3]
median <- (1 - exp(beta *t + beta_square * t^2 + beta_cubic * t^3))*100
lb <- (1 - exp(beta_ub *t + beta_square_ub * t^2 + beta_cubic_ub * t^3))*100
ub <- (1 - exp(beta_lb *t + beta_square_lb * t^2 + beta_cubic_lb * t^3))*100
aic <- AIC(model) 
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated hospitalization",
           formula = "case_control ~ inverse_t + (inverse_t)^2 + (inverse_t)^3",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)


###################################
# Against RSV-associated LRTI
################################
df.glm <- df %>% 
  filter(symp_LRT_distress == 1) %>%
  mutate(case_control = positive_rsv)

# # unadjusted
# model <- glm(case_control ~ inverse_t, data = df.glm, family = binomial)
# beta <- model$coefficients[2]
# 1 - exp(1/30 * beta) # 73
# 1 - exp(1/60 * beta) # 48
# 1 - exp(1/90 * beta) # 35
# AIC(model) # 1044
# 
# # add square term
# model <- glm(case_control ~ inverse_t + square_inverse_t, data = df.glm, family = binomial)
# beta <- model$coefficients[2]
# beta_square <- model$coefficients[3]
# 1 - exp(1/30 * beta + (1/30)^2 * beta_square) # 82
# 1 - exp(1/60 * beta + (1/60)^2 * beta_square) # 61
# 1 - exp(1/90 * beta + (1/90)^2 * beta_square) # 48
# AIC(model) # 1041
# 
# # add cubic term
# model <- glm(case_control ~ inverse_t + cubic_inverse_t, data = df.glm, family = binomial)
# beta <- model$coefficients[2]
# beta_cubic <- model$coefficients[3]
# 1 - exp(1/30 * beta + (1/30)^3 * beta_cubic) # 76
# 1 - exp(1/60 * beta + (1/60)^3 * beta_cubic) # 53
# 1 - exp(1/90 * beta + (1/90)^3 * beta_cubic) # 40
# AIC(model) # 1044
# 
# # add square and cubic term (best)
# model <- glm(case_control ~ inverse_t + square_inverse_t + cubic_inverse_t, data = df.glm, family = binomial)
# beta <- model$coefficients[2]
# beta_square <- model$coefficients[3]
# beta_cubic <- model$coefficients[4]
# 1 - exp(1/30 * beta + (1/30)^2 * beta_square + (1/30)^3 * beta_cubic) # 90
# 1 - exp(1/60 * beta + (1/60)^2 * beta_square + (1/60)^3 * beta_cubic) # 89
# 1 - exp(1/90 * beta + (1/90)^2 * beta_square + (1/90)^3 * beta_cubic) # 82
# 1 - exp(1/120 * beta + (1/120)^2 * beta_square + (1/120)^3 * beta_cubic) # 76
# AIC(model) # 1021


##  adjusted
model <- glm(case_control ~ inverse_t +
               age_at_test_in_months_cat_2 + month_when_tested_cat, 
             data = df.glm, family = binomial)
beta_median <- model$coefficients[2]
beta_lb <- confint(model)[2,][1]
beta_ub <- confint(model)[2,][2]
median <- (1- exp(t * beta_median))*100
ub <- (1- exp(t * beta_lb))*100
lb <- (1- exp(t * beta_ub))*100
ve <- paste0(round(median,1), " (", round(lb,1), "-", round(ub,1), ")")
aic <- AIC(model)
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated LRTI",
           formula = "case_control ~ inverse_t",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)

# add square term 
model <- glm(case_control ~ inverse_t + square_inverse_t +
               age_at_test_in_months_cat_2 + month_when_tested_cat, data = df.glm, family = binomial)
beta <- model$coefficients[2]
beta_square <- model$coefficients[3]
median <- (1- exp(beta * t + beta_square * t^2)) * 100
aic <- AIC(model) 
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated LRTI",
           formula = "case_control ~ inverse_t + (inverse_t)^2",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)


# add cubic term 
model <- glm(case_control ~ inverse_t + cubic_inverse_t +
               age_at_test_in_months_cat_2 + month_when_tested_cat, data = df.glm, family = binomial)
beta <- model$coefficients[2]
beta_cubic <- model$coefficients[3]
median <- (1 - exp(beta *t + beta_cubic * t^3))*100
aic <- AIC(model) 
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated LRTI",
           formula = "case_control ~ inverse_t + (inverse_t)^3",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)

# add square and cubic term 
model <- glm(case_control ~ inverse_t + square_inverse_t + cubic_inverse_t + 
               age_at_test_in_months_cat_2 + month_when_tested_cat, data = df.glm, family = binomial)
beta <- model$coefficients[2]
beta_lb <- confint(model)[,1][2:4][1]
beta_ub <- confint(model)[,2][2:4][1]
beta_square <- model$coefficients[3]
beta_square_lb <- confint(model)[,1][2:4][2]
beta_square_ub <- confint(model)[,2][2:4][2]
beta_cubic <- model$coefficients[4]
beta_cubic_lb <- confint(model)[,1][2:4][3]
beta_cubic_ub <- confint(model)[,2][2:4][3]
median <- (1 - exp(beta *t + beta_square * t^2 + beta_cubic * t^3))*100
lb <- (1 - exp(beta_ub *t + beta_square_ub * t^2 + beta_cubic_ub * t^3))*100
ub <- (1 - exp(beta_lb *t + beta_square_lb * t^2 + beta_cubic_lb * t^3))*100
aic <- AIC(model) 
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated LRTI",
           formula = "case_control ~ inverse_t + (inverse_t)^2 + (inverse_t)^3",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)



###################################
# Against RSV-associated LRTI hospitalization
################################
df.glm <- df %>% 
  filter(symp_LRT_distress == 1 & encounter_type == "inpatient") %>%
  mutate(case_control = positive_rsv)

# # unadjusted
# model <- glm(case_control ~ inverse_t, data = df.glm, family = binomial)
# beta <- model$coefficients[2]
# 1 - exp(1/30 * beta) # 51
# 1 - exp(1/60 * beta) # 30
# 1 - exp(1/90 * beta) # 22
# AIC(model) # 413.74
# 
# # add square term
# model <- glm(case_control ~ inverse_t + square_inverse_t, data = df.glm, family = binomial)
# beta <- model$coefficients[2]
# beta_square <- model$coefficients[3]
# 1 - exp(1/30 * beta + (1/30)^2 * beta_square) # 77
# 1 - exp(1/60 * beta + (1/60)^2 * beta_square) # 54
# 1 - exp(1/90 * beta + (1/90)^2 * beta_square) # 41
# AIC(model) # 413.66
# 
# # add cubic term
# model <- glm(case_control ~ inverse_t + cubic_inverse_t, data = df.glm, family = binomial)
# beta <- model$coefficients[2]
# beta_cubic <- model$coefficients[3]
# 1 - exp(1/30 * beta + (1/30)^3 * beta_cubic) # 64
# 1 - exp(1/60 * beta + (1/60)^3 * beta_cubic) # 40
# 1 - exp(1/90 * beta + (1/90)^3 * beta_cubic) # 29
# AIC(model) # 415


##  adjusted (best)
##  adjusted
model <- glm(case_control ~ inverse_t +
               age_at_test_in_months_cat_2 + month_when_tested_cat, 
             data = df.glm, family = binomial)
beta_median <- model$coefficients[2]
beta_lb <- confint(model)[2,][1]
beta_ub <- confint(model)[2,][2]
median <- (1- exp(t * beta_median))*100
ub <- (1- exp(t * beta_lb))*100
lb <- (1- exp(t * beta_ub))*100
ve <- paste0(round(median,1), " (", round(lb,1), "-", round(ub,1), ")")
aic <- AIC(model)
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated LRTI hospitalization",
           formula = "case_control ~ inverse_t",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)

# add square term 
model <- glm(case_control ~ inverse_t + square_inverse_t +
               age_at_test_in_months_cat_2 + month_when_tested_cat, data = df.glm, family = binomial)
beta <- model$coefficients[2]
beta_square <- model$coefficients[3]
median <- (1- exp(beta * t + beta_square * t^2)) * 100
aic <- AIC(model) 
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated LRTI hospitalization",
           formula = "case_control ~ inverse_t + (inverse_t)^2",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)


# add cubic term 
model <- glm(case_control ~ inverse_t + cubic_inverse_t +
               age_at_test_in_months_cat_2 + month_when_tested_cat, data = df.glm, family = binomial)
beta <- model$coefficients[2]
beta_cubic <- model$coefficients[3]
median <- (1 - exp(beta *t + beta_cubic * t^3))*100
aic <- AIC(model) 
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated LRTI hospitalization",
           formula = "case_control ~ inverse_t + (inverse_t)^3",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)

# add square and cubic term 
model <- glm(case_control ~ inverse_t + square_inverse_t + cubic_inverse_t + 
               age_at_test_in_months_cat_2 + month_when_tested_cat, data = df.glm, family = binomial)
beta <- model$coefficients[2]
beta_lb <- confint(model)[,1][2:4][1]
beta_ub <- confint(model)[,2][2:4][1]
beta_square <- model$coefficients[3]
beta_square_lb <- confint(model)[,1][2:4][2]
beta_square_ub <- confint(model)[,2][2:4][2]
beta_cubic <- model$coefficients[4]
beta_cubic_lb <- confint(model)[,1][2:4][3]
beta_cubic_ub <- confint(model)[,2][2:4][3]
median <- (1 - exp(beta *t + beta_square * t^2 + beta_cubic * t^3))*100
lb <- (1 - exp(beta_ub *t + beta_square_ub * t^2 + beta_cubic_ub * t^3))*100
ub <- (1 - exp(beta_lb *t + beta_square_lb * t^2 + beta_cubic_lb * t^3))*100
aic <- AIC(model) 
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated LRTI hospitalization",
           formula = "case_control ~ inverse_t + (inverse_t)^2 + (inverse_t)^3",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)

###################################
# Against RSV-associated severe outcomes
################################
df.glm <- df %>% 
  filter(icu_admitted == "yes" | highflow_oxygen == 1) %>%
  mutate(case_control = positive_rsv)

# # unadjusted
# model <- glm(case_control ~ inverse_t, data = df.glm, family = binomial)
# beta <- model$coefficients[2]
# 1 - exp(1/30 * beta) # 98
# 1 - exp(1/60 * beta) # 89
# 1 - exp(1/90 * beta) # 76
# AIC(model) # 524
# 
# # add square term
# model <- glm(case_control ~ inverse_t + square_inverse_t, data = df.glm, family = binomial)
# beta <- model$coefficients[2]
# beta_square <- model$coefficients[3]
# 1 - exp(1/30 * beta + (1/30)^2 * beta_square) # 98
# 1 - exp(1/60 * beta + (1/60)^2 * beta_square) # 89
# 1 - exp(1/90 * beta + (1/90)^2 * beta_square) # 77
# AIC(model) # 526
# 
# # add cubic term
# model <- glm(case_control ~ inverse_t + cubic_inverse_t, data = df.glm, family = binomial)
# beta <- model$coefficients[2]
# beta_cubic <- model$coefficients[3]
# 1 - exp(1/30 * beta + (1/30)^3 * beta_cubic) # 98
# 1 - exp(1/60 * beta + (1/60)^3 * beta_cubic) # 88
# 1 - exp(1/90 * beta + (1/90)^3 * beta_cubic) # 77
# AIC(model) # 526
# 
# # add square and cubic term (not working)
# model <- glm(case_control ~ inverse_t + square_inverse_t + cubic_inverse_t, data = df.glm, family = binomial)
# beta <- model$coefficients[2]
# beta_square <- model$coefficients[3]
# beta_cubic <- model$coefficients[4]
# 1 - exp(1/30 * beta + (1/30)^2 * beta_square + (1/30)^3 * beta_cubic) # 1
# 1 - exp(1/60 * beta + (1/60)^2 * beta_square + (1/60)^3 * beta_cubic) # 1
# 1 - exp(1/90 * beta + (1/90)^2 * beta_square + (1/90)^3 * beta_cubic) # 1
# 1 - exp(1/120 * beta + (1/120)^2 * beta_square + (1/120)^3 * beta_cubic) # 1
# AIC(model) # 10676


##  adjusted
model <- glm(case_control ~ inverse_t +
               age_at_test_in_months_cat_2 + month_when_tested_cat, 
             data = df.glm, family = binomial)
beta_median <- model$coefficients[2]
beta_lb <- confint(model)[2,][1]
beta_ub <- confint(model)[2,][2]
median <- (1- exp(t * beta_median))*100
ub <- (1- exp(t * beta_lb))*100
lb <- (1- exp(t * beta_ub))*100
ve <- paste0(round(median,1), " (", round(lb,1), "-", round(ub,1), ")")
aic <- AIC(model)
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated severe outcomes",
           formula = "case_control ~ inverse_t",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)

# add square term 
model <- glm(case_control ~ inverse_t + square_inverse_t +
               age_at_test_in_months_cat_2 + month_when_tested_cat, data = df.glm, family = binomial)
beta <- model$coefficients[2]
beta_square <- model$coefficients[3]
median <- (1- exp(beta * t + beta_square * t^2)) * 100
aic <- AIC(model) 
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated severe outcomes",
           formula = "case_control ~ inverse_t + (inverse_t)^2",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)


# add cubic term 
model <- glm(case_control ~ inverse_t + cubic_inverse_t +
               age_at_test_in_months_cat_2 + month_when_tested_cat, data = df.glm, family = binomial)
beta <- model$coefficients[2]
beta_cubic <- model$coefficients[3]
median <- (1 - exp(beta *t + beta_cubic * t^3))*100
aic <- AIC(model) 
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated severe outcomes",
           formula = "case_control ~ inverse_t + (inverse_t)^3",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)

# add square and cubic term 
model <- glm(case_control ~ inverse_t + square_inverse_t + cubic_inverse_t + 
               age_at_test_in_months_cat_2 + month_when_tested_cat, data = df.glm, family = binomial)
beta <- model$coefficients[2]
beta_square <- model$coefficients[3]
beta_cubic <- model$coefficients[4]
median <- (1 - exp(beta *t + beta_square * t^2 + beta_cubic * t^3))*100
aic <- AIC(model) 
ve.wane <- rbind(
  ve.wane,
  data.frame(against = "RSV-associated severe outcomes",
           formula = "case_control ~ inverse_t + (inverse_t)^2 + (inverse_t)^3",
           ve_1m = median[1], ve_2m = median[2], ve_3m = median[3], ve_4m = median[4], ve_5m = median[5],
           AIC = aic
           )
)

ve.wane %>% 
  mutate(across(starts_with("ve_"), ~ round(.,1))) %>%
  mutate(AIC = round(AIC, 2)) %>%
  arrange(against, AIC) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20, groupBy = "against")

```

<br>

### glm with Bernstein polynomials to ensure the monotonic decrease of VE over time


```{r warning=FALSE}
# df.bp <- df %>% mutate(case_control = positive_rsv)
# function to run through different degree of freedom, D
run_glm_bp <- function(D,  # degree of freedom
                       df.bp # dataset with defined case_control
                       ){
  
  inverse_t <- df.bp$inverse_t
  
  for(d in 2:D){
  
    bp_inverse_t <- matrix(NA, nrow = length(inverse_t), ncol = (d+1))
    bp_colnames <- paste0("bp_inverse_t_", 1:(d+1))
  
    for(j in 1:length(inverse_t)){
      # Bernstein basis polynomial
      bp_inverse_t[j,] <- choose(d, c(0:d)) * (inverse_t[j]^c(0:d)) * (1.00 - inverse_t[j])^(d - c(0:d))
      # some property: each generated row sum is 1, no need to additionally multiply basis with other things
    }
    colnames(bp_inverse_t) <- bp_colnames
    df.bp <- cbind(df.bp, bp_inverse_t)
    
    formula_unadj <- as.formula(paste0("case_control ~ ", 
                      paste(paste0("bp_inverse_t_", 1:(d+1)), collapse = " + ")))
    formula_adj <- as.formula(paste0("case_control ~ ", 
                      paste(paste0("bp_inverse_t_", 1:(d+1)), collapse = " + "),
                      " + age_at_test_in_months_cat_2 + month_when_tested_cat"))
    # run adjusted glm
    model <- glm(formula_adj, data = df.bp, family = binomial)
    beta <- matrix((model$coefficients)[2:(d+2)], nrow = d+1)
    beta_lb <- matrix(confint(model)[,1][2:(d+2)], nrow = d+1)
    beta_ub <- matrix(confint(model)[,2][2:(d+2)], nrow = d+1)
    
    t_vax <- c(1/30, 1/60, 1/90, 1/120, 1/150)
    t_unvax <- c(0, 0, 0, 0, 0)
    bp_t_vax <- matrix(NA, nrow = length(t_vax), ncol = (d+1))
    bp_t_unvax <- matrix(NA, nrow = length(t_unvax), ncol = (d+1))

    for(j in 1:length(t_vax)){
      bp_t_vax[j,] <- choose(d, c(0:d)) * (t_vax[j]^c(0:d)) * (1.00 - t_vax[j])^(d - c(0:d)) * t_vax[j]
      bp_t_unvax[j,] <- choose(d, c(0:d)) * (t_unvax[j]^c(0:d)) * (1.00 - t_unvax[j])^(d - c(0:d)) * t_unvax[j]
    }
    
    median <- (1 - exp(bp_t_vax %*% beta))*100
    ub <- (1 - exp(bp_t_vax %*% beta_lb))*100
    lb <- (1 - exp(bp_t_vax %*% beta_ub))*100
    aic <- AIC(model)
    temp <- data.frame(
      d = d , median = median, lb = lb, ub = ub, month = c(1:5), AIC = aic
    )
    
    if(d == 2){ve.wane.bp <- temp}
    if(d != 2){ve.wane.bp <- rbind(ve.wane.bp, temp)}

  }
  
  return(ve.wane.bp)
}
```


```{r}
df.bp <- df %>% mutate(case_control = positive_rsv)
ve.wane.bp.infection <- run_glm_bp(D = 3, df.bp = df.bp) %>% mutate(against = "RSV infection") 


df.bp <- df %>% 
  filter(encounter_type == "inpatient") %>%
  mutate(case_control = positive_rsv)
ve.wane.bp.rsvhosp <- run_glm_bp(D = 3, df.bp = df.bp) %>% mutate(against = "RSV-associated hospitalization") 

  
df.bp <- df %>% 
  filter(symp_LRT_distress == 1) %>%
  mutate(case_control = positive_rsv)
ve.wane.bp.rsvLRTI <- run_glm_bp(D = 3, df.bp = df.bp) %>% mutate(against = "RSV-associated LRTI") 


df.bp <- df %>% 
  filter(icu_admitted == "yes" | highflow_oxygen == 1) %>%
  mutate(case_control = positive_rsv)
ve.wane.bp.severe <- run_glm_bp(D = 3, df.bp = df.bp) %>% mutate(against = "RSV-associated severe outcomes") 

rbind(
  ve.wane.bp.infection, 
  ve.wane.bp.rsvhosp,
  ve.wane.bp.rsvLRTI,
  ve.wane.bp.severe
) %>% 
  mutate(across(c( median, lb, ub, AIC), ~ round(.))) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20, groupBy = "against")
```


```{r}
# example code from Josh to generate Bernstein polynomials
ds_time <- seq(0.00, 1.00, 0.01)
d <- 3 # degree of freedom, larger d ---> smoother
z_ds <- matrix(NA, nrow = length(ds_time), ncol = (d+1))

for(j in 1:length(ds_time)){
   z_ds[j,] <- choose(d, c(0:d)) * (ds_time[j]^c(0:d)) * (1.00 - ds_time[j])^(d - c(0:d))
}
# sum of each row of z_ds is 1
```



<br>


```{r eval = F}
# model using jags
source("jags_waning.R")

###################################
# Against infection 
###################################
df.jags <- df %>% 
  # define case and control
  mutate(case_control = positive_rsv) 
# %>%
#   filter(!is.na(cf_birth_weight) & !is.na(cf_gestage))

# try running glm first before going bayesian
# (very similar to bayesian result: 1st month: 48%, 2nd months: 27%)
model <- glm(case_control ~ inverse_time_since_vax, data = df.jags, family = binomial)



# prepare the input dataset for jags 
dataset_continuous_infection <- 
            list(
                N_records = nrow(df.jags),
                log_inverse_time_since_vax = df.jags$log_inverse_time_since_vax,
                case_status = df.jags$case_control,
                vax = df.jags$rsv_mab,
                # confounders
                cf_age_1 = df.jags$cf_age_1,
                cf_age_2 = df.jags$cf_age_2,
                cf_age_3 = df.jags$cf_age_3,
                cf_age_4 = df.jags$cf_age_4,
                cf_age_5 = df.jags$cf_age_5,
                cf_month_tested_1 = df.jags$cf_month_tested_1, # ref
                cf_month_tested_2 = df.jags$cf_month_tested_2,
                cf_month_tested_3 = df.jags$cf_month_tested_3,
                cf_month_tested_4 = df.jags$cf_month_tested_4,
                # cf_month_tested_5 = df.jags$cf_month_tested_5,
                # cf_month_tested_6 = df.jags$cf_month_tested_6,
                # cf_month_tested_7 = df.jags$cf_month_tested_7,
                # cf_month_tested_8 = df.jags$cf_month_tested_8,
                cf_birth_weight = df.jags$cf_birth_weight,
                cf_gestage = df.jags$cf_gestage
                )



source("jags_waning.R")

if(rerun){
  
  jags.post <- rjags::jags.model(textConnection(model_string_waning_continuous), 
                          data = dataset_continuous_infection,
                          n.chains = 3)

  samples <- rjags::coda.samples(jags.post, 
                          variable.names=c("int", "beta"),
                          n.iter = 5000)
  saveRDS(samples, "../data/jags/post/wane_continuous_infection.rds")

}else{
  samples <- readRDS("../data/jags/post/wane_continuous_infection.rds")
}

# look at traceplot 
# plot(samples[, "int"])
# plot(samples[, "beta"])


post1 <- as.data.frame(as.matrix(samples[[1]][-c(1:4500),]))  
post2 <- as.data.frame(as.matrix(samples[[2]][-c(1:4500),])) 
post3 <- as.data.frame(as.matrix(samples[[3]][-c(1:4500),])) 
post <- bind_rows(post1, post2, post3)

1 - exp(log(1/30 + 1) * median(post$beta))


###################################
# Against RSV+ hospitalizations
###################################
df.jags <- df %>% 
  # define case and control
  mutate(case_control = case_when(positive_rsv == 1 & encounter_type == "inpatient" ~ 1,
                                  positive_rsv == 0 ~ 0))
  

dataset_continuous_RSVhosp <- 
            list(
                N_records = nrow(df.jags),
                case_status = df.jags$case_control,
                vax = df.jags$rsv_mab,
                inverse_time_since_vax = df.jags$inverse_time_since_vax,
                # confounders
                cf_age = df.jags$cf_age,
                #cf_month_tested_1 = df.jags$cf_month_tested_1, # ref
                cf_month_tested_2 = df.jags$cf_month_tested_2,
                cf_month_tested_3 = df.jags$cf_month_tested_3,
                cf_month_tested_4 = df.jags$cf_month_tested_4,
                cf_month_tested_5 = df.jags$cf_month_tested_5,
                cf_month_tested_6 = df.jags$cf_month_tested_6,
                cf_month_tested_7 = df.jags$cf_month_tested_7,
                cf_month_tested_8 = df.jags$cf_month_tested_8,
                cf_birth_weight = df.jags$cf_birth_weight
                
                )

source("jags_waning.R")

if(rerun){
  
  jags.post <- rjags::jags.model(textConnection(model_string_waning_continuous), 
                          data = dataset_continuous_RSVhosp,
                          n.chains = 3)

  samples <- rjags::coda.samples(jags.post, 
                          variable.names=c("int","beta",
                                           "beta_cf_month_tested_2",
                                           "beta_cf_month_tested_3",
                                           "beta_cf_month_tested_4",
                                           "beta_cf_month_tested_5",
                                           "beta_cf_month_tested_6",
                                           "beta_cf_month_tested_7",
                                           "beta_cf_month_tested_8"
                                           ),
                          n.iter = 5000)
  saveRDS(samples, "../data/jags/post/wane_2monthsinterval_RSVhosp.rds")

}else{
  samples <- readRDS("../data/jags/post/wane_2monthsinterval_RSVhosp.rds")
}

# look at traceplot 
# plot(samples[, "int"])
# plot(samples[, "beta"])

post1 <- as.data.frame(as.matrix(samples[[1]][-c(1:4500),]))  
post2 <- as.data.frame(as.matrix(samples[[2]][-c(1:4500),])) 
post3 <- as.data.frame(as.matrix(samples[[3]][-c(1:4500),])) 
post <- bind_rows(post1, post2, post3)

1 - exp(1/90 * median(post$beta))






```


















