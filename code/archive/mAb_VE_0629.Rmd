---
title: "VE of Nirsevimab"
output: 
  html_document:
    toc: true
    toc_float: true
---

#### Date: `r Sys.Date()`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(dplyr)
library(tidyr)
library(tidyverse)
library(readxl)
library(writexl)
library(reactable)
library(ggplot2)
library(stringr)
library(flextable)
library(lubridate)


library(gtsummary) # for table 1
library(multcomp)
library(survival) # for matched case-control

fig.counter <- 1
tab.counter <- 1

source("utils_mAb_VE.R")
```


```{r}
# read in dataset
df <- read.csv("../data/clean_data/df.mab.csv") %>% 
  mutate(collection_date = as.Date(collection_date))
colnames <- as.data.frame(colnames(df))

# add some variables 
df <- process_df(df)
```


### There are totally `r nrow(df)` testing records in the analysis dataset. 

<br>


### Look at the risk factors {.tabset}

#### Table `r tab.counter`  Each risk factor
```{r}
tab.counter <- tab.counter + 1

data.frame(
  anemia = nrow(df %>% filter(risk_factor_anemia == "yes")),
  blood = nrow(df %>% filter(risk_factor_blood == "yes")),
  immunodeficiency = nrow(df %>% filter(risk_factor_immunodeficiency == "yes")),
  cardiac = nrow(df %>% filter(risk_factor_cardiac == "yes")),
  pulmonary_disease = nrow(df %>% filter(risk_factor_pulmonary == "yes")),
  down_syndrome = nrow(df %>% filter(risk_factor_down == "yes")),
  small_for_gestage = nrow(df %>% filter(risk_factor_small_for_gestage == 1)),
  gestage_lessthan37wks = nrow(df %>% filter(risk_factor_gestagelessthan37wks == 1))
) %>%
  pivot_longer(cols = 1:8, names_to = "risk_factor", values_to = "n_records") %>%
  arrange(desc(n_records)) %>%
  mutate(perc = round(n_records / nrow(df)*100,1)) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

```

<br>


#### Table `r tab.counter` At least one risk factor 
```{r}
tab.counter <- tab.counter + 1

df %>% count(risk_factor_atleastone) %>%
 mutate(perc = round(n / nrow(df)*100,1)) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))


# filter out those with at least one risk factor 
a <- df %>% filter(risk_factor_atleastone == "yes") %>% 
  dplyr::select(StudyID, collection_date, positive_rsv, rsv_mab,
                starts_with("risk_factor"))

# write csv for checking
# write.csv(a, "../data/data_to_check/atleastoneriskfactor.csv", row.names = F)
```



<br>

### Table `r tab.counter`. Characteristic of study population (testing level) {.tabset}
  * this is assuming that: if mAb was taken before collection date, we count it as immunized. For SSA, need to change it to: if the person took mAb more than X days before sample collection, we count it as immunized.
  * we look at different pairs of case and control here (mainly to see which ones should be confounders).

#### RSV+ vs. RSV-
```{r}
tab.counter <- tab.counter + 1

df_table1 <- df %>%
  # add dose of mab 
  mutate(rsv_mab = case_when(rsv_mab_detailed == "100mg before collection" ~ "Yes, 100mg dose",
                             rsv_mab_detailed == "50mg before collection" ~ "Yes, 50mg dose",
                             TRUE ~ "No")) %>%
  mutate(risk_factor_gestagelessthan37wks = case_when(
    risk_factor_gestagelessthan37wks == 1 ~ "Less than 37 weeks",
    risk_factor_gestagelessthan37wks == 0 ~ "37 weeks or more"
  )) %>% 
  dplyr::select(positive_rsv,Sex, age_at_test_in_months, age_at_test_in_months_cat_2, race_ethnicity, birth_weight, insurance_type, rsv_mab, month_when_tested_cat, encounter_type, 
                # risk factors (main ones that are >= 5% prevalence)
                risk_factor_pulmonary, risk_factor_cardiac, risk_factor_asthma, risk_factor_anemia,
                risk_factor_gestagelessthan37wks,
                risk_factor_atleastone,
                symp_LRT_distress) %>% 
  mutate(positive_rsv = case_when(positive_rsv == 1 ~ "RSV+",
                                  positive_rsv == 0 ~ "RSV-")) %>%
  # to display the missing, making the NA value explicit level of factor 
  mutate(across(c(positive_rsv,
                  Sex, race_ethnicity, insurance_type, rsv_mab, 
                risk_factor_atleastone, risk_factor_gestagelessthan37wks), ~ factor(.) %>% forcats::fct_explicit_na())) %>% 
  # re-rank variables 
  dplyr::select(positive_rsv, 
                Sex, age_at_test_in_months, age_at_test_in_months_cat_2, 
                month_when_tested_cat,
                race_ethnicity, 
                birth_weight,
                risk_factor_gestagelessthan37wks,
                risk_factor_pulmonary, risk_factor_cardiac, risk_factor_anemia,
                risk_factor_atleastone,  insurance_type, rsv_mab, 
                encounter_type, 
                symp_LRT_distress)

df_table1_infection <- df_table1 %>% dplyr::select(-encounter_type, -symp_LRT_distress)

# footnotes 
footnote_otherraces <- "Inclusing Asian, Pacific Islander, Middle Eastern or Northern American, American Indian or Native American by self-reporting."
footnote_atleastoneriskfactor <- "Have at least one of the following conditions recorded in the infant's medical history or diagnosis records: 1) Anemia; 2) Immunodeficiency (e.g. transplantation history, leukemia, etc.); 3) Cardiac diseases (including congenital heart diseases diagnosed at birth or any reporting of heart conditions); 4) Pulmonary diseases; 5) Down syndrome; 6) Small for gestational age (birth weight < 2,500 grams); 7) Prematurity (gestational age less than 37 weeks)."


table1_infection <- df_table1_infection %>% 
  tbl_summary(by = positive_rsv,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", 
                                               "{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                age_at_test_in_months_cat_2 ~ "Age at testing",
                month_when_tested_cat ~ "Time tested", 
                race_ethnicity ~ "Race and ethnicity",
                risk_factor_pulmonary ~ "Pulmonary diseases", 
                risk_factor_cardiac ~ "Cardiac diseases", 
                risk_factor_anemia ~ "Anemia",
                risk_factor_gestagelessthan37wks ~ "Gestational age",
                risk_factor_atleastone ~ "Having at least one risk factor",
                insurance_type ~ "Insurance type",
                rsv_mab ~ "mAb status",
                birth_weight ~ "Birth weight"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = footnote_otherraces
                 ) %>%
  modify_table_styling(
    columns = label,
    rows = label == "Having at least one risk factor",
    footnote = footnote_atleastoneriskfactor
  )
  


table1_infection %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 
  
```


#### RSV+ hospitalized vs. RSV+ (outpatient)
  * this is to compare severe cases requiring hospitalization and mild cases
```{r}
tab.counter <- tab.counter + 1

df_table1_severity <- df_table1 %>%
  mutate(case_control = case_when(positive_rsv == "RSV+" & encounter_type == "inpatient" ~ "RSV+ hospitalizations",
                                  positive_rsv == "RSV+" & encounter_type == "outpatient" ~ "RSV+ outpatients")) %>%
  dplyr::select(-encounter_type, -positive_rsv, -symp_LRT_distress)
  


table1_severity <- df_table1_severity %>% 
  tbl_summary(by = case_control,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", 
                                               "{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                age_at_test_in_months_cat_2 ~ "Age at testing",
                month_when_tested_cat ~ "Time tested", 
                race_ethnicity ~ "Race and ethnicity",
                risk_factor_pulmonary ~ "Pulmonary diseases", 
                risk_factor_cardiac ~ "Cardiac diseases",
                risk_factor_anemia ~ "Anemia",
                risk_factor_gestagelessthan37wks ~ "Gestational age",
                risk_factor_atleastone ~ "Having at least one risk factor",
                insurance_type ~ "Insurance type",
                rsv_mab ~ "mAb status",
                birth_weight ~ "Birth weight"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = footnote_otherraces
  ) %>%
   modify_table_styling(
    columns = label,
    rows = label == "Having at least one risk factor",
    footnote = footnote_atleastoneriskfactor
  )


table1_severity %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 
  
```

#### RSV+ hospitalized vs. RSV- (all)
  * this is to compare severe cases requiring hospitalization and all RSV- 
```{r}
tab.counter <- tab.counter + 1

df_table1_severity_2 <- df_table1 %>%
  mutate(case_control = case_when(positive_rsv == "RSV+" & encounter_type == "inpatient" ~ "RSV+ hospitalizations",
                                  positive_rsv == "RSV-" ~ "RSV-")) %>%
  dplyr::select(-encounter_type, -positive_rsv, -symp_LRT_distress)
  


table1_severity_2 <- df_table1_severity_2 %>% 
  tbl_summary(by = case_control,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", 
                                               "{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                age_at_test_in_months_cat_2 ~ "Age at testing",
                month_when_tested_cat ~ "Time tested", 
                race_ethnicity ~ "Race and ethnicity",
                risk_factor_pulmonary ~ "Pulmonary diseases", 
                risk_factor_cardiac ~ "Cardiac diseases",
                risk_factor_anemia ~ "Anemia",
                risk_factor_gestagelessthan37wks ~ "Gestational age",
                risk_factor_atleastone ~ "Having at least one risk factor",
                insurance_type ~ "Insurance type",
                rsv_mab ~ "mAb status",
                birth_weight ~ "Birth weight"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = footnote_otherraces
  ) %>%
   modify_table_styling(
    columns = label,
    rows = label == "Having at least one risk factor",
    footnote = footnote_atleastoneriskfactor
  )


table1_severity_2 %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 
  
```

#### Inpatient vs. outpatient
  * this is to compare inpatient and outpatient records
```{r}
tab.counter <- tab.counter + 1

df_table1_encounter <- df_table1 %>%
  mutate(case_control = case_when(encounter_type == "inpatient" ~ "Inpatient",
                                  encounter_type == "outpatient" ~ "Outpatient")) %>%
  dplyr::select(-encounter_type, -symp_LRT_distress)



table1_encounter <- df_table1_encounter %>% 
  tbl_summary(by = case_control,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", 
                                               "{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                age_at_test_in_months_cat_2 ~ "Age at testing",
                month_when_tested_cat ~ "Time tested", 
                race_ethnicity ~ "Race and ethnicity",
                risk_factor_pulmonary ~ "Pulmonary diseases", 
                risk_factor_cardiac ~ "Cardiac diseases",
                risk_factor_anemia ~ "Anemia",
                risk_factor_gestagelessthan37wks ~ "Gestational age",
                risk_factor_atleastone ~ "Having at least one risk factor",
                insurance_type ~ "Insurance type",
                rsv_mab ~ "mAb status",
                birth_weight ~ "Birth weight"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = footnote_otherraces
  ) %>%
   modify_table_styling(
    columns = label,
    rows = label == "Having at least one risk factor",
    footnote = footnote_atleastoneriskfactor
  )


table1_encounter %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 
  
```

#### LRTI vs. no LRTI
  * this is to compare those with symptoms of LRTI and those without LRTI symptoms
```{r}
tab.counter <- tab.counter + 1

df_table1_LRTI <- df_table1 %>%
  mutate(case_control = case_when(symp_LRT_distress == 1 ~ "LRTI",
                                  TRUE ~ "no LRTI")) %>%
  dplyr::select(-encounter_type, -symp_LRT_distress)



table1_LRTI <- df_table1_LRTI %>% 
  tbl_summary(by = case_control,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", 
                                               "{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                age_at_test_in_months_cat_2 ~ "Age at testing",
                month_when_tested_cat ~ "Time tested", 
                race_ethnicity ~ "Race and ethnicity",
                risk_factor_pulmonary ~ "Pulmonary diseases", 
                risk_factor_cardiac ~ "Cardiac diseases", 
                risk_factor_anemia ~ "Anemia",
                risk_factor_gestagelessthan37wks ~ "Gestational age",
                risk_factor_atleastone ~ "Having at least one risk factor",
                insurance_type ~ "Insurance type",
                rsv_mab ~ "mAb status",
                birth_weight ~ "Birth weight"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = footnote_otherraces
  ) %>%
   modify_table_styling(
    columns = label,
    rows = label == "Having at least one risk factor",
    footnote = footnote_atleastoneriskfactor
  )


table1_LRTI %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 
  
```


<br>

### Clinical outcomes {.tabset}

####  Table `r tab.counter`.
```{r}
tab.counter <- tab.counter + 1

df_table1_outcome <- df %>%
  mutate(rsv_mab = case_when(rsv_mab_detailed == "100mg before collection" ~ "100mg dose",
                             rsv_mab_detailed == "50mg before collection" ~ "50mg dose",
                             TRUE ~ "Not vaccinated")) %>%
  mutate(encounter_type = case_when(encounter_type %in% c("inpatient_unrelated", "outpatient") ~ "no",
                                    encounter_type == "inpatient" ~ "yes")) %>%
  mutate(icu_admitted = case_when(icu_admitted %in% c("yes_unrelated", "no") ~ "no",
                                  TRUE ~ "yes")) %>%
  mutate(highflow_oxygen = case_when(highflow_oxygen == 1 ~ "yes",
                                     TRUE ~ "no")) %>% 
  mutate(across(starts_with("symp_"), ~ ifelse(is.na(.), "no", "yes"))) %>%
  mutate(positive_rsv = case_when(positive_rsv == 1 ~ "RSV+",
                                  positive_rsv == 0 ~ "RSV-")) %>%
  # to display the missing, making the NA value explicit level of factor 
  mutate(across(c(positive_rsv,
                   rsv_mab), ~ factor(.) %>% forcats::fct_explicit_na())) %>% 
  # re-rank variables 
  dplyr::select(rsv_mab, positive_rsv, 
                encounter_type, hosp_los, icu_admitted, icu_los_days, highflow_oxygen,
                starts_with("symp_")) 



table1_outcome <- df_table1_outcome %>% 
  tbl_summary(by = positive_rsv,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                rsv_mab ~ "mAb status",
                encounter_type = "Hospital admission",
                hosp_los = "Duration of hospitalization (days)",
                icu_admitted = "ICU admission",
                icu_los_days = "Duration of ICU admission (days)",
                highflow_oxygen = "Required highflow oxygen support",
                symp_URT_distress = "Distress in URT",
                symp_LRT_distress = "Distress in LRT",
                symp_fever = "Fever (> 38°C/100.4°F)",
                symp_cough = "Cough",
                symp_wheezing = "Wheezing",
                symp_breathing = "Breathing difficulties",
                symp_bronchiolitis = "Bronchiolitis",
                symp_sepsis = "Sepsis"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  #add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = footnote_otherraces
  ) %>%
   modify_table_styling(
    columns = label,
    rows = label == "Having at least one risk factor",
    footnote = footnote_atleastoneriskfactor
  )


table1_outcome %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 

```

<br>


```{r echo = T}
# For VE against infection,
# only adjusting for those that has significant difference comparing RSV+ and RSV- records
confounders_infection <- c(
  "age_at_test_in_months_cat_2", # 3-month interval
  "month_when_tested_cat", 
  "birth_weight",
  "risk_factor_gestagelessthan37wks"
)

# For VE against severity
# only adjusting for those that has significant difference comparing RSV+ hospitalization and RSV+ outpatient
confounders_severity <- c(
  "age_at_test_in_months_cat_2", # 3-month interval
  "risk_factor_pulmonary"
)

# For VE against severity (2)
# only adjusting for those that has significant difference comparing RSV+ hospitalization and RSV-
confounders_severity_2 <- c(
  "age_at_test_in_months_cat_2", # 3-month interval
  "month_when_tested_cat"
)

# For VE against hospitalization
# only adjusting for those that has significant difference comparing inpatient and outpatient
confounders_encounter <- c(
  "age_at_test_in_months_cat_2", # 3-month interval
  "month_when_tested_cat",
  "risk_factor_gestagelessthan37wks",
  "risk_factor_pulmonary",
  "risk_factor_cardiac",
  "risk_factor_anemia",
  "risk_factor_atleastone",
  "insurance_type"
  
)


confounders_LRTI <- c(
  "Sex",
  "age_at_test_in_months_cat_2", # 3-month interval
  "month_when_tested_cat",
  "race_ethnicity",
  "birth_weight",
  "risk_factor_gestagelessthan37wks",
  "risk_factor_pulmonary",
  "risk_factor_cardiac",
  "risk_factor_atleastone"
)
```

<br>

```{r}
# recode symp_LRT_distress to have 1 and 0 (previously 1 and NA, will create some issue when counting records in analysis)
df <- df %>%
  mutate(symp_LRT_distress = ifelse(is.na(symp_LRT_distress), 0, 1))
```




### Table `r tab.counter`. Effectiveness of Nirsevimab {.tabset}
##### Here, I pooled all the cases and controls together, to estimate the VE for different pairs of case and control definitions.
  * Columns n_overall, n_cases, n_controls are numbers of individuals were sample size used in the analysis. 
    + The sample size outside the parenthesis is the sample size that contributes to estimates of **unadjusted** effectiveness in the logistic regression models.
    + The sample size inside the parenthesis is the sample size that effectively contributes to estimates of **adjusted** effectiveness in the logistic regression models.

#### Table `r tab.counter`.

```{r warning=FALSE}
tab.counter <- tab.counter + 1

###################################
# inpatient RSV+ vs. inpatient RSV-
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 ~ 1,
                                  encounter_type == "inpatient" & positive_rsv == 0 ~ 0))

ve.1 <- regress_unmatch(df.ve = df.ve, confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (inpatient)", control = "RSV- (inpatient)")


###################################
# outpatient RSV+ vs. outpatient RSV-
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "outpatient" & positive_rsv == 1 ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 0 ~ 0))

ve.2 <- regress_unmatch(df.ve = df.ve, confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (outpatient)", control = "RSV- (outpatient)")


###################################
# all RSV+ vs. all RSV-
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(positive_rsv == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.3 <- regress_unmatch(df.ve = df.ve, confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (all)", control = "RSV- (all)")



###################################
# RSV+ hospitalized vs. all RSV- 
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.4 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ hospitalizations", control = "RSV- (all)")


###################################
# severe RSV+ hospitalized vs. all RSV- 
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.5 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ hospitalizations", control = "RSV- (all)")

###################################
# RSV+ icu vs. all RSV- 
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(positive_rsv == 1 & icu_admitted == "yes" ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.6 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ ICU admission", control = "RSV- (all)")


###################################
# RSV+ LRT-hospitalizations vs. all RSV- 
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    ( symp_LRT_distress == 1 ) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.7 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ LRTI hospitalizations", control = "RSV- (all)")


###################################
# severe RSV+ LRT-hospitalizations vs. all RSV- 
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    ( symp_LRT_distress == 1 ) &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.8 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ LRTI hospitalizations", control = "RSV- (all)")


###################################
# RSV+ LRTI vs. RSV- 
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1  ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.9 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ LRTI", control = "RSV- (all)")


###################################
# severe RSV LRTI vs. RSV-
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1 &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.10 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ LRTI", control = "RSV- (all)")




###################################
# all-cause hospitalizations vs. outpatient  
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient"  ~ 1,
                                  encounter_type == "outpatient" ~ 0))

ve.11 <- regress_unmatch(df.ve = df.ve, confounders = confounders_encounter) %>% 
 mutate(case = "all-cause hospitalizations", control = "not hospitalized")

###################################
# LRT-hospitalizations vs. outpatient  
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & symp_LRT_distress == 1  ~ 1,
                                  encounter_type == "outpatient" ~ 0))

ve.12 <- regress_unmatch(df.ve = df.ve, confounders = confounders_encounter) %>% 
 mutate(case = "LRTI hospitalizations", control = "not hospitalized")


###################################
# LRTI vs. no LRTI 
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(symp_LRT_distress == 1  ~ 1,
                                  TRUE ~ 0))

ve.13 <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(case = "LRTI", control = "no LRTI")


###################################
# RSV+ hospitalization vs. RSV+ outpatient (case-only)
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1  ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.14 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity) %>% 
 mutate(case = "RSV+ hospitalizations", control = "RSV+ outpatient")


###################################
# severe RSV+ hospitalization vs. RSV+ outpatient (case-only)
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    (icu_admitted == "yes" | highflow_oxygen == 1)  ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.15 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity) %>% 
 mutate(case = "severe RSV+ hospitalizations", control = "RSV+ outpatient")


###################################
# RSV+ LRTI vs. RSV+ outpatient (case-only)
###################################
# this might not be possible as there is overlap between case and control
df.ve <- df %>% 
  mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1 ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.16 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity) %>% 
 mutate(case = "RSV+ LRTI", control = "RSV+ outpatient")



###################################
# severe RSV+ LRTI vs. RSV+ outpatient
###################################
# this might not be possible as there is overlap between case and control
df.ve <- df %>% 
  mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1 &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 1 & encounter_type == "outpatient" ~ 0))

ve.17 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity) %>% 
 mutate(case = "severe RSV+ LRTI", control = "RSV+ outpatient")




# combine the tables together 
ve <- 
  rbind(
  ve.1, ve.2, ve.3, ve.4, ve.5,
  ve.6, ve.7, ve.8, ve.9, ve.10,
  ve.11, ve.12, ve.13, ve.14, ve.15
) %>% 
  dplyr::select(case, control, n_cases_mab, n_cases_nomab, n_controls_mab, n_controls_nomab, ve_unadj, ve_adj) 

ve %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20) 

```

#### Figure `r fig.counter`.
```{r, fig.width = 13, fig.height= 6}
fig.counter <- fig.counter + 1

source("utils_mAb_VE.R")

ve_forest()
```

#### Figure `r fig.counter`. (with n_records)
```{r, fig.width = 18, fig.height= 7}
fig.counter <- fig.counter + 1

source("utils_mAb_VE.R")

ve_forest_withn()
```


<br>

### Look at how VE of mAb changes over time {.tabset}

#### Table `r tab.counter`  1 month interval
Why the unadjusted and adjusted are reversed? 
```{r warning=F}
tab.counter <- tab.counter + 1

####################
# all RSV+ vs. all RSV-
####################

df.wane <- df %>% mutate(case_control = positive_rsv) 

# unadjusted
model.unadj <- glm(case_control ~ days_btw_mab_collection_cat_3, data = df.wane, family = "binomial")


ve.median.unadj <- 1 - exp(model.unadj$coefficients[2:6])
ve.ub.unadj <- 1 - exp(confint(model.unadj)[,1][2:6])
ve.lb.unadj <- 1 - exp(confint(model.unadj)[,2][2:6])

# adjusted 
formula <- as.formula(paste0("case_control ~ days_btw_mab_collection_cat_3 + ", 
                             paste(confounders_infection, collapse = " + ")))
model.adj <- glm(formula, data = df.wane, family = "binomial")
ve.median.adj <- 1 - exp(model.adj$coefficients[2:6])
ve.ub.adj <- 1 - exp(confint(model.adj)[,1][2:6])
ve.lb.adj <- 1 - exp(confint(model.adj)[,2][2:6])



n.cases <- df.wane[, c("case_control", "days_btw_mab_collection_cat_3")] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat_3)
n.controls <- df.wane[, c("case_control", "days_btw_mab_collection_cat_3")] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat_3)

n.cases.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat_3", confounders_infection)] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat_3)
n.controls.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat_3", confounders_infection)] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat_3)


ve.wane.1m.infection <- 
  data.frame(
  case_control = rep("RSV+ vs. RSV-", 6),
  strata = c("not immunized", "immunized 0-1 months ago", "immunied 1-2 months ago", "immunized 2-3 months ago", "immunized 3-4 months ago",  "immunized 4 months + ago"),
  n.cases = paste0(n.cases[,2], " (", n.cases.adj[,2], ")"),
  n.controls = paste0(n.controls[,2], " (", n.controls.adj[,2], ")"),
  VE.unadjusted = c("REF", paste0(round(ve.median.unadj*100,1), " (", round(ve.lb.unadj*100,1), "-", round(ve.ub.unadj*100,1), ")")),
  VE.adjusted = c("REF", paste0(round(ve.median.adj*100,1), " (", round(ve.lb.adj*100,1), "-", round(ve.ub.adj*100,1), ")"))
)




ve.wane.1m.infection%>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20, groupBy = "case_control") 
```


#### Table `r tab.counter`  2 months interval
Why the unadjusted and adjusted are reversed? 
```{r warning=F}
tab.counter <- tab.counter + 1

####################
# all RSV+ vs. all RSV-
####################

df.wane <- df %>% mutate(case_control = positive_rsv) 

# unadjusted
model.unadj <- glm(case_control ~ days_btw_mab_collection_cat, data = df.wane, family = "binomial")


ve.median.unadj <- 1 - exp(model.unadj$coefficients[2:4])
ve.ub.unadj <- 1 - exp(confint(model.unadj)[,1][2:4])
ve.lb.unadj <- 1 - exp(confint(model.unadj)[,2][2:4])

# adjusted 
formula <- as.formula(paste0("case_control ~ days_btw_mab_collection_cat + ", 
                             paste(confounders_infection, collapse = " + ")))
model.adj <- glm(formula, data = df.wane, family = "binomial")
ve.median.adj <- 1 - exp(model.adj$coefficients[2:4])
ve.ub.adj <- 1 - exp(confint(model.adj)[,1][2:4])
ve.lb.adj <- 1 - exp(confint(model.adj)[,2][2:4])



n.cases <- df.wane[, c("case_control", "days_btw_mab_collection_cat")] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat)
n.controls <- df.wane[, c("case_control", "days_btw_mab_collection_cat")] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat)

n.cases.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat", confounders_infection)] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat)
n.controls.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat", confounders_infection)] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat)


ve.wane.2m.infection <- 
  data.frame(
  case_control = rep("RSV+ vs. RSV-", 4),
  strata = c("not immunized", "immunized 0-2 months ago", "immuniaed 2-4 months ago", "immunized 4 months + ago"),
  n.cases = paste0(n.cases[,2], " (", n.cases.adj[,2], ")"),
  n.controls = paste0(n.controls[,2], " (", n.controls.adj[,2], ")"),
  VE.unadjusted = c("REF", paste0(round(ve.median.unadj*100,1), " (", round(ve.lb.unadj*100,1), "-", round(ve.ub.unadj*100,1), ")")),
  VE.adjusted = c("REF", paste0(round(ve.median.adj*100,1), " (", round(ve.lb.adj*100,1), "-", round(ve.ub.adj*100,1), ")"))
)



########################################
# RSV+ hospitalizations vs. all RSV- 
########################################

df.wane <- df %>% mutate(case_control = case_when(positive_rsv == 1 & encounter_type == "inpatient" ~ 1,
                                                  positive_rsv == 0 ~ 0)) 



# unadjusted
model.unadj <- glm(case_control ~ days_btw_mab_collection_cat, data = df.wane, family = "binomial")


ve.median.unadj <- 1 - exp(model.unadj$coefficients[2:4])
ve.ub.unadj <- 1 - exp(confint(model.unadj)[,1][2:4])
ve.lb.unadj <- 1 - exp(confint(model.unadj)[,2][2:4])

# adjusted 
formula <- as.formula(paste0("case_control ~ days_btw_mab_collection_cat + ", 
                             paste(confounders_severity_2, collapse = " + ")))
model.adj <- glm(formula, data = df.wane, family = "binomial")
ve.median.adj <- 1 - exp(model.adj$coefficients[2:4])
ve.ub.adj <- 1 - exp(confint(model.adj)[,1][2:4])
ve.lb.adj <- 1 - exp(confint(model.adj)[,2][2:4])



n.cases <- df.wane[, c("case_control", "days_btw_mab_collection_cat")] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat)
n.controls <- df.wane[, c("case_control", "days_btw_mab_collection_cat")] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat)

n.cases.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat", confounders_severity_2)] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat)
n.controls.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat", confounders_severity_2)] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat)


ve.wane.2m.severity <- 
  data.frame(
  case_control = rep("RSV+ hospitalization vs. RSV-", 4),
  strata = c("not immunized", "immunized 0-2 months ago", "immuniaed 2-4 months ago", "immunized 4 months + ago"),
  n.cases = paste0(n.cases[,2], " (", n.cases.adj[,2], ")"),
  n.controls = paste0(n.controls[,2], " (", n.controls.adj[,2], ")"),
  VE.unadjusted = c("REF", paste0(round(ve.median.unadj*100,1), " (", round(ve.lb.unadj*100,1), "-", round(ve.ub.unadj*100,1), ")")),
  VE.adjusted = c("REF", paste0(round(ve.median.adj*100,1), " (", round(ve.lb.adj*100,1), "-", round(ve.ub.adj*100,1), ")"))
)


########################################
# RSV+ LRTI vs. RSV-
########################################

df.wane <- df %>% mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1 ~ 1,
                                                  positive_rsv == 0 ~ 0)) 



# unadjusted
model.unadj <- glm(case_control ~ days_btw_mab_collection_cat, data = df.wane, family = "binomial")


ve.median.unadj <- 1 - exp(model.unadj$coefficients[2:4])
ve.ub.unadj <- 1 - exp(confint(model.unadj)[,1][2:4])
ve.lb.unadj <- 1 - exp(confint(model.unadj)[,2][2:4])

# adjusted 
formula <- as.formula(paste0("case_control ~ days_btw_mab_collection_cat + ", 
                             paste(confounders_severity_2, collapse = " + ")))
model.adj <- glm(formula, data = df.wane, family = "binomial")
ve.median.adj <- 1 - exp(model.adj$coefficients[2:4])
ve.ub.adj <- 1 - exp(confint(model.adj)[,1][2:4])
ve.lb.adj <- 1 - exp(confint(model.adj)[,2][2:4])



n.cases <- df.wane[, c("case_control", "days_btw_mab_collection_cat")] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat)
n.controls <- df.wane[, c("case_control", "days_btw_mab_collection_cat")] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat)

n.cases.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat", confounders_severity_2)] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat)
n.controls.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat", confounders_severity_2)] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat)


ve.wane.2m.LRTI <- 
  data.frame(
  case_control = rep("RSV+ LRTI vs. RSV-", 4),
  strata = c("not immunized", "immunized 0-2 months ago", "immuniaed 2-4 months ago", "immunized 4 months + ago"),
  n.cases = paste0(n.cases[,2], " (", n.cases.adj[,2], ")"),
  n.controls = paste0(n.controls[,2], " (", n.controls.adj[,2], ")"),
  VE.unadjusted = c("REF", paste0(round(ve.median.unadj*100,1), " (", round(ve.lb.unadj*100,1), "-", round(ve.ub.unadj*100,1), ")")),
  VE.adjusted = c("REF", paste0(round(ve.median.adj*100,1), " (", round(ve.lb.adj*100,1), "-", round(ve.ub.adj*100,1), ")"))
)



########################################
# RSV+ LRTI hosp vs. RSV-
########################################

df.wane <- df %>% mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1 & 
                                                    encounter_type == "inpatient" ~ 1,
                                                  positive_rsv == 0 ~ 0)) 



# unadjusted
model.unadj <- glm(case_control ~ days_btw_mab_collection_cat, data = df.wane, family = "binomial")


ve.median.unadj <- 1 - exp(model.unadj$coefficients[2:4])
ve.ub.unadj <- 1 - exp(confint(model.unadj)[,1][2:4])
ve.lb.unadj <- 1 - exp(confint(model.unadj)[,2][2:4])

# adjusted 
formula <- as.formula(paste0("case_control ~ days_btw_mab_collection_cat + ", 
                             paste(confounders_severity_2, collapse = " + ")))
model.adj <- glm(formula, data = df.wane, family = "binomial")
ve.median.adj <- 1 - exp(model.adj$coefficients[2:4])
ve.ub.adj <- 1 - exp(confint(model.adj)[,1][2:4])
ve.lb.adj <- 1 - exp(confint(model.adj)[,2][2:4])



n.cases <- df.wane[, c("case_control", "days_btw_mab_collection_cat")] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat)
n.controls <- df.wane[, c("case_control", "days_btw_mab_collection_cat")] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat)

n.cases.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat", confounders_severity_2)] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat)
n.controls.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat", confounders_severity_2)] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat)


ve.wane.2m.LRTIhosp <- 
  data.frame(
  case_control = rep("RSV+ LRTI hospitalizations vs. RSV-", 4),
  strata = c("not immunized", "immunized 0-2 months ago", "immuniaed 2-4 months ago", "immunized 4 months + ago"),
  n.cases = paste0(n.cases[,2], " (", n.cases.adj[,2], ")"),
  n.controls = paste0(n.controls[,2], " (", n.controls.adj[,2], ")"),
  VE.unadjusted = c("REF", paste0(round(ve.median.unadj*100,1), " (", round(ve.lb.unadj*100,1), "-", round(ve.ub.unadj*100,1), ")")),
  VE.adjusted = c("REF", paste0(round(ve.median.adj*100,1), " (", round(ve.lb.adj*100,1), "-", round(ve.ub.adj*100,1), ")"))
)




rbind(ve.wane.2m.infection, ve.wane.2m.severity, ve.wane.2m.LRTI, ve.wane.2m.LRTIhosp) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20, groupBy = "case_control") 
```


#### Table `r tab.counter`  3 months interval
```{r warning=F}
tab.counter <- tab.counter + 1

####################
# all RSV+ vs. all RSV- 
####################

df.wane <- df %>% mutate(case_control = positive_rsv) 

# unadjusted
model.unadj <- glm(case_control ~ days_btw_mab_collection_cat_2, data = df.wane, family = "binomial")


ve.median.unadj <- 1 - exp(model.unadj$coefficients[2:3])
ve.ub.unadj <- 1 - exp(confint(model.unadj)[,1][2:3])
ve.lb.unadj <- 1 - exp(confint(model.unadj)[,2][2:3])

# adjusted 
formula <- as.formula(paste0("case_control ~ days_btw_mab_collection_cat_2 + ", 
                             paste(confounders_infection, collapse = " + ")))
model.adj <- glm(formula, data = df.wane, family = "binomial")
ve.median.adj <- 1 - exp(model.adj$coefficients[2:3])
ve.ub.adj <- 1 - exp(confint(model.adj)[,1][2:3])
ve.lb.adj <- 1 - exp(confint(model.adj)[,2][2:3])



n.cases <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2")] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat_2)
n.controls <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2")] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat_2)

n.cases.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2", confounders_infection)] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat_2)
n.controls.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2", confounders_infection)] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat_2)


ve.wane.3m.infection <- 
  data.frame(
  case_control = rep("RSV+ vs. RSV-", 3),
  strata = c("not immunized", "immunized 0-3 months ago", "immuniaed 3-6 months ago"),
  n.cases = paste0(n.cases[,2], " (", n.cases.adj[,2], ")"),
  n.controls = paste0(n.controls[,2], " (", n.controls.adj[,2], ")"),
  VE.unadjusted = c("REF", paste0(round(ve.median.unadj*100,1), " (", round(ve.lb.unadj*100,1), "-", round(ve.ub.unadj*100,1), ")")),
  VE.adjusted = c("REF", paste0(round(ve.median.adj*100,1), " (", round(ve.lb.adj*100,1), "-", round(ve.ub.adj*100,1), ")"))
)



########################################
# RSV+ hospitalizations vs. all RSV- 
########################################

df.wane <- df %>% mutate(case_control = case_when(positive_rsv == 1 & encounter_type == "inpatient" ~ 1,
                                                  positive_rsv == 0 ~ 0)) 



# unadjusted
model.unadj <- glm(case_control ~ days_btw_mab_collection_cat_2, data = df.wane, family = "binomial")


ve.median.unadj <- 1 - exp(model.unadj$coefficients[2:3])
ve.ub.unadj <- 1 - exp(confint(model.unadj)[,1][2:3])
ve.lb.unadj <- 1 - exp(confint(model.unadj)[,2][2:3])

# adjusted 
formula <- as.formula(paste0("case_control ~ days_btw_mab_collection_cat_2 + ", 
                             paste(confounders_severity_2, collapse = " + ")))
model.adj <- glm(formula, data = df.wane, family = "binomial")
ve.median.adj <- 1 - exp(model.adj$coefficients[2:3])
ve.ub.adj <- 1 - exp(confint(model.adj)[,1][2:3])
ve.lb.adj <- 1 - exp(confint(model.adj)[,2][2:3])


n.cases <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2")] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat_2)
n.controls <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2")] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat_2)

n.cases.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2", confounders_severity_2)] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat_2)
n.controls.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2", confounders_severity_2)] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat_2)


ve.wane.3m.severity <- 
  data.frame(
  case_control = rep("RSV+ hospitalizations vs. RSV-", 3),
  strata = c("not immunized", "immunized 0-3 months ago", "immuniaed 3-6 months ago"),
  n.cases = paste0(n.cases[,2], " (", n.cases.adj[,2], ")"),
  n.controls = paste0(n.controls[,2], " (", n.controls.adj[,2], ")"),
  VE.unadjusted = c("REF", paste0(round(ve.median.unadj*100,1), " (", round(ve.lb.unadj*100,1), "-", round(ve.ub.unadj*100,1), ")")),
  VE.adjusted = c("REF", paste0(round(ve.median.adj*100,1), " (", round(ve.lb.adj*100,1), "-", round(ve.ub.adj*100,1), ")"))
)


########################################
# RSV+ LRTI vs. all RSV- 
########################################

df.wane <- df %>% mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1 ~ 1,
                                                  positive_rsv == 0 ~ 0)) 



# unadjusted
model.unadj <- glm(case_control ~ days_btw_mab_collection_cat_2, data = df.wane, family = "binomial")

ve.median.unadj <- 1 - exp(model.unadj$coefficients[2:3])
ve.ub.unadj <- 1 - exp(confint(model.unadj)[,1][2:3])
ve.lb.unadj <- 1 - exp(confint(model.unadj)[,2][2:3])

# adjusted 
formula <- as.formula(paste0("case_control ~ days_btw_mab_collection_cat_2 + ", 
                             paste(confounders_severity_2, collapse = " + ")))
model.adj <- glm(formula, data = df.wane, family = "binomial")
ve.median.adj <- 1 - exp(model.adj$coefficients[2:3])
ve.ub.adj <- 1 - exp(confint(model.adj)[,1][2:3])
ve.lb.adj <- 1 - exp(confint(model.adj)[,2][2:3])


n.cases <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2")] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat_2)
n.controls <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2")] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat_2)

n.cases.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2", confounders_severity_2)] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat_2)
n.controls.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2", confounders_severity_2)] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat_2)


ve.wane.3m.LRTI <- 
  data.frame(
  case_control = rep("RSV+ LRTI vs. RSV-", 3),
  strata = c("not immunized", "immunized 0-3 months ago", "immuniaed 3-6 months ago"),
  n.cases = paste0(n.cases[,2], " (", n.cases.adj[,2], ")"),
  n.controls = paste0(n.controls[,2], " (", n.controls.adj[,2], ")"),
  VE.unadjusted = c("REF", paste0(round(ve.median.unadj*100,1), " (", round(ve.lb.unadj*100,1), "-", round(ve.ub.unadj*100,1), ")")),
  VE.adjusted = c("REF", paste0(round(ve.median.adj*100,1), " (", round(ve.lb.adj*100,1), "-", round(ve.ub.adj*100,1), ")"))
)



########################################
# RSV+ LRTI hospitalizations vs. all RSV- 
########################################

df.wane <- df %>% mutate(case_control = case_when(positive_rsv == 1 & encounter_type == "inpatient" &
                                                    symp_LRT_distress == 1 ~ 1,
                                                  positive_rsv == 0 ~ 0)) 



# unadjusted
model.unadj <- glm(case_control ~ days_btw_mab_collection_cat_2, data = df.wane, family = "binomial")
ve.median.unadj <- 1 - exp(model.unadj$coefficients[2:3])
ve.ub.unadj <- 1 - exp(confint(model.unadj)[,1][2:3])
ve.lb.unadj <- 1 - exp(confint(model.unadj)[,2][2:3])

# adjusted 
formula <- as.formula(paste0("case_control ~ days_btw_mab_collection_cat_2 + ", 
                             paste(confounders_severity_2, collapse = " + ")))
model.adj <- glm(formula, data = df.wane, family = "binomial")
ve.median.adj <- 1 - exp(model.adj$coefficients[2:3])
ve.ub.adj <- 1 - exp(confint(model.adj)[,1][2:3])
ve.lb.adj <- 1 - exp(confint(model.adj)[,2][2:3])


n.cases <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2")] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat_2)
n.controls <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2")] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat_2)

n.cases.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2", confounders_severity_2)] %>%
  drop_na() %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat_2)
n.controls.adj <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2", confounders_severity_2)] %>%
  drop_na() %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat_2)


ve.wane.3m.LRTIhosp <- 
  data.frame(
  case_control = rep("RSV+ LRTI hospitalizations vs. RSV-", 3),
  strata = c("not immunized", "immunized 0-3 months ago", "immuniaed 3-6 months ago"),
  n.cases = paste0(n.cases[,2], " (", n.cases.adj[,2], ")"),
  n.controls = paste0(n.controls[,2], " (", n.controls.adj[,2], ")"),
  VE.unadjusted = c("REF", paste0(round(ve.median.unadj*100,1), " (", round(ve.lb.unadj*100,1), "-", round(ve.ub.unadj*100,1), ")")),
  VE.adjusted = c("REF", paste0(round(ve.median.adj*100,1), " (", round(ve.lb.adj*100,1), "-", round(ve.ub.adj*100,1), ")"))
)

rbind(ve.wane.3m.infection, ve.wane.3m.severity, ve.wane.3m.LRTI, ve.wane.3m.LRTIhosp) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20, groupBy = "case_control") 
```

<br>

### Look at whether dosage has an influence on VE. {.tabset}

#### Table `r tab.counter` Compare infants who took 100mg and 50mg dosage  
```{r}
tab.counter <- tab.counter + 1

df_table1_dosage <- df_table1 %>%
  mutate(rsv_mab_dose = case_when(rsv_mab == "Yes, 100mg dose" ~ "100mg",
                                  rsv_mab == "Yes, 50mg dose" ~ "50mg")) %>%
  filter(!is.na(rsv_mab_dose))

table1_dosage <- df_table1_dosage %>% 
  dplyr::select(-rsv_mab, -encounter_type, -positive_rsv) %>%
  tbl_summary(by = rsv_mab_dose,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", 
                                               "{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                age_at_test_in_months_cat_2 ~ "Age at testing",
                month_when_tested_cat ~ "Time tested", 
                race_ethnicity ~ "Race and ethnicity",
                risk_factor_pulmonary ~ "Pulmonary diseases", 
                risk_factor_cardiac ~ "Cardiac diseases",
                risk_factor_anemia ~ "Anemia",
                risk_factor_gestagelessthan37wks ~ "Gestational age",
                risk_factor_atleastone ~ "Having at least one risk factor",
                insurance_type ~ "Insurance type",
                birth_weight ~ "Birth weight"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = footnote_otherraces
  ) %>%
   modify_table_styling(
    columns = label,
    rows = label == "Having at least one risk factor",
    footnote = footnote_atleastoneriskfactor
  )


table1_dosage %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 
  
```
#### Table `r tab.counter` VE by dosage (100mg vs. not vaccinated)
```{r warning=F}
tab.counter <- tab.counter + 1

df.100mg <- df %>% 
  mutate(rsv_mab = case_when(rsv_mab_dose == "100mg" ~ 1,
                             rsv_mab == 0 ~ 0))


###################################
# inpatient RSV+ vs. inpatient RSV-
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 ~ 1,
                                  encounter_type == "inpatient" & positive_rsv == 0 ~ 0))

ve.1 <- regress_unmatch(df.ve = df.ve, confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (inpatient)", control = "RSV- (inpatient)")


###################################
# outpatient RSV+ vs. outpatient RSV-
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "outpatient" & positive_rsv == 1 ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 0 ~ 0))

ve.2 <- regress_unmatch(df.ve = df.ve, confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (outpatient)", control = "RSV- (outpatient)")

###################################
# all RSV+ vs. all RSV-
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(positive_rsv == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.3 <- regress_unmatch(df.ve = df.ve, confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (all)", control = "RSV- (all)")


###################################
# RSV+ hospitalized vs. all RSV- 
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.4 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ hospitalizations", control = "RSV- (all)")


###################################
# severe RSV+ hospitalized vs. all RSV- 
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.5 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ hospitalizations", control = "RSV- (all)")

###################################
# RSV+ icu vs. all RSV- 
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(positive_rsv == 1 & icu_admitted == "yes" ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.6 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ ICU admission", control = "RSV- (all)")

###################################
# RSV+ LRT-hospitalizations vs. all RSV- 
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    ( symp_LRT_distress == 1 ) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.7 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ LRTI hospitalizations", control = "RSV- (all)")


###################################
# severe RSV+ LRT-hospitalizations vs. all RSV- 
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    ( symp_LRT_distress == 1 ) &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.8 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ LRTI hospitalizations", control = "RSV- (all)")


###################################
# RSV LRTI vs. all RSV- 
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.9 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ LRTI", control = "RSV- (all)")


###################################
# severe RSV LRTI vs. all RSV- 
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1 &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.10 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ LRTI", control = "RSV- (all)")



###################################
# all-cause hospitalizations vs. outpatient  
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient"  ~ 1,
                                  encounter_type == "outpatient" ~ 0))

ve.11 <- regress_unmatch(df.ve = df.ve, confounders = confounders_encounter) %>% 
 mutate(case = "all-cause hospitalizations", control = "not hospitalized")


###################################
# LRT-hospitalizations vs. outpatient  
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & symp_LRT_distress == 1  ~ 1,
                                  encounter_type == "outpatient" ~ 0))

ve.12 <- regress_unmatch(df.ve = df.ve, confounders = confounders_encounter) %>% 
 mutate(case = "LRTI hospitalizations", control = "not hospitalized")


###################################
# LRTI vs. no LRTI  
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(symp_LRT_distress == 1  ~ 1,
                                  TRUE ~ 0))

ve.13 <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(case = "LRTI", control = "no LRTI")


###################################
# RSV+ hospitalization vs. RSV+ outpatient (case-only)
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1  ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.14 <- regress_unmatch(df.ve = df.ve,  confounders = confounders_severity) %>% 
 mutate(case = "RSV+ hospitalizations", control = "RSV+ outpatient")



###################################
# severe RSV+ hospitalization vs. RSV+ outpatient (case-only)
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    (icu_admitted == "yes" | highflow_oxygen == 1)  ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.15 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity) %>% 
 mutate(case = "severe RSV+ hospitalizations", control = "RSV+ outpatient")


###################################
# RSV+ LRTI vs. RSV+ outpatient (case-only)
###################################
# this might not be possible as there is overlap between case and control
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1 ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.16 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity) %>% 
 mutate(case = "RSV+ LRTI", control = "RSV+ outpatient")


###################################
# severe RSV+ LRTI vs. RSV+ outpatient (case-only)
###################################
# this might not be possible as there is overlap between case and control
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1 & 
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.17 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity) %>% 
 mutate(case = "severe RSV+ LRTI", control = "RSV+ outpatient")


# combine the tables together 
ve.100mg <- 
  rbind(
  ve.1, ve.2, ve.3, ve.4, ve.5,
  ve.7, ve.8, ve.9, ve.10,
  ve.11, ve.12, ve.13, ve.14, ve.15
) %>% 
  dplyr::select(case, control, n_cases_mab, n_cases_nomab, n_controls_mab, n_controls_nomab, ve_unadj, ve_adj) 


ve.100mg %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20) 
```

#### Table `r tab.counter` VE by dosage (50mg vs. not vaccinated)
```{r warning=F}
tab.counter <- tab.counter + 1

df.50mg <- df %>% 
  mutate(rsv_mab = case_when(rsv_mab_dose == "50mg" ~ 1,
                             rsv_mab == 0 ~ 0))


###################################
# inpatient RSV+ vs. inpatient RSV-
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 ~ 1,
                                  encounter_type == "inpatient" & positive_rsv == 0 ~ 0))

ve.1 <- regress_unmatch(df.ve = df.ve, confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (inpatient)", control = "RSV- (inpatient)")


###################################
# outpatient RSV+ vs. outpatient RSV-
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "outpatient" & positive_rsv == 1 ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 0 ~ 0))

ve.2 <- regress_unmatch(df.ve = df.ve, confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (outpatient)", control = "RSV- (outpatient)")

###################################
# all RSV+ vs. all RSV-
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(positive_rsv == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.3 <- regress_unmatch(df.ve = df.ve, confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (all)", control = "RSV- (all)")


###################################
# RSV+ hospitalized vs. all RSV- 
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.4 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ hospitalizations", control = "RSV- (all)")


###################################
# severe RSV+ hospitalized vs. all RSV- 
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.5 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ hospitalizations", control = "RSV- (all)")

###################################
# RSV+ icu vs. all RSV- 
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(positive_rsv == 1 & icu_admitted == "yes" ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.6 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ ICU admission", control = "RSV- (all)")

###################################
# RSV+ LRT-hospitalizations vs. all RSV- 
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    ( symp_LRT_distress == 1 ) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.7 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ LRTI hospitalizations", control = "RSV- (all)")


###################################
# severe RSV+ LRT-hospitalizations vs. all RSV- 
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    ( symp_LRT_distress == 1 ) &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.8 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ LRTI hospitalizations", control = "RSV- (all)")


###################################
# RSV LRTI vs. all RSV- 
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.9 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ LRTI", control = "RSV- (all)")


###################################
# severe RSV LRTI vs. all RSV- 
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1 &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.10 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ LRTI", control = "RSV- (all)")



###################################
# all-cause hospitalizations vs. outpatient  
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient"  ~ 1,
                                  encounter_type == "outpatient" ~ 0))

ve.11 <- regress_unmatch(df.ve = df.ve, confounders = confounders_encounter) %>% 
 mutate(case = "all-cause hospitalizations", control = "not hospitalized")


###################################
# LRT-hospitalizations vs. outpatient  
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & symp_LRT_distress == 1  ~ 1,
                                  encounter_type == "outpatient" ~ 0))

ve.12 <- regress_unmatch(df.ve = df.ve, confounders = confounders_encounter) %>% 
 mutate(case = "LRTI hospitalizations", control = "not hospitalized")


###################################
# LRTI vs. no LRTI  
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(symp_LRT_distress == 1  ~ 1,
                                  TRUE ~ 0))

ve.13 <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(case = "LRTI", control = "no LRTI")


###################################
# RSV+ hospitalization vs. RSV+ outpatient (case-only)
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1  ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.14 <- regress_unmatch(df.ve = df.ve,  confounders = confounders_severity) %>% 
 mutate(case = "RSV+ hospitalizations", control = "RSV+ outpatient")



###################################
# severe RSV+ hospitalization vs. RSV+ outpatient (case-only)
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    (icu_admitted == "yes" | highflow_oxygen == 1)  ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.15 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity) %>% 
 mutate(case = "severe RSV+ hospitalizations", control = "RSV+ outpatient")


###################################
# RSV+ LRTI vs. RSV+ outpatient (case-only)
###################################
# this might not be possible as there is overlap between case and control
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1 ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.16 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity) %>% 
 mutate(case = "RSV+ LRTI", control = "RSV+ outpatient")


###################################
# severe RSV+ LRTI vs. RSV+ outpatient (case-only)
###################################
# this might not be possible as there is overlap between case and control
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(positive_rsv == 1 & symp_LRT_distress == 1 & 
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.17 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severity) %>% 
 mutate(case = "severe RSV+ LRTI", control = "RSV+ outpatient")


# combine the tables together 
ve.50mg <- 
  rbind(
  ve.1, ve.2, ve.3, ve.4, ve.5,
  ve.7, ve.8, ve.9, ve.10,
  ve.11, ve.12, ve.13, ve.14, ve.15
) %>% 
  dplyr::select(case, control, n_cases_mab, n_cases_nomab, n_controls_mab, n_controls_nomab, ve_unadj, ve_adj) 


ve.50mg %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20) 
```

#### Table `r tab.counter`. Compare VE from 50mg and 100mg dosage
```{r}
tab.counter <- tab.counter + 1

ve.50mg %>% 
  dplyr::select(case, control, ve_unadj, ve_adj) %>%
  rename(VE.unadjusted.50mg = ve_unadj, VE.adjusted.50mg = ve_adj) %>%
  left_join(
    ve.100mg %>% 
      dplyr::select(case, control, ve_unadj, ve_adj) %>%
      rename(VE.unadjusted.100mg = ve_unadj, VE.adjusted.100mg = ve_adj) 
  ) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T,  defaultPageSize = 20,
           columnGroups = list(
    colGroup(name = "100mg", columns = c("VE.unadjusted.100mg", "VE.adjusted.100mg")),
    colGroup(name = "50mg", columns = c("VE.unadjusted.50mg", "VE.adjusted.50mg"))
  ),
  columns = list(
    VE.unadjusted.100mg = colDef(name = "VE.unadjusted"),
    VE.adjusted.100mg= colDef(name = "VE.adjusted"),
    VE.unadjusted.50mg = colDef(name = "VE.unadjusted"),
    VE.adjusted.50mg = colDef(name = "VE.adjusted")
  ))
```

<br>









