---
title: "VE of Nirsevimab"
output: 
  html_document:
    toc: true
    toc_float: true
---

#### Date: `r Sys.Date()`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(dplyr)
library(tidyr)
library(tidyverse)
library(readxl)
library(writexl)
library(reactable)
library(ggplot2)
library(stringr)
library(flextable)


library(gtsummary) # for table 1
library(multcomp)
library(survival) # for matched case-control

fig.counter <- 1
tab.counter <- 1
```


```{r}
# read in dataset
df <- read.csv("../data/clean_data/df.mab.csv")
colnames <- as.data.frame(colnames(df))
```

### There are totally `r nrow(df)` testing records in the analysis dataset. 

<br>

### Table `r tab.counter`. Study population (testing level)
  * (TBC) where should we include the "unrelated" hospital admissions and ICU admissions? count them as "outpatient"/"no ICU admission"? (currently doing this, but doesn't really make sense..)
  * this is assuming that: if mAb was taken before collection date, we count it as immunized. For SSA, need to change it to: if the person took mAb more than 5 days before sample collection, we count it as immunized.
  * Here, cases are RSV+, and controls are RSV-.

```{r}
tab.counter <- tab.counter + 1

df_table1 <- df %>%
  # add dose of mab 
  mutate(rsv_mab = case_when(rsv_mab_detailed == "100mg before collection" ~ "Yes, 100mg dose",
                             rsv_mab_detailed == "50mg before collection" ~ "Yes, 50mg dose",
                             TRUE ~ "No")) %>%
  dplyr::select(positive_rsv,Sex, age_at_test_in_months, race_ethnicity, encounter_type, risk_factor_gestage, insurance_type, rsv_mab, risk_factor_atleastone, icu_admitted) %>% 
  mutate(positive_rsv = case_when(positive_rsv == 1 ~ "Cases (RSV+)",
                                  positive_rsv == 0 ~ "Controls (RSV-)")) %>%
  # count "unrelated" hosp and ICU admissions as "no"
  mutate(encounter_type = ifelse(encounter_type == "inpatient_unrelated", "outpatient", encounter_type)) %>%
  mutate(icu_admitted = ifelse(icu_admitted == "yes_unrelated", "no", icu_admitted))

table1_testing <- df_table1 %>% 
  tbl_summary(by = positive_rsv,
              
              type = all_continuous() ~ "continuous2",       # indicate that you want to print multiple statistics 
              statistic = list(all_continuous() ~ c("{mean} ({sd})", "{median} ({p25}, {p75})"),                 
                          all_categorical() ~ "{n} ({p}%)"),
              
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
              
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                race_ethnicity ~ "Race and ethnicity",
                encounter_type ~ "Encounter type",
                risk_factor_gestage ~ "Gestational age",
                insurance_type ~ "Insurance type",
                rsv_mab ~ "mAb status",
                risk_factor_atleastone ~ "Having at least one risk factor",
                icu_admitted ~ "ICU admission"
                ),
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels()


table1_testing %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 
  
```

<br>

```{r}

###############################
# Functions for VE estimation
###############################

## unmatched  model (unstratified)
regress_unmatch <- function(df.ve,
                            adjusted = "no"){
  
  # get n of cases and controls
  n.cases <- df.ve %>% filter(case_control == 1) %>% nrow()
  n.controls <- df.ve %>% filter(case_control == 0) %>% nrow()
  
  # effective n used by model, after removing missing values
  if(adjusted == "no"){
    n.cases.eff <- n.cases   
    n.controls.eff <- n.controls
    formula <- as.formula("case_control ~ rsv_mab")
  }
  if(adjusted == "yes"){
    n.cases.eff <-  df.ve[, c("case_control", confounders)] %>% 
      filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 1) %>% nrow()
    n.controls.eff <- df.ve[, c("case_control", confounders)] %>% 
      filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 0) %>% nrow()
    
    formula <- as.formula(paste(c("case_control ~ rsv_mab", confounders), collapse = " + ")) 
  }

  model <- glm(formula, data = df.ve, family = "binomial") 
  
  # get estimates
  ve.median <- 1 - exp(model$coefficients[2])
  ve.ub <- 1 - exp(confint(model)[2,][1])
  ve.lb <- 1 - exp(confint(model)[2,][2])
  
  # make a table
  ve.results <- data.frame(
    n_overall = n.cases + n.controls,
    n_overall_eff = n.cases.eff + n.controls.eff,
    n_cases = n.cases,
    n_cases_eff = n.cases.eff,
    n_controls = n.controls,
    n_controls_eff = n.controls.eff,
    ve_median = ve.median,
    ve_lb = ve.lb,
    ve_ub = ve.ub
  ) 
  
  row.names(ve.results) <- NULL
  
  return(ve.results)
}



## unmatched model (stratified)
# this seems not right (redo this)
regress_unmatch_stratified <- function(df.ve, 
                                       stratify_by,  # variable to stratify by
                                       adjusted = "no"){
  
  if(stratify_by == "age_at_test_in_months_cat"){
    confounders <- c(confounders, stratify_by)
  }
  
  # get n of cases and controls
  n.cases <- df.ve %>% filter(case_control == 1) %>% count(get(stratify_by))
  n.controls <- df.ve %>% filter(case_control == 0) %>% count(get(stratify_by))
  
  n.strata <- nrow(n.cases)
  
  
  # effective n and formula
  if(adjusted == "no"){
    n.cases.eff <-  n.cases
    n.controls.eff <- n.controls
    formula <- as.formula(paste0("case_control ~ rsv_mab + ", stratify_by))
  }
  
  if(adjusted == "yes"){
     n.cases.eff <-  df.ve[, c("case_control", confounders)] %>% 
      filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 1) %>% count(get(stratify_by))
    n.controls.eff <- df.ve[, c("case_control", confounders)] %>% 
      filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 0) %>% count(get(stratify_by))
    
    # reorder confounders
    confounders <- c(stratify_by, confounders[confounders %in% stratify_by == F])
    formula <- as.formula(paste(c("case_control ~ rsv_mab", confounders), collapse = " + ")) 
  }
  
  model <- glm(formula, data = df.ve, family = "binomial") 
  
  # get estimates
  ve.median <- c(1 - exp(model$coefficients[2]), # ve.median for first group
                 1- exp( model$coefficients[2] + model$coefficients[3:(n.strata+1)] )
                ) # ve for other groups
                 
  ve.ub <- c(1 - exp(confint(model)[,1][2]), # for first group
             1 - exp(confint(model)[,1][3:(n.strata+1)] + confint(model)[,1][2])) # for other groups
  ve.lb <- c(1 - exp(confint(model)[,2][2]), # for first group
             1 - exp(confint(model)[,2][3:(n.strata+1)] + confint(model)[,2][2])) # for other groups
  
  # make a table
  ve.results <- data.frame(
    strata = n.cases[,1],
    n_overall = n.cases[,2] + n.controls[,2],
    n_overall_eff = n.cases.eff[,2] + n.controls.eff[,2],
    n_cases = n.cases[,2],
    n_cases_eff = n.cases.eff[,2],
    n_controls = n.controls[,2],
    n_controls_eff = n.controls.eff[,2],
    ve_median = ve.median,
    ve_lb = ve.lb,
    ve_ub = ve.ub
  ) 
  
  rownames(ve.results) <- NULL
  
  return(ve.results)
  
}


# filter out subgroup and calculate VE of each subgroup
regress_unmatch_stratified <- function(df.ve = df.unmatched,
                                       stratify_by){
  
  df.glm <- df.ve %>% filter(!is.na(get(stratify_by)))
  confounders <- confounders[confounders %in% stratify_by == F]
  
  # remove subgroups with too few records
  if(stratify_by == "risk_factor_gestage"){
    df.glm <- df.glm %>% filter(risk_factor_gestage != "post term")
  }
  
  groups <- unique(df.glm[ , stratify_by])
  # subset each subgroup
  for(i in 1:length(groups)){
    
    # filter out this subgroup
    df.glm <- df.ve %>% filter(get(stratify_by) == groups[i])
    
    
    # run unadjusted glm
    model.unadj <- glm(case_control ~ rsv_mab, data = df.glm, family = "binomial")
    
    # get unadjuested estimates for this group
    ve.median.unadj <- 1 - exp(model.unadj$coefficients[2])
    ve.ub.unadj <- 1 - exp(confint(model.unadj)[2,][1])
    ve.lb.unadj <- 1 - exp(confint(model.unadj)[2,][2])
    
    # run adjusted glm
    if(groups[i] == "preterm"){confounders <- confounders[confounders %in% "risk_factor_atleastone" == F]}
    formula <- as.formula(paste(c("case_control ~ rsv_mab", 
                                 confounders), collapse = " + "))
    model.adj <- glm(formula, data = df.glm, family = "binomial")
    
    # get unadjuested estimates for this group
    ve.median.adj <- 1 - exp(model.adj$coefficients[2])
    ve.ub.adj <- 1 - exp(confint(model.adj)[,1][2])
    ve.lb.adj <- 1 - exp(confint(model.adj)[,2][2])
    
    # get the number of case and controls
    n.cases <- df.glm %>% filter(case_control ==1 ) %>% nrow()
    n.controls <- df.glm %>% filter(case_control == 0) %>% nrow 
    n.cases.eff <- df.glm[, c("case_control", confounders)] %>% filter(case_control == 1) %>%
      filter(across(everything(), ~ !is.na(.))) %>% nrow()
    n.controls.eff <- df.glm[, c("case_control", confounders)] %>% filter(case_control == 0) %>%
      filter(across(everything(), ~ !is.na(.))) %>% nrow()
    
    # combine results 
    df.results.temp <- data.frame(
      n_overall = n.cases + n.controls,
      n_overall_eff = n.cases.eff + n.controls.eff,
      n_cases = n.cases,
      n_cases_eff = n.cases.eff,
      n_controls = n.controls, 
      n_controls_eff = n.controls.eff,
      ve_median_unadj = ve.median.unadj,
      ve_lb_unadj = ve.lb.unadj,
      ve_ub_unadj = ve.ub.unadj,
      ve_median_adj = ve.median.adj,
      ve_lb_adj = ve.lb.adj,
      ve_ub_adj = ve.ub.adj
    ) %>%
      mutate(stratify_by = stratify_by,
             strata = groups[i])
    
    if(i == 1){df.results <- df.results.temp}
    if(i != 1){df.results <- rbind(df.results, df.results.temp)}
    
  }
  
  return(df.results)
  
}


```


```{r}
confounders <- c("Sex", 
                 "risk_factor_gestage",
                 "age_at_test_in_months",
                 "race_ethnicity",
                  "insurance_type",
                  "risk_factor_atleastone"
                  )

```

<br>

### Effectiveness of Nirsevimab (unmatched) {.tabset}

#### Table `r tab.counter`. Case: RSV+; control: RSV-
```{r warning=F}
tab.counter <- tab.counter + 1

df <- df %>%
  mutate(age_at_test_in_months_cat = case_when(
    age_at_test_in_months < 6 ~ "under 6m",
    age_at_test_in_months >= 6 & age_at_test_in_months < 12 ~ "6-12m",
    age_at_test_in_months >= 12 ~ "above 1 yo" 
  )) %>%
  mutate(risk_factor_atleastone = case_when(risk_factor_atleastone == 1 ~ "yes",
                                            risk_factor_atleastone == 0 ~ "no"))

# define case and control
df.unmatched <- df %>% mutate(case_control = positive_rsv)


run_unmatched_models <- function(){

###################
# VE (unstratified)
###################
ve.unmatched.unadj <- regress_unmatch(df.ve = df.unmatched,
                                              adjusted = "no") %>%
  mutate(stratify_by = "unstratified", strata = NA)

ve.unmatched.adj <- regress_unmatch(df.ve = df.unmatched) %>%
  mutate(stratify_by = "unstratified", strata = NA)


###################
# VE (stratified)
###################

# by gestational age
ve.unmatched.unadj.gestage <- regress_unmatch_stratified(df.ve = df.unmatched %>% 
                                                           filter(risk_factor_gestage != "post term"),
                                                         stratify_by = "risk_factor_gestage",
                                                         adjusted = "no") %>%
  mutate(stratify_by = "risk_factor_gestage")

ve.unmatched.adj.gestage <- regress_unmatch_stratified(df.ve = df.unmatched %>% 
                                                         filter(risk_factor_gestage != "post term"),
                                                       stratify_by = "risk_factor_gestage",
                                                       adjusted = "yes") %>%
   mutate(stratify_by = "risk_factor_gestage")



# by sex
ve.unmatched.unadj.sex <- regress_unmatch_stratified(df.ve = df.unmatched %>% filter(!is.na(Sex)),
                                                         stratify_by = "Sex",
                                                         adjusted = "no") %>%
  mutate(stratify_by = "Sex")

ve.unmatched.adj.sex <- regress_unmatch_stratified(df.ve = df.unmatched %>% filter(!is.na(Sex)),
                                                       stratify_by = "Sex",
                                                       adjusted = "yes") %>%
   mutate(stratify_by = "Sex")

# by age at testing 
ve.unmatched.unadj.agetested <- regress_unmatch_stratified(df.ve = df.unmatched,
                                                       stratify_by = "age_at_test_in_months_cat",
                                                       adjusted = "no") %>%
   mutate(stratify_by = "Age when tested")


ve.unmatched.adj.agetested <- regress_unmatch_stratified(df.ve = df.unmatched,
                                                       stratify_by = "age_at_test_in_months_cat",
                                                       adjusted = "yes") %>%
   mutate(stratify_by = "Age when tested")


# by race and ethnicity
ve.unmatched.unadj.race <- regress_unmatch_stratified(df.ve = df.unmatched,
                                                       stratify_by = "race_ethnicity",
                                                       adjusted = "no") %>%
   mutate(stratify_by = "Race and ethnicity")


ve.unmatched.adj.race <- regress_unmatch_stratified(df.ve = df.unmatched,
                                                       stratify_by = "race_ethnicity",
                                                       adjusted = "yes") %>%
   mutate(stratify_by = "Race and ethnicity")


# by insurance type 
ve.unmatched.unadj.insurance <- regress_unmatch_stratified(df.ve = df.unmatched,
                                                       stratify_by = "insurance_type",
                                                       adjusted = "no") %>%
   mutate(stratify_by = "Insurance type")


ve.unmatched.adj.insurance <- regress_unmatch_stratified(df.ve = df.unmatched,
                                                       stratify_by = "insurance_type",
                                                       adjusted = "yes") %>%
   mutate(stratify_by = "Insurance type")

# by if having risk factors
ve.unmatched.unadj.riskfactor <- regress_unmatch_stratified(df.ve = df.unmatched,
                                                       stratify_by = "risk_factor_atleastone",
                                                       adjusted = "no") %>%
   mutate(stratify_by = "Whether have risk factors")


ve.unmatched.adj.riskfactor <- regress_unmatch_stratified(df.ve = df.unmatched,
                                                       stratify_by = "risk_factor_atleastone",
                                                       adjusted = "yes") %>%
   mutate(stratify_by = "Whether have risk factors")


# combine into one table
ve.unmatched <- 
  # unadjusted ve
  rbind(
    ve.unmatched.unadj,
    ve.unmatched.unadj.gestage,
    ve.unmatched.unadj.sex,
    ve.unmatched.unadj.agetested,
    ve.unmatched.unadj.race,
    ve.unmatched.unadj.insurance,
    ve.unmatched.unadj.riskfactor
  ) %>%
  dplyr::select(ve_median, ve_lb, ve_ub, stratify_by, strata) %>%
  mutate(across(ve_median:ve_ub, ~ round(. * 100, 1))) %>%
  mutate(VE.unadjusted = paste0(ve_median, " (", ve_lb, "-", ve_ub, ")")) %>%
  dplyr::select(-c(ve_median, ve_lb, ve_ub)) %>%
  left_join(
    rbind(
      ve.unmatched.adj,
      ve.unmatched.adj.gestage,
      ve.unmatched.adj.sex,
      ve.unmatched.adj.agetested,
      ve.unmatched.adj.race,
      ve.unmatched.adj.insurance,
      ve.unmatched.adj.riskfactor
  ) %>%
  mutate(n_overall = paste0(n_overall, " (", n_overall_eff, ")"),
         n_cases = paste0(n_cases, " (", n_cases_eff, ")"),
         n_controls = paste0(n_controls, " (", n_controls_eff, ")")) %>%
  dplyr::select(n_overall, n_cases, n_controls, ve_median, ve_lb, ve_ub, stratify_by, strata) %>%
  mutate(across(ve_median:ve_ub, ~ round(. * 100, 1))) %>%
  mutate(VE.adjusted = paste0(ve_median, " (", ve_lb, "-", ve_ub, ")")) %>%
  dplyr::select(-c(ve_median, ve_lb, ve_ub)),
  by = c("stratify_by", "strata")
  ) %>%
  dplyr::select(stratify_by, strata, n_overall, n_cases, n_controls, VE.unadjusted, VE.adjusted)

return(ve.unmatched)
}

run_unmatched_models() %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            groupBy = "stratify_by", defaultExpanded = T) 

```


#### Table `r tab.counter`. Case: RSV+ & hospitalized; control: RSV- 
  * TBC: control should be only RSV- or also include RSV+ but not hospitalized? 
```{r warning=F}
tab.counter <- tab.counter + 1

# define case and control
df.unmatched <- df %>% 
  mutate(case_control = case_when(positive_rsv == 1 & encounter_type == "inpatient" ~ 1,
                                  positive_rsv == 0 ~ 0)) %>% 
  filter(!is.na(case_control)) %>%
  filter(insurance_type != "uninsured")

run_unmatched_models() %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            groupBy = "stratify_by", defaultExpanded = T) 

```

#### Table `r tab.counter`. Case: RSV+ & severe; control: RSV- 
  * TBC: control should be only RSV- or also include RSV+ but not hospitalized? 
  * here severe cases includes: those admitted to ICU or ordered highflow oxygen
```{r warning=F}
tab.counter <- tab.counter + 1

# define case and control
df.unmatched <- df %>% 
  mutate(case_control = case_when(positive_rsv == 1 & (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0)) %>% 
  filter(!is.na(case_control)) %>%
  filter(insurance_type != "uninsured")

run_unmatched_models() %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            groupBy = "stratify_by", defaultExpanded = T) 

```


#### Table `r tab.counter`. Case: RSV+ & ICU admitted; control: RSV- 
  * TBC: control should be only RSV- or also include RSV+ but not admitted to ICU? 
  * there are only 24 records with RSV+ and also admitted to ICU, might be too small sample size.
```{r warning=F}
tab.counter <- tab.counter + 1

# define case and control
df.unmatched <- df %>% 
  mutate(case_control = case_when(positive_rsv == 1 & icu_admitted == "yes" ~ 1,
                                  positive_rsv == 0 ~ 0)) %>%
  filter(!is.na(case_control))

regress_unmatch(df.ve = df.unmatched, adjusted = "no") %>% 
  mutate(across(ve_median: ve_ub, ~ round(.*100,1))) %>%
  mutate(VE.unadjusted = paste0(ve_median, " (", ve_lb, "-", ve_ub, ")")) %>%
  dplyr::select(VE.unadjusted) %>%
  cbind(
    regress_unmatch(df.ve = df.unmatched, adjusted = "yes") %>%
    mutate(across(ve_median: ve_ub, ~ round(.*100,1))) %>%
    mutate(VE.adjusted = paste0(ve_median, " (", ve_lb, "-", ve_ub, ")")) %>%
    mutate(n_overall = paste0(n_overall, " (", n_overall_eff, ")"),
           n_cases = paste0(n_cases, " (", n_cases_eff, ")"),
           n_controls = paste0(n_controls, " (", n_controls_eff, ")")) %>%
    dplyr::select(n_overall, n_cases, n_controls, VE.adjusted)
  ) %>% 
  dplyr::select(n_overall, n_cases, n_controls, VE.unadjusted, VE.adjusted) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T) 

```

<br>

#### Table `r tab.counter`. VE by severity (Case-only analyses) 
  * Only doing unstratified for now.
  * severe cases includes those admitted to ICU and those ordered highflow oxygen.
```{r warning=F}
tab.counter <- tab.counter + 1

## RSV+ & hospitalized vs. RSV+ unhospitalized
df.severity <- df %>% filter(positive_rsv == 1) %>% 
  filter(encounter_type != "inpatient_unrelated") %>%
  mutate(case_control = case_when(encounter_type == "inpatient" ~ 1,
                                  encounter_type == "outpatient" ~ 0))

ve.severity.hosp.unadj <- regress_unmatch(df.ve = df.severity, adjusted = "no") %>% 
  mutate(type = "RSV+ & hospitalized vs. RSV+ unhospitalized")
ve.severity.hosp.adj <- regress_unmatch(df.ve = df.severity, adjusted = "yes") %>%
  mutate(type = "RSV+ & hospitalized vs. RSV+ unhospitalized")


## RSV+ & severe vs. RSV+ mild
# (severe: admitted to ICU or highflow_oxygen == "yes)
df.severity <- df %>% filter(positive_rsv == 1) %>% 
  mutate(case_control = case_when(icu_admitted == "yes" | highflow_oxygen == 1 ~ 1,
                                  TRUE ~ 0))

ve.severity.severe.unadj <- regress_unmatch(df.ve = df.severity, adjusted = "no") %>%
  mutate(type = "RSV+ & severe vs. RSV+ & not severe")
ve.severity.severe.adj <- regress_unmatch(df.ve = df.severity, adjusted = "yes") %>%
  mutate(type = "RSV+ & severe vs. RSV+ & not severe")


# combine into one table
ve.unmatched.severity <- 
  # unadjusted ve
  rbind(
    ve.severity.hosp.unadj,
    ve.severity.severe.unadj
  ) %>%
  dplyr::select(ve_median, ve_lb, ve_ub, type) %>%
  mutate(across(ve_median:ve_ub, ~ round(. * 100, 1))) %>%
  mutate(VE.unadjusted = paste0(ve_median, " (", ve_lb, "-", ve_ub, ")")) %>%
  dplyr::select(-c(ve_median, ve_lb, ve_ub)) %>%
  left_join(
    rbind(
      ve.severity.hosp.adj,
      ve.severity.severe.adj
  ) %>%
  mutate(n_overall = paste0(n_overall, " (", n_overall_eff, ")"),
         n_cases = paste0(n_cases, " (", n_cases_eff, ")"),
         n_controls = paste0(n_controls, " (", n_controls_eff, ")")) %>%
  mutate(across(ve_median:ve_ub, ~ round(. * 100, 1))) %>%
  mutate(VE.adjusted = paste0(ve_median, " (", ve_lb, "-", ve_ub, ")")) %>%
  dplyr::select(-c(ve_median, ve_lb, ve_ub, n_overall_eff, n_cases_eff, n_controls_eff)),
  by = c("type")
  ) %>%
  dplyr::select(type, n_overall, n_cases, n_controls, VE.unadjusted, VE.adjusted)

ve.unmatched.severity %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T) 
```

#### Table `r tab.counter`. VE over time
```{r}
tab.counter <- tab.counter + 1

# classify time since mab to testing 
df <- df %>% 
  mutate(days_btw_mab_collection_cat = 
           case_when(days_btw_mab_collection < 0 & days_btw_mab_collection > -60 ~ "0-2 months", 
                     days_btw_mab_collection <= -60 & days_btw_mab_collection > -120 ~ "2-4 months",
                     days_btw_mab_collection <= -120 ~ "4 months +",
                     is.na(days_btw_mab_collection) | days_btw_mab_collection >= 0 ~ "no mAb"))

# define case control
df.wane <- df %>% mutate(case_control = positive_rsv)

# unadjusted
model <- glm(case_control ~ days_btw_mab_collection_cat, data = df.wane, family = "binomial")

summary(model)
```













