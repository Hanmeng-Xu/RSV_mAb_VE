---
title: "Waning VE of Nirsevimab"
output: 
  html_document:
    toc: true
    toc_float: true
---

#### Date: `r Sys.Date()`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(dplyr)
library(tidyr)
library(tidyverse)
library(readxl)
library(writexl)
library(reactable)
library(ggplot2)
library(stringr)
library(flextable)
library(lubridate)
library(rjags)


library(gtsummary) # for table 1
library(multcomp)
library(survival) # for matched case-control

fig.counter <- 1
tab.counter <- 1

source("utils_mAb_VE.R")
source("jags_waning.R")

rerun <- FALSE
```


```{r}
# read in dataset
df <- read.csv("../data/clean_data/df.mab.csv") %>% 
  mutate(collection_date = as.Date(collection_date))
colnames <- as.data.frame(colnames(df))

# add some variables 
df <- process_df(df)
```

<br>

#### Based on the preliminary results of waning of VE, look at Nirsevimab's time-varying effect against these outcomes:
  * RSV infection (case: RSV+; control: RSV-)
  * RSV-related LRTI (case: RSV+ LRTI; control: RSV-)

<br>

```{r}
df <- df %>% 
  # recode confounders
  mutate(cf_birth_weight = birth_weight) %>% # about 25% missing 
  mutate(cf_age = case_when(age_at_test_in_months_cat_2 == "under 3m" ~ 1,
                            age_at_test_in_months_cat_2 == "3-6m" ~ 2,
                            age_at_test_in_months_cat_2 == "6-9m" ~ 3,
                            age_at_test_in_months_cat_2 == "9-12m" ~ 4,
                            age_at_test_in_months_cat_2 == "above 1 yo" ~ 5)) %>%
  mutate(cf_month_tested = case_when(month_when_tested_cat == "Oct-Nov" ~ 1,
                                     month_when_tested_cat == "Dec-Jan" ~ 2,
                                     month_when_tested_cat == "Feb-Mar" ~ 3,
                                     month_when_tested_cat == "April and after" ~ 4
                                     )) %>%
  # convert confounders to dummy variables 
  mutate(cf_age_1 = ifelse(cf_age == 1, 1, 0),
         cf_age_2 = ifelse(cf_age == 2, 1, 0),
         cf_age_3 = ifelse(cf_age == 3, 1, 0),
         cf_age_4 = ifelse(cf_age == 4, 1, 0), 
         cf_age_5 = ifelse(cf_age == 5, 1, 0)) %>%
  mutate(cf_month_tested_1 = ifelse(cf_month_tested == 1, 1, 0),
         cf_month_tested_2 = ifelse(cf_month_tested == 2, 1, 0),
         cf_month_tested_3 = ifelse(cf_month_tested == 3, 1, 0),
         cf_month_tested_4 = ifelse(cf_month_tested == 4, 1, 0))
```

<br>

### VE over time {.tabset}

#### 2-month interval
  * classify time since vax to testing into three groups: 0-2 months, 2-4 months and >4 months
  * converged
```{r}
source("jags_waning.R")

###################################
# Against infection 
###################################
df.jags <- df %>% 
  # vax time groups 
  mutate(vax_time_group1 = ifelse(days_btw_mab_collection_cat == "0-2 months", 1, 0)) %>%
  mutate(vax_time_group2 = ifelse(days_btw_mab_collection_cat == "2-4 months", 1, 0)) %>%
  mutate(vax_time_group3 = ifelse(days_btw_mab_collection_cat == "4 months +", 1, 0)) %>%
  # define case and control
  mutate(case_control = positive_rsv)


# prepare the input dataset for jags 
dataset_2monthsinterval_infection <- 
            list(
                N_records = nrow(df.jags),
                vax = df.jags$rsv_mab,
                vax_time_group1 = df.jags$vax_time_group1,
                vax_time_group2 = df.jags$vax_time_group2,
                vax_time_group3 = df.jags$vax_time_group3,
                case_status = df.jags$case_control,
                # confounders
                # cf_birth_weight = df.jags$birth_weight,
                cf_age_1 = df.jags$cf_age_1, # age when tested
                cf_age_2 = df.jags$cf_age_2,
                cf_age_3 = df.jags$cf_age_3,
                cf_age_4 = df.jags$cf_age_4,
                cf_age_5 = df.jags$cf_age_5,
                cf_month_tested_1 = df.jags$cf_month_tested_1, # month when tested
                cf_month_tested_2 = df.jags$cf_month_tested_2,
                cf_month_tested_3 = df.jags$cf_month_tested_3,
                cf_month_tested_4 = df.jags$cf_month_tested_4
                )

source("jags_waning.R")

if(rerun){
  
  jags.post <- rjags::jags.model(textConnection(model_string_waning_2monthsinterval), 
                          data = dataset_2monthsinterval_infection,
                          n.chains = 3)

  samples <- rjags::coda.samples(jags.post, 
                          variable.names=c("beta1", "beta2", "beta3"),
                          n.iter = 5000)
  saveRDS(samples, "../data/jags/post/wane_2monthsinterval_infection.rds")

}else{
  samples <- readRDS("../data/jags/post/wane_2monthsinterval_infection.rds")
}

# look at traceplot 
# plot(samples[, "beta1"])
# title("beta1 (against infection)")
# plot(samples[, "beta2"])
# title("beta2 (against infection)")
# plot(samples[, "beta3"])
# title("beta3 (against infection)")


post1 <- as.data.frame(as.matrix(samples[[1]][-c(1:4500),]))  
post2 <- as.data.frame(as.matrix(samples[[2]][-c(1:4500),])) 
post3 <- as.data.frame(as.matrix(samples[[3]][-c(1:4500),])) 
post <- bind_rows(post1, post2, post3)

ve.median.0_2m <- round((1 - exp(median(post$beta1)))*100,1)
ve.lb.0_2m <- round((1 - exp(quantile(post$beta1, 0.975))) *100,1)
ve.ub.0_2m <- round((1 - exp(quantile(post$beta1, 0.025)))*100, 1)

ve.median.2_4m <- round((1 - exp(median(post$beta2)))*100,1)
ve.lb.2_4m <- round((1 - exp(quantile(post$beta2, 0.975))) *100,1)
ve.ub.2_4m <- round((1 - exp(quantile(post$beta2, 0.025)))*100, 1)

ve.median.4m <- round((1 - exp(median(post$beta3)))*100,1)
ve.lb.4m <- round((1 - exp(quantile(post$beta3, 0.975))) *100,1)
ve.ub.4m <- round((1 - exp(quantile(post$beta3, 0.025)))*100, 1)

# look at the result
ve.2monthsinterval.infection <- 
  data.frame(
  case_control = rep("RSV+ vs. RSV-", 4),
  vax_time = c("not vaccinated",
               "vaccinated 0-2 months ago",
               "vaccinated 2-4 months ago",
               "vaccinated 4+ months ago"),
  VE.adjusted = c(
    "REF",
    paste0(ve.median.0_2m, " (", ve.lb.0_2m, "-", ve.ub.0_2m, ")"),
    paste0(ve.median.2_4m, " (", ve.lb.2_4m, "-", ve.ub.2_4m, ")"),
    paste0(ve.median.4m, " (", ve.lb.4m, "-", ve.ub.4m, ")")
  )
) %>%
  cbind(
    table(df.jags$days_btw_mab_collection_cat, df.jags$case_control) %>%
      matrix(ncol = 2)
  ) %>%
  dplyr::rename(n_cases = `2`, n_controls = `1`)


# for plotting 
df.ve.2monthsinterval.infection <- 
  data.frame(
  case_control = rep("RSV+ vs. RSV-", 3),
  vax_time = c(
               "vaccinated 0-2 months ago",
               "vaccinated 2-4 months ago",
               "vaccinated 4+ months ago"),
  VE.median = c(ve.median.0_2m, ve.median.2_4m, ve.median.4m),
  VE.lb = c(ve.lb.0_2m, ve.lb.2_4m, ve.lb.4m),
  VE.ub = c(ve.ub.0_2m, ve.ub.2_4m, ve.ub.4m)
  )

  


###################################
# Against RSV+ LRTI
###################################
df.jags <- df %>% 
  # vax time groups 
  mutate(vax_time_group1 = ifelse(days_btw_mab_collection_cat == "0-2 months", 1, 0)) %>%
  mutate(vax_time_group2 = ifelse(days_btw_mab_collection_cat == "2-4 months", 1, 0)) %>%
  mutate(vax_time_group3 = ifelse(days_btw_mab_collection_cat == "4 months +", 1, 0)) %>%
  # define case and control
  filter(symp_LRT_distress == 1) %>%
  mutate(case_control = positive_rsv)
  

dataset_2monthsinterval_RSVLRTI <- 
            list(
                N_records = nrow(df.jags),
                vax = df.jags$rsv_mab,
                vax_time_group1 = df.jags$vax_time_group1,
                vax_time_group2 = df.jags$vax_time_group2,
                vax_time_group3 = df.jags$vax_time_group3,
                case_status = df.jags$case_control,
                # confounders
                # cf_birth_weight = df.jags$birth_weight,
                #cf_age = df.jags$cf_age, # age when tested
                #cf_month_tested = df.jags$cf_month_tested # month when tested
                cf_age_1 = df.jags$cf_age_1, # age when tested
                cf_age_2 = df.jags$cf_age_2,
                cf_age_3 = df.jags$cf_age_3,
                cf_age_4 = df.jags$cf_age_4,
                cf_age_5 = df.jags$cf_age_5,
                cf_month_tested_1 = df.jags$cf_month_tested_1, # month when tested
                cf_month_tested_2 = df.jags$cf_month_tested_2,
                cf_month_tested_3 = df.jags$cf_month_tested_3,
                cf_month_tested_4 = df.jags$cf_month_tested_4
                )

source("jags_waning.R")

if(rerun){
  
  jags.post <- rjags::jags.model(textConnection(model_string_waning_2monthsinterval), 
                          data = dataset_2monthsinterval_RSVLRTI,
                          n.chains = 3)

  samples <- rjags::coda.samples(jags.post, 
                          variable.names=c("beta1", "beta2", "beta3"),
                          n.iter = 5000)
  saveRDS(samples, "../data/jags/post/wane_2monthsinterval_RSVLRTI.rds")

}else{
  samples <- readRDS("../data/jags/post/wane_2monthsinterval_RSVLRTI.rds")
}


# look at traceplot 
# plot(samples[, "beta1"])
# title("beta1 (against RSV+ LRTI)")
# plot(samples[, "beta2"])
# title("beta2 (against RSV+ LRTI)")
# plot(samples[, "beta3"])
# title("beta3 (against RSV+ LRTI)")


post1 <- as.data.frame(as.matrix(samples[[1]][-c(1:4500),]))  
post2 <- as.data.frame(as.matrix(samples[[2]][-c(1:4500),])) 
post3 <- as.data.frame(as.matrix(samples[[3]][-c(1:4500),])) 
post <- bind_rows(post1, post2, post3)

ve.median.0_2m <- round((1 - exp(median(post$beta1)))*100,1)
ve.lb.0_2m <- round((1 - exp(quantile(post$beta1, 0.975))) *100,1)
ve.ub.0_2m <- round((1 - exp(quantile(post$beta1, 0.025)))*100, 1)

ve.median.2_4m <- round((1 - exp(median(post$beta2)))*100,1)
ve.lb.2_4m <- round((1 - exp(quantile(post$beta2, 0.975))) *100,1)
ve.ub.2_4m <- round((1 - exp(quantile(post$beta2, 0.025)))*100, 1)

ve.median.4m <- round((1 - exp(median(post$beta3)))*100,1)
ve.lb.4m <- round((1 - exp(quantile(post$beta3, 0.975))) *100,1)
ve.ub.4m <- round((1 - exp(quantile(post$beta3, 0.025)))*100, 1)

# look at the result
ve.2monthsinterval.RSVLRTI <- 
  data.frame(
    case_control = rep("RSV+ LRTI vs. RSV-", 4),
    vax_time = c("not vaccinated",
                  "vaccinated 0-2 months ago",
                  "vaccinated 2-4 months ago",
                 "vaccinated 4+ months ago"),
    VE.adjusted = c(
      "REF",
      paste0(ve.median.0_2m, " (", ve.lb.0_2m, "-", ve.ub.0_2m, ")"),
      paste0(ve.median.2_4m, " (", ve.lb.2_4m, "-", ve.ub.2_4m, ")"),
      paste0(ve.median.4m, " (", ve.lb.4m, "-", ve.ub.4m, ")")
  )
) %>%
  cbind(
    table(df.jags$days_btw_mab_collection_cat, df.jags$case_control) %>%
      matrix(ncol = 2)
  ) %>%
  dplyr::rename(n_cases = `2`, n_controls = `1`)


# for plotting 
df.ve.2monthsinterval.RSVLRTI <- 
  data.frame(
  case_control = rep("RSV+ LRTI vs. RSV-", 3),
  vax_time = c(
               "vaccinated 0-2 months ago",
               "vaccinated 2-4 months ago",
               "vaccinated 4+ months ago"),
  VE.median = c(ve.median.0_2m, ve.median.2_4m, ve.median.4m),
  VE.lb = c(ve.lb.0_2m, ve.lb.2_4m, ve.lb.4m),
  VE.ub = c(ve.ub.0_2m, ve.ub.2_4m, ve.ub.4m)
  )


###################################
# Against RSV+ hospitalizations
###################################
df.jags <- df %>% 
  # vax time groups 
  mutate(vax_time_group1 = ifelse(days_btw_mab_collection_cat == "0-2 months", 1, 0)) %>%
  mutate(vax_time_group2 = ifelse(days_btw_mab_collection_cat == "2-4 months", 1, 0)) %>%
  mutate(vax_time_group3 = ifelse(days_btw_mab_collection_cat == "4 months +", 1, 0)) %>%
  # define case and control
  filter(encounter_type == "inpatient") %>%
  mutate(case_control = positive_rsv)
  

dataset_2monthsinterval_RSVhosp <- 
            list(
                N_records = nrow(df.jags),
                vax = df.jags$rsv_mab,
                vax_time_group1 = df.jags$vax_time_group1,
                vax_time_group2 = df.jags$vax_time_group2,
                vax_time_group3 = df.jags$vax_time_group3,
                case_status = df.jags$case_control,
                # confounders
                # cf_birth_weight = df.jags$birth_weight,
                #cf_age = df.jags$cf_age, # age when tested
                #cf_month_tested = df.jags$cf_month_tested # month when tested
                cf_age_1 = df.jags$cf_age_1, # age when tested
                cf_age_2 = df.jags$cf_age_2,
                cf_age_3 = df.jags$cf_age_3,
                cf_age_4 = df.jags$cf_age_4,
                cf_age_5 = df.jags$cf_age_5,
                cf_month_tested_1 = df.jags$cf_month_tested_1, # month when tested
                cf_month_tested_2 = df.jags$cf_month_tested_2,
                cf_month_tested_3 = df.jags$cf_month_tested_3,
                cf_month_tested_4 = df.jags$cf_month_tested_4
                )

source("jags_waning.R")

if(rerun){
  
  jags.post <- rjags::jags.model(textConnection(model_string_waning_2monthsinterval), 
                          data = dataset_2monthsinterval_RSVhosp,
                          n.chains = 3)

  samples <- rjags::coda.samples(jags.post, 
                          variable.names=c("beta1", "beta2", "beta3"),
                          n.iter = 5000)
  saveRDS(samples, "../data/jags/post/wane_2monthsinterval_RSVhosp.rds")

}else{
  samples <- readRDS("../data/jags/post/wane_2monthsinterval_RSVhosp.rds")
}


# look at traceplot 
# plot(samples[, "beta1"])
# title("beta1 (against RSV+ LRTI)")
# plot(samples[, "beta2"])
# title("beta2 (against RSV+ LRTI)")
# plot(samples[, "beta3"])
# title("beta3 (against RSV+ LRTI)")


post1 <- as.data.frame(as.matrix(samples[[1]][-c(1:4500),]))  
post2 <- as.data.frame(as.matrix(samples[[2]][-c(1:4500),])) 
post3 <- as.data.frame(as.matrix(samples[[3]][-c(1:4500),])) 
post <- bind_rows(post1, post2, post3)

ve.median.0_2m <- round((1 - exp(median(post$beta1)))*100,1)
ve.lb.0_2m <- round((1 - exp(quantile(post$beta1, 0.975))) *100,1)
ve.ub.0_2m <- round((1 - exp(quantile(post$beta1, 0.025)))*100, 1)

ve.median.2_4m <- round((1 - exp(median(post$beta2)))*100,1)
ve.lb.2_4m <- round((1 - exp(quantile(post$beta2, 0.975))) *100,1)
ve.ub.2_4m <- round((1 - exp(quantile(post$beta2, 0.025)))*100, 1)

ve.median.4m <- round((1 - exp(median(post$beta3)))*100,1)
ve.lb.4m <- round((1 - exp(quantile(post$beta3, 0.975))) *100,1)
ve.ub.4m <- round((1 - exp(quantile(post$beta3, 0.025)))*100, 1)

# look at the result
ve.2monthsinterval.RSVhosp <- 
  data.frame(
    case_control = rep("RSV+ hospitalizations vs. RSV-", 4),
    vax_time = c("not vaccinated",
                  "vaccinated 0-2 months ago",
                  "vaccinated 2-4 months ago",
                 "vaccinated 4+ months ago"),
    VE.adjusted = c(
      "REF",
      paste0(ve.median.0_2m, " (", ve.lb.0_2m, "-", ve.ub.0_2m, ")"),
      paste0(ve.median.2_4m, " (", ve.lb.2_4m, "-", ve.ub.2_4m, ")"),
      paste0(ve.median.4m, " (", ve.lb.4m, "-", ve.ub.4m, ")")
  )
) %>%
  cbind(
    table(df.jags$days_btw_mab_collection_cat, df.jags$case_control) %>%
      matrix(ncol = 2)
  ) %>%
  dplyr::rename(n_cases = `2`, n_controls = `1`)


# for plotting 
df.ve.2monthsinterval.RSVhosp <- 
  data.frame(
  case_control = rep("RSV+ hospitalizations vs. RSV-", 3),
  vax_time = c(
               "vaccinated 0-2 months ago",
               "vaccinated 2-4 months ago",
               "vaccinated 4+ months ago"),
  VE.median = c(ve.median.0_2m, ve.median.2_4m, ve.median.4m),
  VE.lb = c(ve.lb.0_2m, ve.lb.2_4m, ve.lb.4m),
  VE.ub = c(ve.ub.0_2m, ve.ub.2_4m, ve.ub.4m)
  )

# look at all the results with 2-month interval
ve.2monthsinterval.infection %>%
  rbind(ve.2monthsinterval.RSVLRTI, 
        ve.2monthsinterval.RSVhosp) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, groupBy = "case_control") 
```

#### 2-month interval (figure, showing full CI) 
```{r fig.width = 8, fig.height = 4}
df.plt.wane <- 
  df.ve.2monthsinterval.infection %>%
  rbind(df.ve.2monthsinterval.RSVLRTI, 
        df.ve.2monthsinterval.RSVhosp) %>% 
  mutate(time_since_vax = case_when(vax_time == "vaccinated 0-2 months ago" ~ "0-2 months",
                                    vax_time == "vaccinated 2-4 months ago" ~ "3-4 months", 
                                    vax_time == "vaccinated 4+ months ago" ~ "after 4 months")) %>%
  mutate(VE = paste0(round(VE.median), " (", round(VE.lb), ", ", round(VE.ub), ")")) %>% 
  mutate(time_since_vax = factor(time_since_vax, levels = c("0-2 months", "3-4 months", "after 4 months"))) %>% 
  mutate(case_control = case_when(case_control == "RSV+ vs. RSV-" ~ "Against RSV infection",
                                  case_control == "RSV+ LRTI vs. RSV-" ~ "Against RSV LRTI",
                                  case_control == "RSV+ hospitalizations vs. RSV-" ~ "Against RSV hospitalizations")) %>%
  mutate(case_control = factor(case_control, levels = c("Against RSV infection",
                                                        "Against RSV LRTI",
                                                        "Against RSV hospitalizations")))

df.plt.wane %>%
  ggplot() +
  geom_point(aes(x = time_since_vax, y = VE.median, color = case_control), 
             position = position_dodge(0.5)) +
  geom_errorbar(aes(x = time_since_vax, ymin = VE.lb, ymax = VE.ub, color = case_control), 
                width = 0, position = position_dodge(0.5)) +
  geom_text(aes(x = time_since_vax, y = VE.median , color = case_control, label = VE), 
            angle = 90, position = position_dodge(0.5), vjust = - 0.7, show_guide = F,
            size = 3) +
  theme_classic() +
  scale_color_brewer(palette = "Dark2") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ylab("Effectiveness of Nirsevimab (%)") +
  xlab("Time since vaccination") +
  labs(color = "Clinical endpoint") 
  

```

#### 2-month interval (figure, showing partial CI) 
```{r fig.width = 8, fig.height = 4}
df.no.arrow <- 
  df.plt.wane %>%
  mutate(add_arrow = ifelse(VE.lb < -20, 1, 0)) %>%
  mutate(VE.lb = ifelse(add_arrow == 1, -20, VE.lb)) %>% 
  mutate(across(starts_with("VE"), ~ ifelse(add_arrow == 1, NA, .)))

df.add.arrow <- 
  df.plt.wane %>%
  mutate(add_arrow = ifelse(VE.lb < -20, 1, 0)) %>%
  mutate(VE.lb = ifelse(add_arrow == 1, -20, VE.lb)) %>% 
  mutate(across(starts_with("VE"), ~ ifelse(add_arrow != 1, NA, .)))

# adjusted arrows to parallel
# https://stackoverflow.com/questions/67853990/geom-segment-parallel-dodging
space_between_bars <- 0.145
df.add.arrow$case_control_x_adj = scale(as.numeric(as.factor(df.add.arrow$case_control))) * space_between_bars
df.add.arrow$x = as.numeric(as.factor(df.add.arrow$time_since_vax)) + df.add.arrow$case_control_x_adj


ggplot() +
  # if lb > -20
  geom_point(aes(x = time_since_vax, y = VE.median, color = case_control), 
             position = position_dodge(0.5), data = df.no.arrow) +
  geom_errorbar(aes(x = time_since_vax, ymin = VE.lb, ymax = VE.ub, color = case_control), 
                width = 0, position = position_dodge(0.5), data = df.no.arrow) +
  geom_text(aes(x = time_since_vax, y = VE.median, color = case_control, label = VE), 
            angle = 90, position = position_dodge(0.5), vjust = - 0.7, show_guide = F,
            size = 3, data = df.no.arrow) +
  # if lb < -20
  geom_point(aes(x = time_since_vax, y = VE.median, color = case_control), 
             position = position_dodge(0.5), data = df.add.arrow) +
  geom_segment(aes(x = x, xend = x, 
                   y = VE.ub, yend = VE.lb, color = case_control),
               arrow = arrow(length = unit(2, "mm")),
               position = position_dodge(0.5),
               data = df.add.arrow, show_guide = F) +
  geom_text(aes(x = time_since_vax, y = (VE.ub+50)/2, color = case_control, label = VE), 
            angle = 90, position = position_dodge(0.5), vjust = - 0.7, show_guide = F,
            size = 3, data = df.add.arrow) +
  theme_classic() +
  scale_color_brewer(palette = "Dark2") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ylab("Effectiveness of Nirsevimab (%)") +
  xlab("Time since vaccination") +
  labs(color = "Clinical endpoint") +
  ylim(c(-25, 100))
```


#### 1-month interval
  * classify time since vax to testing into three groups: 0-1, 1-2, 2-3, 3-4 and >4 months
```{r}
source("jags_waning.R")

###################################
# Against RSV infection 
###################################

# prepare the input dataset for jags 
df.jags <- df %>% 
  # vax time groups 
  mutate(vax_time_group1 = ifelse(days_btw_mab_collection_cat_3 == "0-1 months", 1, 0)) %>%
  mutate(vax_time_group2 = ifelse(days_btw_mab_collection_cat_3 == "1-2 months", 1, 0)) %>%
  mutate(vax_time_group3 = ifelse(days_btw_mab_collection_cat_3 == "2-3 months", 1, 0)) %>%
  mutate(vax_time_group4 = ifelse(days_btw_mab_collection_cat_3 == "3-4 months", 1, 0)) %>%
  mutate(vax_time_group5 = ifelse(days_btw_mab_collection_cat_3 == "4 months +", 1, 0)) %>%
  # define case and control
  mutate(case_control = positive_rsv)
  

dataset_1monthinterval_infection <- 
            list(
                N_records = nrow(df.jags),
                vax = df.jags$rsv_mab,
                vax_time_group1 = df.jags$vax_time_group1,
                vax_time_group2 = df.jags$vax_time_group2,
                vax_time_group3 = df.jags$vax_time_group3,
                vax_time_group4 = df.jags$vax_time_group4,
                vax_time_group5 = df.jags$vax_time_group5,
                case_status = df.jags$case_control,
                # confounders
                # cf_birth_weight = df.jags$birth_weight,
                #cf_age = df.jags$cf_age, # age when tested
                #cf_month_tested = df.jags$cf_month_tested # month when tested
                cf_age_1 = df.jags$cf_age_1, # age when tested
                cf_age_2 = df.jags$cf_age_2,
                cf_age_3 = df.jags$cf_age_3,
                cf_age_4 = df.jags$cf_age_4,
                cf_age_5 = df.jags$cf_age_5,
                cf_month_tested_1 = df.jags$cf_month_tested_1, # month when tested
                cf_month_tested_2 = df.jags$cf_month_tested_2,
                cf_month_tested_3 = df.jags$cf_month_tested_3,
                cf_month_tested_4 = df.jags$cf_month_tested_4
                )

source("jags_waning.R")

if(rerun){
  
  jags.post <- rjags::jags.model(textConnection(model_string_waning_1monthinterval), 
                          data = dataset_1monthinterval_infection,
                          n.chains = 3)

  samples <- rjags::coda.samples(jags.post, 
                          variable.names=c("beta1", "beta2", "beta3", "beta4", "beta5"),
                          n.iter = 5000)
  saveRDS(samples, "../data/jags/post/wane_1monthinterval_infection.rds")

}else{
  samples <- readRDS("../data/jags/post/wane_1monthinterval_infection.rds")
}

post1 <- as.data.frame(as.matrix(samples[[1]][-c(1:4500),]))  
post2 <- as.data.frame(as.matrix(samples[[2]][-c(1:4500),])) 
post3 <- as.data.frame(as.matrix(samples[[3]][-c(1:4500),])) 
post <- bind_rows(post1, post2, post3)

ve.median.0_1m <- round((1 - exp(median(post$beta1)))*100,1)
ve.lb.0_1m <- round((1 - exp(quantile(post$beta1, 0.975))) *100,1)
ve.ub.0_1m <- round((1 - exp(quantile(post$beta1, 0.025)))*100, 1)

ve.median.1_2m <- round((1 - exp(median(post$beta2)))*100,1)
ve.lb.1_2m <- round((1 - exp(quantile(post$beta2, 0.975))) *100,1)
ve.ub.1_2m <- round((1 - exp(quantile(post$beta2, 0.025)))*100, 1)

ve.median.2_3m <- round((1 - exp(median(post$beta3)))*100,1)
ve.lb.2_3m <- round((1 - exp(quantile(post$beta3, 0.975))) *100,1)
ve.ub.2_3m <- round((1 - exp(quantile(post$beta3, 0.025)))*100, 1)

ve.median.3_4m <- round((1 - exp(median(post$beta4)))*100,1)
ve.lb.3_4m <- round((1 - exp(quantile(post$beta4, 0.975))) *100,1)
ve.ub.3_4m <- round((1 - exp(quantile(post$beta4, 0.025)))*100, 1)

ve.median.4m <- round((1 - exp(median(post$beta5)))*100,1)
ve.lb.4m <- round((1 - exp(quantile(post$beta5, 0.975))) *100,1)
ve.ub.4m <- round((1 - exp(quantile(post$beta5, 0.025)))*100, 1)

# look at the result
ve.1monthinterval.infection <- 
  data.frame(
  case_control = rep("RSV+ vs. RSV-", 6),
  vax_time = c("not vaccinated",
               "vaccinated 0-1 months ago",
               "vaccinated 1-2 months ago",
               "vaccinated 2-3 months ago",
               "vaccinated 3-4 months ago",
               "vaccinated 4+ months ago"),
  VE.adjusted = c(
    "REF",
    paste0(ve.median.0_1m, " (", ve.lb.0_1m, "-", ve.ub.0_1m, ")"),
    paste0(ve.median.1_2m, " (", ve.lb.1_2m, "-", ve.ub.1_2m, ")"),
    paste0(ve.median.2_3m, " (", ve.lb.2_3m, "-", ve.ub.2_3m, ")"),
    paste0(ve.median.3_4m, " (", ve.lb.3_4m, "-", ve.ub.3_4m, ")"),
    paste0(ve.median.4m, " (", ve.lb.4m, "-", ve.ub.4m, ")")
  )
) %>% 
  cbind(
    table(df.jags$days_btw_mab_collection_cat_3, df.jags$case_control) %>%
      matrix(ncol = 2)
  ) %>%
  dplyr::rename(n_cases = `2`, n_controls = `1`)
  
# for plotting 
df.ve.1monthinterval.infection <- 
  data.frame(
  case_control = rep("RSV+ vs. RSV-", 5),
  vax_time = c(
               "vaccinated 0-1 months ago",
               "vaccinated 1-2 months ago",
               "vaccinated 2-3 months ago",
               "vaccinated 3-4 months ago",
               "vaccinated 4+ months ago"),
  VE.median = c(ve.median.0_1m, ve.median.1_2m, ve.median.2_3m, ve.median.3_4m, ve.median.4m),
  VE.lb = c(ve.lb.0_1m, ve.lb.1_2m, ve.lb.2_3m, ve.lb.3_4m, ve.lb.4m),
  VE.ub = c(ve.ub.0_1m, ve.ub.1_2m, ve.ub.2_3m, ve.ub.3_4m, ve.ub.4m)
  )



# 
# plot(samples[, "beta1"])
# title("beta1")
# plot(samples[, "beta2"])
# title("beta2")
# plot(samples[, "beta3"])
# title("beta3")
# plot(samples[, "beta4"])
# title("beta4")
# plot(samples[, "beta5"])
# title("beta5")


###################################
# Against RSV LRTI
###################################

# prepare the input dataset for jags 
df.jags <- df %>% 
  # vax time groups 
  mutate(vax_time_group1 = ifelse(days_btw_mab_collection_cat_3 == "0-1 months", 1, 0)) %>%
  mutate(vax_time_group2 = ifelse(days_btw_mab_collection_cat_3 == "1-2 months", 1, 0)) %>%
  mutate(vax_time_group3 = ifelse(days_btw_mab_collection_cat_3 == "2-3 months", 1, 0)) %>%
  mutate(vax_time_group4 = ifelse(days_btw_mab_collection_cat_3 == "3-4 months", 1, 0)) %>%
  mutate(vax_time_group5 = ifelse(days_btw_mab_collection_cat_3 == "4 months +", 1, 0)) %>%
  # define case and control
  mutate(case_control = case_when(positive_rsv ==1 & symp_LRT_distress == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))
  

dataset_1monthinterval_RSVLRTI <- 
            list(
                N_records = nrow(df.jags),
                vax = df.jags$rsv_mab,
                vax_time_group1 = df.jags$vax_time_group1,
                vax_time_group2 = df.jags$vax_time_group2,
                vax_time_group3 = df.jags$vax_time_group3,
                vax_time_group4 = df.jags$vax_time_group4,
                vax_time_group5 = df.jags$vax_time_group5,
                case_status = df.jags$case_control,
                # confounders
                # cf_birth_weight = df.jags$birth_weight,
                #cf_age = df.jags$cf_age, # age when tested
                #cf_month_tested = df.jags$cf_month_tested # month when tested
                cf_age_1 = df.jags$cf_age_1, # age when tested
                cf_age_2 = df.jags$cf_age_2,
                cf_age_3 = df.jags$cf_age_3,
                cf_age_4 = df.jags$cf_age_4,
                cf_age_5 = df.jags$cf_age_5,
                cf_month_tested_1 = df.jags$cf_month_tested_1, # month when tested
                cf_month_tested_2 = df.jags$cf_month_tested_2,
                cf_month_tested_3 = df.jags$cf_month_tested_3,
                cf_month_tested_4 = df.jags$cf_month_tested_4
                )

source("jags_waning.R")

if(rerun){
  
  jags.post <- rjags::jags.model(textConnection(model_string_waning_1monthinterval), 
                          data = dataset_1monthinterval_RSVLRTI,
                          n.chains = 3)

  samples <- rjags::coda.samples(jags.post, 
                          variable.names=c("beta1", "beta2", "beta3", "beta4", "beta5"),
                          n.iter = 5000)
  saveRDS(samples, "../data/jags/post/wane_1monthinterval_RSVLRTI.rds")

}else{
  samples <- readRDS("../data/jags/post/wane_1monthinterval_RSVLRTI.rds")
}

post1 <- as.data.frame(as.matrix(samples[[1]][-c(1:4500),]))  
post2 <- as.data.frame(as.matrix(samples[[2]][-c(1:4500),])) 
post3 <- as.data.frame(as.matrix(samples[[3]][-c(1:4500),])) 
post <- bind_rows(post1, post2, post3)

ve.median.0_1m <- round((1 - exp(median(post$beta1)))*100,1)
ve.lb.0_1m <- round((1 - exp(quantile(post$beta1, 0.975))) *100,1)
ve.ub.0_1m <- round((1 - exp(quantile(post$beta1, 0.025)))*100, 1)

ve.median.1_2m <- round((1 - exp(median(post$beta2)))*100,1)
ve.lb.1_2m <- round((1 - exp(quantile(post$beta2, 0.975))) *100,1)
ve.ub.1_2m <- round((1 - exp(quantile(post$beta2, 0.025)))*100, 1)

ve.median.2_3m <- round((1 - exp(median(post$beta3)))*100,1)
ve.lb.2_3m <- round((1 - exp(quantile(post$beta3, 0.975))) *100,1)
ve.ub.2_3m <- round((1 - exp(quantile(post$beta3, 0.025)))*100, 1)

ve.median.3_4m <- round((1 - exp(median(post$beta4)))*100,1)
ve.lb.3_4m <- round((1 - exp(quantile(post$beta4, 0.975))) *100,1)
ve.ub.3_4m <- round((1 - exp(quantile(post$beta4, 0.025)))*100, 1)

ve.median.4m <- round((1 - exp(median(post$beta5)))*100,1)
ve.lb.4m <- round((1 - exp(quantile(post$beta5, 0.975))) *100,1)
ve.ub.4m <- round((1 - exp(quantile(post$beta5, 0.025)))*100, 1)

# look at the result
ve.1monthinterval.RSVLRTI <- 
  data.frame(
  case_control = rep("RSV+ LRTI vs. RSV-", 6),
  vax_time = c("not vaccinated",
               "vaccinated 0-1 months ago",
               "vaccinated 1-2 months ago",
               "vaccinated 2-3 months ago",
               "vaccinated 3-4 months ago",
               "vaccinated 4+ months ago"),
  VE.adjusted = c(
    "REF",
    paste0(ve.median.0_1m, " (", ve.lb.0_1m, "-", ve.ub.0_1m, ")"),
    paste0(ve.median.1_2m, " (", ve.lb.1_2m, "-", ve.ub.1_2m, ")"),
    paste0(ve.median.2_3m, " (", ve.lb.2_3m, "-", ve.ub.2_3m, ")"),
    paste0(ve.median.3_4m, " (", ve.lb.3_4m, "-", ve.ub.3_4m, ")"),
    paste0(ve.median.4m, " (", ve.lb.4m, "-", ve.ub.4m, ")")
  )
) %>% 
  cbind(
    table(df.jags$days_btw_mab_collection_cat_3, df.jags$case_control) %>%
      matrix(ncol = 2)
  ) %>%
  dplyr::rename(n_cases = `2`, n_controls = `1`)
  

# for plotting 
df.ve.1monthinterval.RSVLRTI <- 
  data.frame(
  case_control = rep("RSV+ LRTI vs. RSV-", 5),
  vax_time = c(
               "vaccinated 0-1 months ago",
               "vaccinated 1-2 months ago",
               "vaccinated 2-3 months ago",
               "vaccinated 3-4 months ago",
               "vaccinated 4+ months ago"),
  VE.median = c(ve.median.0_1m, ve.median.1_2m, ve.median.2_3m, ve.median.3_4m, ve.median.4m),
  VE.lb = c(ve.lb.0_1m, ve.lb.1_2m, ve.lb.2_3m, ve.lb.3_4m, ve.lb.4m),
  VE.ub = c(ve.ub.0_1m, ve.ub.1_2m, ve.ub.2_3m, ve.ub.3_4m, ve.ub.4m)
  )




###################################
# Against RSV hosp
###################################

# prepare the input dataset for jags 
df.jags <- df %>% 
  # vax time groups 
  mutate(vax_time_group1 = ifelse(days_btw_mab_collection_cat_3 == "0-1 months", 1, 0)) %>%
  mutate(vax_time_group2 = ifelse(days_btw_mab_collection_cat_3 == "1-2 months", 1, 0)) %>%
  mutate(vax_time_group3 = ifelse(days_btw_mab_collection_cat_3 == "2-3 months", 1, 0)) %>%
  mutate(vax_time_group4 = ifelse(days_btw_mab_collection_cat_3 == "3-4 months", 1, 0)) %>%
  mutate(vax_time_group5 = ifelse(days_btw_mab_collection_cat_3 == "4 months +", 1, 0)) %>%
  # define case and control
  mutate(case_control = case_when(positive_rsv == 1 & encounter_type == "inpatient" ~ 1,
                                  positive_rsv == 0 ~ 0))
  

dataset_1monthinterval_RSVhosp <- 
            list(
                N_records = nrow(df.jags),
                vax = df.jags$rsv_mab,
                vax_time_group1 = df.jags$vax_time_group1,
                vax_time_group2 = df.jags$vax_time_group2,
                vax_time_group3 = df.jags$vax_time_group3,
                vax_time_group4 = df.jags$vax_time_group4,
                vax_time_group5 = df.jags$vax_time_group5,
                case_status = df.jags$case_control,
                # confounders
                # cf_birth_weight = df.jags$birth_weight,
                #cf_age = df.jags$cf_age, # age when tested
                #cf_month_tested = df.jags$cf_month_tested # month when tested
                cf_age_1 = df.jags$cf_age_1, # age when tested
                cf_age_2 = df.jags$cf_age_2,
                cf_age_3 = df.jags$cf_age_3,
                cf_age_4 = df.jags$cf_age_4,
                cf_age_5 = df.jags$cf_age_5,
                cf_month_tested_1 = df.jags$cf_month_tested_1, # month when tested
                cf_month_tested_2 = df.jags$cf_month_tested_2,
                cf_month_tested_3 = df.jags$cf_month_tested_3,
                cf_month_tested_4 = df.jags$cf_month_tested_4
                )

source("jags_waning.R")

if(rerun){
  
  jags.post <- rjags::jags.model(textConnection(model_string_waning_1monthinterval), 
                          data = dataset_1monthinterval_RSVhosp,
                          n.chains = 3)

  samples <- rjags::coda.samples(jags.post, 
                          variable.names=c("beta1", "beta2", "beta3", "beta4", "beta5"),
                          n.iter = 5000)
  saveRDS(samples, "../data/jags/post/wane_1monthinterval_RSVhosp.rds")

}else{
  samples <- readRDS("../data/jags/post/wane_1monthinterval_RSVhosp.rds")
}

post1 <- as.data.frame(as.matrix(samples[[1]][-c(1:4500),]))  
post2 <- as.data.frame(as.matrix(samples[[2]][-c(1:4500),])) 
post3 <- as.data.frame(as.matrix(samples[[3]][-c(1:4500),])) 
post <- bind_rows(post1, post2, post3)

ve.median.0_1m <- round((1 - exp(median(post$beta1)))*100,1)
ve.lb.0_1m <- round((1 - exp(quantile(post$beta1, 0.975))) *100,1)
ve.ub.0_1m <- round((1 - exp(quantile(post$beta1, 0.025)))*100, 1)

ve.median.1_2m <- round((1 - exp(median(post$beta2)))*100,1)
ve.lb.1_2m <- round((1 - exp(quantile(post$beta2, 0.975))) *100,1)
ve.ub.1_2m <- round((1 - exp(quantile(post$beta2, 0.025)))*100, 1)

ve.median.2_3m <- round((1 - exp(median(post$beta3)))*100,1)
ve.lb.2_3m <- round((1 - exp(quantile(post$beta3, 0.975))) *100,1)
ve.ub.2_3m <- round((1 - exp(quantile(post$beta3, 0.025)))*100, 1)

ve.median.3_4m <- round((1 - exp(median(post$beta4)))*100,1)
ve.lb.3_4m <- round((1 - exp(quantile(post$beta4, 0.975))) *100,1)
ve.ub.3_4m <- round((1 - exp(quantile(post$beta4, 0.025)))*100, 1)

ve.median.4m <- round((1 - exp(median(post$beta5)))*100,1)
ve.lb.4m <- round((1 - exp(quantile(post$beta5, 0.975))) *100,1)
ve.ub.4m <- round((1 - exp(quantile(post$beta5, 0.025)))*100, 1)

# look at the result
ve.1monthinterval.RSVhosp <- 
  data.frame(
  case_control = rep("RSV+ hospitalizations vs. RSV-", 6),
  vax_time = c("not vaccinated",
               "vaccinated 0-1 months ago",
               "vaccinated 1-2 months ago",
               "vaccinated 2-3 months ago",
               "vaccinated 3-4 months ago",
               "vaccinated 4+ months ago"),
  VE.adjusted = c(
    "REF",
    paste0(ve.median.0_1m, " (", ve.lb.0_1m, "-", ve.ub.0_1m, ")"),
    paste0(ve.median.1_2m, " (", ve.lb.1_2m, "-", ve.ub.1_2m, ")"),
    paste0(ve.median.2_3m, " (", ve.lb.2_3m, "-", ve.ub.2_3m, ")"),
    paste0(ve.median.3_4m, " (", ve.lb.3_4m, "-", ve.ub.3_4m, ")"),
    paste0(ve.median.4m, " (", ve.lb.4m, "-", ve.ub.4m, ")")
  )
) %>% 
  cbind(
    table(df.jags$days_btw_mab_collection_cat_3, df.jags$case_control) %>%
      matrix(ncol = 2)
  ) %>%
  dplyr::rename(n_cases = `2`, n_controls = `1`)

# for plotting 
df.ve.1monthinterval.RSVhosp <- 
  data.frame(
  case_control = rep("RSV+ hospitalizations vs. RSV-", 5),
  vax_time = c(
               "vaccinated 0-1 months ago",
               "vaccinated 1-2 months ago",
               "vaccinated 2-3 months ago",
               "vaccinated 3-4 months ago",
               "vaccinated 4+ months ago"),
  VE.median = c(ve.median.0_1m, ve.median.1_2m, ve.median.2_3m, ve.median.3_4m, ve.median.4m),
  VE.lb = c(ve.lb.0_1m, ve.lb.1_2m, ve.lb.2_3m, ve.lb.3_4m, ve.lb.4m),
  VE.ub = c(ve.ub.0_1m, ve.ub.1_2m, ve.ub.2_3m, ve.ub.3_4m, ve.ub.4m)
  )


  

# look at all the results with 2-month interval
ve.1monthinterval.infection %>%
  rbind(ve.1monthinterval.RSVLRTI, 
        ve.1monthinterval.RSVhosp) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, groupBy = "case_control") 
```

#### 1-month interval (figure, showing full CI) 
```{r fig.width = 9, fig.height = 4}
df.plt.wane <- 
  df.ve.1monthinterval.infection %>%
  rbind(df.ve.1monthinterval.RSVLRTI, 
        df.ve.1monthinterval.RSVhosp) %>% 
  mutate(time_since_vax = case_when(
                                    vax_time == "vaccinated 0-1 months ago" ~ "1 month",
                                    vax_time == "vaccinated 1-2 months ago" ~ "2 months", 
                                    vax_time == "vaccinated 2-3 months ago" ~ "3 months", 
                                    vax_time == "vaccinated 3-4 months ago" ~ "4 months", 
                                    vax_time == "vaccinated 4+ months ago" ~ "after 4 months")) %>%
  mutate(VE = paste0(round(VE.median), " (", round(VE.lb), ", ", round(VE.ub), ")")) %>% 
  mutate(time_since_vax = factor(time_since_vax, levels = c("1 month", "2 months","3 months","4 months", "after 4 months"))) %>% 
  mutate(case_control = case_when(case_control == "RSV+ vs. RSV-" ~ "Against RSV infection",
                                  case_control == "RSV+ LRTI vs. RSV-" ~ "Against RSV LRTI",
                                  case_control == "RSV+ hospitalizations vs. RSV-" ~ "Against RSV hospitalizations")) %>%
  mutate(case_control = factor(case_control, levels = c("Against RSV infection",
                                                        "Against RSV LRTI",
                                                        "Against RSV hospitalizations")))

df.plt.wane %>%
  ggplot() +
  geom_point(aes(x = time_since_vax, y = VE.median, color = case_control), 
             position = position_dodge(0.5)) +
  geom_errorbar(aes(x = time_since_vax, ymin = VE.lb, ymax = VE.ub, color = case_control), 
                width = 0, position = position_dodge(0.5)) +
  geom_text(aes(x = time_since_vax, y = VE.median, color = case_control, label = VE), 
            angle = 90, position = position_dodge(0.5), vjust = - 0.7, show_guide = F,
            size = 3) +
  theme_classic() +
  scale_color_brewer(palette = "Dark2") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ylab("Effectiveness of Nirsevimab (%)") +
  xlab("Time since vaccination") +
  labs(color = "Clinical endpoint")

```

#### 1-month interval (figure, showing partial CI) 
```{r fig.width = 9, fig.height = 4}
df.no.arrow <- 
  df.plt.wane %>%
  mutate(add_arrow = ifelse(VE.lb < -20, 1, 0)) %>%
  mutate(VE.lb = ifelse(add_arrow == 1, -20, VE.lb)) %>% 
  mutate(across(starts_with("VE"), ~ ifelse(add_arrow == 1, NA, .)))

df.add.arrow <- 
  df.plt.wane %>%
  mutate(add_arrow = ifelse(VE.lb < -20, 1, 0)) %>%
  mutate(VE.lb = ifelse(add_arrow == 1, -20, VE.lb)) %>% 
  mutate(across(starts_with("VE"), ~ ifelse(add_arrow != 1, NA, .)))

# adjusted arrows to parallel
# https://stackoverflow.com/questions/67853990/geom-segment-parallel-dodging
space_between_bars <- 0.145
df.add.arrow$case_control_x_adj = scale(as.numeric(as.factor(df.add.arrow$case_control))) * space_between_bars
df.add.arrow$x = as.numeric(as.factor(df.add.arrow$time_since_vax)) + df.add.arrow$case_control_x_adj


ggplot() +
  # if lb > -20
  geom_point(aes(x = time_since_vax, y = VE.median, color = case_control), 
             position = position_dodge(0.5), data = df.no.arrow) +
  geom_errorbar(aes(x = time_since_vax, ymin = VE.lb, ymax = VE.ub, color = case_control), 
                width = 0, position = position_dodge(0.5), data = df.no.arrow) +
  geom_text(aes(x = time_since_vax, y = VE.median, color = case_control, label = VE), 
            angle = 90, position = position_dodge(0.5), vjust = - 0.7, show_guide = F,
            size = 3, data = df.no.arrow) +
  # if lb < -50
  geom_point(aes(x = time_since_vax, y = VE.median, color = case_control), 
             position = position_dodge(0.5), data = df.add.arrow) +
  geom_segment(aes(x = x, xend = x, 
                   y = VE.ub, yend = VE.lb, color = case_control),
               arrow = arrow(length = unit(2, "mm")),
               position = position_dodge(0.5),
               data = df.add.arrow, show_guide = F) +
  geom_text(aes(x = time_since_vax, y = (VE.ub+50)/2, color = case_control, label = VE), 
            angle = 90, position = position_dodge(0.5), vjust = - 0.7, show_guide = F,
            size = 3, data = df.add.arrow) +
  theme_classic() +
  scale_color_brewer(palette = "Dark2") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ylab("Effectiveness of Nirsevimab (%)") +
  xlab("Time since vaccination") +
  labs(color = "Clinical endpoint") +
  ylim(c(-20,100))
```

<br>


### what if we use an alternative prior structure on the increments {.tabset}
#### old model above
For model above, the increments have structure of: 
```{r echo = T}
# Non-negative increments for ensuring order
  # d[1] ~ dnorm(0, 0.0001)  # beta1 (uninformative)
  # d[2] ~ dnorm(0, 0.001)T(0,)  # non-negative increases
  # d[3] ~ dnorm(0, 0.001)T(0,)  # non-negative
  # d[4] ~ dnorm(0, 0.001)T(0,)  # non-negative
  # d[5] ~ dnorm(0, 0.001)T(0,)  # non-negative
  # # 
  # # Ensure monotonicity through cumulative sums
  # beta1 <- d[1]
  # beta2 <- beta1 + d[2]
  # beta3 <- beta2 + d[3]
  # beta4 <- beta3 + d[4]
  # beta5 <- beta4 + d[5]
```

#### new model
but what if we change the prior structure to below like this:
```{r, echo = T}
 # # Non-negative increments for ensuring order
  # d[1] ~ dnorm(0, 0.0001)  # beta1 (uninformative)
  # d[2] ~ dnorm(0, tau_d)T(0,)  # non-negative increases
  # d[3] ~ dnorm(0, tau_d)T(0,)  # non-negative
  # d[4] ~ dnorm(0, tau_d)T(0,)  # non-negative
  # d[5] ~ dnorm(0, tau_d)T(0,)  # non-negative
  # # 
  # # Ensure monotonicity through cumulative sums
  # beta1 <- d[1]
  # beta2 <- beta1 + d[2]
  # beta3 <- beta2 + d[3]
  # beta4 <- beta3 + d[4]
  # beta5 <- beta4 + d[5]
  # 
  # # uninformative prior for tau_d 
  # tau_d ~ dgamma(0.01, 0.01)
```

#### Rerun model with 1-month interval using the new model with more flexible tau_d
  * uninformative prior for precision (tau_d) of increment 
  * classify time since vax to testing into three groups: 0-1, 1-2, 2-3, 3-4 and >4 months
```{r}
source("jags_waning.R")

###################################
# Against RSV infection 
###################################

# prepare the input dataset for jags 
df.jags <- df %>% 
  # vax time groups 
  mutate(vax_time_group1 = ifelse(days_btw_mab_collection_cat_3 == "0-1 months", 1, 0)) %>%
  mutate(vax_time_group2 = ifelse(days_btw_mab_collection_cat_3 == "1-2 months", 1, 0)) %>%
  mutate(vax_time_group3 = ifelse(days_btw_mab_collection_cat_3 == "2-3 months", 1, 0)) %>%
  mutate(vax_time_group4 = ifelse(days_btw_mab_collection_cat_3 == "3-4 months", 1, 0)) %>%
  mutate(vax_time_group5 = ifelse(days_btw_mab_collection_cat_3 == "4 months +", 1, 0)) %>%
  # define case and control
  mutate(case_control = positive_rsv) 

# what if additionally include birth weight and gestage<37wks as confounders 
df.jags <- df.jags %>%
  filter(!is.na(cf_birth_weight) & !is.na(risk_factor_gestagelessthan37wks))
  

dataset_1monthinterval_infection <- 
            list(
                N_records = nrow(df.jags),
                vax = df.jags$rsv_mab,
                vax_time_group1 = df.jags$vax_time_group1,
                vax_time_group2 = df.jags$vax_time_group2,
                vax_time_group3 = df.jags$vax_time_group3,
                vax_time_group4 = df.jags$vax_time_group4,
                vax_time_group5 = df.jags$vax_time_group5,
                case_status = df.jags$case_control,
                # confounders
                cf_birth_weight = df.jags$birth_weight,
                cf_gestage = df.jags$risk_factor_gestagelessthan37wks,
                #cf_age = df.jags$cf_age, # age when tested
                #cf_month_tested = df.jags$cf_month_tested # month when tested
                cf_age_1 = df.jags$cf_age_1, # age when tested
                cf_age_2 = df.jags$cf_age_2,
                cf_age_3 = df.jags$cf_age_3,
                cf_age_4 = df.jags$cf_age_4,
                cf_age_5 = df.jags$cf_age_5,
                cf_month_tested_1 = df.jags$cf_month_tested_1, # month when tested
                cf_month_tested_2 = df.jags$cf_month_tested_2,
                cf_month_tested_3 = df.jags$cf_month_tested_3,
                cf_month_tested_4 = df.jags$cf_month_tested_4
                )

source("jags_waning.R")

if(rerun){
  
  jags.post <- rjags::jags.model(textConnection(model_string_waning_1monthinterval_tau), 
                          data = dataset_1monthinterval_infection,
                          n.chains = 3)

  samples <- rjags::coda.samples(jags.post, 
                          variable.names=c("beta1", "beta2", "beta3", "beta4", "beta5"),
                          n.iter = 5000)
  saveRDS(samples, "../data/jags/post/wane_1monthinterval_infection_tau.rds")

}else{
  samples <- readRDS("../data/jags/post/wane_1monthinterval_infection_tau.rds")
}

post1 <- as.data.frame(as.matrix(samples[[1]][-c(1:4500),]))  
post2 <- as.data.frame(as.matrix(samples[[2]][-c(1:4500),])) 
post3 <- as.data.frame(as.matrix(samples[[3]][-c(1:4500),])) 
post <- bind_rows(post1, post2, post3)

ve.median.0_1m <- round((1 - exp(median(post$beta1)))*100,1)
ve.lb.0_1m <- round((1 - exp(quantile(post$beta1, 0.975))) *100,1)
ve.ub.0_1m <- round((1 - exp(quantile(post$beta1, 0.025)))*100, 1)

ve.median.1_2m <- round((1 - exp(median(post$beta2)))*100,1)
ve.lb.1_2m <- round((1 - exp(quantile(post$beta2, 0.975))) *100,1)
ve.ub.1_2m <- round((1 - exp(quantile(post$beta2, 0.025)))*100, 1)

ve.median.2_3m <- round((1 - exp(median(post$beta3)))*100,1)
ve.lb.2_3m <- round((1 - exp(quantile(post$beta3, 0.975))) *100,1)
ve.ub.2_3m <- round((1 - exp(quantile(post$beta3, 0.025)))*100, 1)

ve.median.3_4m <- round((1 - exp(median(post$beta4)))*100,1)
ve.lb.3_4m <- round((1 - exp(quantile(post$beta4, 0.975))) *100,1)
ve.ub.3_4m <- round((1 - exp(quantile(post$beta4, 0.025)))*100, 1)

ve.median.4m <- round((1 - exp(median(post$beta5)))*100,1)
ve.lb.4m <- round((1 - exp(quantile(post$beta5, 0.975))) *100,1)
ve.ub.4m <- round((1 - exp(quantile(post$beta5, 0.025)))*100, 1)

# look at the result
ve.1monthinterval.infection <- 
  data.frame(
  case_control = rep("RSV+ vs. RSV-", 6),
  vax_time = c("not vaccinated",
               "vaccinated 0-1 months ago",
               "vaccinated 1-2 months ago",
               "vaccinated 2-3 months ago",
               "vaccinated 3-4 months ago",
               "vaccinated 4+ months ago"),
  VE.adjusted = c(
    "REF",
    paste0(ve.median.0_1m, " (", ve.lb.0_1m, "-", ve.ub.0_1m, ")"),
    paste0(ve.median.1_2m, " (", ve.lb.1_2m, "-", ve.ub.1_2m, ")"),
    paste0(ve.median.2_3m, " (", ve.lb.2_3m, "-", ve.ub.2_3m, ")"),
    paste0(ve.median.3_4m, " (", ve.lb.3_4m, "-", ve.ub.3_4m, ")"),
    paste0(ve.median.4m, " (", ve.lb.4m, "-", ve.ub.4m, ")")
  )
) %>% 
  cbind(
    table(df.jags$days_btw_mab_collection_cat_3, df.jags$case_control) %>%
      matrix(ncol = 2)
  ) %>%
  dplyr::rename(n_cases = `2`, n_controls = `1`)
  
# for plotting 
df.ve.1monthinterval.infection <- 
  data.frame(
  case_control = rep("RSV+ vs. RSV-", 5),
  vax_time = c(
               "vaccinated 0-1 months ago",
               "vaccinated 1-2 months ago",
               "vaccinated 2-3 months ago",
               "vaccinated 3-4 months ago",
               "vaccinated 4+ months ago"),
  VE.median = c(ve.median.0_1m, ve.median.1_2m, ve.median.2_3m, ve.median.3_4m, ve.median.4m),
  VE.lb = c(ve.lb.0_1m, ve.lb.1_2m, ve.lb.2_3m, ve.lb.3_4m, ve.lb.4m),
  VE.ub = c(ve.ub.0_1m, ve.ub.1_2m, ve.ub.2_3m, ve.ub.3_4m, ve.ub.4m)
  )



# 
# plot(samples[, "beta1"])
# title("beta1")
# plot(samples[, "beta2"])
# title("beta2")
# plot(samples[, "beta3"])
# title("beta3")
# plot(samples[, "beta4"])
# title("beta4")
# plot(samples[, "beta5"])
# title("beta5")


###################################
# Against RSV LRTI
###################################

# prepare the input dataset for jags 
df.jags <- df %>% 
  # vax time groups 
  mutate(vax_time_group1 = ifelse(days_btw_mab_collection_cat_3 == "0-1 months", 1, 0)) %>%
  mutate(vax_time_group2 = ifelse(days_btw_mab_collection_cat_3 == "1-2 months", 1, 0)) %>%
  mutate(vax_time_group3 = ifelse(days_btw_mab_collection_cat_3 == "2-3 months", 1, 0)) %>%
  mutate(vax_time_group4 = ifelse(days_btw_mab_collection_cat_3 == "3-4 months", 1, 0)) %>%
  mutate(vax_time_group5 = ifelse(days_btw_mab_collection_cat_3 == "4 months +", 1, 0)) %>%
  # define case and control
  mutate(case_control = case_when(positive_rsv ==1 & symp_LRT_distress == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

# what if additionally include birth weight and gestage<37wks as confounders 
df.jags <- df.jags %>%
  filter(!is.na(cf_birth_weight) & !is.na(risk_factor_gestagelessthan37wks))


dataset_1monthinterval_RSVLRTI <- 
            list(
                N_records = nrow(df.jags),
                vax = df.jags$rsv_mab,
                vax_time_group1 = df.jags$vax_time_group1,
                vax_time_group2 = df.jags$vax_time_group2,
                vax_time_group3 = df.jags$vax_time_group3,
                vax_time_group4 = df.jags$vax_time_group4,
                vax_time_group5 = df.jags$vax_time_group5,
                case_status = df.jags$case_control,
                # confounders
                cf_birth_weight = df.jags$birth_weight,
                cf_gestage = df.jags$risk_factor_gestagelessthan37wks,
                #cf_age = df.jags$cf_age, # age when tested
                #cf_month_tested = df.jags$cf_month_tested # month when tested
                cf_age_1 = df.jags$cf_age_1, # age when tested
                cf_age_2 = df.jags$cf_age_2,
                cf_age_3 = df.jags$cf_age_3,
                cf_age_4 = df.jags$cf_age_4,
                cf_age_5 = df.jags$cf_age_5,
                cf_month_tested_1 = df.jags$cf_month_tested_1, # month when tested
                cf_month_tested_2 = df.jags$cf_month_tested_2,
                cf_month_tested_3 = df.jags$cf_month_tested_3,
                cf_month_tested_4 = df.jags$cf_month_tested_4
                )

source("jags_waning.R")

if(rerun){
  
  jags.post <- rjags::jags.model(textConnection(model_string_waning_1monthinterval_tau), 
                          data = dataset_1monthinterval_RSVLRTI,
                          n.chains = 3)

  samples <- rjags::coda.samples(jags.post, 
                          variable.names=c("beta1", "beta2", "beta3", "beta4", "beta5"),
                          n.iter = 5000)
  saveRDS(samples, "../data/jags/post/wane_1monthinterval_RSVLRTI.rds")

}else{
  samples <- readRDS("../data/jags/post/wane_1monthinterval_RSVLRTI.rds")
}

post1 <- as.data.frame(as.matrix(samples[[1]][-c(1:4500),]))  
post2 <- as.data.frame(as.matrix(samples[[2]][-c(1:4500),])) 
post3 <- as.data.frame(as.matrix(samples[[3]][-c(1:4500),])) 
post <- bind_rows(post1, post2, post3)

ve.median.0_1m <- round((1 - exp(median(post$beta1)))*100,1)
ve.lb.0_1m <- round((1 - exp(quantile(post$beta1, 0.975))) *100,1)
ve.ub.0_1m <- round((1 - exp(quantile(post$beta1, 0.025)))*100, 1)

ve.median.1_2m <- round((1 - exp(median(post$beta2)))*100,1)
ve.lb.1_2m <- round((1 - exp(quantile(post$beta2, 0.975))) *100,1)
ve.ub.1_2m <- round((1 - exp(quantile(post$beta2, 0.025)))*100, 1)

ve.median.2_3m <- round((1 - exp(median(post$beta3)))*100,1)
ve.lb.2_3m <- round((1 - exp(quantile(post$beta3, 0.975))) *100,1)
ve.ub.2_3m <- round((1 - exp(quantile(post$beta3, 0.025)))*100, 1)

ve.median.3_4m <- round((1 - exp(median(post$beta4)))*100,1)
ve.lb.3_4m <- round((1 - exp(quantile(post$beta4, 0.975))) *100,1)
ve.ub.3_4m <- round((1 - exp(quantile(post$beta4, 0.025)))*100, 1)

ve.median.4m <- round((1 - exp(median(post$beta5)))*100,1)
ve.lb.4m <- round((1 - exp(quantile(post$beta5, 0.975))) *100,1)
ve.ub.4m <- round((1 - exp(quantile(post$beta5, 0.025)))*100, 1)

# look at the result
ve.1monthinterval.RSVLRTI <- 
  data.frame(
  case_control = rep("RSV+ LRTI vs. RSV-", 6),
  vax_time = c("not vaccinated",
               "vaccinated 0-1 months ago",
               "vaccinated 1-2 months ago",
               "vaccinated 2-3 months ago",
               "vaccinated 3-4 months ago",
               "vaccinated 4+ months ago"),
  VE.adjusted = c(
    "REF",
    paste0(ve.median.0_1m, " (", ve.lb.0_1m, "-", ve.ub.0_1m, ")"),
    paste0(ve.median.1_2m, " (", ve.lb.1_2m, "-", ve.ub.1_2m, ")"),
    paste0(ve.median.2_3m, " (", ve.lb.2_3m, "-", ve.ub.2_3m, ")"),
    paste0(ve.median.3_4m, " (", ve.lb.3_4m, "-", ve.ub.3_4m, ")"),
    paste0(ve.median.4m, " (", ve.lb.4m, "-", ve.ub.4m, ")")
  )
) %>% 
  cbind(
    table(df.jags$days_btw_mab_collection_cat_3, df.jags$case_control) %>%
      matrix(ncol = 2)
  ) %>%
  dplyr::rename(n_cases = `2`, n_controls = `1`)
  

# for plotting 
df.ve.1monthinterval.RSVLRTI <- 
  data.frame(
  case_control = rep("RSV+ LRTI vs. RSV-", 5),
  vax_time = c(
               "vaccinated 0-1 months ago",
               "vaccinated 1-2 months ago",
               "vaccinated 2-3 months ago",
               "vaccinated 3-4 months ago",
               "vaccinated 4+ months ago"),
  VE.median = c(ve.median.0_1m, ve.median.1_2m, ve.median.2_3m, ve.median.3_4m, ve.median.4m),
  VE.lb = c(ve.lb.0_1m, ve.lb.1_2m, ve.lb.2_3m, ve.lb.3_4m, ve.lb.4m),
  VE.ub = c(ve.ub.0_1m, ve.ub.1_2m, ve.ub.2_3m, ve.ub.3_4m, ve.ub.4m)
  )




###################################
# Against RSV hosp
###################################

# prepare the input dataset for jags 
df.jags <- df %>% 
  # vax time groups 
  mutate(vax_time_group1 = ifelse(days_btw_mab_collection_cat_3 == "0-1 months", 1, 0)) %>%
  mutate(vax_time_group2 = ifelse(days_btw_mab_collection_cat_3 == "1-2 months", 1, 0)) %>%
  mutate(vax_time_group3 = ifelse(days_btw_mab_collection_cat_3 == "2-3 months", 1, 0)) %>%
  mutate(vax_time_group4 = ifelse(days_btw_mab_collection_cat_3 == "3-4 months", 1, 0)) %>%
  mutate(vax_time_group5 = ifelse(days_btw_mab_collection_cat_3 == "4 months +", 1, 0)) %>%
  # define case and control
  mutate(case_control = case_when(positive_rsv == 1 & encounter_type == "inpatient" ~ 1,
                                  positive_rsv == 0 ~ 0))
  

dataset_1monthinterval_RSVhosp <- 
            list(
                N_records = nrow(df.jags),
                vax = df.jags$rsv_mab,
                vax_time_group1 = df.jags$vax_time_group1,
                vax_time_group2 = df.jags$vax_time_group2,
                vax_time_group3 = df.jags$vax_time_group3,
                vax_time_group4 = df.jags$vax_time_group4,
                vax_time_group5 = df.jags$vax_time_group5,
                case_status = df.jags$case_control,
                # confounders
                # cf_birth_weight = df.jags$birth_weight,
                #cf_age = df.jags$cf_age, # age when tested
                #cf_month_tested = df.jags$cf_month_tested # month when tested
                cf_age_1 = df.jags$cf_age_1, # age when tested
                cf_age_2 = df.jags$cf_age_2,
                cf_age_3 = df.jags$cf_age_3,
                cf_age_4 = df.jags$cf_age_4,
                cf_age_5 = df.jags$cf_age_5,
                cf_month_tested_1 = df.jags$cf_month_tested_1, # month when tested
                cf_month_tested_2 = df.jags$cf_month_tested_2,
                cf_month_tested_3 = df.jags$cf_month_tested_3,
                cf_month_tested_4 = df.jags$cf_month_tested_4
                )

source("jags_waning.R")

if(rerun){
  
  jags.post <- rjags::jags.model(textConnection(model_string_waning_1monthinterval), 
                          data = dataset_1monthinterval_RSVhosp,
                          n.chains = 3)

  samples <- rjags::coda.samples(jags.post, 
                          variable.names=c("beta1", "beta2", "beta3", "beta4", "beta5"),
                          n.iter = 5000)
  saveRDS(samples, "../data/jags/post/wane_1monthinterval_RSVhosp.rds")

}else{
  samples <- readRDS("../data/jags/post/wane_1monthinterval_RSVhosp.rds")
}

post1 <- as.data.frame(as.matrix(samples[[1]][-c(1:4500),]))  
post2 <- as.data.frame(as.matrix(samples[[2]][-c(1:4500),])) 
post3 <- as.data.frame(as.matrix(samples[[3]][-c(1:4500),])) 
post <- bind_rows(post1, post2, post3)

ve.median.0_1m <- round((1 - exp(median(post$beta1)))*100,1)
ve.lb.0_1m <- round((1 - exp(quantile(post$beta1, 0.975))) *100,1)
ve.ub.0_1m <- round((1 - exp(quantile(post$beta1, 0.025)))*100, 1)

ve.median.1_2m <- round((1 - exp(median(post$beta2)))*100,1)
ve.lb.1_2m <- round((1 - exp(quantile(post$beta2, 0.975))) *100,1)
ve.ub.1_2m <- round((1 - exp(quantile(post$beta2, 0.025)))*100, 1)

ve.median.2_3m <- round((1 - exp(median(post$beta3)))*100,1)
ve.lb.2_3m <- round((1 - exp(quantile(post$beta3, 0.975))) *100,1)
ve.ub.2_3m <- round((1 - exp(quantile(post$beta3, 0.025)))*100, 1)

ve.median.3_4m <- round((1 - exp(median(post$beta4)))*100,1)
ve.lb.3_4m <- round((1 - exp(quantile(post$beta4, 0.975))) *100,1)
ve.ub.3_4m <- round((1 - exp(quantile(post$beta4, 0.025)))*100, 1)

ve.median.4m <- round((1 - exp(median(post$beta5)))*100,1)
ve.lb.4m <- round((1 - exp(quantile(post$beta5, 0.975))) *100,1)
ve.ub.4m <- round((1 - exp(quantile(post$beta5, 0.025)))*100, 1)

# look at the result
ve.1monthinterval.RSVhosp <- 
  data.frame(
  case_control = rep("RSV+ hospitalizations vs. RSV-", 6),
  vax_time = c("not vaccinated",
               "vaccinated 0-1 months ago",
               "vaccinated 1-2 months ago",
               "vaccinated 2-3 months ago",
               "vaccinated 3-4 months ago",
               "vaccinated 4+ months ago"),
  VE.adjusted = c(
    "REF",
    paste0(ve.median.0_1m, " (", ve.lb.0_1m, "-", ve.ub.0_1m, ")"),
    paste0(ve.median.1_2m, " (", ve.lb.1_2m, "-", ve.ub.1_2m, ")"),
    paste0(ve.median.2_3m, " (", ve.lb.2_3m, "-", ve.ub.2_3m, ")"),
    paste0(ve.median.3_4m, " (", ve.lb.3_4m, "-", ve.ub.3_4m, ")"),
    paste0(ve.median.4m, " (", ve.lb.4m, "-", ve.ub.4m, ")")
  )
) %>% 
  cbind(
    table(df.jags$days_btw_mab_collection_cat_3, df.jags$case_control) %>%
      matrix(ncol = 2)
  ) %>%
  dplyr::rename(n_cases = `2`, n_controls = `1`)

# for plotting 
df.ve.1monthinterval.RSVhosp <- 
  data.frame(
  case_control = rep("RSV+ hospitalizations vs. RSV-", 5),
  vax_time = c(
               "vaccinated 0-1 months ago",
               "vaccinated 1-2 months ago",
               "vaccinated 2-3 months ago",
               "vaccinated 3-4 months ago",
               "vaccinated 4+ months ago"),
  VE.median = c(ve.median.0_1m, ve.median.1_2m, ve.median.2_3m, ve.median.3_4m, ve.median.4m),
  VE.lb = c(ve.lb.0_1m, ve.lb.1_2m, ve.lb.2_3m, ve.lb.3_4m, ve.lb.4m),
  VE.ub = c(ve.ub.0_1m, ve.ub.1_2m, ve.ub.2_3m, ve.ub.3_4m, ve.ub.4m)
  )


  

# look at all the results with 2-month interval
ve.1monthinterval.infection %>%
  rbind(ve.1monthinterval.RSVLRTI, 
        ve.1monthinterval.RSVhosp) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, groupBy = "case_control") 
```

#### 1-month interval (figure, showing full CI) 
```{r fig.width = 9, fig.height = 4}
df.plt.wane <- 
  df.ve.1monthinterval.infection %>%
  rbind(df.ve.1monthinterval.RSVLRTI, 
        df.ve.1monthinterval.RSVhosp) %>% 
  mutate(time_since_vax = case_when(
                                    vax_time == "vaccinated 0-1 months ago" ~ "1 month",
                                    vax_time == "vaccinated 1-2 months ago" ~ "2 months", 
                                    vax_time == "vaccinated 2-3 months ago" ~ "3 months", 
                                    vax_time == "vaccinated 3-4 months ago" ~ "4 months", 
                                    vax_time == "vaccinated 4+ months ago" ~ "after 4 months")) %>%
  mutate(VE = paste0(round(VE.median), " (", round(VE.lb), ", ", round(VE.ub), ")")) %>% 
  mutate(time_since_vax = factor(time_since_vax, levels = c("1 month", "2 months","3 months","4 months", "after 4 months"))) %>% 
  mutate(case_control = case_when(case_control == "RSV+ vs. RSV-" ~ "Against RSV infection",
                                  case_control == "RSV+ LRTI vs. RSV-" ~ "Against RSV LRTI",
                                  case_control == "RSV+ hospitalizations vs. RSV-" ~ "Against RSV hospitalizations")) %>%
  mutate(case_control = factor(case_control, levels = c("Against RSV infection",
                                                        "Against RSV LRTI",
                                                        "Against RSV hospitalizations")))

df.plt.wane %>%
  ggplot() +
  geom_point(aes(x = time_since_vax, y = VE.median, color = case_control), 
             position = position_dodge(0.5)) +
  geom_errorbar(aes(x = time_since_vax, ymin = VE.lb, ymax = VE.ub, color = case_control), 
                width = 0, position = position_dodge(0.5)) +
  geom_text(aes(x = time_since_vax, y = VE.median, color = case_control, label = VE), 
            angle = 90, position = position_dodge(0.5), vjust = - 0.7, show_guide = F,
            size = 3) +
  theme_classic() +
  scale_color_brewer(palette = "Dark2") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ylab("Effectiveness of Nirsevimab (%)") +
  xlab("Time since vaccination") +
  labs(color = "Clinical endpoint")

```

#### 1-month interval (figure, showing partial CI) 
```{r fig.width = 9, fig.height = 4}
df.no.arrow <- 
  df.plt.wane %>%
  mutate(add_arrow = ifelse(VE.lb < -20, 1, 0)) %>%
  mutate(VE.lb = ifelse(add_arrow == 1, -20, VE.lb)) %>% 
  mutate(across(starts_with("VE"), ~ ifelse(add_arrow == 1, NA, .)))

df.add.arrow <- 
  df.plt.wane %>%
  mutate(add_arrow = ifelse(VE.lb < -20, 1, 0)) %>%
  mutate(VE.lb = ifelse(add_arrow == 1, -20, VE.lb)) %>% 
  mutate(across(starts_with("VE"), ~ ifelse(add_arrow != 1, NA, .)))

# adjusted arrows to parallel
# https://stackoverflow.com/questions/67853990/geom-segment-parallel-dodging
space_between_bars <- 0.145
df.add.arrow$case_control_x_adj = scale(as.numeric(as.factor(df.add.arrow$case_control))) * space_between_bars
df.add.arrow$x = as.numeric(as.factor(df.add.arrow$time_since_vax)) + df.add.arrow$case_control_x_adj


ggplot() +
  # if lb > -20
  geom_point(aes(x = time_since_vax, y = VE.median, color = case_control), 
             position = position_dodge(0.5), data = df.no.arrow) +
  geom_errorbar(aes(x = time_since_vax, ymin = VE.lb, ymax = VE.ub, color = case_control), 
                width = 0, position = position_dodge(0.5), data = df.no.arrow) +
  geom_text(aes(x = time_since_vax, y = VE.median, color = case_control, label = VE), 
            angle = 90, position = position_dodge(0.5), vjust = - 0.7, show_guide = F,
            size = 3, data = df.no.arrow) +
  # if lb < -50
  geom_point(aes(x = time_since_vax, y = VE.median, color = case_control), 
             position = position_dodge(0.5), data = df.add.arrow) +
  geom_segment(aes(x = x, xend = x, 
                   y = VE.ub, yend = VE.lb, color = case_control),
               arrow = arrow(length = unit(2, "mm")),
               position = position_dodge(0.5),
               data = df.add.arrow, show_guide = F) +
  geom_text(aes(x = time_since_vax, y = (VE.ub+50)/2, color = case_control, label = VE), 
            angle = 90, position = position_dodge(0.5), vjust = - 0.7, show_guide = F,
            size = 3, data = df.add.arrow) +
  theme_classic() +
  scale_color_brewer(palette = "Dark2") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ylab("Effectiveness of Nirsevimab (%)") +
  xlab("Time since vaccination") +
  labs(color = "Clinical endpoint") +
  ylim(c(-20,100))
```

<br>











