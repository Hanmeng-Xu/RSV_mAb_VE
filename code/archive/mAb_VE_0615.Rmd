---
title: "VE of Nirsevimab"
output: 
  html_document:
    toc: true
    toc_float: true
---

#### Date: `r Sys.Date()`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(dplyr)
library(tidyr)
library(tidyverse)
library(readxl)
library(writexl)
library(reactable)
library(ggplot2)
library(stringr)
library(flextable)
library(lubridate)


library(gtsummary) # for table 1
library(multcomp)
library(survival) # for matched case-control

fig.counter <- 1
tab.counter <- 1

source("utils_mAb_VE.R")
```


```{r}
# read in dataset
df <- read.csv("../data/clean_data/df.mab.csv") %>% 
  mutate(collection_date = as.Date(collection_date))
colnames <- as.data.frame(colnames(df))


```


```{r}
# add/recode some variables 

# month when tested and age when tested 
df <- df %>% 
  mutate(month_when_tested = as.character(month(collection_date, label = T))) %>% 
  mutate(month_when_tested = ifelse(month_when_tested == "Sep", "Oct", month_when_tested)) %>%
  # age when tested (6m interval)
  mutate(age_at_test_in_months_cat = case_when(
    age_at_test_in_months < 6 ~ "under 6m",
    age_at_test_in_months >= 6 & age_at_test_in_months < 12 ~ "6-12m",
    age_at_test_in_months >= 12 ~ "above 1 yo" 
  )) %>%
  # age when tested (3m interval)
  mutate(age_at_test_in_months_cat_2 = case_when(
    age_at_test_in_months < 3 ~ "under 3m",
    age_at_test_in_months >= 3 & age_at_test_in_months < 6 ~ "3-6m",
    age_at_test_in_months >= 6 & age_at_test_in_months < 9 ~ "6-9m",
    age_at_test_in_months >= 9 & age_at_test_in_months < 12 ~ "9-12m",
    age_at_test_in_months >= 12 ~ "above 1 yo" 
  )) %>%
  mutate(risk_factor_atleastone = case_when(risk_factor_atleastone == 1 ~ "yes",
                                            risk_factor_atleastone == 0 ~ "no")) %>% 
  mutate(across(c(risk_factor_anemia, 
                  risk_factor_blood,
                  risk_factor_pulmonary,
                  risk_factor_liver,
                  risk_factor_cardiac,
                  risk_factor_asthma,
                  risk_factor_immunodeficiency,
                  risk_factor_down,
                  risk_factor_wheezing,
                  risk_factor_environmental
                  #risk_factor_small_for_gestage # this has values of 1 0 NA
                  ), ~ ifelse(is.na(.), "no", "yes"))) %>%
  mutate(age_at_test_in_months_cat = factor(age_at_test_in_months_cat,
                                            levels = c("under 6m",
                                                       "6-12m",
                                                       "above 1 yo"))) %>%
  mutate(age_at_test_in_months_cat_2 = factor(age_at_test_in_months_cat_2,
                                              levels = c("under 3m",
                                                         "3-6m",
                                                         "6-9m",
                                                         "9-12m",
                                                         "above 1 yo"))) %>% 
  mutate(race_ethnicity = factor(race_ethnicity,
                                 levels = c("Hispanic",
                                            "White non-Hispanic",
                                            "Black non-Hispanic",
                                            "Other non-Hispanic",
                                            "unknown")))

# birth weight in grams (originally ounce)
df <- df %>%  mutate(birth_weight = Birth.Wgt * 28.3)

# classify time since mab to testing 
df <- df %>% 
  mutate(days_btw_mab_collection_cat = 
           case_when(days_btw_mab_collection < 0 & days_btw_mab_collection > -60 ~ "0-2 months", 
                     days_btw_mab_collection <= -60 & days_btw_mab_collection > -120 ~ "2-4 months",
                     days_btw_mab_collection <= -120 ~ "4 months +",
                     is.na(days_btw_mab_collection) | days_btw_mab_collection >= 0 ~ "no mAb")) %>%
  mutate(days_btw_mab_collection_cat = factor(days_btw_mab_collection_cat,
                                              levels = c("no mAb",
                                                         "0-2 months",
                                                         "2-4 months",
                                                         "4 months +"))) %>%
  mutate(days_btw_mab_collection_cat_2 = 
           case_when(days_btw_mab_collection < 0 & days_btw_mab_collection > -90 ~ "0-3 months", 
                     days_btw_mab_collection <= -90 & days_btw_mab_collection > -190 ~ "3-6 months",
                     is.na(days_btw_mab_collection) | days_btw_mab_collection >= 0 ~ "no mAb")) %>%
  mutate(days_btw_mab_collection_cat_2 = factor(days_btw_mab_collection_cat_2,
                                              levels = c("no mAb",
                                                         "0-3 months",
                                                         "3-6 months")))


# group month_when_tested into fewer groups
df <- df %>% 
  mutate(month_when_tested_cat = case_when(
         collection_date >= as.Date("2023-9-30") & collection_date <= as.Date("2023-11-30") ~ "Oct-Nov",
         collection_date >= as.Date("2023-12-1") & collection_date <= as.Date("2024-1-31") ~ "Dec-Jan",
         collection_date >= as.Date("2024-2-1") & collection_date <= as.Date("2024-3-31") ~ "Feb-Mar",
         collection_date >= as.Date("2024-4-1")  ~ "April and after"
  )) %>% 
  mutate(month_when_tested_cat = factor(month_when_tested_cat,
                                        levels = c("Oct-Nov", "Dec-Jan", "Feb-Mar","April and after")))
  

# dosage 
df <- df %>% 
  mutate(rsv_mab_dose = case_when(rsv_mab_detailed == "100mg before collection" ~ "100mg",
                                  rsv_mab_detailed == "50mg before collection" ~ "50mg",
                                  TRUE ~ "no mAb"))


```


### There are totally `r nrow(df)` testing records in the analysis dataset. 

<br>


### Look at the risk factors {.tabset}

#### Table `r tab.counter`  Each risk factor
```{r}
tab.counter <- tab.counter + 1

data.frame(
  anemia = nrow(df %>% filter(risk_factor_anemia == "yes")),
  blood = nrow(df %>% filter(risk_factor_blood == "yes")),
  asthma = nrow(df %>% filter(risk_factor_asthma == "yes")),
  liver_disease = nrow(df %>% filter(risk_factor_liver == "yes")),
  immunodeficiency = nrow(df %>% filter(risk_factor_immunodeficiency == "yes")),
  cardiac = nrow(df %>% filter(risk_factor_cardiac == "yes")),
  pulmonary_disease = nrow(df %>% filter(risk_factor_pulmonary == "yes")),
  down_syndrome = nrow(df %>% filter(risk_factor_down == "yes")),
  wheezing = nrow(df %>% filter(risk_factor_wheezing == "yes")),
  environmental = nrow(df %>% filter(risk_factor_environmental == "yes")),
  small_for_gestage = nrow(df %>% filter(risk_factor_small_for_gestage == 1)),
  gestage_lessthan37wks = nrow(df %>% filter(risk_factor_gestagelessthan37wks == 1))
) %>%
  pivot_longer(cols = 1:12, names_to = "risk_factor", values_to = "n_records") %>%
  arrange(desc(n_records)) %>%
  mutate(perc = round(n_records / nrow(df)*100,1)) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

```

<br>


Table `r tab.counter` At least one risk factor 
```{r}
tab.counter <- tab.counter + 1

df %>% count(risk_factor_atleastone) %>%
 mutate(perc = round(n / nrow(df)*100,1)) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))


# filter out those with at least one risk factor 
a <- df %>% filter(risk_factor_atleastone == "yes") %>% 
  dplyr::select(StudyID, collection_date, positive_rsv, rsv_mab,
                starts_with("risk_factor"))

# write csv for checking
# write.csv(a, "../data/data_to_check/atleastoneriskfactor.csv", row.names = F)
```



<br>

### Table `r tab.counter`. Characteristic of study population (testing level) {.tabset}
  * this is assuming that: if mAb was taken before collection date, we count it as immunized. For SSA, need to change it to: if the person took mAb more than X days before sample collection, we count it as immunized.
  * we look at different pairs of case and control here (mainly to see which ones should be confounders).

#### RSV+ vs. RSV-
```{r}
tab.counter <- tab.counter + 1

df_table1 <- df %>%
  # add dose of mab 
  mutate(rsv_mab = case_when(rsv_mab_detailed == "100mg before collection" ~ "Yes, 100mg dose",
                             rsv_mab_detailed == "50mg before collection" ~ "Yes, 50mg dose",
                             TRUE ~ "No")) %>%
  mutate(risk_factor_gestagelessthan37wks = case_when(
    risk_factor_gestagelessthan37wks == 1 ~ "Less than 37 weeks",
    risk_factor_gestagelessthan37wks == 0 ~ "37 weeks or more"
  )) %>% 
  dplyr::select(positive_rsv,Sex, age_at_test_in_months, age_at_test_in_months_cat_2, race_ethnicity, birth_weight, insurance_type, rsv_mab, month_when_tested_cat, encounter_type, 
                # risk factors (main ones that are >= 5% prevalence)
                risk_factor_pulmonary, risk_factor_cardiac, risk_factor_asthma, risk_factor_anemia,
                risk_factor_gestagelessthan37wks,
                risk_factor_atleastone) %>% 
  mutate(positive_rsv = case_when(positive_rsv == 1 ~ "RSV+",
                                  positive_rsv == 0 ~ "RSV-")) %>%
  # to display the missing, making the NA value explicit level of factor 
  mutate(across(c(positive_rsv,
                  Sex, race_ethnicity, insurance_type, rsv_mab, 
                risk_factor_atleastone, risk_factor_gestagelessthan37wks), ~ factor(.) %>% forcats::fct_explicit_na())) %>% 
  # re-rank variables 
  dplyr::select(positive_rsv, 
                Sex, age_at_test_in_months, age_at_test_in_months_cat_2, 
                month_when_tested_cat,
                race_ethnicity, 
                birth_weight,
                risk_factor_gestagelessthan37wks,
                risk_factor_pulmonary, risk_factor_cardiac, risk_factor_asthma, risk_factor_anemia,
                risk_factor_atleastone,  insurance_type, rsv_mab, 
                encounter_type)

df_table1_infection <- df_table1 %>% dplyr::select(-encounter_type)


table1_infection <- df_table1_infection %>% 
  tbl_summary(by = positive_rsv,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", 
                                               "{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                age_at_test_in_months_cat_2 ~ "Age at testing",
                month_when_tested_cat ~ "Time tested", 
                race_ethnicity ~ "Race and ethnicity",
                risk_factor_pulmonary ~ "Pulmonary diseases", 
                risk_factor_cardiac ~ "Cardiac diseases", 
                risk_factor_asthma ~ "Asthma", 
                risk_factor_anemia ~ "Anemia",
                risk_factor_gestagelessthan37wks ~ "Gestational age",
                risk_factor_atleastone ~ "Having at least one risk factor",
                insurance_type ~ "Insurance type",
                rsv_mab ~ "mAb status",
                birth_weight ~ "Birth weight"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = "Inclusing Asian, Pacific Islander, Middle Eastern or Northern American, American Indian or Native American by self-reporting."
  )


table1_infection %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 
  
```
#### RSV+ hospitalized vs. RSV+ (outpatient)
  * this is to compare severe cases requiring hospitalization and mild cases
```{r}
tab.counter <- tab.counter + 1

df_table1_severity <- df_table1 %>%
  mutate(case_control = case_when(positive_rsv == "RSV+" & encounter_type == "inpatient" ~ "RSV+ hospitalizations",
                                  positive_rsv == "RSV+" & encounter_type == "outpatient" ~ "RSV+ outpatients")) %>%
  dplyr::select(-encounter_type, -positive_rsv)
  


table1_severity <- df_table1_severity %>% 
  tbl_summary(by = case_control,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", 
                                               "{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                age_at_test_in_months_cat_2 ~ "Age at testing",
                month_when_tested_cat ~ "Time tested", 
                race_ethnicity ~ "Race and ethnicity",
                risk_factor_pulmonary ~ "Pulmonary diseases", 
                risk_factor_cardiac ~ "Cardiac diseases", 
                risk_factor_asthma ~ "Asthma", 
                risk_factor_anemia ~ "Anemia",
                risk_factor_gestagelessthan37wks ~ "Gestational age",
                risk_factor_atleastone ~ "Having at least one risk factor",
                insurance_type ~ "Insurance type",
                rsv_mab ~ "mAb status",
                birth_weight ~ "Birth weight"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = "Inclusing Asian, Pacific Islander, Middle Eastern or Northern American, American Indian or Native American by self-reporting."
  )


table1_severity %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 
  
```

#### RSV+ hospitalized vs. RSV- (all)
  * this is to compare severe cases requiring hospitalization and all RSV- 
```{r}
tab.counter <- tab.counter + 1

df_table1_severity_2 <- df_table1 %>%
  mutate(case_control = case_when(positive_rsv == "RSV+" & encounter_type == "inpatient" ~ "RSV+ hospitalizations",
                                  positive_rsv == "RSV-" ~ "RSV-")) %>%
  dplyr::select(-encounter_type, -positive_rsv)
  


table1_severity_2 <- df_table1_severity_2 %>% 
  tbl_summary(by = case_control,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", 
                                               "{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                age_at_test_in_months_cat_2 ~ "Age at testing",
                month_when_tested_cat ~ "Time tested", 
                race_ethnicity ~ "Race and ethnicity",
                risk_factor_pulmonary ~ "Pulmonary diseases", 
                risk_factor_cardiac ~ "Cardiac diseases", 
                risk_factor_asthma ~ "Asthma", 
                risk_factor_anemia ~ "Anemia",
                risk_factor_gestagelessthan37wks ~ "Gestational age",
                risk_factor_atleastone ~ "Having at least one risk factor",
                insurance_type ~ "Insurance type",
                rsv_mab ~ "mAb status",
                birth_weight ~ "Birth weight"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = "Inclusing Asian, Pacific Islander, Middle Eastern or Northern American, American Indian or Native American by self-reporting."
  )


table1_severity_2 %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 
  
```

#### Inpatient vs. outpatient
  * this is to compare inpatient and outpatient records
```{r}
tab.counter <- tab.counter + 1

df_table1_encounter <- df_table1 %>%
  mutate(case_control = case_when(encounter_type == "inpatient" ~ "Inpatient",
                                  encounter_type == "outpatient" ~ "Outpatient")) %>%
  dplyr::select(-encounter_type)



table1_encounter <- df_table1_encounter %>% 
  tbl_summary(by = case_control,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", 
                                               "{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                age_at_test_in_months_cat_2 ~ "Age at testing",
                month_when_tested_cat ~ "Time tested", 
                race_ethnicity ~ "Race and ethnicity",
                risk_factor_pulmonary ~ "Pulmonary diseases", 
                risk_factor_cardiac ~ "Cardiac diseases", 
                risk_factor_asthma ~ "Asthma", 
                risk_factor_anemia ~ "Anemia",
                risk_factor_gestagelessthan37wks ~ "Gestational age",
                risk_factor_atleastone ~ "Having at least one risk factor",
                insurance_type ~ "Insurance type",
                rsv_mab ~ "mAb status",
                birth_weight ~ "Birth weight"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = "Inclusing Asian, Pacific Islander, Middle Eastern or Northern American, American Indian or Native American by self-reporting."
  )


table1_encounter %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 
  
```


<br>


```{r echo = T}
# For VE against infection,
# only adjusting for those that has significant difference comparing RSV+ and RSV- records
confounders_infection <- c(
  "age_at_test_in_months_cat_2", # 3-minth interval
  "month_when_tested_cat", 
  "birth_weight"
)

# For VE against severity
# only adjusting for those that has significant difference comparing RSV+ hospitalization and RSV+ outpatient
confounders_severity <- c(
  "age_at_test_in_months_cat_2", # 3-minth interval
  "month_when_tested_cat",
  "risk_factor_pulmonary",
  "risk_factor_asthma"
)

# For VE against severity (2)
# only adjusting for those that has significant difference comparing RSV+ hospitalization and RSV-
confounders_severity_2 <- c(
  "age_at_test_in_months_cat_2", # 3-minth interval
  "month_when_tested_cat"
)

# For VE against hospitalization
# only adjusting for those that has significant difference comparing inpatient and outpatient
confounders_encounter <- c(
  "age_at_test_in_months_cat_2", # 3-minth interval
  "month_when_tested_cat",
  "risk_factor_gestagelessthan37wks",
  "risk_factor_pulmonary",
  "risk_factor_cardiac",
  "risk_factor_asthma",
  "risk_factor_anemia",
  "risk_factor_atleastone"
  
)



```

<br>

### Table `r tab.counter`. Effectiveness of Nirsevimab
#### Here, I pooled all the cases and controls together, to estimate the VE for different pairs of case and control definitions.
  * Columns n_overall, n_cases, n_controls are numbers of individuals were sample size used in the analysis. 
    + The sample size outside the parenthesis is the sample size that contributes to estimates of **unadjusted** effectiveness in the logistic regression models.
    + The sample size inside the parenthesis is the sample size that effectively contributes to estimates of *adjusted* effectiveness in the logistic regression models.

```{r warning=FALSE}
tab.counter <- tab.counter + 1

###################################
# inpatient RSV+ vs. inpatient RSV-
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 ~ 1,
                                  encounter_type == "inpatient" & positive_rsv == 0 ~ 0))

ve.unadj.1 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (inpatient)", control = "RSV- (inpatient)")
ve.adj.1 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_infection) %>%
  mutate(case = "RSV+ (inpatient)", control = "RSV- (inpatient)")


###################################
# outpatient RSV+ vs. outpatient RSV-
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "outpatient" & positive_rsv == 1 ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 0 ~ 0))

ve.unadj.2 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (outpatient)", control = "RSV- (outpatient)")
ve.adj.2 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_infection) %>%
  mutate(case = "RSV+ (outpatient)", control = "RSV- (outpatient)")


###################################
# all RSV+ vs. all RSV-
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(positive_rsv == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.3 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (all)", control = "RSV- (all)")
ve.adj.3 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_infection) %>%
  mutate(case = "RSV+ (all)", control = "RSV- (all)")



###################################
# RSV+ hospitalized vs. all RSV- 
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.4 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ hospitalizations", control = "RSV- (all)")
ve.adj.4 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "RSV+ hospitalizations", control = "RSV- (all)")


###################################
# severe RSV+ hospitalized vs. all RSV- 
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.5 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ hospitalizations", control = "RSV- (all)")
ve.adj.5 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "severe RSV+ hospitalizations", control = "RSV- (all)")

###################################
# RSV+ icu vs. all RSV- 
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    (icu_admitted == "yes" ) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.6 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ ICU admission", control = "RSV- (all)")
ve.adj.6 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "RSV+ ICU admission", control = "RSV- (all)")

###################################
# RSV+ LRT-hospitalizations vs. all RSV- 
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    ( symp_LRT_distress == 1 ) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.7 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ LRT-hospitalizations", control = "RSV- (all)")
ve.adj.7 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "RSV+ LRT-hospitalizations", control = "RSV- (all)")


###################################
# severe RSV+ LRT-hospitalizations vs. all RSV- 
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    ( symp_LRT_distress == 1 ) &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.8 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ LRT-hospitalizations", control = "RSV- (all)")
ve.adj.8 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "severe RSV+ LRT-hospitalizations", control = "RSV- (all)")


###################################
# all-cause hospitalizations vs. outpatient  
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient"  ~ 1,
                                  encounter_type == "outpatient" ~ 0))

ve.unadj.9 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_encounter) %>% 
 mutate(case = "all-cause hospitalizations", control = "not hospitalized")
ve.adj.9 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_encounter) %>%
 mutate(case = "all-cause hospitalizations", control = "not hospitalized")

###################################
# LRT-hospitalizations vs. outpatient  
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & symp_LRT_distress == 1  ~ 1,
                                  encounter_type == "outpatient" ~ 0))

ve.unadj.10 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_encounter) %>% 
 mutate(case = "LRT-hospitalizations", control = "not hospitalized")
ve.adj.10 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_encounter) %>%
 mutate(case = "LRT-hospitalizations", control = "not hospitalized")


###################################
# RSV+ hospitalization vs. RSV+ outpatient (case-only)
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1  ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.unadj.11 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity) %>% 
 mutate(case = "RSV+ hospitalized", control = "RSV+ outpatient")
ve.adj.11 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity) %>%
 mutate(case = "RSV+ hospitalized", control = "RSV+ outpatient")


###################################
# severe RSV+ hospitalization vs. RSV+ outpatient (case-only)
###################################
df.ve <- df %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) == 1  ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.unadj.12 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity) %>% 
 mutate(case = "severe RSV+ hospitalized", control = "RSV+ outpatient")
ve.adj.12 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity) %>%
 mutate(case = "severe RSV+ hospitalized", control = "RSV+ outpatient")





# combine the tables together 
rbind(
  ve.unadj.1, ve.unadj.2, ve.unadj.3, ve.unadj.4, ve.unadj.5,
  ve.unadj.6, ve.unadj.7, ve.unadj.8, ve.unadj.9, ve.unadj.10,
  ve.unadj.11, ve.unadj.12
) %>% 
  mutate(across(starts_with("ve"), ~ round(. * 100, 1))) %>%
  mutate(VE.unadjusted = paste0(ve_median, " (", ve_lb, "-", ve_ub, ")")) %>%
  dplyr::select(VE.unadjusted) %>% 
  cbind(
    rbind(
      ve.adj.1, ve.adj.2, ve.adj.3, ve.adj.4, ve.adj.5,
      ve.adj.6, ve.adj.7, ve.adj.8, ve.adj.9, ve.adj.10,
      ve.adj.11, ve.adj.12
    ) %>% 
  mutate(across(starts_with("ve"), ~ round(. * 100, 1))) %>%
  mutate(VE.adjusted = paste0(ve_median, " (", ve_lb, "-", ve_ub, ")")) %>%
  mutate(n_overall = paste0(n_overall, " (", n_overall_eff, ")"),
         n_cases = paste0(n_cases, " (", n_cases_eff, ")"),
         n_controls = paste0(n_controls, " (", n_controls_eff, ")")) %>%
  dplyr::select(case, control, n_overall, n_cases, n_controls, VE.adjusted) 
  ) %>% 
  dplyr::select(case, control, n_overall, n_cases, n_controls, VE.unadjusted, VE.adjusted) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20) 

```

<br>

### Look at how VE of mAb changes over time {.tabset}

#### Table `r tab.counter`  2 months interval
Why the unadjusted and adjusted are reversed? 
```{r warning=F}
tab.counter <- tab.counter + 1

####################
# Against infection
####################

df.wane <- df %>% mutate(case_control = positive_rsv) 

# unadjusted
model.unadj <- glm(case_control ~ days_btw_mab_collection_cat, data = df.wane, family = "binomial")


ve.median.unadj <- 1 - exp(model.unadj$coefficients[2:4])
ve.ub.unadj <- 1 - exp(confint(model.unadj)[,1][2:4])
ve.lb.unadj <- 1 - exp(confint(model.unadj)[,2][2:4])

# adjusted 
formula <- as.formula(paste0("case_control ~ days_btw_mab_collection_cat + ", 
                             paste(confounders_infection, collapse = " + ")))
model.adj <- glm(formula, data = df.wane, family = "binomial")
ve.median.adj <- 1 - exp(model.adj$coefficients[2:4])
ve.ub.adj <- 1 - exp(confint(model.adj)[,1][2:4])
ve.lb.adj <- 1 - exp(confint(model.adj)[,2][2:4])

n.cases.eff <- df.wane[, c("case_control", "days_btw_mab_collection_cat", confounders_infection)] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat)

n.controls.eff <- df.wane[, c("case_control", "days_btw_mab_collection_cat", confounders_infection)] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat)

n.overall.eff <- n.cases.eff + n.controls.eff

n.cases <-  df.wane[, c("case_control", "days_btw_mab_collection_cat")] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat)

n.controls <-  df.wane[, c("case_control", "days_btw_mab_collection_cat")] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat)

n.overall <- n.cases + n.controls 

ve.wane.2m.infection <- 
  data.frame(
  case_control = "RSV+ vs. RSV-",
  strata = c("immunized 0-2 months ago", "immuniaed 2-4 months ago", "immunized 4 months + ago"),
  n.overall = paste0(n.overall[,2], " (", n.overall.eff[,2], ")")[2:4],
  n.cases = paste0(n.cases[,2], " (", n.cases.eff[,2], ")")[2:4],
  n.controls = paste0(n.controls[,2], " (", n.controls.eff[,2], ")")[2:4],
  VE.unadjusted = paste0(round(ve.median.unadj*100,1), " (", round(ve.lb.unadj*100,1), "-", round(ve.ub.unadj*100,1), ")"),
  VE.adjusted = paste0(round(ve.median.adj*100,1), " (", round(ve.lb.adj*100,1), "-", round(ve.ub.adj*100,1), ")")
)


####################
# Against severity
####################

df.wane <- df %>% mutate(case_control = case_when(positive_rsv == 1 & encounter_type == "inpatient" ~ 1,
                                                  positive_rsv == 0 ~ 0)) 


# unadjusted
model.unadj <- glm(case_control ~ days_btw_mab_collection_cat, data = df.wane, family = "binomial")


ve.median.unadj <- 1 - exp(model.unadj$coefficients[2:4])
ve.ub.unadj <- 1 - exp(confint(model.unadj)[,1][2:4])
ve.lb.unadj <- 1 - exp(confint(model.unadj)[,2][2:4])

# adjusted 
formula <- as.formula(paste0("case_control ~ days_btw_mab_collection_cat + ", 
                             paste(confounders_severity_2, collapse = " + ")))
model.adj <- glm(formula, data = df.wane, family = "binomial")
ve.median.adj <- 1 - exp(model.adj$coefficients[2:4])
ve.ub.adj <- 1 - exp(confint(model.adj)[,1][2:4])
ve.lb.adj <- 1 - exp(confint(model.adj)[,2][2:4])

n.cases.eff <- df.wane[, c("case_control", "days_btw_mab_collection_cat", confounders_severity_2)] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat)

n.controls.eff <- df.wane[, c("case_control", "days_btw_mab_collection_cat", confounders_severity_2)] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat)

n.overall.eff <- n.cases.eff + n.controls.eff

n.cases <-  df.wane[, c("case_control", "days_btw_mab_collection_cat")] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat)

n.controls <-  df.wane[, c("case_control", "days_btw_mab_collection_cat")] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat)

n.overall <- n.cases + n.controls 

ve.wane.2m.severity <- 
  data.frame(
  case_control = "RSV+ hospitalization vs. RSV-",
  strata = c("immunized 0-2 months ago", "immuniaed 2-4 months ago", "immunized 4 months + ago"),
  n.overall = paste0(n.overall[,2], " (", n.overall.eff[,2], ")")[2:4],
  n.cases = paste0(n.cases[,2], " (", n.cases.eff[,2], ")")[2:4],
  n.controls = paste0(n.controls[,2], " (", n.controls.eff[,2], ")")[2:4],
  VE.unadjusted = paste0(round(ve.median.unadj*100,1), " (", round(ve.lb.unadj*100,1), "-", round(ve.ub.unadj*100,1), ")"),
  VE.adjusted = paste0(round(ve.median.adj*100,1), " (", round(ve.lb.adj*100,1), "-", round(ve.ub.adj*100,1), ")")
)

rbind(ve.wane.2m.infection, ve.wane.2m.severity) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20) 
```


#### Table `r tab.counter`  3 months interval
```{r warning=F}
tab.counter <- tab.counter + 1

####################
# Against infection
####################

df.wane <- df %>% mutate(case_control = positive_rsv) 


# unadjusted
model.unadj <- glm(case_control ~ days_btw_mab_collection_cat_2, data = df.wane, family = "binomial")


ve.median.unadj <- 1 - exp(model.unadj$coefficients[2:3])
ve.ub.unadj <- 1 - exp(confint(model.unadj)[,1][2:3])
ve.lb.unadj <- 1 - exp(confint(model.unadj)[,2][2:3])

# adjusted 
formula <- as.formula(paste0("case_control ~ days_btw_mab_collection_cat_2 + ", 
                             paste(confounders_infection, collapse = " + ")))
model.adj <- glm(formula, data = df.wane, family = "binomial")
ve.median.adj <- 1 - exp(model.adj$coefficients[2:3])
ve.ub.adj <- 1 - exp(confint(model.adj)[,1][2:3])
ve.lb.adj <- 1 - exp(confint(model.adj)[,2][2:3])

n.cases.eff <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2", confounders_infection)] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat_2)

n.controls.eff <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2", confounders_infection)] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat_2)

n.overall.eff <- n.cases.eff + n.controls.eff

n.cases <-  df.wane[, c("case_control", "days_btw_mab_collection_cat_2")] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat_2)

n.controls <-  df.wane[, c("case_control", "days_btw_mab_collection_cat_2")] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat_2)

n.overall <- n.cases + n.controls 

ve.wane.3m.infection <- 
  data.frame(
  case_control = "RSV+ vs. RSV-",
  strata = c("immunized 0-3 months ago", "immuniaed 3-6 months ago"),
  n.overall = paste0(n.overall[,2], " (", n.overall.eff[,2], ")")[2:3],
  n.cases = paste0(n.cases[,2], " (", n.cases.eff[,2], ")")[2:3],
  n.controls = paste0(n.controls[,2], " (", n.controls.eff[,2], ")")[2:3],
  VE.unadjusted = paste0(round(ve.median.unadj*100,1), " (", round(ve.lb.unadj*100,1), "-", round(ve.ub.unadj*100,1), ")"),
  VE.adjusted = paste0(round(ve.median.adj*100,1), " (", round(ve.lb.adj*100,1), "-", round(ve.ub.adj*100,1), ")")
)


####################
# Against severity
####################

df.wane <- df %>% mutate(case_control = case_when(positive_rsv == 1 & encounter_type == "inpatient" ~ 1,
                                                  positive_rsv == 0 ~ 0)) 


# unadjusted
model.unadj <- glm(case_control ~ days_btw_mab_collection_cat_2, data = df.wane, family = "binomial")


ve.median.unadj <- 1 - exp(model.unadj$coefficients[2:3])
ve.ub.unadj <- 1 - exp(confint(model.unadj)[,1][2:3])
ve.lb.unadj <- 1 - exp(confint(model.unadj)[,2][2:3])

# adjusted 
formula <- as.formula(paste0("case_control ~ days_btw_mab_collection_cat_2 + ", 
                             paste(confounders_severity_2, collapse = " + ")))
model.adj <- glm(formula, data = df.wane, family = "binomial")
ve.median.adj <- 1 - exp(model.adj$coefficients[2:3])
ve.ub.adj <- 1 - exp(confint(model.adj)[,1][2:3])
ve.lb.adj <- 1 - exp(confint(model.adj)[,2][2:3])

n.cases.eff <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2", confounders_severity_2)] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat_2)

n.controls.eff <- df.wane[, c("case_control", "days_btw_mab_collection_cat_2", confounders_severity_2)] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat_2)

n.overall.eff <- n.cases.eff + n.controls.eff

n.cases <-  df.wane[, c("case_control", "days_btw_mab_collection_cat_2")] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 1) %>% count(days_btw_mab_collection_cat_2)

n.controls <-  df.wane[, c("case_control", "days_btw_mab_collection_cat_2")] %>%
  filter(across(everything(), ~ !is.na(.))) %>% filter(case_control == 0) %>% count(days_btw_mab_collection_cat_2)

n.overall <- n.cases + n.controls 

ve.wane.3m.severity <- 
  data.frame(
  case_control = "RSV+ hospitalization vs. RSV-",
  strata = c("immunized 0-3 months ago", "immuniaed 3-6 months ago"),
  n.overall = paste0(n.overall[,2], " (", n.overall.eff[,2], ")")[2:3],
  n.cases = paste0(n.cases[,2], " (", n.cases.eff[,2], ")")[2:3],
  n.controls = paste0(n.controls[,2], " (", n.controls.eff[,2], ")")[2:3],
  VE.unadjusted = paste0(round(ve.median.unadj*100,1), " (", round(ve.lb.unadj*100,1), "-", round(ve.ub.unadj*100,1), ")"),
  VE.adjusted = paste0(round(ve.median.adj*100,1), " (", round(ve.lb.adj*100,1), "-", round(ve.ub.adj*100,1), ")")
)

rbind(ve.wane.3m.infection, ve.wane.3m.severity) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20) 
```

<br>

### Look at whether dosage has an influence on VE. {.tabset}

#### Table `r tab.counter` Compare infants who took 100mg and 50mg dosage  
```{r}
tab.counter <- tab.counter + 1

df_table1_dosage <- df_table1 %>%
  mutate(rsv_mab_dose = case_when(rsv_mab == "Yes, 100mg dose" ~ "100mg",
                                  rsv_mab == "Yes, 50mg dose" ~ "50mg")) %>%
  filter(!is.na(rsv_mab_dose))

table1_dosage <- df_table1_dosage %>% 
  dplyr::select(-rsv_mab, -encounter_type, -positive_rsv) %>%
  tbl_summary(by = rsv_mab_dose,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", 
                                               "{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                age_at_test_in_months_cat_2 ~ "Age at testing",
                month_when_tested_cat ~ "Time tested", 
                race_ethnicity ~ "Race and ethnicity",
                risk_factor_pulmonary ~ "Pulmonary diseases", 
                risk_factor_cardiac ~ "Cardiac diseases", 
                risk_factor_asthma ~ "Asthma", 
                risk_factor_anemia ~ "Anemia",
                risk_factor_gestagelessthan37wks ~ "Gestational age",
                risk_factor_atleastone ~ "Having at least one risk factor",
                insurance_type ~ "Insurance type",
                birth_weight ~ "Birth weight"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = "Inclusing Asian, Pacific Islander, Middle Eastern or Northern American, American Indian or Native American by self-reporting."
  )


table1_dosage %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 
  
```
#### Table `r tab.counter` VE by dosage (100mg vs. not vaccinated)
```{r warning=F}
tab.counter <- tab.counter + 1

df.100mg <- df %>% 
  mutate(rsv_mab = case_when(rsv_mab_dose == "100mg" ~ 1,
                             rsv_mab == 0 ~ 0))


###################################
# inpatient RSV+ vs. inpatient RSV-
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 ~ 1,
                                  encounter_type == "inpatient" & positive_rsv == 0 ~ 0))

ve.unadj.1 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (inpatient)", control = "RSV- (inpatient)")
ve.adj.1 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_infection) %>%
  mutate(case = "RSV+ (inpatient)", control = "RSV- (inpatient)")


###################################
# outpatient RSV+ vs. outpatient RSV-
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "outpatient" & positive_rsv == 1 ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 0 ~ 0))

ve.unadj.2 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (outpatient)", control = "RSV- (outpatient)")
ve.adj.2 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_infection) %>%
  mutate(case = "RSV+ (outpatient)", control = "RSV- (outpatient)")


###################################
# all RSV+ vs. all RSV-
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(positive_rsv == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.3 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (all)", control = "RSV- (all)")
ve.adj.3 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_infection) %>%
  mutate(case = "RSV+ (all)", control = "RSV- (all)")


###################################
# RSV+ hospitalized vs. all RSV- 
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.4 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ hospitalizations", control = "RSV- (all)")
ve.adj.4 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "RSV+ hospitalizations", control = "RSV- (all)")


###################################
# severe RSV+ hospitalized vs. all RSV- 
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.5 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ hospitalizations", control = "RSV- (all)")
ve.adj.5 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "severe RSV+ hospitalizations", control = "RSV- (all)")

###################################
# RSV+ icu vs. all RSV- 
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    (icu_admitted == "yes" ) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.6 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ ICU admission", control = "RSV- (all)")
ve.adj.6 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "RSV+ ICU admission", control = "RSV- (all)")

###################################
# RSV+ LRT-hospitalizations vs. all RSV- 
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    ( symp_LRT_distress == 1 ) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.7 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ LRT-hospitalizations", control = "RSV- (all)")
ve.adj.7 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "RSV+ LRT-hospitalizations", control = "RSV- (all)")


###################################
# severe RSV+ LRT-hospitalizations vs. all RSV- 
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    ( symp_LRT_distress == 1 ) &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.8 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ LRT-hospitalizations", control = "RSV- (all)")
ve.adj.8 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "severe RSV+ LRT-hospitalizations", control = "RSV- (all)")


###################################
# all-cause hospitalizations vs. outpatient  
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient"  ~ 1,
                                  encounter_type == "outpatient" ~ 0))

ve.unadj.9 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_encounter) %>% 
 mutate(case = "all-cause hospitalizations", control = "not hospitalized")
ve.adj.9 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_encounter) %>%
 mutate(case = "all-cause hospitalizations", control = "not hospitalized")

###################################
# LRT-hospitalizations vs. outpatient  
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & symp_LRT_distress == 1  ~ 1,
                                  encounter_type == "outpatient" ~ 0))

ve.unadj.10 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_encounter) %>% 
 mutate(case = "LRT-hospitalizations", control = "not hospitalized")
ve.adj.10 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_encounter) %>%
 mutate(case = "LRT-hospitalizations", control = "not hospitalized")

###################################
# RSV+ hospitalization vs. RSV+ outpatient (case-only)
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1  ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.unadj.11 <- regress_unmatch(df.ve = df.ve, adjusted = "no", confounders = confounders_severity) %>% 
 mutate(case = "RSV+ hospitalized", control = "RSV+ outpatient")
ve.adj.11 <- regress_unmatch(df.ve = df.ve, adjusted = "yes", confounders = confounders_severity) %>%
 mutate(case = "RSV+ hospitalized", control = "RSV+ outpatient")


###################################
# severe RSV+ hospitalization vs. RSV+ outpatient (case-only)
###################################
df.ve <- df.100mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) == 1  ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.unadj.12 <- regress_unmatch(df.ve = df.ve, adjusted = "no", confounders = confounders_severity) %>% 
 mutate(case = "severe RSV+ hospitalized", control = "RSV+ outpatient")
ve.adj.12 <- regress_unmatch(df.ve = df.ve, adjusted = "yes", confounders = confounders_severity) %>%
 mutate(case = "severe RSV+ hospitalized", control = "RSV+ outpatient")




# combine the tables together 
ve.100mg <- rbind(
  ve.unadj.1, ve.unadj.2, ve.unadj.3, ve.unadj.4, ve.unadj.5,
   ve.unadj.7, ve.unadj.8, ve.unadj.9, ve.unadj.10,
  ve.unadj.11, ve.unadj.12
) %>% 
  mutate(across(starts_with("ve"), ~ round(. * 100, 1))) %>%
  mutate(VE.unadjusted = paste0(ve_median, " (", ve_lb, "-", ve_ub, ")")) %>%
  dplyr::select(VE.unadjusted) %>% 
  cbind(
    rbind(
      ve.adj.1, ve.adj.2, ve.adj.3, ve.adj.4, ve.adj.5,
      ve.adj.7, ve.adj.8, ve.adj.9, ve.adj.10,
      ve.adj.11, ve.adj.12
    ) %>% 
  mutate(across(starts_with("ve"), ~ round(. * 100, 1))) %>%
  mutate(VE.adjusted = paste0(ve_median, " (", ve_lb, "-", ve_ub, ")")) %>%
  mutate(n_overall = paste0(n_overall, " (", n_overall_eff, ")"),
         n_cases = paste0(n_cases, " (", n_cases_eff, ")"),
         n_controls = paste0(n_controls, " (", n_controls_eff, ")")) %>%
  dplyr::select(case, control, n_overall, n_cases, n_controls, VE.adjusted) 
  ) %>%
  dplyr::select(case, control, n_overall, n_cases, n_controls, VE.unadjusted, VE.adjusted)

ve.100mg %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20) 
```

#### Table `r tab.counter` VE by dosage (50mg vs. not vaccinated)
```{r warning=F}
tab.counter <- tab.counter + 1

df.50mg <- df %>% 
  mutate(rsv_mab = case_when(rsv_mab_dose == "50mg" ~ 1,
                             rsv_mab == 0 ~ 0))


###################################
# inpatient RSV+ vs. inpatient RSV-
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 ~ 1,
                                  encounter_type == "inpatient" & positive_rsv == 0 ~ 0))

ve.unadj.1 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (inpatient)", control = "RSV- (inpatient)")
ve.adj.1 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_infection) %>%
  mutate(case = "RSV+ (inpatient)", control = "RSV- (inpatient)")


###################################
# outpatient RSV+ vs. outpatient RSV-
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "outpatient" & positive_rsv == 1 ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 0 ~ 0))

ve.unadj.2 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (outpatient)", control = "RSV- (outpatient)")
ve.adj.2 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_infection) %>%
  mutate(case = "RSV+ (outpatient)", control = "RSV- (outpatient)")


###################################
# all RSV+ vs. all RSV-
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(positive_rsv == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.3 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_infection) %>% 
 mutate(case = "RSV+ (all)", control = "RSV- (all)")
ve.adj.3 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_infection) %>%
  mutate(case = "RSV+ (all)", control = "RSV- (all)")


###################################
# RSV+ hospitalized vs. all RSV- 
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.4 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ hospitalizations", control = "RSV- (all)")
ve.adj.4 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "RSV+ hospitalizations", control = "RSV- (all)")


###################################
# severe RSV+ hospitalized vs. all RSV- 
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.5 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ hospitalizations", control = "RSV- (all)")
ve.adj.5 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "severe RSV+ hospitalizations", control = "RSV- (all)")

###################################
# RSV+ icu vs. all RSV- 
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    (icu_admitted == "yes" ) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.6 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ ICU admission", control = "RSV- (all)")
ve.adj.6 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "RSV+ ICU admission", control = "RSV- (all)")

###################################
# RSV+ LRT-hospitalizations vs. all RSV- 
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    ( symp_LRT_distress == 1 ) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.7 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "RSV+ LRT-hospitalizations", control = "RSV- (all)")
ve.adj.7 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "RSV+ LRT-hospitalizations", control = "RSV- (all)")


###################################
# severe RSV+ LRT-hospitalizations vs. all RSV- 
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1 &
                                    ( symp_LRT_distress == 1 ) &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) ~ 1,
                                  positive_rsv == 0 ~ 0))

ve.unadj.8 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_severity_2) %>% 
 mutate(case = "severe RSV+ LRT-hospitalizations", control = "RSV- (all)")
ve.adj.8 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_severity_2) %>%
 mutate(case = "severe RSV+ LRT-hospitalizations", control = "RSV- (all)")


###################################
# all-cause hospitalizations vs. outpatient  
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient"  ~ 1,
                                  encounter_type == "outpatient" ~ 0))

ve.unadj.9 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_encounter) %>% 
 mutate(case = "all-cause hospitalizations", control = "not hospitalized")
ve.adj.9 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_encounter) %>%
 mutate(case = "all-cause hospitalizations", control = "not hospitalized")

###################################
# LRT-hospitalizations vs. outpatient  
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & symp_LRT_distress == 1  ~ 1,
                                  encounter_type == "outpatient" ~ 0))

ve.unadj.10 <- regress_unmatch(df.ve = df.ve,adjusted = "no", confounders = confounders_encounter) %>% 
 mutate(case = "LRT-hospitalizations", control = "not hospitalized")
ve.adj.10 <- regress_unmatch(df.ve = df.ve,adjusted = "yes", confounders = confounders_encounter) %>%
 mutate(case = "LRT-hospitalizations", control = "not hospitalized")

###################################
# RSV+ hospitalization vs. RSV+ outpatient (case-only)
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv == 1  ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.unadj.11 <- regress_unmatch(df.ve = df.ve, adjusted = "no", confounders = confounders_severity) %>% 
 mutate(case = "RSV+ hospitalized", control = "RSV+ outpatient")
ve.adj.11 <- regress_unmatch(df.ve = df.ve, adjusted = "yes", confounders = confounders_severity) %>%
 mutate(case = "RSV+ hospitalized", control = "RSV+ outpatient")


###################################
# severe RSV+ hospitalization vs. RSV+ outpatient (case-only)
###################################
df.ve <- df.50mg %>% 
  mutate(case_control = case_when(encounter_type == "inpatient" & positive_rsv &
                                    (icu_admitted == "yes" | highflow_oxygen == 1) == 1  ~ 1,
                                  encounter_type == "outpatient" & positive_rsv == 1 ~ 0))

ve.unadj.12 <- regress_unmatch(df.ve = df.ve, adjusted = "no", confounders = confounders_severity) %>% 
 mutate(case = "severe RSV+ hospitalized", control = "RSV+ outpatient")
ve.adj.12 <- regress_unmatch(df.ve = df.ve, adjusted = "yes", confounders = confounders_severity) %>%
 mutate(case = "severe RSV+ hospitalized", control = "RSV+ outpatient")




# combine the tables together 
ve.50mg <- rbind(
  ve.unadj.1, ve.unadj.2, ve.unadj.3, ve.unadj.4, ve.unadj.5,
   ve.unadj.7, ve.unadj.8, ve.unadj.9, ve.unadj.10,
  ve.unadj.11, ve.unadj.12
) %>% 
  mutate(across(starts_with("ve"), ~ round(. * 100, 1))) %>%
  mutate(VE.unadjusted = paste0(ve_median, " (", ve_lb, "-", ve_ub, ")")) %>%
  dplyr::select(VE.unadjusted) %>% 
  cbind(
    rbind(
      ve.adj.1, ve.adj.2, ve.adj.3, ve.adj.4, ve.adj.5,
      ve.adj.7, ve.adj.8, ve.adj.9, ve.adj.10,
      ve.adj.11, ve.adj.12
    ) %>% 
  mutate(across(starts_with("ve"), ~ round(. * 100, 1))) %>%
  mutate(VE.adjusted = paste0(ve_median, " (", ve_lb, "-", ve_ub, ")")) %>%
  mutate(n_overall = paste0(n_overall, " (", n_overall_eff, ")"),
         n_cases = paste0(n_cases, " (", n_cases_eff, ")"),
         n_controls = paste0(n_controls, " (", n_controls_eff, ")")) %>%
  dplyr::select(case, control, n_overall, n_cases, n_controls, VE.adjusted) 
  ) %>%
  dplyr::select(case, control, n_overall, n_cases, n_controls, VE.unadjusted, VE.adjusted)

ve.50mg %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20) 
```

#### Table `r tab.counter`. Compare VE from 50mg and 100mg dosage
```{r}
tab.counter <- tab.counter + 1

ve.50mg %>% 
  dplyr::select(case, control, VE.unadjusted, VE.adjusted) %>%
  rename(VE.unadjusted.50mg = VE.unadjusted, VE.adjusted.50mg = VE.adjusted) %>%
  left_join(
    ve.100mg %>% 
  dplyr::select(case, control, VE.unadjusted, VE.adjusted) %>%
  rename(VE.unadjusted.100mg = VE.unadjusted, VE.adjusted.100mg = VE.adjusted)
  ) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T,  defaultPageSize = 20,
           columnGroups = list(
    colGroup(name = "100mg", columns = c("VE.unadjusted.100mg", "VE.adjusted.100mg")),
    colGroup(name = "50mg", columns = c("VE.unadjusted.50mg", "VE.adjusted.50mg"))
  ),
  columns = list(
    VE.unadjusted.100mg = colDef(name = "VE.unadjusted"),
    VE.adjusted.100mg= colDef(name = "VE.adjusted"),
    VE.unadjusted.50mg = colDef(name = "VE.unadjusted"),
    VE.adjusted.50mg = colDef(name = "VE.adjusted")
  ))
```

<br>









