---
title: "VE of Nirsevimab"
output: 
  html_document:
    toc: true
    toc_float: true
---

#### Date: `r Sys.Date()`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(dplyr)
library(tidyr)
library(tidyverse)
library(readxl)
library(writexl)
library(reactable)
library(ggplot2)
library(stringr)
library(flextable)
library(lubridate)
library(MASS)
library(smd)


library(gtsummary) # for table 1
library(multcomp)
library(survival) # for matched case-control

fig.counter <- 1
tab.counter <- 1

source("utils_mAb_VE.R")

savenewplot <- FALSE
```


```{r}
# read in dataset
df <- read.csv("../data/clean_data/df.mab.csv") %>% 
  mutate(collection_date = as.Date(collection_date))
colnames <- as.data.frame(colnames(df))

# add some variables 
df <- process_df(df)
```


### There are totally `r nrow(df)` testing records in the analysis dataset. 

### Figure `r fig.counter`. Look at distribution of testing by time 
```{r, fig.width = 8, fig.height = 4}
fig.counter <- fig.counter + 1

plt.collection.date <- 
  df %>% 
  filter(collection_date >= as.Date("2023-10-1")) %>%
  mutate(positive_rsv = ifelse(positive_rsv == 1, "Case", "Control")) %>%
  mutate(positive_rsv = factor(positive_rsv, levels = c("Control", "Case"))) %>%
  ggplot() +
  geom_histogram(aes(x = collection_date, fill = factor(positive_rsv)), color = "black",
                 binwidth = 7) +
  scale_x_date(date_breaks = "1 month", date_labels = "%Y-%m",
               limits = as.Date(c("2023-9-30", "2024-05-14"))) +
  theme_classic() +
  xlab("Time of sample collection for RSV test") +
  ylab("Number of RSV test records")  +
  labs(fill = "Case status") +
  scale_fill_brewer(palette = "Set2") +
  geom_vline(xintercept = as.Date("2023-10-1"), linetype = "dashed")  +
  geom_text(aes(x = as.Date("2023-10-5"), y = 140, vjust = 0.8,
                label = "Nirsevimab \nadministration\n started"), 
            angle = 90, size = 3.5, fontface = "plain", 
            check_overlap = TRUE, lineheight = 0.75) +
  theme(legend.position = "top")


plt.collection.date
  
if(savenewplot){
  ggsave(plot = plt.collection.date, filename = "../figs_tabs/figures/plt.collection.date.pdf", height = 4, width = 8)
}
```

<br>

### Figure `r fig.counter`. Let's look at the distribution of immunization date, and see why coverage is so low?
```{r}
fig.counter <- fig.counter + 1

plt.vax.time <- 
  df %>% 
  mutate(mab_date = as.Date(mab_date)) %>%
  ggplot() +
  geom_histogram(aes(x = mab_date), color = "black", fill = "white", binwidth = 7) +
  scale_x_date(date_breaks = "1 month", date_labels = "%Y-%m") + 
  theme_classic() +
  xlab("Time of nirsevimab immunization") +
  ylab("Count")  +
  geom_vline(xintercept = as.Date("2023-10-1"), linetype = "dashed")  +
  geom_text(aes(x = as.Date("2023-10-5"), y = 35, vjust = 0.8, lineheight = 0.75,
                label = "Nirsevimab \nadministration \nstarted"), 
            angle = 90, size = 3.5, fontface = "plain", check_overlap = TRUE) +
  scale_x_date(date_breaks = "1 month", date_labels = "%Y-%m",
               limits = as.Date(c("2023-9-30", "2024-05-14"))) +
  theme(legend.position = "top")


plt.vax.time

if(savenewplot){
  ggsave(plot = plt.vax.time, filename = "../figs_tabs/figures/plt.vax.time.pdf", height = 4, width = 8)
}
```

### combine the above two plots in one figure
```{r, fig.width = 8, fig.height = 8}
plt.collection.vaxtime <- plot_grid(plt.collection.date, plt.vax.time,
          labels = c("A.", "B."), 
          ncol = 1, align = "v", rel_heights = c(4:3))

plt.collection.vaxtime

if(savenewplot){
  ggsave(plot = plt.collection.vaxtime, filename = "../figs_tabs/figures/plt.collection.vaxtime.pdf", height = 8, width = 8)
}

```




<br>


### Look at the risk factors {.tabset}

#### Table `r tab.counter`  Each risk factor
```{r}
tab.counter <- tab.counter + 1

data.frame(
  anemia = nrow(df %>% filter(risk_factor_anemia == "yes")),
  blood = nrow(df %>% filter(risk_factor_blood == "yes")),
  immunodeficiency = nrow(df %>% filter(risk_factor_immunodeficiency == "yes")),
  cardiac = nrow(df %>% filter(risk_factor_cardiac == "yes")),
  pulmonary_disease = nrow(df %>% filter(risk_factor_pulmonary == "yes")),
  down_syndrome = nrow(df %>% filter(risk_factor_down == "yes")),
  small_for_gestage = nrow(df %>% filter(risk_factor_small_for_gestage == 1)),
  gestage_lessthan37wks = nrow(df %>% filter(risk_factor_gestagelessthan37wks == 1))
) %>%
  pivot_longer(cols = 1:8, names_to = "risk_factor", values_to = "n_records") %>%
  arrange(desc(n_records)) %>%
  mutate(perc = round(n_records / nrow(df)*100,1)) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

```

<br>


#### Table `r tab.counter` At least one risk factor 
```{r}
tab.counter <- tab.counter + 1

df %>% count(risk_factor_atleastone) %>%
 mutate(perc = round(n / nrow(df)*100,1)) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))


# filter out those with at least one risk factor 
# a <- df %>% filter(risk_factor_atleastone == "yes") %>% 
#   dplyr::select(StudyID, collection_date, positive_rsv, rsv_mab,
#                 starts_with("risk_factor"))

# write csv for checking
# write.csv(a, "../data/data_to_check/atleastoneriskfactor.csv", row.names = F)
```



<br>

### Table `r tab.counter`. Characteristic of study population (testing level) {.tabset}
  * this is assuming that: if mAb was taken before collection date, we count it as immunized. For SSA, need to change it to: if the person took mAb more than X days before sample collection, we count it as immunized.
  * we look at different pairs of case and control here (mainly to see which ones should be confounders).

#### RSV+ vs. RSV-
```{r}
tab.counter <- tab.counter + 1

df_table1 <- df %>%
  # add dose of mab 
  mutate(rsv_mab = case_when(rsv_mab_detailed == "100mg before collection" ~ "Yes, 100mg dose",
                             rsv_mab_detailed == "50mg before collection" ~ "Yes, 50mg dose",
                             TRUE ~ "No")) %>%
  mutate(risk_factor_gestagelessthan37wks = case_when(
    risk_factor_gestagelessthan37wks == 1 ~ "Less than 37 weeks",
    risk_factor_gestagelessthan37wks == 0 ~ "37 weeks or more"
  )) %>% 
  dplyr::select(positive_rsv,Sex, age_at_test_in_months, age_at_test_in_months_cat_2, race_ethnicity, birth_weight, insurance_type, rsv_mab, month_when_tested_cat, encounter_type, 
                # risk factors (main ones that are >= 5% prevalence)
                risk_factor_pulmonary, risk_factor_cardiac, risk_factor_asthma, risk_factor_anemia,
                risk_factor_gestagelessthan37wks,
                risk_factor_atleastone,
                symp_LRT_distress) %>% 
  mutate(positive_rsv = case_when(positive_rsv == 1 ~ "Cases",
                                  positive_rsv == 0 ~ "Controls")) %>%
  # to display the missing, making the NA value explicit level of factor 
  mutate(across(c(positive_rsv,
                  Sex, race_ethnicity, insurance_type, rsv_mab, 
                risk_factor_atleastone, risk_factor_gestagelessthan37wks), ~ factor(.) %>% forcats::fct_explicit_na())) %>% 
  # re-rank variables 
  dplyr::select(positive_rsv, 
                Sex, age_at_test_in_months, age_at_test_in_months_cat_2, 
                month_when_tested_cat,
                race_ethnicity, 
                birth_weight,
                risk_factor_gestagelessthan37wks,
                risk_factor_pulmonary, risk_factor_cardiac, risk_factor_anemia,
                risk_factor_atleastone,  insurance_type, rsv_mab, 
                encounter_type, 
                symp_LRT_distress)

df_table1_infection <- df_table1 %>% dplyr::select(-encounter_type, -symp_LRT_distress)

# footnotes 
footnote_otherraces <- "Inclusing Asian, Pacific Islander, Middle Eastern or Northern American, American Indian or Native American by self-reporting."
footnote_atleastoneriskfactor <- "Have at least one of the following conditions recorded in the infant's medical history or diagnosis records: 1) Anemia; 2) Immunodeficiency (e.g. transplantation history, leukemia, etc.); 3) Cardiac diseases (including congenital heart diseases diagnosed at birth or any reporting of heart conditions); 4) Pulmonary diseases; 5) Down syndrome; 6) Small for gestational age (birth weight < 2,500 grams); 7) Prematurity (gestational age less than 37 weeks)."


table1_infection <- df_table1_infection %>% 
  tbl_summary(by = positive_rsv,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", 
                                               "{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                age_at_test_in_months_cat_2 ~ "Age at testing",
                month_when_tested_cat ~ "Time tested", 
                race_ethnicity ~ "Race and ethnicity",
                risk_factor_pulmonary ~ "Pulmonary diseases", 
                risk_factor_cardiac ~ "Cardiac diseases", 
                risk_factor_anemia ~ "Anemia",
                risk_factor_gestagelessthan37wks ~ "Gestational age",
                risk_factor_atleastone ~ "Having at least one risk factor",
                insurance_type ~ "Insurance type",
                rsv_mab ~ "mAb status",
                birth_weight ~ "Birth weight"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  #add_difference(everything() ~ "smd") %>%
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = footnote_otherraces
                 ) %>%
  modify_table_styling(
    columns = label,
    rows = label == "Having at least one risk factor",
    footnote = footnote_atleastoneriskfactor
  )
  


table1_infection %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 
  
if(savenewplot){
  table1_infection %>%
    as_gt() %>%
    gt::gtsave(filename = "../figs_tabs/tables/table1_characteristics.docx")
}
```



<br>

### Clinical outcomes {.tabset}

####  Table `r tab.counter`.
Here we filtered out only the cases (RSV+) and compare between vaccinated and unvaccinated.
```{r}
tab.counter <- tab.counter + 1

df_table1_outcome <- df %>%
  # mutate(rsv_mab = case_when(rsv_mab_detailed == "100mg before collection" ~ "100mg dose",
  #                            rsv_mab_detailed == "50mg before collection" ~ "50mg dose",
  #                            TRUE ~ "Not vaccinated")) %>%
  mutate(rsv_mab = ifelse(rsv_mab == 1, "Vaccinated", "Unvaccinated")) %>%
  mutate(encounter_type = case_when(encounter_type %in% c("inpatient_unrelated", "outpatient") ~ "no",
                                    encounter_type == "inpatient" ~ "yes")) %>%
  mutate(icu_admitted = case_when(icu_admitted %in% c("yes_unrelated", "no") ~ "no",
                                  TRUE ~ "yes")) %>%
  mutate(hosp_los = ifelse(encounter_type == "no", NA, hosp_los)) %>%
  mutate(icu_los_days = ifelse(icu_admitted == "no", NA, icu_los_days)) %>%
  mutate(highflow_oxygen = case_when(highflow_oxygen == 1 ~ "yes",
                                     TRUE ~ "no")) %>% 
  mutate(across(starts_with("symp_"), ~ ifelse(is.na(.), "no", "yes"))) %>%
  mutate(positive_rsv = case_when(positive_rsv == 1 ~ "RSV+",
                                  positive_rsv == 0 ~ "RSV-")) %>%
  # to display the missing, making the NA value explicit level of factor 
  mutate(across(c(positive_rsv,
                   rsv_mab), ~ factor(.) %>% forcats::fct_explicit_na())) %>% 
  # re-rank variables 
  dplyr::select(rsv_mab, positive_rsv, 
                encounter_type, hosp_los, icu_admitted, icu_los_days, highflow_oxygen,
                starts_with("symp_")) %>%
  filter(positive_rsv == "RSV+") %>% 
  dplyr::select(-positive_rsv)



table1_outcome <- df_table1_outcome %>% 
  tbl_summary(by = rsv_mab,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                encounter_type = "Hospital admission",
                hosp_los = "Duration of hospitalization (days)",
                icu_admitted = "ICU admission",
                icu_los_days = "Duration of ICU admission (days)",
                highflow_oxygen = "Required highflow oxygen support",
                symp_URT_distress = "Distress in URT",
                symp_LRT_distress = "Distress in LRT",
                symp_fever = "Fever (> 38°C/100.4°F)",
                symp_cough = "Cough",
                symp_wheezing = "Wheezing",
                symp_breathing = "Breathing difficulties",
                symp_bronchiolitis = "Bronchiolitis",
                symp_sepsis = "Sepsis"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  #add_difference(everything() ~ "smd") %>%
  #add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = footnote_otherraces
  ) %>%
   modify_table_styling(
    columns = label,
    rows = label == "Having at least one risk factor",
    footnote = footnote_atleastoneriskfactor
  )


table1_outcome %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 

if(savenewplot){
  table1_outcome %>%
    as_gt() %>%
    gt::gtsave(filename = "../figs_tabs/tables/table2_clinical_outcomes.docx")
}
```

<br>

### compare between immunized vs. unimmunized
#### RSV+ vs. RSV-
```{r}
tab.counter <- tab.counter + 1

df_table1_immunize <- df_table1 %>% dplyr::select(-encounter_type, -symp_LRT_distress) %>% 
  mutate(rsv_mab_simple = ifelse(rsv_mab == "No", "Unimmunized", "Immunized"))


table1_immunize <- df_table1_immunize %>% 
  tbl_summary(by = rsv_mab_simple,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", 
                                               "{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                age_at_test_in_months_cat_2 ~ "Age at testing",
                month_when_tested_cat ~ "Time tested", 
                race_ethnicity ~ "Race and ethnicity",
                risk_factor_pulmonary ~ "Pulmonary diseases", 
                risk_factor_cardiac ~ "Cardiac diseases", 
                risk_factor_anemia ~ "Anemia",
                risk_factor_gestagelessthan37wks ~ "Gestational age",
                risk_factor_atleastone ~ "Having at least one risk factor",
                insurance_type ~ "Insurance type",
                birth_weight ~ "Birth weight"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  #add_difference(everything() ~ "smd") %>%
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = footnote_otherraces
                 ) %>%
  modify_table_styling(
    columns = label,
    rows = label == "Having at least one risk factor",
    footnote = footnote_atleastoneriskfactor
  )
  


table1_immunize %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 
  
if(savenewplot){
  table1_immunize %>%
    as_gt() %>%
    gt::gtsave(filename = "../figs_tabs/tables/table1_immunize.docx")
}
```


From table1, there are four variables that are significantly different between the case and control (p < 0.05): age tested, month tested, premature (gestage < 37wk), birth weight. But because this is collinearity between prematurity and birth weight, only included one into the model. Because there is less missing in prematurity variable, thus included this instead of birth weight.
```{r}
library(corrplot)
library(car)


df.cor <- df %>% dplyr::select(
  positive_rsv,
  rsv_mab,
  age_at_test_in_months_cat_2, # 3-month interval
  month_when_tested_cat,
  race_ethnicity,
  birth_weight,
  risk_factor_gestagelessthan37wks,
  risk_factor_atleastone,
  insurance_type
) 
  
df.M <- df.cor %>% 
  dplyr::select(-positive_rsv, -rsv_mab) %>%
  mutate(age_at_test_in_months_cat_2 = case_when(age_at_test_in_months_cat_2 == "under 3m" ~ 1,
                                                 age_at_test_in_months_cat_2 == "3-6m" ~ 2,
                                                 age_at_test_in_months_cat_2 == "6-9m" ~ 3,
                                                 age_at_test_in_months_cat_2 == "9-12m" ~ 4,
                                                 age_at_test_in_months_cat_2 == "above 1 yo" ~ 5)) %>%
  mutate(month_when_tested_cat = case_when(month_when_tested_cat == "Oct-Nov" ~ 1,
                                           month_when_tested_cat == "Dec-Jan" ~ 2,
                                           month_when_tested_cat == "Feb-Mar" ~ 3,
                                           month_when_tested_cat == "April and after" ~ 4)) %>%
  mutate(insurance_type = case_when(insurance_type == "private" ~ 1, 
                                    insurance_type == "public" ~ 2,
                                    insurance_type == "uninsured" ~ 3)) %>%
  mutate(race_ethnicity = case_when(race_ethnicity == "Hispanic" ~ 1,
                                    race_ethnicity == "White non-Hispanic" ~ 2,
                                    race_ethnicity == "Black non-Hispanic" ~ 3,
                                    race_ethnicity == "Other non-Hispanic" ~ 4,
                                    race_ethnicity == "unknown" ~5 )) %>%
  mutate(risk_factor_atleastone = ifelse(risk_factor_atleastone == "yes", 1, 0)) %>%
  rename(`Age tested` = age_at_test_in_months_cat_2,
         `Month tested` = month_when_tested_cat,
         `Birth weight` = birth_weight, 
         `Prematurity` = risk_factor_gestagelessthan37wks,
         `Race` = race_ethnicity,
         `>=1 risk factor` = risk_factor_atleastone,
         `Insurance type` = insurance_type)

M <- cor(df.M, use = "complete.obs")
pdf(file = "../figs_tabs/figures/corr.pdf", width = 5, height = 5)
corrplot(M, method = 'number') # thus prematurity and small for gest age are correlated
dev.off()

M.removebw <- cor(df.M %>% dplyr::select(-`Birth weight`, -Prematurity), use = "complete.obs")
pdf(file = "../figs_tabs/figures/corr_removebw.pdf", width = 5, height = 5)
corrplot(M.removebw, method = 'number', tl.col = "black") # thus prematurity and small for gest age are correlated
dev.off()


pdf(file = "../figs_tabs/figures/corr_comb.pdf", width = 10, height = 5)
par(mfrow=c(1,2))
corrplot(M, method = 'number', tl.col = "black")
mtext("A.", at = 0, line = 0, cex=2)
corrplot(M.removebw, method = 'number', tl.col = "black")
mtext("B.", at = 0, line = 0, cex=2)
dev.off()

```


<br>

```{r}
# recode symp_LRT_distress to have 1 and 0 (previously 1 and NA, will create some issue when counting records in analysis)
df <- df %>%
  mutate(symp_LRT_distress = ifelse(is.na(symp_LRT_distress), 0, 1))

# for the missing value in gest age cat, change the NA --> 999
df <- df %>% 
  mutate(risk_factor_gestagelessthan37wks = ifelse(is.na(risk_factor_gestagelessthan37wks), 999, risk_factor_gestagelessthan37wks))
```


### Selection of confounders included in the adjusted model {.tabset}
Using stepwise (both directions) to select the model using AIC

#### RSV infection
```{r echo=T}
temp <- df 

all_confounders <- c(
  "age_at_test_in_months_cat_2", # 3-month interval
  "month_when_tested_cat",
  "race_ethnicity",
  #"risk_factor_gestagelessthan37wks",
  "risk_factor_atleastone",
  "insurance_type"
)
 
formula <- as.formula(paste(c("positive_rsv ~ rsv_mab", all_confounders), collapse = " + ")) 
full.model <- glm(formula, data = temp, family = "binomial")
step.model <- stepAIC(full.model, 
                      scope = list(lower = ~ rsv_mab + age_at_test_in_months_cat_2 + month_when_tested_cat,
                                   upper = formula),
                      direction = "backward", trace = FALSE)
confounders_infection <- c(
  "age_at_test_in_months_cat_2", # 3-month interval
  "month_when_tested_cat"
)
step.model$anova

aic.infection <- as.data.frame(step.model$anova) %>% dplyr::select(Step, AIC) %>% 
  mutate(endpoint = "Medically attended RSV infection") %>% 
  mutate(Step = ifelse(Step == "", str_replace(as.character(formula[3]), "rsv_mab \\+ ", ""), Step)) %>% 
  rename(Confounders = Step)
```

#### ED visit as outcome
```{r echo=T}
temp <- df %>% filter(encounter_type == "outpatient")
full.model <- glm(formula, data = temp, family = "binomial")
step.model <- stepAIC(full.model, 
                      scope = list(lower = ~ rsv_mab + age_at_test_in_months_cat_2 + month_when_tested_cat,
                                   upper = formula),
                      direction = "backward", trace = FALSE)
confounders_ed <- c(
  "age_at_test_in_months_cat_2", # 3-month interval
  "month_when_tested_cat"
)
step.model$anova

aic.ed <- as.data.frame(step.model$anova) %>% dplyr::select(Step, AIC) %>% 
  mutate(endpoint = "RSV-associated outpatient visit") %>% 
  mutate(Step = ifelse(Step == "", str_replace(as.character(formula[3]), "rsv_mab \\+ ", ""), Step)) %>% 
  rename(Confounders = Step)
```

#### inpatient as outcome 
```{r echo=T}
temp <- df %>% filter(encounter_type == "inpatient")
full.model <- glm(formula, data = temp, family = "binomial")
step.model <- stepAIC(full.model, 
                      scope = list(lower = ~ rsv_mab + age_at_test_in_months_cat_2 + month_when_tested_cat,
                                   upper = formula),
                      direction = "backward", trace = FALSE)
confounders_inpatient <- c(
  "age_at_test_in_months_cat_2", # 3-month interval
  "month_when_tested_cat",
  "risk_factor_atleastone"
)
step.model$anova

aic.inpatient <- as.data.frame(step.model$anova) %>% dplyr::select(Step, AIC) %>% 
  mutate(endpoint = "RSV-associated hospitalization") %>% 
  mutate(Step = ifelse(Step == "", str_replace(as.character(formula[3]), "rsv_mab \\+ ", ""), Step)) %>% 
  rename(Confounders = Step)
```

#### severe presentations as outcome
```{r echo=T}
temp <- df %>% filter(icu_admitted == "yes" | highflow_oxygen == 1)
full.model <- glm(formula, data = temp, family = "binomial")
step.model <- stepAIC(full.model, 
                      scope = list(lower = ~ rsv_mab + age_at_test_in_months_cat_2 + month_when_tested_cat,
                                   upper = formula),
                      direction = "backward", trace = FALSE)
confounders_severe <- c(
  "age_at_test_in_months_cat_2", # 3-month interval
  "month_when_tested_cat",
  "risk_factor_atleastone"
)
step.model$anova

aic.severe <- as.data.frame(step.model$anova) %>% dplyr::select(Step, AIC) %>% 
  mutate(endpoint = "RSV-associated severe outcomes") %>% 
  mutate(Step = ifelse(Step == "", str_replace(as.character(formula[3]), "rsv_mab \\+ ", ""), Step)) %>% 
  rename(Confounders = Step)
```

#### LRTI
```{r echo=T}
temp <- df %>% filter(symp_LRT_distress == 1)
full.model <- glm(formula, data = temp, family = "binomial")
step.model <- stepAIC(full.model, 
                      scope = list(lower = ~ rsv_mab + age_at_test_in_months_cat_2 + month_when_tested_cat,
                                   upper = formula),
                      direction = "backward", trace = FALSE)
confounders_LRTI <- c(
  "age_at_test_in_months_cat_2", # 3-month interval
  "month_when_tested_cat",
  "risk_factor_atleastone"
)
step.model$anova

aic.LRTI <- as.data.frame(step.model$anova) %>% dplyr::select(Step, AIC) %>% 
  mutate(endpoint = "RSV-associated LRTI") %>% 
  mutate(Step = ifelse(Step == "", str_replace(as.character(formula[3]), "rsv_mab \\+ ", ""), Step)) %>% 
  rename(Confounders = Step)
```

#### LRTI hospitalizations
```{r echo=T}
temp <- df %>% filter(symp_LRT_distress == 1 & encounter_type == "inpatient")
full.model <- glm(formula, data = temp, family = "binomial")
step.model <- stepAIC(full.model, 
                      scope = list(lower = ~ rsv_mab + age_at_test_in_months_cat_2 + month_when_tested_cat,
                                   upper = formula),
                      direction = "backward", trace = FALSE)
confounders_LRTIhosp <- c(
  "age_at_test_in_months_cat_2", # 3-month interval
  "month_when_tested_cat",
  "risk_factor_atleastone"
)
step.model$anova

aic.LRTIhosp <- as.data.frame(step.model$anova) %>% dplyr::select(Step, AIC) %>% 
  mutate(endpoint = "RSV-associated LRTI hospitalization") %>% 
  mutate(Step = ifelse(Step == "", str_replace(as.character(formula[3]), "rsv_mab \\+ ", ""), Step)) %>% 
  rename(Confounders = Step)
```

#### save the AIC comparison in the backward selection process for each outcome 
```{r}
tab.aic <- 
  rbind(aic.infection,
      aic.ed,
      aic.inpatient,
      aic.severe, 
      aic.LRTI, 
      aic.LRTIhosp) %>%
  mutate(AIC = round(AIC,1)) %>%
  dplyr::select(endpoint, Confounders, AIC) %>%
  # rename some confounders
  mutate(Confounders = str_replace(Confounders, "age_at_test_in_months_cat_2", "age_tested")) %>%
  mutate(Confounders = str_replace(Confounders, "month_when_tested_cat", "month_tested")) %>%
  mutate(Confounders = str_replace(Confounders, "risk_factor_gestagelessthan37wks", "prematurity")) %>%
  mutate(Confounders = str_replace(Confounders, "risk_factor_atleastone", "atleastone_risk_factor")) %>%
  flextable() %>%
  width(j = 1, width = 2) %>%
  width(j = 2, width = 6) %>%
  merge_at(j = 1, i = 1:4) %>%
  merge_at(j = 1, i = 5:8) %>%
  merge_at(j = 1, i = 9:11) %>%
  merge_at(j = 1, i = 12:14) %>%
  merge_at(j = 1, i = 15:17) %>%
  merge_at(j = 1, i = 18:20) %>%
  vline() %>%
  hline()
  
tab.aic

if(savenewplot){
  save_as_docx(tab.aic, path = "../figs_tabs/tables/AIC.docx")
}

```

<br>

### Table `r tab.counter`. Effectiveness of Nirsevimab {.tabset}
##### Here, I pooled all the cases and controls together, to estimate the VE for different pairs of case and control definitions.
  * Columns n_overall, n_cases, n_controls are numbers of individuals were sample size used in the analysis. 
    + The sample size outside the parenthesis is the sample size that contributes to estimates of **unadjusted** effectiveness in the logistic regression models.
    + The sample size inside the parenthesis is the sample size that effectively contributes to estimates of **adjusted** effectiveness in the logistic regression models.
    + look at nirsevimab's effectiveness against: 
      + RSV infection 
      + RSV-associated ED visit (outpatient)
      + RSV-associated hospitalizations
      + RSV-associated LRTI
      + RSV-associated LRTI hospitalizations
      + RSV-associated ICU admissions
      + RSV-associated severe disease
     
#### Table `r tab.counter`. 
```{r warning=F}
tab.counter <- tab.counter + 1
##########################
# Against RSV infection (inpatient + outpatient)
##########################
df.ve <- df %>% mutate(case_control = positive_rsv)

ve.1 <- regress_unmatch(df.ve = df.ve, confounders = confounders_infection) %>% 
 mutate(against = "Medically attended RSV infection")


##########################
# Against RSV hospitalizations
##########################
df.ve <- df %>% 
  filter(encounter_type == "inpatient") %>% mutate(case_control = positive_rsv)

ve.2 <- regress_unmatch(df.ve = df.ve, confounders = confounders_inpatient) %>% 
 mutate(against = "RSV-associated hospitalization")


##########################
# Against RSV ED visit
##########################
# remove those "Specimen"? 
df.ve <- df %>% 
  filter(encounter_type == "outpatient") %>% mutate(case_control = positive_rsv)

ve.3 <- regress_unmatch(df.ve = df.ve, confounders = confounders_ed) %>% 
 mutate(against = "RSV-associated outpatient visit")

##########################
# Against RSV-associated LRTI
##########################
df.ve <- df %>% 
  filter(symp_LRT_distress == 1) %>% mutate(case_control = positive_rsv)
ve.4 <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(against = "RSV-associated LRTI (Oct-May)")
ve.4.alltime <- ve.4

df.ve <- df.ve %>% filter(collection_date <= as.Date("2024-1-31"))
ve.4.OctJan <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(against = "RSV-associated LRTI (Oct-Jan)")

df.ve <- df.ve %>% filter(collection_date <= as.Date("2023-12-31"))
ve.4.OctDec <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(against = "RSV-associated LRTI (Oct-Dec)")

df.ve <- df.ve %>% filter(collection_date <= as.Date("2023-12-31") & collection_date >= as.Date("2023-11-1"))
ve.4.NovDec <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(against = "RSV-associated LRTI (Nov-Dec)")



##########################
# Against RSV-associated LRTI hospitalization
##########################
df.ve <- df %>% 
  filter(symp_LRT_distress == 1 & encounter_type == "inpatient") %>% 
  mutate(case_control = positive_rsv)
ve.5 <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTIhosp) %>% 
 mutate(against = "RSV-associated LRTI hospitalization (Oct-May)")
ve.5.alltime <- ve.5

df.ve <- df.ve %>% filter(collection_date <= as.Date("2024-1-31"))
ve.5.OctJan <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTIhosp) %>% 
 mutate(against = "RSV-associated LRTI hospitalization (Oct-Jan)")

df.ve <- df.ve %>% filter(collection_date <= as.Date("2023-12-31"))
ve.5.OctDec <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTIhosp) %>% 
 mutate(against = "RSV-associated LRTI hospitalization (Oct-Dec)")

df.ve <- df.ve %>% filter(collection_date <= as.Date("2023-12-31") & collection_date >= as.Date("2023-11-1"))
ve.5.NovDec <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTIhosp) %>% 
 mutate(against = "RSV-associated LRTI hospitalization (Nov-Dec)")




##########################
# Against RSV-associated severe disease outcomes
##########################
# severe disease outcome includes: ICU admissions or high flow rate oxygen support
df.ve <- df %>% 
  filter(icu_admitted == "yes" | highflow_oxygen == 1) %>% 
  mutate(case_control = positive_rsv)

ve.6 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severe) %>% 
 mutate(against = "RSV-associated severe outcomes")


##########################
# Against all-cause LRTI 
##########################

# all time 
df.ve <- df %>% mutate(case_control = symp_LRT_distress)
ve.7.alltime <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(against = "All-cause LRTI (Oct-May)")

df.ve <- df.ve %>% filter(collection_date <= as.Date("2024-1-31"))
ve.7.OctJan <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(against = "All-cause LRTI (Oct-Jan)")

df.ve <- df.ve %>% filter(collection_date <= as.Date("2023-12-31"))
ve.7.OctDec <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(against = "All-cause LRTI (Oct-Dec)")

df.ve <- df.ve %>% filter(collection_date <= as.Date("2023-12-31") & collection_date >= as.Date("2023-11-1"))
ve.7.NovDec <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(against = "All-cause LRTI (Nov-Dec)")

df.ve <- df %>% mutate(case_control = symp_LRT_distress) %>% 
  filter(collection_date >= as.Date("2024-2-1"))
ve.7.FebMay <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(against = "All-cause LRTI (Feb-May)")



##########################
# Against all-cause LRTI hospitalization
##########################

# case: hospitalized LRTI; control: hospitalized non-LRTI (?)
df.ve <- df %>% mutate(case_control = symp_LRT_distress) %>% 
  filter(encounter_type == "inpatient")
ve.8.alltime <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTIhosp) %>% 
 mutate(against = "All-cause LRTI hospitalization (Oct-May)")

df.ve <- df.ve %>% filter(collection_date <= as.Date("2024-1-31"))
ve.8.OctJan <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTIhosp) %>% 
 mutate(against = "All-cause LRTI hospitalization (Oct-Jan)")

df.ve <- df.ve %>% filter(collection_date <= as.Date("2023-12-31"))
ve.8.OctDec <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTIhosp) %>% 
 mutate(against = "All-cause LRTI hospitalization (Oct-Dec)")

df.ve <- df.ve %>% filter(collection_date <= as.Date("2023-12-31") & collection_date >= as.Date("2023-11-1"))
ve.8.NovDec <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTIhosp) %>% 
 mutate(against = "All-cause LRTI hospitalization (Nov-Dec)")

df.ve <- df %>% mutate(case_control = symp_LRT_distress) %>% 
  filter(encounter_type == "inpatient") %>%
  filter(collection_date >= as.Date("2024-2-1"))
ve.8.FebMay <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTIhosp) %>% 
 mutate(against = "All-cause LRTI hospitalization (Feb-May)")




## combine the results for the main outcome
ve <- 
  rbind(
  ve.1, ve.2, ve.3, ve.4, ve.5, ve.6
) %>% 
  dplyr::select(against, n_cases_mab, n_cases_nomab, n_controls_mab, n_controls_nomab, ve_unadj, ve_adj) 

ve %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20)

## combine all results
ve.all <- 
  rbind(
  ve.1, ve.2, ve.3, 
  ve.4,
  ve.5,
  ve.6,
  ve.7.alltime, ve.7.OctJan, ve.7.OctDec, ve.7.NovDec, ve.7.FebMay,
  ve.8.alltime, ve.8.OctJan, ve.8.OctDec, ve.8.NovDec, ve.8.FebMay
) %>% 
  dplyr::select(against, n_cases_mab, n_cases_nomab, n_controls_mab, n_controls_nomab, ve_unadj, ve_adj) 

```


#### Figure `r fig.counter`. (2 rows for each outcome)
```{r, fig.width = 12, fig.height= 3.5}
fig.counter <- fig.counter + 1

source("utils_mAb_VE.R")

# select the main outcomes
ve.main <- rbind(ve[1,], ve[3,], ve[2,], ve[6,]) %>%
  mutate(across(starts_with("n_"), ~str_replace(., " \\s*\\([^\\)]+\\)", "")))


plt.ve.main <- ve_forest_2rows(df.plot = ve.main)

plt.ve.main

if(savenewplot){
  ggsave(plot = plt.ve.main, filename = "../figs_tabs/figures/ve.main.pdf", height = 3.5, width = 12)
}
```

<br>



<br>

### Read in the literature data and compare with our current estimates {.tabset}

#### all outcomes (unstratifieds)
```{r}
df.lit <- read_excel("../data/SR/SR.xlsx", sheet = "studies")

# classify the outcomes into several categories
df.lit <- df.lit %>% 
  mutate(outcome_group = case_when(outcome %in% c("RSV bronchiolitis ICU admission",
                                                  "RSV severe diseases",
                                                  "Severe RSV LRTI with oxygen support",
                                                  "RSV ICU admission") ~ "RSV-associated severe outcomes",
                                   outcome %in% c("RSV hospitalization") ~ "RSV-associated hospitalization",
                                   outcome %in% c("RSV LRTI") ~ "RSV-associated LRTI",
                                   outcome %in% c("RSV LRTI hospitalization",
                                                  "RSV bronchiolitis hospitalization") ~ "RSV-associated LRTI hospitalization",
                                   outcome %in% c("RSV ED visit") ~ "RSV-associated outpatient visit",
                                   outcome %in% c("all-cause LRTI hospitalization") ~ "All-cause LRTI hospitalization",
                                   outcome %in% c("all-cause bronchiolitis", 
                                                  "all-cause LRTI") ~ "All-cause LRTI",
                                   TRUE ~ outcome))


# combine the literature estimates and current estimates

# first break down the CI of current studies 
a <- matrix(unlist(strsplit(ve.all$ve_adj, "\\(")), ncol = 2, byrow = T) %>% 
    as.data.frame() %>%
    mutate(V2 = str_replace(V2, "\\)", "")) %>% 
    mutate(n_dash = str_count(V2, "-"))
  
a$ve_adj_lb <- NA
a$ve_adj_ub <- NA
  
a[which(a$n_dash == 1),]$ve_adj_lb <- as.numeric(matrix(unlist(strsplit((a[which(a$n_dash == 1),])$V2, "-")), ncol = 2, byrow = T)[,1])
a[which(a$n_dash == 1),]$ve_adj_ub <- as.numeric(matrix(unlist(strsplit((a[which(a$n_dash == 1),])$V2, "-")), ncol = 2, byrow = T)[,2])
  
if(2 %in% c(a$n_dash)){
    # when there is lb < 0 
    a[which(a$n_dash == 2),]$ve_adj_lb <- - as.numeric(matrix(unlist(strsplit(sub(".", "", (a[which(a$n_dash == 2),])$V2), "-")), ncol = 2, byrow = T)[,1])
    a[which(a$n_dash == 2),]$ve_adj_ub <- + as.numeric(matrix(unlist(strsplit(sub(".", "", (a[which(a$n_dash == 2),])$V2), "-")), ncol = 2, byrow = T)[,2])
}
  
a <- a %>% dplyr::rename(ve_adj_median = V1) %>% dplyr::select(-V2, -n_dash)
  
ve.current <- cbind(ve.all %>% dplyr::select(against, ve_adj), a) %>% 
  mutate(studyID = "Current study", study_type = "observational", country = "US") %>% 
  rename(outcome = against) %>% mutate(outcome_group = outcome) %>%
  rename(VE_mean = ve_adj_median, 
         VE_lb = ve_adj_lb, 
         VE_ub = ve_adj_ub) %>% 
  mutate(outcome_group = str_replace(outcome_group, " \\s*\\([^\\)]+\\)", "")) %>%
  mutate(time_range = "Oct-May") %>%
  mutate(time_range = ifelse(str_detect(outcome, "(Oct-May)"), "Oct-May", time_range),
         time_range = ifelse(str_detect(outcome, "(Oct-Jan)"), "Oct-Jan", time_range),
         time_range = ifelse(str_detect(outcome, "(Oct-Dec)"), "Oct-Dec", time_range),
         time_range = ifelse(str_detect(outcome, "(Nov-Dec)"), "Nov-Dec", time_range),
         time_range = ifelse(str_detect(outcome, "(Feb-May)"), "Feb-May", time_range)
         )
  

# combine with previous literature
df.comb <- df.lit %>% dplyr::select(studyID, study_type, country, time_range,outcome, outcome_group, 
                                    VE_mean, VE_lb, VE_ub) %>%
  mutate(ve_adj = paste0(VE_mean, " (", VE_lb, "-", VE_ub, ")")) %>% 
  rbind(ve.current) %>%
  filter(!is.na(outcome)) 

# only keep the Levy 2024 for 3-12 months age group
df.comb <- df.comb %>% 
  filter(studyID != "Levy 2024" | 
           studyID == "Levy 2024" & VE_mean == 26.5)

```


```{r fig.height = 16, fig.width = 9}
### plot all VE in literature for each outcome
df.infection <- df.comb %>% filter(outcome_group == "Medically attended RSV infection")
df.outpatient <- df.comb %>% filter(outcome_group == "RSV-associated outpatient visit")
df.hosp <- df.comb %>% filter(outcome_group == "RSV-associated hospitalization")
df.severe <- df.comb %>% filter(outcome_group == "RSV-associated severe outcomes")
df.LRTI <- df.comb %>% filter(outcome_group == "RSV-associated LRTI")
df.LRTIhosp <- df.comb %>% filter(outcome_group == "RSV-associated LRTI hospitalization")
df.allcauseLRTI <- df.comb %>% filter(outcome_group == "All-cause LRTI")
df.allcauseLRTIhosp <- df.comb %>% filter(outcome_group == "All-cause LRTI hospitalization")



plt.ve.lit.infection <- plot_ve(df.outcome = df.infection)
plt.ve.lit.outpatient <- plot_ve(df.outcome = df.outpatient)
plt.ve.lit.hosp <- plot_ve(df.outcome = df.hosp)
plt.ve.lit.severe <- plot_ve(df.outcome = df.severe)
plt.ve.lit.LRTI <- plot_ve(df.outcome = df.LRTI)
plt.ve.lit.LRTIhosp <- plot_ve(df.outcome = df.LRTIhosp)
plt.ve.lit.allcauseLRTI <- plot_ve(df.outcome = df.allcauseLRTI)
plt.ve.lit.allcauseLRTIhosp <- plot_ve(df.outcome = df.allcauseLRTIhosp)


# combine all 
plt.ve.lit.all <- 
  plot_grid(plt.ve.lit.infection, 
          plt.ve.lit.outpatient,
          plt.ve.lit.hosp,
          plt.ve.lit.severe,
          plt.ve.lit.LRTI,
          plt.ve.lit.LRTIhosp,
          plt.ve.lit.allcauseLRTI,
          plt.ve.lit.allcauseLRTIhosp,
          ncol = 1, 
          rel_heights = c(3.8,4.2,6,5,3.8,4.5,5.6,5),
          labels = c("A)", "B)", "C)", "D)", "E)", "F)", "G)", "H)")
          )


plt.ve.lit.all

if(savenewplot){
  ggsave(plot = plt.ve.lit.all, filename = "../figs_tabs/figures/ve.lit.all.pdf", height = 16, width = 9)
}


```

#### main outcomes
```{r, fig.height = 9, fig.width=9}
# save the main comparison plot for the paper.
plt.ve.lit <- 
  plot_grid(plt.ve.lit.infection, 
          plt.ve.lit.outpatient,
          plt.ve.lit.hosp,
          plt.ve.lit.severe,
          ncol = 1, 
          rel_heights = c(3.8,4,6,5), 
          labels = c("A)", "B)", "C)", "D)"))


plt.ve.lit

if(savenewplot){
  ggsave(plot = plt.ve.lit, filename = "../figs_tabs/figures/ve.lit.pdf", height = 9, width = 9)
}

```

#### all-cause LRTI (stratified)
```{r fig.width = 10, fig.height=6}
# stratify the outcomes against all-cause lRTI & all-cause LRTI hosp
df.allcauseLRTI <- df.allcauseLRTI %>%
  mutate(time_range_cat = case_when(time_range %in% c("Sep-Jan", "Oct-Jan", "Oct-Dec", "Nov-Dec") ~ "Peak months",
                                    time_range %in% c("19/20 season", "Oct-May", "16/17 season", "2019-2021") ~ "Full season",
                                    time_range %in% c("Feb-May") ~ "Off-peak months"))

df.allcauseLRTIhosp <- df.allcauseLRTIhosp %>%
   mutate(time_range_cat = case_when(time_range %in% c("Sep-Dec", "Oct-Jan", "Oct-Dec", "Nov-Dec") ~ "Peak months",
                                     time_range %in% c("19/20 season", "Oct-May",  "16/17 season", "2019-2021") ~ "Full season",
                                     time_range %in% c("Feb-May") ~ "Off-peak months"))

plt.ve.lit.allcauseLRTI.stratified <- plot_ve_stratified(df.outcome = df.allcauseLRTI)
plt.ve.lit.allcauseLRTIhosp.stratified <- plot_ve_stratified(df.outcome = df.allcauseLRTIhosp)

plt.ve.lit.allcauseLRTI.stratified.extend <- plot_ve_stratified_extend(df.outcome = df.allcauseLRTI)
plt.ve.lit.allcauseLRTIhosp.stratified.extend <- plot_ve_stratified_extend(df.outcome = df.allcauseLRTIhosp)


plt.ve.lit.allcause.stratified <- 
  plot_grid(plt.ve.lit.allcauseLRTI.stratified,
            plt.ve.lit.allcauseLRTIhosp.stratified,
            ncol = 1, 
            rel_heights = c(6,6), 
            labels = c("A) ", "B) "))

plt.ve.lit.allcause.stratified.extend <- 
  plot_grid(plt.ve.lit.allcauseLRTI.stratified.extend,
            plt.ve.lit.allcauseLRTIhosp.stratified.extend,
            ncol = 1, 
            rel_heights = c(6,6), 
            labels = c("A) ", "B) "))

plt.ve.lit.allcause.stratified.extend

if(savenewplot){
  ggsave(plot = plt.ve.lit.allcause.stratified.extend, filename = "../figs_tabs/figures/ve.lit.allcause.stratified.extend.pdf", height = 6, width = 10)
}

```

#### Main outcomes with stratified all-cause VE
```{r fig.width = 10, fig.height=14}
plt.ve.lit.main.stratified <- 
  plot_grid(plt.ve.lit.infection, 
          plt.ve.lit.outpatient,
          plt.ve.lit.hosp,
          plt.ve.lit.severe,
          plt.ve.lit.allcauseLRTI.stratified,
          plt.ve.lit.allcauseLRTIhosp.stratified,
          ncol = 1, 
          rel_heights = c(3.8,4.2,6,5,6.6,5.5),
          labels = c("A)", "B)", "C)", "D)", "E)", "F)")
          )


plt.ve.lit.main.stratified

if(savenewplot){
  ggsave(plot = plt.ve.lit.main.stratified, filename = "../figs_tabs/figures/ve.lit.main.stratified.pdf", height = 14, width = 10)
}
```


#### all outcomes (all-cause LRTI stratified)
```{r fig.height = 18, fig.width = 9}
# combine the main outcomes and the stratified outcomes
# combine all 
plt.ve.lit.all.stratified <- 
  plot_grid(plt.ve.lit.infection, 
          plt.ve.lit.outpatient,
          plt.ve.lit.hosp,
          plt.ve.lit.severe,
          plt.ve.lit.LRTI,
          plt.ve.lit.LRTIhosp,
          plt.ve.lit.allcauseLRTI.stratified,
          plt.ve.lit.allcauseLRTIhosp.stratified,
          ncol = 1, 
          rel_heights = c(3.8,4.2,6,5,3.8,4.5,6.6,5.5),
          labels = c("A)", "B)", "C)", "D)", "E)", "F)", "G)", "H)")
          )


plt.ve.lit.all.stratified

if(savenewplot){
  ggsave(plot = plt.ve.lit.all.stratified, filename = "../figs_tabs/figures/ve.lit.all.stratified.pdf", height = 16, width = 9)
}
```



<br>

### Earlier records
Look at when restricting to records up to March, if the results are the same as what was reported in the ACIP meeting by CDC.
```{r warning=F,fig.width = 12, fig.height= 3.5}

df.early <- df %>% filter(collection_date <= as.Date("2024-03-31"))
# df.early <- df %>% filter(collection_date <= as.Date("2023-12-31"))
# df.early <- df %>% filter(collection_date <= as.Date("2023-12-31") & collection_date >= as.Date("2023-12-1"))

# all-cause LRTI 
# df.ve <- df.early %>% mutate(case_control = ifelse(is.na(symp_LRT_distress), 0, 1))


tab.counter <- tab.counter + 1
##########################
# Against RSV infection (inpatient + outpatient)
##########################
df.ve <- df.early %>% mutate(case_control = positive_rsv)

ve.1 <- regress_unmatch(df.ve = df.ve, confounders = confounders_infection) %>% 
 mutate(against = "Medically attended RSV infection")


##########################
# Against RSV hospitalizations
##########################
df.ve <- df.early %>% 
  filter(encounter_type == "inpatient") %>% mutate(case_control = positive_rsv)

ve.2 <- regress_unmatch(df.ve = df.ve, confounders = confounders_inpatient) %>% 
 mutate(against = "RSV-associated hospitalization")


##########################
# Against RSV ED visit
##########################
# remove those "Specimen"? 
df.ve <- df.early %>% 
  filter(encounter_type == "outpatient") %>% mutate(case_control = positive_rsv)

ve.3 <- regress_unmatch(df.ve = df.ve, confounders = confounders_ed) %>% 
 mutate(against = "RSV-associated outpatient visit")

##########################
# Against RSV-associated LRTI
##########################
df.ve <- df.early %>% 
  filter(symp_LRT_distress == 1) %>% mutate(case_control = positive_rsv)

ve.4 <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(against = "RSV-associated LRTI")


##########################
# Against RSV-associated LRTI hospitalization
##########################
df.ve <- df.early %>% 
  filter(symp_LRT_distress == 1 & encounter_type == "inpatient") %>% 
  mutate(case_control = positive_rsv)

ve.5 <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTIhosp) %>% 
 mutate(against = "RSV-associated LRTI hospitalization")




##########################
# Against RSV-associated severe disease outcomes
##########################
# severe disease outcome includes: ICU admissions or high flow rate oxygen support
df.ve <- df.early %>% 
  filter(icu_admitted == "yes" | highflow_oxygen == 1) %>% 
  mutate(case_control = positive_rsv)

ve.6 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severe) %>% 
 mutate(against = "RSV-associated severe outcomes")


## combine the results 
# combine the tables together 
ve.early <- 
  rbind(
  ve.1, ve.2, ve.3, ve.4, ve.5, ve.6
) %>% 
  dplyr::select(against, n_cases_mab, n_cases_nomab, n_controls_mab, n_controls_nomab, ve_unadj, ve_adj) 


# select the main outcomes
ve.early <- rbind(ve.early[1,], ve.early[3,], ve.early[2,], ve.early[6,]) %>%
  mutate(across(starts_with("n_"), ~str_replace(., " \\s*\\([^\\)]+\\)", "")))


plt.ve.early <- ve_forest_2rows(df.plot = ve.early)

plt.ve.early

if(savenewplot){
  ggsave(plot = plt.ve.early, filename = "../figs_tabs/figures/ve.early.pdf", height = 3.5, width = 12)
}


#### restricting to only ED visit
df.ve <- df.early %>% 
  filter(`Encounter.Type` == "Emergency") %>% mutate(case_control = positive_rsv)

ve.3.ed <- regress_unmatch(df.ve = df.ve, confounders = confounders_ed) %>% 
 mutate(against = "RSV-associated outpatient visit")


```

<br>
<br>

### Look at whether dosage has an influence on VE. {.tabset}

#### Table `r tab.counter` Compare infants who took 100mg and 50mg dosage  
```{r}
tab.counter <- tab.counter + 1

df_table1_dosage <- df_table1 %>%
  mutate(rsv_mab_dose = case_when(rsv_mab == "Yes, 100mg dose" ~ "100mg",
                                  rsv_mab == "Yes, 50mg dose" ~ "50mg")) %>%
  filter(!is.na(rsv_mab_dose))

table1_dosage <- df_table1_dosage %>% 
  dplyr::select(-rsv_mab, -encounter_type, -positive_rsv, -symp_LRT_distress) %>%
  tbl_summary(by = rsv_mab_dose,
              
              type = list(all_continuous() ~ "continuous2"),       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", 
                                               "{median} ({p25}, {p75})",
                                               "{N_miss} ({p_miss}%)"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                Sex ~ "Sex", 
                age_at_test_in_months ~ "Age at testing (months)",
                age_at_test_in_months_cat_2 ~ "Age at testing",
                month_when_tested_cat ~ "Time tested", 
                race_ethnicity ~ "Race and ethnicity",
                risk_factor_pulmonary ~ "Pulmonary diseases", 
                risk_factor_cardiac ~ "Cardiac diseases",
                risk_factor_anemia ~ "Anemia",
                risk_factor_gestagelessthan37wks ~ "Gestational age",
                risk_factor_atleastone ~ "Having at least one risk factor",
                insurance_type ~ "Insurance type",
                birth_weight ~ "Birth weight"
                ),
         
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~ style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) %>%
  bold_labels() %>%
  modify_table_styling(
    columns = label,
    rows = label == "Other non-Hispanic",
    footnote = footnote_otherraces
  ) %>%
   modify_table_styling(
    columns = label,
    rows = label == "Having at least one risk factor",
    footnote = footnote_atleastoneriskfactor
  )


table1_dosage %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 


if(savenewplot){
  table1_dosage %>%
    as_gt() %>%
    gt::gtsave(filename = "../figs_tabs/tables/table1_dosage.docx")
}
  
```

#### Table `r tab.counter` VE by dosage (100mg vs. not vaccinated)
```{r warning=F}
tab.counter <- tab.counter + 1

df.100mg <- df %>% 
  mutate(rsv_mab = case_when(rsv_mab_dose == "100mg" ~ 1,
                             rsv_mab == 0 ~ 0))

##########################
# Against RSV infection (inpatient + outpatient)
##########################
df.ve <- df.100mg %>% mutate(case_control = positive_rsv)

ve.1 <- regress_unmatch(df.ve = df.ve, confounders = confounders_infection) %>% 
 mutate(against = "Medically attended RSV infection")


##########################
# Against RSV hospitalizations
##########################
df.ve <- df.100mg %>% 
  filter(encounter_type == "inpatient") %>% mutate(case_control = positive_rsv)

ve.2 <- regress_unmatch(df.ve = df.ve, confounders = confounders_inpatient) %>% 
 mutate(against = "RSV-associated hospitalization")


##########################
# Against RSV ED visit
##########################
# remove those "Specimen"? 
df.ve <- df.100mg %>% 
  filter(encounter_type == "outpatient") %>% mutate(case_control = positive_rsv)

ve.3 <- regress_unmatch(df.ve = df.ve, confounders = confounders_ed) %>% 
 mutate(against = "RSV-associated outpatient visit")

##########################
# Against RSV-associated LRTI
##########################
df.ve <- df.100mg %>% 
  filter(symp_LRT_distress == 1) %>% mutate(case_control = positive_rsv)

ve.4 <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(against = "RSV-associated LRTI")


##########################
# Against RSV-associated LRTI hospitalization
##########################
df.ve <- df.100mg %>% 
  filter(symp_LRT_distress == 1 & encounter_type == "inpatient") %>% 
  mutate(case_control = positive_rsv)

ve.5 <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTIhosp) %>% 
 mutate(against = "RSV-associated LRTI hospitalization")




##########################
# Against RSV-associated severe disease outcomes
##########################
# severe disease outcome includes: ICU admissions or high flow rate oxygen support
df.ve <- df.100mg %>% 
  filter(icu_admitted == "yes" | highflow_oxygen == 1) %>% 
  mutate(case_control = positive_rsv)

ve.6 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severe) %>% 
 mutate(against = "RSV-associated severe outcomes")


## combine the results 
# combine the tables together 
ve.100mg <- 
  rbind(
  ve.1, ve.2, ve.3, ve.4, ve.5, ve.6
) %>% 
  dplyr::select(against, n_cases_mab, n_cases_nomab, n_controls_mab, n_controls_nomab, ve_unadj, ve_adj) 

ve.100mg %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20)
```

#### Table `r tab.counter` VE by dosage (50mg vs. not vaccinated)
```{r warning=F}
tab.counter <- tab.counter + 1

df.50mg <- df %>% 
  mutate(rsv_mab = case_when(rsv_mab_dose == "50mg" ~ 1,
                             rsv_mab == 0 ~ 0))


##########################
# Against RSV infection (inpatient + outpatient)
##########################
df.ve <- df.50mg %>% mutate(case_control = positive_rsv)

ve.1 <- regress_unmatch(df.ve = df.ve, confounders = confounders_infection) %>% 
 mutate(against = "Medically attended RSV infection")


##########################
# Against RSV hospitalizations
##########################
df.ve <- df.50mg %>% 
  filter(encounter_type == "inpatient") %>% mutate(case_control = positive_rsv)

ve.2 <- regress_unmatch(df.ve = df.ve, confounders = confounders_inpatient) %>% 
 mutate(against = "RSV-associated hospitalization")


##########################
# Against RSV ED visit
##########################
# remove those "Specimen"? 
df.ve <- df.50mg %>% 
  filter(encounter_type == "outpatient") %>% mutate(case_control = positive_rsv)

ve.3 <- regress_unmatch(df.ve = df.ve, confounders = confounders_ed) %>% 
 mutate(against = "RSV-associated outpatient visit")

##########################
# Against RSV-associated LRTI
##########################
df.ve <- df.50mg %>% 
  filter(symp_LRT_distress == 1) %>% mutate(case_control = positive_rsv)

ve.4 <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(against = "RSV-associated LRTI")


##########################
# Against RSV-associated LRTI hospitalization
##########################
df.ve <- df.50mg %>% 
  filter(symp_LRT_distress == 1 & encounter_type == "inpatient") %>% 
  mutate(case_control = positive_rsv)

ve.5 <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTIhosp) %>% 
 mutate(against = "RSV-associated LRTI hospitalization")




##########################
# Against RSV-associated severe disease outcomes
##########################
# severe disease outcome includes: ICU admissions or high flow rate oxygen support
df.ve <- df.50mg %>% 
  filter(icu_admitted == "yes" | highflow_oxygen == 1) %>% 
  mutate(case_control = positive_rsv)

ve.6 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severe) %>% 
 mutate(against = "RSV-associated severe outcomes")


## combine the results 
# combine the tables together 
ve.50mg <- 
  rbind(
  ve.1, ve.2, ve.3, ve.4, ve.5, ve.6
) %>% 
  dplyr::select(against, n_cases_mab, n_cases_nomab, n_controls_mab, n_controls_nomab, ve_unadj, ve_adj) 

ve.50mg %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T, defaultPageSize = 20)
```

#### Table `r tab.counter`. Compare VE from 50mg and 100mg dosage
```{r}
tab.counter <- tab.counter + 1

ve.50mg %>% 
  dplyr::select(against, ve_unadj, ve_adj) %>%
  rename(VE.unadjusted.50mg = ve_unadj, VE.adjusted.50mg = ve_adj) %>%
  left_join(
    ve.100mg %>% 
      dplyr::select(against, ve_unadj, ve_adj) %>%
      rename(VE.unadjusted.100mg = ve_unadj, VE.adjusted.100mg = ve_adj) 
  ) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            defaultExpanded = T,  defaultPageSize = 20,
           columnGroups = list(
    colGroup(name = "100mg", columns = c("VE.unadjusted.100mg", "VE.adjusted.100mg")),
    colGroup(name = "50mg", columns = c("VE.unadjusted.50mg", "VE.adjusted.50mg"))
  ),
  columns = list(
    VE.unadjusted.100mg = colDef(name = "VE.unadjusted"),
    VE.adjusted.100mg= colDef(name = "VE.adjusted"),
    VE.unadjusted.50mg = colDef(name = "VE.unadjusted"),
    VE.adjusted.50mg = colDef(name = "VE.adjusted")
  ))
```

<br>

#### Combine plot of any dose, 100mg, 50mg
```{r fig.width = 12, fig.height = 5.5}
# rearrange data frame for plotting
ve.dose <- 
  cbind(
    ve.100mg %>% 
      dplyr::rename(n_cases_mab_100mg = n_cases_mab, 
                    n_controls_mab_100mg = n_controls_mab,
                    ve_unadj_100mg = ve_unadj,
                    ve_adj_100mg = ve_adj) %>%
      dplyr::select(against, n_cases_mab_100mg, n_cases_nomab, n_controls_mab_100mg, n_controls_nomab, ve_unadj_100mg, ve_adj_100mg),
    ve.50mg %>% 
      dplyr::rename(n_cases_mab_50mg = n_cases_mab, 
                    n_controls_mab_50mg = n_controls_mab,
                    ve_unadj_50mg = ve_unadj,
                    ve_adj_50mg = ve_adj) %>%
      dplyr::select(n_cases_mab_50mg, n_controls_mab_50mg, ve_unadj_50mg, ve_adj_50mg),
    ve %>% 
      dplyr::rename(n_cases_mab_anydose = n_cases_mab, 
                    n_controls_mab_anydose = n_controls_mab,
                    ve_unadj_anydose = ve_unadj,
                    ve_adj_anydose = ve_adj) %>%
      dplyr::select(n_cases_mab_anydose, n_controls_mab_anydose, ve_unadj_anydose, ve_adj_anydose)
  ) %>% 
  mutate(across(starts_with("n_"), ~str_replace(., " \\s*\\([^\\)]+\\)", "")))

ve.dose <- rbind(ve.dose[1,],
                            ve.dose[3,],
                            ve.dose[2,],
                            ve.dose[6,])


source("utils_mAb_VE.R")

plt.ve.bydose <- ve_forest_dose_addanydose(df.plot = ve.dose)

plt.ve.bydose

if(savenewplot){
  ggsave(plot = plt.ve.bydose, filename = "../figs_tabs/figures/ve.bydose.pdf", height = 5.5, width = 12)
}

```


<br>
<br>

### what if we look at the VE against different age groups? 
Per ACIP's meeting slides, it would be good to look at VE among <8 months and 8-12 months.
Should we classify age using age when being tested or age when nirsevimab became available (chose this). 

```{r warning=FALSE}
df <- df %>% mutate(DOB = as.Date(DOB))

# Classifying method 1: classify using DOB (whether younger than 8 months on 2023-10-1) 
df.young <- df %>% filter(DOB > as.Date("2023-2-1")) # 2648
df.old <- df %>% filter(DOB <= as.Date("2023-2-1")) # 499 # this is not possible to do as there is no vaccinated cases among this older age group

# Classifying method 2: classify using age when being tested 
#df.young <- df %>% filter(age_at_test_in_months < 8) # 1885
#df.old <- df %>% filter(age_at_test_in_months >= 8) # 1262

################################################################################
# First, VE against younger kids 
################################################################################


##########################
# Against RSV infection (inpatient + outpatient)
##########################
df.ve <- df.young %>% mutate(case_control = positive_rsv)

ve.1 <- regress_unmatch(df.ve = df.ve, confounders = confounders_infection) %>% 
 mutate(against = "Medically attended RSV infection")


##########################
# Against RSV hospitalizations
##########################
df.ve <- df.young %>% 
  filter(encounter_type == "inpatient") %>% mutate(case_control = positive_rsv)

ve.2 <- regress_unmatch(df.ve = df.ve, confounders = confounders_inpatient) %>% 
 mutate(against = "RSV-associated hospitalization")


##########################
# Against RSV ED visit
##########################
# remove those "Specimen"? 
df.ve <- df.young %>% 
  filter(encounter_type == "outpatient") %>% mutate(case_control = positive_rsv)

ve.3 <- regress_unmatch(df.ve = df.ve, confounders = confounders_ed) %>% 
 mutate(against = "RSV-associated outpatient visit")

##########################
# Against RSV-associated LRTI
##########################
df.ve <- df.young %>% 
  filter(symp_LRT_distress == 1) %>% mutate(case_control = positive_rsv)

ve.4 <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTI) %>% 
 mutate(against = "RSV-associated LRTI")


##########################
# Against RSV-associated LRTI hospitalization
##########################
df.ve <- df.young %>% 
  filter(symp_LRT_distress == 1 & encounter_type == "inpatient") %>% 
  mutate(case_control = positive_rsv)

ve.5 <- regress_unmatch(df.ve = df.ve, confounders = confounders_LRTIhosp) %>% 
 mutate(against = "RSV-associated LRTI hospitalization")




##########################
# Against RSV-associated severe disease outcomes
##########################
# severe disease outcome includes: ICU admissions or high flow rate oxygen support
df.ve <- df.young %>% 
  filter(icu_admitted == "yes" | highflow_oxygen == 1) %>% 
  mutate(case_control = positive_rsv)

ve.6 <- regress_unmatch(df.ve = df.ve, confounders = confounders_severe) %>% 
 mutate(against = "RSV-associated severe outcomes")


## combine the results 
# combine the tables together 
ve.young <- 
  rbind(
  ve.1, ve.2, ve.3, ve.4, ve.5, ve.6
) %>% 
  dplyr::select(against, n_cases_mab, n_cases_nomab, n_controls_mab, n_controls_nomab, ve_unadj, ve_adj) 

# ve.young %>%
#   reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
#             defaultExpanded = T, defaultPageSize = 20)


################################################################################
# too few vaccinated cases to calculate VE for older kids
################################################################################
```

#### convert VE under 8m to forest plot
```{r fig.width = 11, fig.height = 5}
ve.young <- ve.young %>% 
  mutate(across(starts_with("n_"), ~str_replace(., " \\s*\\([^\\)]+\\)", "")))

# rearrange the outcomes
ve.young <- rbind(
  ve.young[1, ],
  ve.young[2, ],
  ve.young[2, ],
  ve.young[6, ],
  ve.young[4, ],
  ve.young[5, ]
)



plt.ve.under8m.eligibleage <- ve_forest_2rows(ve.young)

plt.ve.under8m.eligibleage

if(savenewplot){
  ggsave(plot = plt.ve.under8m.eligibleage, filename = "../figs_tabs/figures/ve.under8.eligibleage.pdf", height = 5, width = 11)
}
```

<br>

### Sample size, power or minimum detectable odds ratio for an unmatched or matched case-control study (using epi.sscc() function) {.tabset}
  * Another tool (shinyapp) for sample size calculation: https://apps.p-95.com/app/drivesamplesize
  
#### MA RSV infection
```{r echo=T}
library(epiR)

# for medically attended RSV infection
epi.sscc(N = 3090, # total number of subjects included
         OR = NA,  # expected study odds ratio
         p1 = 0.031,  # the prevalence of exposure amongst the cases.
         p0 = 0.128,  # the prevalence of exposure amongst the controls.
         n = 3090,  # the total number of subjects in the study (i.e., the number of cases plus the number of controls). what is the difference from N??
         power = 0.8, # the required study power. ( Ideally, minimum power of a study required is 80%.)
         r = 3.54,  # number in the control group divided by number in the case group. In our study: 2410/680
         sided.test = 2, # use a one- or two-sided test
         nfractional = FALSE, # whether to return fractional sample size
         conf.level = 0.95, 
         method = "unmatched")
# returning: OR = 0.662: the expected detectable odds ratio given the number of study subjects. 
# VE = 1-OR = 0.338 

```

#### RSV outpatient
```{r echo = T}
# for RSV outpatient
epi.sscc(N = 2505, # total number of subjects included
         OR = NA,  # expected study odds ratio
         p1 = 0.031,  # the prevalence of exposure amongst the cases.
         p0 = 0.116,  # the prevalence of exposure amongst the controls.
         n = 2050,  # the total number of subjects in the study (i.e., the number of cases plus the number of controls). what is the difference from N??
         power = 0.8, # the required study power. ( Ideally, minimum power of a study required is 80%.)
         r = 3.87,  # number in the control group divided by number in the case group. here: 
         sided.test = 2, # use a one- or two-sided test
         nfractional = FALSE, # whether to return fractional sample size
         conf.level = 0.95, 
         method = "unmatched")
# returning: OR = 0.5629488: the expected detectable odds ratio given the number of study subjects. 
# VE = 1-OR = 0.4370512


```

#### RSV inpatient
```{r echo = T}
# for RSV inpatient
epi.sscc(N = 543, # total number of subjects included
         OR = NA,  # expected study odds ratio
         p1 = 0.0301,  # the prevalence of exposure amongst the cases.
         p0 = 0.1856764,  # the prevalence of exposure amongst the controls.
         n = 2050,  # the total number of subjects in the study (i.e., the number of cases plus the number of controls). what is the difference from N??
         power = 0.8, # the required study power. ( Ideally, minimum power of a study required is 80%.)
         r = 2.27,  # number in the control group divided by number in the case group. here: 
         sided.test = 2, # use a one- or two-sided test
         nfractional = FALSE, # whether to return fractional sample size
         conf.level = 0.95, 
         method = "unmatched")
# returning: OR = 0.6856783: the expected detectable odds ratio given the number of study subjects. 
# VE = 1-OR = 0.3143217
```

#### RSV severe outcomess
```{r echo = T}
# for severe outcomes
epi.sscc(N = 435, # total number of subjects included
         OR = NA,  # expected study odds ratio
         p1 = 0.02758621,  # the prevalence of exposure amongst the cases.
         p0 = 0.2689655,  # the prevalence of exposure amongst the controls.
         n = 435,  # the total number of subjects in the study (i.e., the number of cases plus the number of controls). what is the difference from N??
         power = 0.8, # the required study power. ( Ideally, minimum power of a study required is 80%.)
         r = 2,  # number in the control group divided by number in the case group. here: 
         sided.test = 2, # use a one- or two-sided test
         nfractional = FALSE, # whether to return fractional sample size
         conf.level = 0.95, 
         method = "unmatched")
# returning: OR = 0.4767214, the expected detectable odds ratio given the number of study subjects. 
# VE = 1-OR = 0.5232786


```

```{r}
# get the test-positive rate during peak time (Nov-Dec)
df.peak <- df %>% filter(collection_date >= as.Date("2023-11-1") & collection_date <= as.Date("2023-12-31"))
df.peak %>% count(positive_rsv)

df.offpeak <- df %>% filter(collection_date >= as.Date("2024-2-1"))
df.offpeak %>% count(positive_rsv)

```









