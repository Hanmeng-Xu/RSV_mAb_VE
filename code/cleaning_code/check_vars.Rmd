---
title: "Check and recode variables"
output: 
  html_document:
    toc: true
    toc_float: true
---

#### Date: `r Sys.Date()`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(dplyr)
library(tidyr)
library(tidyverse)
library(readxl)
library(writexl)
library(reactable)
library(ggplot2)
library(stringr)


fig.counter <- 1
tab.counter <- 1

save_recoded_dataset <- TRUE
```

### Table `r tab.counter`. StudyID
```{r}
tab.counter <- tab.counter + 1
# read in data from onedrive shared folder 
df <- read_excel("/Users/hmx/OneDrive - Yale University/Hanmeng RSV VE/data/RSV_deid_2024_may.xlsx", sheet = "Dataset")

n_unique <- length(unique(df$StudyID))
n_single_test <- df %>% group_by(StudyID) %>% count() %>% filter(n==1) %>% nrow()
n_multi_test <- df %>% group_by(StudyID) %>% count() %>% filter(n>1) %>% nrow()

df %>% group_by(StudyID) %>% count() %>% group_by(n) %>% count() %>% rename(`Times tested` = n, n_patients = nn) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

```

There are `r n_unique` patients in the original main dataset. There are `r n_single_test` patients tested only once, and `r n_multi_test` patients were tested more than once. 

<br>

### Figure `r fig.counter`. Display age at testing
  * Age eligibility:   
    + it is possible that they are > 1yo when being tested
    + the mAb is available in October 2023, and is recommended for those under 8 month (CDC), so in theory, only those born after February 2023 are eligible for mAb, these should be included.
    + however, as mAb is also recommended for older high risk infants, also check those born before February and see if they have high risk.
  * Generated age_at_testing_in_days, age_at_testing_in_months.
```{r}
fig.counter <- fig.counter + 1

df <- df %>% mutate(DOB = as.Date(DOB))

df <- df %>% mutate(age_at_test_in_days = as.numeric(as.Date(`Collection Date`) - as.Date(DOB))) %>% 
  mutate(age_at_test_in_months = round(age_at_test_in_days / (365/12), 1))

n_above1yo <- df %>% filter(age_at_test_in_months > 12) %>% nrow()

df %>% 
  ggplot() + theme_classic() +
  geom_histogram(aes(x = age_at_test_in_months), binwidth = 1, color = "black", fill = "white") +
  geom_vline(xintercept = 12, color = "red", linetype = "dashed") +
  annotate("text", x= 13, y = 280, label = "12 months", color = "red")

# remove > 12 months 
# df <- df %>% filter(age_at_test_in_months <= 12)
```

#### There are `r n_above1yo` testing records having age > 12 months at the time of testing. Currently haven't removed any records. (TBC)


<br>

### Table `r tab.counter`. Times tested
```{r}
tab.counter <- tab.counter + 1
# after removing > 12 months records 
n_unique <- length(unique(df$StudyID)) 
n_single_test <- df %>% group_by(StudyID) %>% count() %>% filter(n==1) %>% nrow()
n_multi_test <- df %>% group_by(StudyID) %>% count() %>% filter(n>1) %>% nrow()

# tested many times 
id_multi_tests <- (df %>% group_by(StudyID) %>% count() %>% filter(n > 1))$StudyID # those who had multiple tests
id_5tests <- as.character((df %>% group_by(StudyID) %>% count() %>% filter(n == 5))$StudyID)
id_6tests <- as.character((df %>% group_by(StudyID) %>% count() %>% filter(n == 6))$StudyID)

# unique ids 
id_unique <- (df %>% group_by(StudyID) %>% count())$StudyID 

df %>% group_by(StudyID) %>% count() %>% group_by(n) %>% count() %>% rename(`Times tested` = n, n_patients = nn) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```


After removing records > 12 months at testing, there are `r n_unique` patients in the dataset. There are `r n_single_test` patients tested only once, and `r n_multi_test` patients were tested more than once. 

StudyID for those who were tested 5 timese: `r id_5tests`.
StudyID for those who were tested 6 timese: `r id_6tests`.



<br> 

### Table `r tab.counter` Sex 
recode unknown to NA.
```{r}
tab.counter <- tab.counter + 1

df %>%  count(Sex) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

df <- df %>% 
  mutate(Sex = ifelse(Sex == "Unknown" | Sex == "Choose not to disclose", NA, Sex))

```

<br>

### Figure `r fig.counter`. Sex & Age at testing 
```{r}
fig.counter <- fig.counter + 1

df %>% dplyr::select(age_at_test_in_months, Sex) %>%
  mutate(age = round(age_at_test_in_months)) %>%
  group_by(Sex, age) %>% count() %>% 
  mutate(n = ifelse(Sex == "Female", -n, n)) %>%
  ggplot() +
  geom_col(aes(x = age, y = n, fill = Sex)) + coord_flip() +
  xlab("Age at testing (months)") + theme_classic()

```

<br>

### Figure `r fig.counter` Collection Date (sample collection date)
Generate collection_date (Date class varaible).
```{r}
fig.counter <- fig.counter + 1

df <- df %>% mutate(collection_date = as.Date(`Collection Date`))
#sum(is.na(df$collection_date)) # no missing for sample collection date
max_cd <- max(df$collection_date)
min_cd <- min(df$collection_date)

df %>% ggplot() +
  geom_histogram(aes(x = collection_date), color="black", fill="white") +
  scale_x_date(date_breaks = "1 month") + theme_classic()


# check if collection date is before DOB
# df %>% filter(`Collection Date` < DOB) # n = 0
```

Sample collection date: `r min_cd` ~ `r max_cd`.

<br>

### Viral test, Resp Result, Viral detected: 
#### From these variables, generate variables:
  * tested_xxx: indicating whether this record was tested for certain virus
  * positive_xxx: the testing results for certain virus (flu,rhino,hmpv,adeno,parainfluenza,rsv).
  * positive_otherviruses: binary variable indicating that this record was tested positive for other viruses other than RSV (if == 1, this record was tested positive for other viruses, but this record can be either negative and positive for RSV.)
  
#### From tested_xxx and positive_xxx, generate new variable:
  * tested_viruses: string class, listing viruses tested for a record (some viruses are not listed here, like covid)
  * positive_viruses: string class, listing viruses tested positive for a record (some viruses are not listed here, like covid)

#### what tests are included in "RESPIRATORY VIRUS PCR PANEL     (BH GH LMW Q YH) [LAB3444]"? (TBC, we discussed this, this might not be that important. )
```{r}
# generate "whether tested" variables 
df <- df %>% 
  mutate(tested_flu = ifelse(`Viral test` %in% c("INFLUENZA A+B/RSV BY RT-PCR [LAB11021]",
                                                  "SARS-COV-2 (COVID-19)/INFLUENZA A+B/RSV BY RT-PCR (BH GH LMW YH) [LAB11020]",
                                                  "RESPIRATORY VIRUS PCR PANEL  (YH VERIGENE)(LAB ORDER ONLY) [LAB10852]",
                                                  "ZZZINFLUENZA/RSV PCR      (BH) [LAB9626]",
                                                  "RESPIRATORY VIRUS PCR PANEL     (BH GH LMW Q YH) [LAB3444]"), 1, 0)) %>% 
  mutate(tested_rhino = ifelse(`Viral test` %in% c("RESPIRATORY VIRUS PCR PANEL  (YH VERIGENE)(LAB ORDER ONLY) [LAB10852]",
                                                   "RESPIRATORY VIRUS PCR PANEL     (BH GH LMW Q YH) [LAB3444]"), 1, 0)) %>%
  mutate(tested_hmpv = ifelse(`Viral test` %in% c("RESPIRATORY VIRUS PCR PANEL  (YH VERIGENE)(LAB ORDER ONLY) [LAB10852]",
                                                  "RESPIRATORY VIRUS PCR PANEL     (BH GH LMW Q YH) [LAB3444]"), 1, 0)) %>%
  mutate(tested_adeno = ifelse(`Viral test` %in% c("RESPIRATORY VIRUS PCR PANEL  (YH VERIGENE)(LAB ORDER ONLY) [LAB10852]",
                                                   "RESPIRATORY VIRUS PCR PANEL     (BH GH LMW Q YH) [LAB3444]"), 1, 0)) %>%
  mutate(tested_parainfluenza = ifelse(`Viral test` %in% c("RESPIRATORY VIRUS PCR PANEL  (YH VERIGENE)(LAB ORDER ONLY) [LAB10852]",
                                                           "RESPIRATORY VIRUS PCR PANEL     (BH GH LMW Q YH) [LAB3444]"), 1, 0)) %>%
  mutate(tested_rsv = ifelse(`Viral test` %in% c("INFLUENZA A+B/RSV BY RT-PCR [LAB11021]",
                                                "SARS-COV-2 (COVID-19)/INFLUENZA A+B/RSV BY RT-PCR (BH GH LMW YH) [LAB11020]",
                                                "RESPIRATORY VIRUS PCR PANEL  (YH VERIGENE)(LAB ORDER ONLY) [LAB10852]",
                                                "ZZZINFLUENZA/RSV PCR      (BH) [LAB9626]",
                                                "ZZZRESPIRATORY SYNCYTIAL VIRUS, RAPID ANTIGEN     (GH) [LAB3465]",
                                                "RESPIRATORY VIRUS PCR PANEL     (BH GH LMW Q YH) [LAB3444]",
                                                "ZZZRESPIRATORY SYNCYTIAL VIRUS BY RT-PCR (GH) [LAB3438]"), 1, 0))
  

# generate binary variables for testing results 
df <- df %>% 
  mutate(positive_fluA = case_when(tested_flu == 1 & str_detect(`Virus detected`, "Influenza A") == TRUE ~ 1,
                                   tested_flu == 1 & (str_detect(`Virus detected`, "Influenza A") == FALSE | 
                                                        is.na(`Virus detected`))  ~ 0)) %>%
  mutate(positive_fluB = case_when(tested_flu == 1 & str_detect(`Virus detected`, "Influenza B") == TRUE ~ 1,
                                   tested_flu == 1 & (str_detect(`Virus detected`, "Influenza B") == FALSE | 
                                                        is.na(`Virus detected`))  ~ 0)) %>%
  mutate(positive_flu = ifelse(positive_fluA == 1 | positive_fluB == 1, 1, 0)) %>% 
  mutate(positive_rhino = case_when(tested_rhino == 1 & str_detect(`Virus detected`, "Rhinovirus") == TRUE ~ 1,
                                    tested_rhino == 1 & (str_detect(`Virus detected`, "Rhinovirus") == FALSE | 
                                                        is.na(`Virus detected`))  ~ 0)) %>%
  mutate(positive_hmpv = case_when(tested_hmpv == 1 & str_detect(`Virus detected`, "HMPV") == TRUE ~ 1,
                                   tested_hmpv == 1 & (str_detect(`Virus detected`, "HMPV") == FALSE | 
                                                        is.na(`Virus detected`))  ~ 0)) %>%
  mutate(positive_adeno = case_when(tested_adeno == 1 & str_detect(`Virus detected`, "Adenovirus") == TRUE ~ 1,
                                    tested_adeno == 1 & (str_detect(`Virus detected`, "Adenovirus") == FALSE | 
                                                        is.na(`Virus detected`))  ~ 0)) %>%
  mutate(positive_parainfluenza = case_when(tested_parainfluenza == 1 & str_detect(`Virus detected`, "Parainfluenza") == TRUE ~ 1,
                                            tested_parainfluenza == 1 & (str_detect(`Virus detected`, "Parainfluenza") == FALSE | 
                                                                is.na(`Virus detected`))  ~ 0)) %>%
  mutate(positive_rsv = case_when(tested_rsv == 1 & str_detect(`Virus detected`, "Syncytial") == TRUE ~ 1,
                                  tested_rsv == 1 & (str_detect(`Virus detected`, "Syncytial") == FALSE | 
                                                                is.na(`Virus detected`))  ~ 0))

# variable listing all viruses tested
df <- cbind.data.frame(df,
    tested_viruses = apply(df, 1, function(x)
        paste(colnames(df[ , grepl( "tested_", names(df))])[ x[grepl( "tested_", names(x))] == 1 ], collapse = " "))) %>% 
  mutate(tested_viruses = str_replace_all(tested_viruses, "tested_", ""))


# variable listing all viruses detected 
df <- cbind.data.frame(df,
    positive_viruses = apply(df %>% 
                               mutate(across(positive_fluA:positive_rsv, ~ as.character(.x))) %>% 
                               mutate(across(positive_fluA:positive_rsv,  ~ replace_na(.x, "NA"))), 1, function(x)
        paste(colnames(df[ , grepl( "positive_", names(df))])[ x[grepl( "positive_", names(x))] == 1 ], collapse = " "))) %>% 
  mutate(positive_viruses = str_replace_all(positive_viruses, "positive_", "")) %>% 
  mutate(positive_viruses = str_replace_all(positive_viruses, "NA", "")) %>% 
  mutate(positive_viruses = str_replace(positive_viruses, " flu", "")) %>% 
  mutate(positive_viruses = ifelse(positive_viruses == "", NA, positive_viruses))


# create a variable positive_otherviruses indicating this record tested positive for other viruses 
df <- df %>% 
  mutate(positive_otherviruses = ifelse(positive_fluA == 1 | 
                                          positive_fluB == 1 |
                                          positive_flu == 1 |
                                          positive_rhino == 1 |
                                          positive_hmpv == 1 |
                                          positive_adeno == 1 |
                                          positive_parainfluenza == 1, 1, 0))

# write RSV+ cases for genetic information from Nate's Lab
# a <- df %>% filter(positive_rsv == 1) %>% 
#   dplyr::select(StudyID, `Collection Date`, DOB, `Accession #`)
# write.csv(a, "../../data/genetic/RSV_positive_records.csv", row.names = F)

```

### Table `r tab.counter`. Viral test (taken by a record)
```{r}
tab.counter <- tab.counter + 1
# briefly summarize testing
df %>% 
  group_by(tested_viruses) %>% count() %>% arrange(desc(n)) %>% rename(n_records = n) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

```

This table shows the number of testing records (w/ duplicates) that took certain tests, some viruses are not included here (like SARS-CoV-2).

<br>

### Table `r tab.counter`. Viral test results (by virus combo)
Listing all the combinations of viral test results. Each record contributes one virus combo.
```{r}
tab.counter <- tab.counter + 1

df %>% 
  group_by(positive_viruses) %>% count() %>% arrange(desc(n)) %>% rename(n_records = n) %>% 
  mutate(positive_viruses = ifelse(is.na(positive_viruses), "NO detection of any viruses", positive_viruses)) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```

<br>

### Table `r tab.counter`. Viral test results (by single virus)
Listing viruses tested positive, each record can contribute one or more as one record can be tested positive for multiple viruses.
```{r}
tab.counter <- tab.counter + 1

data.frame(
  fluA = nrow(df %>% filter(positive_fluA == 1)),
  fluB = nrow(df %>% filter(positive_fluB == 1)),
  rhino = nrow(df %>% filter(positive_rhino == 1)),
  hmpv = nrow(df %>% filter(positive_hmpv == 1)),
  adeno = nrow(df %>% filter(positive_adeno == 1)),
  parainfluenza = nrow(df %>% filter(positive_parainfluenza == 1)),
  rsv = nrow(df %>% filter(positive_rsv == 1)),
  `No detection` = nrow(df %>% filter(is.na(positive_viruses)))
) %>% pivot_longer(cols = 1:8, names_to = "Virus", values_to = "n_records") %>% 
  arrange(desc(n_records)) %>%
  mutate(perc = round(n_records / nrow(df)*100, 1)) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
  
```

<br>

### Table `r tab.counter`. Admit Date
#### Generate variable days_btw_admit_collect = collection_date - Admit date. If <0, collection before admission.
  * if the admission date and collection date are 7 days away, we consider this admission is "related" to the testing result (TBC).
  * if days_btw_admit_collect > 7 days, mark encounter_type from "inpatient" to "inpatient_unrelated" (see below).
  * Out of 
```{r}
tab.counter <- tab.counter + 1
 
df %>% 
  mutate(days_btw_admit_collect = as.Date(`Collection Date`) - as.Date(`Admit Date`)) %>%
  group_by(days_btw_admit_collect ) %>% count() %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

# those admitted after sample collection
df <- df %>% mutate(days_btw_admit_collect = as.numeric(as.Date(`Collection Date`) - as.Date(`Admit Date`))) 

df <- df %>% mutate(admit_date = as.Date(`Admit Date`))

n_temp <- df %>% filter(days_btw_admit_collect > 7) %>% nrow()
n_temp_case <- df %>% filter(days_btw_admit_collect > 7) %>% filter(positive_rsv == 1) %>% nrow()
#n_temp_mab <- df %>% filter(days_btw_admit_collect > 7) %>% filter(rsv_mab == 1) %>% nrow()



# a <- df %>% filter(days_btw_admit_collect > 7) %>% 
#   mutate(type = ifelse(DOB == admit_date & DOB == date_icu_admit, "ICU admission on DOB", NA)) %>%
#   select(248, 1:247)
# 
# write.csv(a, "../../data/days_btw_admit_collect_morethan7days.csv", row.names = F)
```

There are `r n_temp` records whose collection date was more than 7 days after admission date. Among, these, there are/is `r n_temp_case` RSV+ case (after the team's checking (Camila checked this), this single patient, with StudyID of 130615212, the reason for admission was NOT respiratory, the symptoms developed later during admission and that’s why they tested, so this is an unrelated admission), 25 were admitted to ICU on DOB. 

<br>

### Table `r tab.counter`. Hosp LoS
Length of Stay (in days) of hospitalization originally recorded in the main dataset.
```{r}
tab.counter <- tab.counter + 1

df %>%  count(`Hosp LoS`) %>% reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

n_missing_hosp_los <- df %>% filter(is.na(`Hosp LoS`)) %>% nrow()
```
  * Hosp LOS for "Emergency", "Specimen", "Outpatient", "Hospital Outpatient Surgery" encounter type: all are 1 day;
  * Hosp LOS for "Observation" encounter type: all but 2 records are 2 days, others all 1 day;
  * Hosp LOS for "Newborn" encounter type: range from 3-287 days
  
#### There are `r n_missing_hosp_los` records missing Hosp LoS: (these are all records from BH EMERGENCY DEPARTMENT)
After discussing, these are all outpaitent, thus no hosp stay.
```{r}
df %>% filter(is.na(`Hosp LoS`)) %>% arrange(StudyID) %>% 
  dplyr::select(StudyID, collection_date, `Collection Department`, tested_viruses, positive_viruses) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```
#### Generate new variable hosp_los:
  * if the encounter type is outpatient ---> NA, as there should not be hosp stay for outpatient.
```{r}
df <- df %>% 
  mutate(hosp_los = ifelse(`Encounter Type` %in% c("Emergency", "Outpatient", "Hospital Outpatient Surgery", "Specimen"), NA, `Hosp LoS`) )

df %>% count(hosp_los) %>% arrange(hosp_los) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```
  

<br>

### Table `r tab.counter`. Collection Department & Admission location
#### Recode these two to sample_source variable (might not use this variable?):
  * if Admission Location is available, use Admission Location;
  * if Admission Location is not available, use Collection Department.
```{r}
tab.counter <- tab.counter + 1

df <- df %>% 
  mutate(sample_source = `Admission Location`) %>%
  mutate(sample_source = case_when(is.na(sample_source) ~ `Collection Department`,
                                   TRUE ~ sample_source))

df %>% group_by(sample_source) %>% count() %>% arrange(desc(n)) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

```

<br>

### Table `r tab.counter`. Original Encounter type
This is the Encounter Type recorded in the original main dataset.
```{r}
tab.counter <- tab.counter + 1
df %>% group_by(`Encounter Type`) %>% count() %>% arrange(desc(n)) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```
<br>

### Table `r tab.counter`. Records missing Encounter type 
There are records missings for original "encounter type" variable. Most from LABs or DRAW STATION except one record from "NE PEDS OLD SAYBROOK" (after discussing, this one is an outpatient record). Fill in these missings with "Specimen" or "Outpatient".
```{r}
tab.counter <- tab.counter + 1

df %>% dplyr::select(StudyID, `Collection Department`, `Admission Location`, `Encounter Type`) %>%
  filter(is.na(`Encounter Type`)) %>% 
  arrange(`Admission Location`) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

df <- df %>%
  mutate(`Encounter Type` = case_when(
    is.na(`Encounter Type`) & str_detect(`Collection Department`, "MAIN LAB|DRAW STATION|SPECIMENS") ~ "Specimen",
    is.na(`Encounter Type`) & `Collection Department` == "NE PEDS OLD SAYBROOK" ~ "Outpatient",
    TRUE ~ `Encounter Type`
  ))
```

<br>

### Table `r tab.counter`. Aggregate "Encounter Type" to fewer categories 
#### Generated new variable: encounter_type, coded as:
  * Emergency ---> outpatient
  * Outpatient ---> outpatient
  * Hospital Outpatient Surgery ---> outpatient 
  * Specimen ---> outpatient
  * Inpatient ---> inpatient 
  * Observation ---> inpatient
  * Newborn ---> inpatient
  * if days_btw_admit_collect > 7 days, change from "inpatient" to "inpatient_unrelated".
```{r}
tab.counter <- tab.counter + 1

df <- df %>% 
  mutate(encounter_type = case_when(`Encounter Type` == "Emergency" ~ "outpatient",
                                    `Encounter Type` == "Inpatient" ~ "inpatient",
                                    `Encounter Type` == "Specimen" ~ "outpatient",
                                    `Encounter Type` == "Observation" ~ "inpatient",
                                    `Encounter Type` == "Newborn" ~ "inpatient",
                                    `Encounter Type` == "Outpatient" ~ "outpatient",
                                    `Encounter Type` == "Hospital Outpatient Surgery" ~ "outpatient")) %>%
  mutate(encounter_type = ifelse(days_btw_admit_collect > 7, "inpatient_unrelated", encounter_type))

df %>% count(encounter_type) %>% rename(n_records = n) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
  
```

<br>

### Table `r tab.counter`. ICU admission date
#### Generated new variables:
  * date_icu_admit: the same as ICU Admission Date but in Date class, N/A as NA;
  * days_btw_collection_icu: days between sample collection and ICU admission (collection_date - ICU admission)
  * icu_admitted: categorical variable indicating whether the icu can be related to the testing result (within a week of testing, TBC), taking values of:
    + yes
    + yes_unrelated: days_btw_collection_icu > 7
    + no
  
```{r}
tab.counter <- tab.counter + 1

df <- df %>% 
  mutate(date_icu_admit = as.Date(`ICU Admission Date`, "%m/%d/%Y")) %>%
  mutate(days_btw_collection_icu = as.numeric(as.Date(`Collection Date`) - date_icu_admit)) %>% 
  mutate(icu_admitted = case_when(days_btw_collection_icu <= 7 ~ "yes",
                                  !is.na(date_icu_admit) & days_btw_collection_icu > 7 ~ "yes_unrelated",
                                  TRUE ~ "no"))

df %>% count(days_btw_collection_icu) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

n_icu <- nrow(df %>% filter(!is.na(date_icu_admit))) # total ICU admissions 
n_icu_unrelated <- nrow(df %>% filter(days_btw_collection_icu > 7))
```

#### Out of `r n_icu` ICU admissions, `r n_icu_unrelated` have ICU admission more than 7 days before or after sample collection date. Check these: (1 RSV+, 9 took mAb)
```{r}
df %>% filter(days_btw_collection_icu > 7) %>% 
  dplyr::select(StudyID, DOB, admit_date, date_icu_admit, collection_date,days_btw_collection_icu, positive_rsv) %>% 
  mutate(type = ifelse(DOB == admit_date & DOB == date_icu_admit, 
                       "ICU admission on DOB", NA)) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

# a <- df %>% filter(days_btw_collection_icu > 7) %>% 
#   mutate(type = ifelse(DOB == admit_date & DOB == date_icu_admit, "ICU admission on DOB", NA)) %>%
#   select(248, 1:247)
# write.csv(a, "../../data/days_btw_ICUadmit_collect_morethan7days.csv", row.names = F)
```

<br>

### Figure `r fig.counter`. ICU admission date 
These are ICU admissions within 7 days of sample collection date.
```{r}
fig.counter <- fig.counter + 1

df %>% 
  filter(icu_admitted == "yes") %>%
  ggplot() + 
  geom_histogram(aes(x = date_icu_admit), color = "black", fill = "white") + theme_classic()
```

<br>

### Figure `r fig.counter`. ICU LOS
#### The original data was in XXd XXh format. Generate new variables:
  * icu_los_hours (unit: hour)
  * icu_los_days (unit: day)
```{r}
fig.counter <- fig.counter + 1

df <- df %>% 
  mutate(icu_los_hours = case_when( 
                                    str_detect(`ICU LOS`, "h") == FALSE & str_detect(`ICU LOS`, "d") == TRUE ~
                                      as.numeric(str_remove(`ICU LOS`, "d")) * 24,
                                    str_detect(`ICU LOS`, "h") == TRUE & str_detect(`ICU LOS`, "d") == FALSE ~ 
                                      as.numeric(str_remove(`ICU LOS`, "h")),
                                    str_detect(`ICU LOS`, "h") == TRUE & str_detect(`ICU LOS`, "d") == TRUE ~ 
                                      parse_number(`ICU LOS`) * 24 + as.numeric(str_remove(gsub(".* ", "", `ICU LOS`), "h")),
                                    str_detect(`ICU LOS`, "m") == TRUE ~ 
                                      as.numeric(str_remove(`ICU LOS`, "m")) * 30
                                  )) %>%
  mutate(icu_los_days = icu_los_hours / 24)


df %>%
  filter(icu_admitted == "yes") %>%
  ggplot() + ggtitle("Only plotting ICU admissions related to the testing \n (within a week of sample collection)") +
  geom_histogram(aes(x = icu_los_days), color = "black", fill = "white")  + theme_classic()
```

Several infants with ICU LOS longer than 1 month: 

### Table `r tab.counter`.
```{r}
tab.counter <- tab.counter + 1

df %>% filter(icu_admitted == "yes") %>% filter(icu_los_days > 30)%>% 
  dplyr::select(StudyID, `Collection Date`, date_icu_admit, icu_los_days) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```

<br>

### Figure `r fig.counter`. Gest age (as recorded in "Gest Age" variable)
There are ~700 records missing for original Gest Age variable.

```{r}
fig.counter <- fig.counter + 1

df %>% 
  ggplot() + geom_histogram(aes(x = `Gest Age`), binwidth = 1, color = "black", fill = "white") + theme_classic()
  
```

#### Generate categorical variable of gest age: gest_age_cat **(is the following classification okay? combine groups?)**
#### Reference: https://www.cdc.gov/nchs/data/nvsr/nvsr73/nvsr73-01.pdf
  *	42 and +: post term
  *	41: late term
  * 39-40: full term
  * 37-38: early term
  *	< 37: preterm
 
### Table `r tab.counter`. Gest Age (classified only using "Gest Age" variable)
#### In addition to "Gest Age" variable, I will also use Medical History, Problems.. variables to classify gestational age to fill in NA here, see below.
```{r}
tab.counter <- tab.counter + 1

df <- df %>%
  mutate(gest_age_cat = case_when( `Gest Age` >= 42 ~ "post term",
                                    `Gest Age` == 41 ~ "late term",
                                    `Gest Age` == 39 | `Gest Age` == 40 ~ "full term",
                                    `Gest Age`== 37 | `Gest Age` == 38 ~ "early term",
                                    `Gest Age` < 37 ~ "preterm")) 
  
df %>% count(gest_age_cat) %>% arrange(desc(n)) %>% rename(n_records = n) %>%
  mutate(perc = round(n_records / nrow(df) * 100,1)) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

```

<br>

### Figure `r fig.counter`. Birth weight
  * PENDING: Generate birth_weight_kg (numeric), low_birth_weight (binary). Low birth weight is defined as a birth weight of less than 2500 g (up to and including 2499 g), as per the World Health Organization (WHO).
  * what is the unit of original variable Birth Wgt (ounce) 
  * created a new variable birth_weight in grams (1 ounce = 28.3 g)
  * After confirming, generate risk factor indicating low birth weight.
```{r}
fig.counter <- fig.counter + 1

df <- df %>% mutate(birth_weight = as.numeric(`Birth Wgt`) * 28.3)

df %>% 
  mutate(birth_weight) %>%
  ggplot() +
  geom_histogram(aes(x = birth_weight), color = "black", fill = "white") + theme_classic()
```

<br>

### Table `r tab.counter`. Race and Ethnicity
There are many conflicting answers. Here are the unique answers for Race variable:
```{r}
tab.counter <- tab.counter + 1

df %>% count(Race) %>% arrange(desc(n)) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```

<br>

#### To classify race, generate new variable "race". I use dominant answers to classify, e.g. if a records answered both black and white, use black.
```{r echo = T}
df <- df %>% 
  mutate(race = case_when(str_detect(Race, "Black") ~ "Black",
                          Race %in% c("White",
                                      "I Do Not See My Race Listed Here\r\nWhite",
                                      "White\r\nI Do Not Know",
                                      "White\r\nI Do Not See My Race Listed Here",
                                      "I Do Not Know\r\nWhite",
                                      "I Prefer Not To Share\r\nWhite",
                                      "White\r\nI Do Not Know\r\nI Do Not See My Race Listed Here") ~ "White",
                          Race %in% c("Asian",
                                      "Asian\r\nWhite",
                                      "White\r\nAsian",
                                      "Asian\r\nI Do Not Know",
                                      "Asian Indian",
                                      "Asian\r\nPacific Islander\r\nWhite",
                                      "Asian\r\nI Do Not Know\r\nWhite") ~ "Asian",
                          Race %in% c("Pacific Islander\r\nWhite",
                                      "White\r\nPacific Islander",
                                      "Pacific Islander\r\nI Do Not See My Race Listed Here",
                                      "American Indian or Native American",
                                      "Middle Eastern or Northern African",
                                      "Pacific Islander",
                                      "American Indian or Native American\r\nI Do Not Know",
                                      "Other\r\nI Do Not See My Race Listed Here",
                                      "I Do Not See My Race Listed Here",
                                      "I Do Not See My Race Listed Here\r\nI Do Not Know",
                                      "I Do Not Know\r\nI Do Not See My Race Listed Here",
                                      "I Do Not See My Race Listed Here\r\nI Prefer Not To Share",
                                      "White\r\nAmerican Indian or Native American",
                                      "Other") ~ "Other",
                          Race %in% c("I Do Not Know",
                                      "I Prefer Not To Share") ~ "unknown")) %>%
  # combine Asian to "Other" category
  mutate(race = ifelse(race == "Asian", "Other", race)) %>%
  mutate(race = ifelse(is.na(race), "unknown", race))

df %>% count(race) %>% 
  mutate(perc = round(n/nrow(df) * 100,1)) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```

```{r}
df %>% count(Ethnicity) %>% arrange(desc(n)) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```

#### Combine race and ethnicity into one variable: generate this new variable called "race_ethnicity" 
#### Method 1 to combine race and ethnicity:
  * Hispanic & not black & not white ---> hispanic 
  * Hispanic & other/unknown race ---> hispanic
  * Black (any ethnicity) ---> Black 
  * white (any ethnicity) ---> white 
  * other race & not Hispanic/unknown ethnicity ---> other 
  * other race & not Hispanic/unknown ethnicity ---> unknown

```{r echo = T}
df <- df %>% 
  mutate(ethnicity = case_when(Ethnicity %in% c("Not Hispanic or Latino/a/e") ~ "Not Hispanic or Latino",
                               Ethnicity %in% c("Hispanic or Latino/a/e", 
                                                 "Puerto Rican",
                                                 "Mexican, Mexican American, Chicano/a") ~ "Hispanic or Latino",
                               Ethnicity %in% c("I Prefer Not To Share",
                                                "I Do Not Know") ~ "unknown"))


# combine race and ethnicity (Method 1)
df <- df %>% 
  mutate(race_ethnicity_2 = case_when(race == "Black" ~ "Black",
                                    race == "White" ~ "White",
                                    race %in% c("Other", "unknown") & ethnicity %in% c("Hispanic or Latino") ~ "Hispanic or Latino",
                                    race == "Other" & ethnicity %in% c("Not Hispanic or Latino", "unknown") ~ "Other",
                                    race == "unknown" & ethnicity %in% c("Not Hispanic or Latino", "unknown") ~ "unknown",
                                    TRUE ~ "unknown"))

df %>% count(race_ethnicity_2) %>% arrange(desc(n)) %>% mutate(perc = round(n/nrow(df)*100,1)) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```

<br>

#### Method 2 to combine race and ethnicity:
  * I think Carlos prefers this classification.
```{r echo = T}
df <- df %>% 
  mutate(race_ethnicity = case_when(ethnicity == "Hispanic or Latino" ~ "Hispanic",
                                      race == "Black" & ethnicity == "Not Hispanic or Latino" ~ "Black non-Hispanic",
                                      race == "Other" & ethnicity == "Not Hispanic or Latino" ~ "Other non-Hispanic",
                                      race == "White" & ethnicity == "Not Hispanic or Latino" ~ "White non-Hispanic",
                                      TRUE ~ "unknown"))
df %>% count(race_ethnicity_2) %>% arrange(desc(n)) %>% mutate(perc = round(n/nrow(df)*100,1)) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```
  
  

<br>

### Table `r tab.counter`. Primary Insurance & Payor
#### Generate new variable insurance_type (TBC)
  *	Medicare / Medicaid ---> public insurance 
  *	Most others ---> private insurance 
  *	Who are considered as “uninsured”? (patients having NA for Primary Insurance and Payor variable? n = 17)
  * After discussing, made some changes to classification. I googled the Insurance and reclassified some.
Aim to use this variable to see the SES background of patients.
```{r}
tab.counter <- tab.counter + 1
df <- df %>% 
  mutate(insurance_concat = paste(`Primary Insurance`, Payor)) %>% 
  mutate(insurance_type = case_when(str_detect(insurance_concat, "MEDICAID") | str_detect(insurance_concat, "MEDICARE") ~ "public",
                                    insurance_concat == "NA NA" ~ "uninsured",
                                    TRUE ~ "private")) %>%
  dplyr::select(-insurance_concat)


# update: after discussing, reclassify insurance_type for some records:
# LOCAL 1199SEIU BENEFIT FUNDS --> uninsured
# MCD MGD” (Medicare Coverage Database managed ?) are Medicare (public insurance)
df <- df %>%
  mutate(insurance_type = case_when(`Primary Insurance` == "LOCAL 1199SEIU BENEFIT FUNDS" ~ "uninsured",
                                    str_detect(`Primary Insurance`, "MCD MGD") | str_detect(Payor, "MCD MGD") ~ "public",
                                    TRUE ~ insurance_type))


df %>% count(insurance_type) %>% arrange(desc(n)) %>% rename(n_records = n) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```

<br>

### Table `r tab.counter`. Fever?
This variable displays whether the patient had a fever according to the NHSN definition (>38 C) within three days of the collection date. The information appears as a Yes or a No.
```{r}
tab.counter <- tab.counter + 1

df %>% count(`Fever?`) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```

<br>

### Table `r tab.counter`. Temp
The most recent flowsheet data for temperature. Convert to new numeric variable recent_temp. (Might not be useful as this is the "most recent" temperature, but I used this below in generating symptom variables, if recent_temp>38, I considered this record had fever symptom.)
```{r}
tab.counter <- tab.counter + 1

df <- df %>% 
  mutate(recent_temp = substring(gsub(".*°F (.+) °C.*", "\\1", Temp), 2)  ) %>% 
  mutate(recent_temp = as.numeric(recent_temp))

df %>% count(recent_temp) %>% arrange(desc(recent_temp)) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

df %>% ggplot() +
  geom_histogram(aes(x = recent_temp), color = "black", fill = "white") + theme_classic() +
  geom_vline(xintercept = 38, color = "red", linetype = "dashed")
```

<br>

### Last PCP visit (haven't processed)
### Last Well Child visit (haven't processed)
### Recent contact (haven't processed)

<br>

### Below are text patterns to detect risk factors (i.e. underlying conditions) and respiratory symptoms from the following variables:
  * Medical History (past) ---> risk factors
  * Problem List (past + current, more from past based on descriptions) ---> risk factors
  * Primary Problem (current) ---> risk factors & respiratory symptoms
  * ED Dx (current) ---> risk factors & respiratory symptoms
  * Admit Dx (current) ---> risk factors & respiratory symptoms
  * Hospital Problem List (current + past, more from current) ---> risk factors & respiratory symptoms
  
#### I detected the presence of these patterns to see if a record has certain risk factor (based on past and current encounters) or show a certain respiratory symptom in current encounter (based on diagnosis records of current encounter). The new variables generated are binary variables. For example, med_hist_congen_heart means that based on description in the "Medical History" variable, this records had congenital heart disease, which can be a risk factor for more severe outcomes.
```{r, echo = T}
######################################
# patterns for underlying risk factors
######################################

pattern_anemia <- paste(c("anemia",
                          "S-C",
                          "thalassemia",
                          "Hemoglobin S-S disease",
                          "Sickle cell",
                          "sickle-cell",
                          "Hemoglobin S trait"), 
                        collapse = "|")

pattern_blood <- paste(pattern_anemia, 
                       c("hemangioma",
                         "Thrombus of aorta",
                         "hypoglycemia"),
                       collapse = "|")

pattern_asthma <- paste(c("asthma",
                          "Reactive airway disease"),
                        collapse = "|")


pattern_liver <- paste(c("liver cell damage",
                         "Liver cell injury",
                         "liver disease",
                         "Decompensated hepatic cirrhosis",
                         "Liver transplanted"), 
                       collapse = "|")

pattern_immunodeficiency <- paste(c("liver transplanted",
                                    "transplant",
                                    "leukemia"),
                                  collapse = "|")

pattern_cvd <- paste(c("Atrial septa",
                       "ventricular septa",
                 "Patent ductus arteriosus",
                 "Cardiac abnormality",
                 "Cardiac hypertrophy", # added 
                 "cardiac septal defect", # added 
                 "fetal cardiac arrhythmia", # added
                 "Cardiac dysfunction", # added
                 "cardiac arrest", # added 
                 "Stenosis of right pulmonary artery", # added
                 "Stenosis of left pulmonary artery", # added
                 "Stenosis of pulmonary artery", # added
                 "Cardiac abnormality", # added
                 "cardiac surgery", # added
                 "cardiac valve disease", # added 
                 "Cardiac anomaly", # added 
                 "Congenital heart disease",
                 "Partial AV canal",
                 "Ventricular septa",
                 "Coarctation of aorta",
                 "double outlet right ventricle",
                 "Dextrocardia",
                 "DORV",
                 # "Heart murmur",
                 # "Heart murmur of newborn",
                 # "murmur",
                 "heart problem",
                 "Mitral regurgitation",
                 "Kawasaki disease",
                 "Coarctation of aorta",
                 # "hemangioma", # moved to blood group
                 "atrial septal defect",
                 # "Thrombus of aorta", # moved to blood group
                 "premature atrial contraction",
                 "Cardiomegaly",
                 "Myocarditis",
                 "supraventricular tachycardia",
                 "Tetralogy of Fallot",
                 "Atrioventricular canal (AVC), complete",
                 "Heart failure",
                 "Aortic arch anomaly",
                 "supraventricular tachycardia",
                 "aortic coarctation",
                 "Enlarged heart"),
                 collapse = "|")


# pattern_leukemia <- "leukemia" # combined with immunodeficiency group


pattern_gi <- paste(c(
                      # "Abdominal distension",
                      # "Acid reflux",
                      # "gastroesophageal reflux",
                      "GI disease",
                      # "Constipation",
                      "Esophageal atresia",
                      "Gastric perforation",
                      # "Gastric reflux",
                      "Hirschsprung",
                      # "GERD",
                      "Colostomy",
                      "necrotizing enterocolitis",
                      "Intestinal perforation",
                      "Intussusception",
                      "Biliary atresia",
                      "Ileostomy",
                      # "esophageal reflux",
                      "Pyloric stenosis",
                      # "Reflux gastritis",
                      "Gastric bleed",
                      "GI bleed",
                      "gastritis"),
                    collapse = "|")


pattern_congen_heart <- paste(c("Congenital heart disease",
                                "Coarctation of aorta",
                                "Congenital heart",
                                "D-TGA",
                                "double outlet right ventricle",
                                "Dextrocardia",
                                "DORV",
                                "Cardiac abnormality",
                                "ventricular septa",
                                "Mitral regurgitation",
                                "Coarctation of aorta",
                                "Hypoplastic aortic arch",
                                "atrial septal defect",
                                # "Thrombus of aorta", # moved to blood group
                                "Heart abnormality",
                                "Cardiomegaly",
                                "patent ductus arteriosus",
                                "Tetralogy of Fallot",
                                "Atrioventricular canal (AVC), complete",
                                "persistent left superior vena cava",
                                "Aortic arch anomaly",
                                "Wolff-Parkinson-White (WPW) syndrome",
                                "supraventricular tachycardia",
                                "Partial AV canal",
                                "Atrial septa",
                                # "Heart murmur of newborn",
                                "supraventricular tachycardia",
                                "Partial anomalous pulmonary venous return",
                                "aortic coarctation",
                                "Congenital coronary artery fistula to pulmonary artery",
                                "Peripheral pulmonic stenosis",
                                "Tricuspid atresia with normal great arteries"),
                              collapse = "|")

pattern_cardiac <- paste(pattern_cvd, 
                         pattern_congen_heart,
                         c("Pulmonary valve atresia",
                           "Partial anomalous pulmonary venous return",
                           "pulmonary artery stenosis",
                           "pulmonary artery",
                           "Peripheral pulmonic stenosis",
                           "Pulmonary valve stenosis",
                           "Pulmonary hypertension"),
                         collapse = "|")


pattern_pulmonary <- paste(c(
                             # "Pulmonary valve atresia", # moved to cardiac
                             # "Chronic cough",
                             "CPAM",
                             "Cystic fibrosis",
                             "Bronchopulmonary dysplasia",
                             "Protracted bacterial bronchitis",
                             "reactive airway disease",
                             "Pneumothorax",
                             #"Pulmonary hypertension",
                             #"Pulmonary valve stenosis",
                             "Bronchomalacia",
                             "Tracheomalacia"
                             # "Partial anomalous pulmonary venous return", 
                             # "pulmonary artery stenosis",
                             # "pulmonary artery",
                             # "Peripheral pulmonic stenosis"
                             ),
                           collapse = "|")

pattern_down <- paste(c("Down syndrome",
                        "Trisomy 21"),
                      collapse = "|")

# 37-38 weeks 
pattern_earlyterm <- paste(c("37 completed weeks",
                             "38 completed weeks",
                             "37 weeks gestation",
                             "38 weeks gestation"),
                           collapse = "|")

# 39-40 weeks
pattern_fullterm <- paste(c("39 completed weeks",
                            "39 weeks gestation",
                            "Term newborn",
                            "Term birth",
                            "40 completed weeks",
                            "40 weeks gestation"),
                          collapse = "|")

# < 37 weeks
pattern_preterm <- paste(c("Premature",
                           "prematurity",
                           "Extremely low birth weight",
                           "Preterm",
                           "36 weeks gestation",
                           "36 completed weeks",
                           "preterm newborn",
                           "preterm birth",
                           "33-34 completed weeks",
                           "29-30 completed weeks",
                           "35-36 completed weeks",
                           "34 completed weeks",
                           "35 completed weeks",
                           "22 weeks gestation"),
                         collapse = "|")

# >= 42 weeks
pattern_postterm <- paste(c("post-term",
                            "post term"),
                          collapse = "|")

pattern_environmental <- paste(c("financial difficulties",
                                 "housing instability",
                                 "food insecurity",
                                 "other social stressor",
                                 "tobacco smoke exposure",
                                 "second hand smoke exposure",
                                 "unemployed",
                                 "high risk social situation",
                                 "income sufficient to buy only necessities",
                                 "contact with or exposure to communicable disease",
                                 "concerned about having social problem",
                                 "social problem",
                                 "economic hardship",
                                 "Need for follow-up by social worker",
                                 "homeless",
                                 "environmental allergies",
                                 "without employment"))


######################################
# patterns for respiratory symptoms
######################################

# for upper respiratory tract diseases 
pattern_URTI <- paste(c("Abnormal breathing",
                        "Breathing difficulty",
                        "difficulty breathing",
                        "breathing problem",
                        "Shortness of breath",
                        "cough",
                        "Acute obstructive laryngitis",
                        "pharyngitis",
                        "otitis media",
                        "upper respiratory infection",
                        "upper respiratory tract infection",
                        "upper resp. tract infection",
                        "upper resp. infection",
                        "croup",
                        "Nasopharyngitis",
                        "Pain in throat",
                        "reactive airway disease",
                        "Nasal congestion",
                        # "wheezing", # moved to LRT
                        "sore throat",
                        "URI",
                        "Laryngeal stridor"), 
                      collapse = "|")

# for lower respiratory tract diseases:
pattern_LRTI <- paste(c("bronchiolitis",
                        "Laryngotracheobronchitis",
                        "Bronchospasm",
                        "Acute chest syndrome",
                        "Acute hypoxic respiratory failure",
                        "Pneumonia",
                        "Hypoxia",
                        "Hypoxemia",
                        "Lower resp. tract infection",
                        "Lower resp. infection",
                        "Lower respiratory tract infection",
                        "Lower respiratory infection",
                        "Hypoxemic respiratory failure",
                        "Acute respiratory failure with hypoxia",
                        "wheezing"), 
                      collapse = "|")


pattern_fever <- "fever|febrile"

pattern_cough <- "cough"

pattern_wheezing <- "wheezing" # this is used in both risk factor detection and symp detection

pattern_breathing <- paste(c("Abnormal breathing",
                             "Breathing difficulty",
                             "difficulty breathing",
                             "Shortness of breath",
                             "breathing problem",
                             "apnea"), 
                           collapse = "|")

pattern_bronchiolitis <- "bronchiolitis|Bronchospasm"

pattern_sepsis <- "sepsis"

# pattern_apnea <- "apnea"

# some general terms used to detect if the record's encounter is suspcted resp infection
pattern_suspect_resp_general <- paste(c("respiratory",
                                        "RSV",
                                        "syncytial",
                                        "viral infection",
                                        "covid",
                                        "influenza", 
                                        "flu",
                                        "viral illness",
                                        "Viral syndrome",
                                        "nasal"
                                        #"asthma",
                                        #"decreased activity"
                                        ), 
                                      collapse = "|")
```


```{r}
##########################
### Medical History (past)
##########################

# extract risk factors and underlying conditions from `Medical History`
df <- df %>%
  mutate(med_hist_anemia = case_when(grepl(pattern_anemia, `Medical History`, ignore.case = T) ~ 1)) %>%
  mutate(med_hist_blood = case_when(grepl(pattern_blood, `Medical History`, ignore.case = T) ~ 1)) %>%
  mutate(med_hist_preterm = case_when(grepl(pattern_preterm, `Medical History`, ignore.case = T) ~ 1)) %>%
  mutate(med_hist_postterm = case_when(grepl(pattern_postterm, `Medical History`, ignore.case = T) ~ 1)) %>%
  mutate(med_hist_asthma = case_when(grepl(pattern_asthma, `Medical History`, ignore.case = T) ~ 1)) %>%
  mutate(med_hist_liver = case_when(grepl(pattern_liver, `Medical History`, ignore.case = T) ~ 1)) %>%
  mutate(med_hist_cvd = case_when(grepl(pattern_cvd, `Medical History`, ignore.case = T) ~ 1)) %>%
  mutate(med_hist_immunodeficiency = case_when(grepl(pattern_immunodeficiency, `Medical History`, ignore.case = T) ~ 1)) %>%
  mutate(med_hist_gi = case_when(grepl(pattern_gi, `Medical History`, ignore.case = T) ~ 1)) %>%
  mutate(med_hist_congen_heart = case_when(grepl(pattern_congen_heart, `Medical History`, ignore.case = T) ~ 1)) %>%
  mutate(med_hist_cardiac = case_when(grepl(pattern_cardiac, `Medical History`, ignore.case = T) ~ 1)) %>%
  mutate(med_hist_pulmonary = case_when(grepl(pattern_pulmonary, `Medical History`, ignore.case = T) ~ 1)) %>%
  mutate(med_hist_down = case_when(grepl(pattern_down, `Medical History`, ignore.case = T) ~ 1))  %>%
  mutate(med_hist_cvd = ifelse(med_hist_congen_heart == 1 & is.na(med_hist_cvd), 1, med_hist_cvd)) %>%
  mutate(med_hist_earlyterm = case_when(grepl(pattern_earlyterm, `Medical History`, ignore.case = T) ~ 1)) %>%
  mutate(med_hist_fullterm = case_when(grepl(pattern_fullterm, `Medical History`, ignore.case = T)  & 
                                           !grepl(pattern_preterm, `Medical History`, ignore.case = T) ~ 1)) 
  # # added this per team's checking advice
  # mutate(med_hist_wheezing = case_when(grepl(pattern_wheezing, `Medical History`, ignore.case = T) ~ 1)) %>%
  # mutate(med_hist_environmental = case_when(grepl(pattern_environmental, `Medical History`, ignore.case = T) ~ 1))

  

```

```{r}
##########################
### Problem List (past+current, more from past)
##########################

# extract risk factors and underlying conditions from `Problem List`

df <- df %>%
  mutate(prob_list_anemia = case_when(grepl(pattern_anemia, `Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(prob_list_blood = case_when(grepl(pattern_blood, `Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(prob_list_preterm = case_when(grepl(pattern_preterm, `Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(prob_list_postterm = case_when(grepl(pattern_postterm, `Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(prob_list_asthma = case_when(grepl(pattern_asthma, `Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(prob_list_liver = case_when(grepl(pattern_liver, `Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(prob_list_cvd = case_when(grepl(pattern_cvd, `Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(prob_list_immunodeficiency = case_when(grepl(pattern_immunodeficiency, `Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(prob_list_gi = case_when(grepl(pattern_gi, `Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(prob_list_congen_heart = case_when(grepl(pattern_congen_heart, `Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(prob_list_cardiac = case_when(grepl(pattern_cardiac, `Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(prob_list_pulmonary = case_when(grepl(pattern_pulmonary, `Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(prob_list_down = case_when(grepl(pattern_down, `Problem List`, ignore.case = T) ~ 1))  %>%
  mutate(prob_list_cvd = ifelse(prob_list_congen_heart == 1 & is.na(prob_list_cvd), 1, prob_list_cvd)) %>%
  mutate(prob_list_earlyterm = case_when(grepl(pattern_earlyterm, `Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(prob_list_fullterm = case_when(grepl(pattern_fullterm, `Problem List`, ignore.case = T)  & 
                                           !grepl(pattern_preterm, `Problem List`, ignore.case = T) ~ 1))
  # # added this per team's advice
  # mutate(prob_list_wheezing = case_when(grepl(pattern_wheezing, `Problem List`, ignore.case = T) ~ 1)) %>%
  # mutate(prob_list_environmental = case_when(grepl(pattern_environmental, `Problem List`, ignore.case = T) ~ 1))

```

```{r}
##################################
### Primary Problem (current)
##################################

# extract risk factors and underlying conditions from `Primary Problem`
df <- df %>%
  mutate(prim_prob_anemia = case_when(grepl(pattern_anemia, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_blood = case_when(grepl(pattern_blood, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_preterm = case_when(grepl(pattern_preterm, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_postterm = case_when(grepl(pattern_postterm, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_asthma = case_when(grepl(pattern_asthma, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_liver = case_when(grepl(pattern_liver, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_cvd = case_when(grepl(pattern_cvd, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_immunodeficiency = case_when(grepl(pattern_immunodeficiency, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_gi = case_when(grepl(pattern_gi, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_congen_heart = case_when(grepl(pattern_congen_heart, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_cardiac = case_when(grepl(pattern_cardiac, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_pulmonary = case_when(grepl(pattern_pulmonary, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_down = case_when(grepl(pattern_down, `Primary Problem`, ignore.case = T) ~ 1))  %>%
  mutate(prim_prob_cvd = ifelse(prim_prob_congen_heart == 1 & is.na(prim_prob_cvd), 1, prim_prob_cvd)) %>%
  mutate(prim_prob_earlyterm = case_when(grepl(pattern_earlyterm, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_fullterm = case_when(grepl(pattern_fullterm, `Primary Problem`, ignore.case = T)  & 
                                           !grepl(pattern_preterm, `Primary Problem`, ignore.case = T) ~ 1)) 
  # # added per team's checking advice
  # mutate(prim_prob_environmental = case_when(grepl(pattern_environmental, `Primary Problem`, ignore.case = T) ~ 1))
  

# extract conditions related to respiratory infection
df <- df %>% 
  mutate(prim_prob_URTI = case_when(grepl(pattern_URTI, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_LRTI = case_when(grepl(pattern_LRTI, `Primary Problem`, ignore.case = T) ~ 1)) %>% 
  mutate(prim_prob_fever = case_when(grepl(pattern_fever, `Primary Problem`, ignore.case = T) | `Fever?` == "Yes" | recent_temp >= 38 ~ 1)) %>%
  mutate(prim_prob_cough = case_when(grepl(pattern_cough, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_wheezing = case_when(grepl(pattern_wheezing, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_breathing = case_when(grepl(pattern_breathing, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_bronchiolitis = case_when(grepl(pattern_bronchiolitis, `Primary Problem`, ignore.case = T) ~ 1)) %>%
  mutate(prim_prob_sepsis = case_when(grepl(pattern_sepsis, `Primary Problem`, ignore.case = T) ~ 1))
  # if a record has LRTI and URTI at the same time, record this as LRTI
  # mutate(prim_prob_URTI = case_when(prim_prob_URTI == 1 & is.na(prim_prob_LRTI) ~ 1))
```

```{r}
############################
### ED Dx (current)
############################

# extract risk factors and underlying conditions from ED Dx 
df <- df %>%
  mutate(ED_dx_anemia = case_when(grepl(pattern_anemia, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_blood = case_when(grepl(pattern_blood, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_preterm = case_when(grepl(pattern_preterm, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_postterm = case_when(grepl(pattern_postterm, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_asthma = case_when(grepl(pattern_asthma, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_liver = case_when(grepl(pattern_liver, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_cvd = case_when(grepl(pattern_cvd, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_immunodeficiency = case_when(grepl(pattern_immunodeficiency, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_gi = case_when(grepl(pattern_gi, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_congen_heart = case_when(grepl(pattern_congen_heart, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_cardiac = case_when(grepl(pattern_cardiac, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_pulmonary = case_when(grepl(pattern_pulmonary, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_down = case_when(grepl(pattern_down, `ED Dx`, ignore.case = T) ~ 1))  %>%
  mutate(ED_dx_cvd = ifelse(ED_dx_congen_heart == 1 & is.na(ED_dx_cvd), 1, ED_dx_cvd)) %>%
  mutate(ED_dx_earlyterm = case_when(grepl(pattern_earlyterm, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_fullterm = case_when(grepl(pattern_fullterm, `ED Dx`, ignore.case = T)  & 
                                           !grepl(pattern_preterm, `ED Dx`, ignore.case = T) ~ 1)) 
  # # added per team's checking advice
  # mutate(ED_dx_environmental = case_when(grepl(pattern_environmental, `ED Dx`, ignore.case = T) ~ 1))


# extract conditions related to respiratory infection
df <- df %>% 
  mutate(ED_dx_URTI = case_when(grepl(pattern_URTI, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_LRTI = case_when(grepl(pattern_LRTI, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_fever = case_when(grepl(pattern_fever, `ED Dx`, ignore.case = T) | 
                                   `Fever?` == "Yes" | recent_temp >= 38 ~ 1)) %>%
  mutate(ED_dx_cough = case_when(grepl(pattern_cough, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_wheezing = case_when(grepl(pattern_wheezing, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_breathing = case_when(grepl(pattern_breathing, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_bronchiolitis = case_when(grepl(pattern_bronchiolitis, `ED Dx`, ignore.case = T) ~ 1)) %>%
  mutate(ED_dx_sepsis = case_when(grepl(pattern_sepsis, `ED Dx`, ignore.case = T) ~ 1))
  # if a record has LRTI and URTI at the same time, record this as LRTI
  # mutate(ED_dx_URTI = case_when(ED_dx_URTI == 1 & is.na(ED_dx_LRTI) ~ 1))
  
```

```{r}
############################
### Admit Dx (current)
############################

# extract risk factors and underlying conditions from Admit Dx
df <- df %>% 
  mutate(admit_dx_anemia = case_when(grepl(pattern_anemia, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_blood = case_when(grepl(pattern_blood, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_preterm = case_when(grepl(pattern_preterm, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_postterm = case_when(grepl(pattern_postterm, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_asthma = case_when(grepl(pattern_asthma, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_liver = case_when(grepl(pattern_liver, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_cvd = case_when(grepl(pattern_cvd, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_immunodeficiency = case_when(grepl(pattern_immunodeficiency, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_gi = case_when(grepl(pattern_gi, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_congen_heart = case_when(grepl(pattern_congen_heart, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_cardiac = case_when(grepl(pattern_cardiac, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_pulmonary = case_when(grepl(pattern_pulmonary, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_down = case_when(grepl(pattern_down, `Admit Dx`, ignore.case = T) ~ 1))  %>%
  mutate(admit_dx_cvd = ifelse(admit_dx_congen_heart == 1 & is.na(admit_dx_cvd), 1, admit_dx_cvd)) %>%
  mutate(admit_dx_earlyterm = case_when(grepl(pattern_earlyterm, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_fullterm = case_when(grepl(pattern_fullterm, `Admit Dx`, ignore.case = T)  & 
                                           !grepl(pattern_preterm, `Admit Dx`, ignore.case = T) ~ 1))
  # # added per team's checking advice
  # mutate(admit_dx_environmental = case_when(grepl(pattern_environmental, `Admit Dx`, ignore.case = T) ~ 1))

# extract conditions related to respiratory infection 
df <- df %>% 
  mutate(admit_dx_URTI = case_when(grepl(pattern_URTI, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_LRTI = case_when(grepl(pattern_LRTI, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_fever = case_when(grepl(pattern_fever, `Admit Dx`, ignore.case = T) | 
                                      `Fever?` == "Yes" | recent_temp >= 38 ~ 1)) %>%
  mutate(admit_dx_cough = case_when(grepl(pattern_cough, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_wheezing = case_when(grepl(pattern_wheezing, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_breathing = case_when(grepl(pattern_breathing, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_bronchiolitis = case_when(grepl(pattern_bronchiolitis, `Admit Dx`, ignore.case = T) ~ 1)) %>%
  mutate(admit_dx_sepsis = case_when(grepl(pattern_sepsis, `Admit Dx`, ignore.case = T) ~ 1))
  # if a record has LRTI and URTI at the same time, record this as LRTI
  # mutate(admit_dx_URTI = case_when(admit_dx_URTI == 1 & is.na(admit_dx_LRTI) ~ 1))
```

```{r}
#########################################
### Hospital Problem List (current+past,more from current)
########################################

# extract risk factors and underlying conditions from Admit Dx
df <- df %>% 
  mutate(hosp_prob_anemia = case_when(grepl(pattern_anemia, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_blood = case_when(grepl(pattern_blood, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_preterm = case_when(grepl(pattern_preterm, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_postterm = case_when(grepl(pattern_postterm, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_asthma = case_when(grepl(pattern_asthma, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_liver = case_when(grepl(pattern_liver, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_cvd = case_when(grepl(pattern_cvd, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_immunodeficiency = case_when(grepl(pattern_immunodeficiency, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_gi = case_when(grepl(pattern_gi, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_congen_heart = case_when(grepl(pattern_congen_heart, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_cardiac = case_when(grepl(pattern_cardiac, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_pulmonary = case_when(grepl(pattern_pulmonary, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_down = case_when(grepl(pattern_down, `Hospital Problem List`, ignore.case = T) ~ 1))  %>%
  mutate(hosp_prob_cvd = ifelse(hosp_prob_congen_heart == 1 & is.na(hosp_prob_cvd), 1, hosp_prob_cvd)) %>%
  mutate(hosp_prob_earlyterm = case_when(grepl(pattern_earlyterm, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_fullterm = case_when(grepl(pattern_fullterm, `Hospital Problem List`, ignore.case = T)  & 
                                           !grepl(pattern_preterm, `Hospital Problem List`, ignore.case = T) ~ 1)) 
  # # added per team's checking advice
  # mutate(hosp_prob_environmental = case_when(grepl(pattern_environmental, `Hospital Problem List`, ignore.case = T) ~ 1))


# extract conditions related to respiratory infection
df <- df %>% 
  mutate(hosp_prob_URTI = case_when(grepl(pattern_URTI, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_LRTI = case_when(grepl(pattern_LRTI, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_fever = case_when(grepl(pattern_fever, `Hospital Problem List`, ignore.case = T) | 
                                       `Fever?` == "Yes" | recent_temp >= 38 ~ 1)) %>%
  mutate(hosp_prob_cough = case_when(grepl(pattern_cough, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_wheezing = case_when(grepl(pattern_wheezing, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_breathing = case_when(grepl(pattern_breathing, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_bronchiolitis = case_when(grepl(pattern_bronchiolitis, `Hospital Problem List`, ignore.case = T) ~ 1)) %>%
  mutate(hosp_prob_sepsis = case_when(grepl(pattern_sepsis, `Hospital Problem List`, ignore.case = T) ~ 1))
  # if a record has LRTI and URTI at the same time, record this as LRTI
  # mutate(hosp_prob_URTI = case_when(hosp_prob_URTI == 1 & is.na(hosp_prob_LRTI) ~ 1))

```

#### From the generated binary variables 
  * med_hist_xx
  * prob_list_xx
  * prim_prob_xx
  * ED_dx_xx
  * Admit_dx_xx
  * hosp_prob_xx
  
#### generate new binary variables: **risk_factor_xx** indicating whether this record has certain risk factor.
  * added risk_factor_small_for_gestage: if birth weight < 2500g, ---> 1, if birth_weight > 2500g ---> 0, if birth_weight missing ---> NA
```{r}
df <- df %>% 
  mutate(risk_factor_anemia = case_when(med_hist_anemia == 1 | prob_list_anemia == 1 | prim_prob_anemia == 1 | 
                                          ED_dx_anemia == 1 | admit_dx_anemia == 1 | hosp_prob_anemia == 1 ~ 1)) %>%
  mutate(risk_factor_blood = case_when(med_hist_blood == 1 | prob_list_blood == 1 | prim_prob_blood == 1 | 
                                          ED_dx_blood == 1 | admit_dx_blood == 1 | hosp_prob_blood == 1 ~ 1)) %>%
  mutate(risk_factor_asthma = case_when(med_hist_asthma == 1 | prob_list_asthma == 1 | prim_prob_asthma == 1 | 
                                          ED_dx_asthma == 1 | admit_dx_asthma == 1 | hosp_prob_asthma == 1 ~ 1)) %>%
  mutate(risk_factor_liver = case_when(med_hist_liver == 1 | prob_list_liver == 1 | prim_prob_liver == 1 | 
                                          ED_dx_liver == 1 | admit_dx_liver == 1 | hosp_prob_liver == 1 ~ 1)) %>%
  mutate(risk_factor_cvd = case_when(med_hist_cvd == 1 | prob_list_cvd == 1 | prim_prob_cvd == 1 | 
                                          ED_dx_cvd == 1 | admit_dx_cvd == 1 | hosp_prob_cvd == 1 ~ 1)) %>%
  mutate(risk_factor_immunodeficiency = case_when(med_hist_immunodeficiency == 1 | prob_list_immunodeficiency == 1 | prim_prob_immunodeficiency == 1 | 
                                          ED_dx_immunodeficiency == 1 | admit_dx_immunodeficiency == 1 | hosp_prob_immunodeficiency == 1 ~ 1)) %>%
  mutate(risk_factor_gi = case_when(med_hist_gi == 1 | prob_list_gi == 1 | prim_prob_gi == 1 | 
                                          ED_dx_gi == 1 | admit_dx_gi == 1 | hosp_prob_gi == 1 ~ 1)) %>%
  mutate(risk_factor_congen_heart = case_when(med_hist_congen_heart == 1 | prob_list_congen_heart == 1 | prim_prob_congen_heart == 1 | 
                                          ED_dx_congen_heart == 1 | admit_dx_congen_heart == 1 | hosp_prob_congen_heart == 1 ~ 1)) %>%
  mutate(risk_factor_cardiac = case_when(med_hist_cardiac == 1 | prob_list_cardiac == 1 | prim_prob_cardiac == 1 | 
                                          ED_dx_cardiac == 1 | admit_dx_cardiac == 1 | hosp_prob_cardiac == 1 ~ 1)) %>%
  mutate(risk_factor_pulmonary = case_when(med_hist_pulmonary == 1 | prob_list_pulmonary == 1 | prim_prob_pulmonary == 1 | 
                                          ED_dx_pulmonary == 1 | admit_dx_pulmonary == 1 | hosp_prob_pulmonary == 1 ~ 1)) %>%
  mutate(risk_factor_down = case_when(med_hist_down == 1 | prob_list_down == 1 | prim_prob_down == 1 | 
                                          ED_dx_down == 1 | admit_dx_down == 1 | hosp_prob_down == 1 ~ 1)) %>%
  mutate(risk_factor_earlyterm = case_when(med_hist_earlyterm == 1 | prob_list_earlyterm == 1 | prim_prob_earlyterm == 1 | 
                                          ED_dx_earlyterm == 1 | admit_dx_earlyterm == 1 | hosp_prob_earlyterm == 1 | 
                                            gest_age_cat == "early term" ~ 1)) %>%
  mutate(risk_factor_fullterm = case_when(med_hist_fullterm == 1 | prob_list_fullterm == 1 | prim_prob_fullterm == 1 | 
                                          ED_dx_fullterm == 1 | admit_dx_fullterm == 1 | hosp_prob_fullterm == 1 | 
                                            gest_age_cat == "full term"  ~ 1)) %>%
  mutate(risk_factor_preterm = case_when(med_hist_preterm == 1 | prob_list_preterm == 1 | prim_prob_preterm == 1 | 
                                          ED_dx_preterm == 1 | admit_dx_preterm == 1 | hosp_prob_preterm == 1 | 
                                           gest_age_cat == "preterm" ~ 1)) %>%
  mutate(risk_factor_postterm = case_when(med_hist_postterm == 1 | prob_list_postterm == 1 | prim_prob_postterm == 1 | 
                                          ED_dx_postterm == 1 | admit_dx_postterm == 1 | hosp_prob_postterm == 1 | 
                                            gest_age_cat == "post term" ~ 1)) 
  # # added per team's checking advice 
  # mutate(risk_factor_wheezing = case_when(med_hist_wheezing == 1 | prob_list_wheezing == 1 ~ 1)) %>%
  # mutate(risk_factor_environmental = case_when(med_hist_environmental == 1 | prob_list_environmental == 1 | prim_prob_environmental == 1 | 
  #                                         ED_dx_environmental == 1 | admit_dx_environmental == 1 | hosp_prob_environmental == 1 ~ 1))


# added per team's checking advice
df <- df %>% 
  mutate(risk_factor_small_for_gestage = case_when(birth_weight < 2500 ~ 1,
                                                   birth_weight >= 2500 ~ 0))
```

<br>

#### From generated binary varibles 
  * prim_prob_xx
  * ED_dx_xx
  * Admit_dx_xx
  * hosp_prob_xx
  
#### generate new binary variables **(symp_xxx)** indicating whether this record has certain respiratory symptoms at this encounter.
```{r}
df <- df %>% 
  mutate(symp_URT_distress = case_when(prim_prob_URTI == 1 | ED_dx_URTI == 1 | admit_dx_URTI == 1 | hosp_prob_URTI == 1 ~ 1)) %>% 
  mutate(symp_LRT_distress = case_when(prim_prob_LRTI == 1 | ED_dx_LRTI == 1 | admit_dx_LRTI == 1 | hosp_prob_LRTI == 1 ~ 1)) %>%
  mutate(symp_fever = case_when(prim_prob_fever == 1 | ED_dx_fever == 1 | admit_dx_fever == 1 | hosp_prob_fever == 1 ~ 1)) %>%
  mutate(symp_cough = case_when(prim_prob_cough == 1 | ED_dx_cough == 1 | admit_dx_cough == 1 | hosp_prob_cough == 1 ~ 1)) %>%
  mutate(symp_wheezing = case_when(prim_prob_wheezing == 1 | ED_dx_wheezing == 1 | admit_dx_wheezing == 1 | hosp_prob_wheezing == 1 ~ 1)) %>%
  mutate(symp_breathing = case_when(prim_prob_breathing == 1 | ED_dx_breathing == 1 | admit_dx_breathing == 1 | hosp_prob_breathing == 1 ~ 1)) %>%
  mutate(symp_bronchiolitis = case_when(prim_prob_bronchiolitis == 1 | ED_dx_bronchiolitis == 1 | admit_dx_bronchiolitis == 1 | hosp_prob_bronchiolitis == 1 ~ 1)) %>%
  mutate(symp_sepsis = case_when(prim_prob_sepsis == 1 | ED_dx_sepsis == 1 | admit_dx_sepsis == 1 | hosp_prob_sepsis == 1 ~ 1)) 
```

<br>

### Table `r tab.counter`. There are some records that no patterns of respiratory symptoms (above patterns) can be detected 
#### (Should they be considered suspected respiratory/RSV infections and included in the study population? TBC)
```{r}
tab.counter <- tab.counter + 1

df.uncertain <- df %>% filter(is.na(symp_URT_distress) & is.na(symp_LRT_distress) & is.na(symp_fever) & is.na(symp_cough) & is.na(symp_wheezing) & is.na(symp_breathing) & is.na(symp_bronchiolitis) & is.na(symp_sepsis) &
                     grepl(pattern_suspect_resp_general, `Primary Problem`,ignore.case = T) %in% c(NA, FALSE)  & 
                     grepl(pattern_suspect_resp_general, `ED Dx`, ignore.case = T) %in% c(NA, FALSE) & 
                     grepl(pattern_suspect_resp_general, `Admit Dx`,ignore.case = T) %in% c(NA, FALSE) & 
                     grepl(pattern_suspect_resp_general, `Hospital Problem List`,ignore.case = T) %in% c(NA, FALSE)                   )

df.uncertain %>%
  dplyr::select(StudyID, `Primary Problem`, `ED Dx`, `Admit Dx`, `Hospital Problem List`) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"),
            columns = list(
            `ED Dx` = colDef(width = 300),
            `Admit Dx` = colDef(width = 300),
            `Hospital Problem List` = colDef(width = 300)
            ))

```

<br>

#### The team helped checked above records and classified them suspected respiratory infections or not, remove those that are not suspected respiratory infections. Deleted 212 records (leaving 66 records from above table)
```{r}
df.check.suspect <- read_excel("/Users/hmx/OneDrive - Yale University/Hanmeng RSV VE/data/records_need_help.xlsx", sheet = "uncertain_suspected_respiratory") %>% mutate(collection_date = as.Date(collection_date))

# id.check.suspect <- df.check.suspect$StudyID
# df %>% filter(StudyID %in% id.check.suspect) %>%group_by(StudyID, collection_date) %>% count() %>% filter(n > 1)
# df.check.suspect %>% group_by(StudyID, collection_date) %>% count() %>% filter(n > 1) # no duplicates

df.not.suspect <- df.check.suspect %>% filter(is_suspected_resp == 0)

for(i in 1:nrow(df.not.suspect)){
  id <- df.not.suspect[i,]$StudyID
  cd <- df.not.suspect[i,]$collection_date
  
  df <- df %>% filter(StudyID != id | collection_date != cd)
}
```

<br>


### Table `r tab.counter`. Summarize extracted risk factors 
Each record can have multiple risk factors. For gestational age (preterm...), I also used the information in gest_age_cat to classify if this record is preterm/early term, etc.
```{r}
tab.counter <- tab.counter + 1

data.frame(
  anemia = nrow(df %>% filter(risk_factor_anemia == 1)),
  blood = nrow(df %>% filter(risk_factor_blood == 1)),
  asthma = nrow(df %>% filter(risk_factor_asthma == 1)),
  liver_disease = nrow(df %>% filter(risk_factor_liver == 1)),
  #cvd = nrow(df %>% filter(risk_factor_cvd == 1)),
  immunodeficiency = nrow(df %>% filter(risk_factor_immunodeficiency == 1)),
  #GI_disease = nrow(df %>% filter(risk_factor_gi == 1)),
  #congenital_heart_disease = nrow(df %>% filter(risk_factor_congen_heart == 1)),
  cardiac = nrow(df %>% filter(risk_factor_cardiac == 1)),
  pulmonary_disease = nrow(df %>% filter(risk_factor_pulmonary == 1)),
  down_syndrome = nrow(df %>% filter(risk_factor_down == 1)),
  #early_term = nrow(df %>% filter(risk_factor_earlyterm == 1)),
  #full_term = nrow(df %>% filter(risk_factor_fullterm == 1)),
  preterm = nrow(df %>% filter(risk_factor_preterm == 1)),
  #post_term = nrow(df %>% filter(risk_factor_postterm == 1)),
  #wheezing = nrow(df %>% filter(risk_factor_wheezing == 1)),
  #environmental = nrow(df %>% filter(risk_factor_environmental == 1)),
  small_for_gestage = nrow(df %>% filter(risk_factor_small_for_gestage == 1))
) %>%
  pivot_longer(cols = 1:10, names_to = "risk_factor", values_to = "n_records") %>%
  arrange(desc(n_records)) %>%
  mutate(perc = round(n_records / nrow(df)*100,1)) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

```

<br>

### Table `r tab.counter`. Some more processing of gestational age 
#### From
  * gest_age_cat (original variable in the dataset);
  * risk_factor_fullterm, risk_factor_earlyterm, risk_factor_preterm, risk_factor_postterm (extracted from medical history..)
```{r}
tab.counter <- tab.counter + 1
# As some information about gestational age was extracted from medical history, there might be some inaccuracy, here first detect if there is individuals who was marked 1 in both cats. 
df <- df %>% 
  mutate(risk_factor_gestage = case_when(
    !is.na(gest_age_cat) ~ gest_age_cat,
    is.na(gest_age_cat) & risk_factor_earlyterm == 1 ~ "early term",
    is.na(gest_age_cat) & risk_factor_fullterm == 1 ~ "full term",
    is.na(gest_age_cat) & risk_factor_postterm == 1 ~ "post term",
    is.na(gest_age_cat) & risk_factor_preterm == 1 ~ "preterm"
  )) 


df %>% count(risk_factor_gestage) %>% arrange(desc(n)) %>% 
  mutate(perc = round(n / nrow(df)*100,1)) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

# a <- df %>% filter(is.na(risk_factor_gestage)) 
# write.csv(a, "../../data/missing_gestage.csv", row.names = F)

```

#### To avoid confusion, remove risk_factor_earlyterm, risk_factor_fullterm, risk_factor_preterm, risk_factor_postterm, and **only keep categorical variable risk_factor_gestage**.
```{r}
df <- df %>% dplyr::select(-c(risk_factor_earlyterm, risk_factor_fullterm, risk_factor_preterm, risk_factor_postterm))
```

<br>

### The team helped check all those records that are older than 8 months on October 1st 2023 (when Nirsevimab became available) and without detection of high risk patterns. I need to do several things: 
  * delete the older records that are not high risk individuals
  * incorporate the risk factor information into the current dataset. (to mark if they have a risk factor or not).
  * After discussing with Carlos, GI should not be counted as a risk factor, thus re-check those marked as having GI disease to see if they truly are high risk individuals.
```{r}
# read in the records checked by team
df.risk.checked <- read_excel("/Users/hmx/OneDrive - Yale University/Hanmeng RSV VE/data/records_need_help.xlsx", sheet = "uncertain_high_risk") %>% 
  filter(!is.na(StudyID))


df.risk.checked <- df.risk.checked %>% 
  mutate(across(starts_with("risk_factor"), ~ ifelse(is.na(.), 0, .))) %>%
  mutate(risk_factor_preterm = ifelse(risk_factor_preterm == 2, 0, risk_factor_preterm)) %>%
  mutate(risk_factor_preterm = as.numeric(risk_factor_preterm)) %>%
  mutate(sum_risk_factor = risk_factor_preterm + 
           risk_factor_anemia +
           risk_factor_pulmonary +
           risk_factor_cardiac + 
           risk_factor_down +
           risk_factor_immunodeficiency +
           risk_factor_small_for_gestage) 

# the only preterm one in df.risk.checked is 130584733, fill this in
df[which(df$StudyID == "130584733"), ]$risk_factor_gestage <- "preterm"


# filter out those that has no risk factors (assigned 0/1 by team) , so these infants are not eligible for Nirsevimab
# out of the sum_risk_factor == 0 kids (totally 519), there are 137 RSV+
# out of the sum_risk_factor > 0 kids (totally 57), there are 11 RSV+.
StudyID.toremove <- (df.risk.checked %>% filter(sum_risk_factor == 0))$StudyID

# remove these non-high-risk older infants from current df 
df <- df %>% filter(StudyID %in% StudyID.toremove == F)

# for high risk records to keep, fill in risk factor information back to df 
df.high.risk <- df.risk.checked %>% filter(sum_risk_factor > 0) %>% 
  dplyr::select(StudyID, starts_with("risk_factor")) %>%
  distinct()


for(i in 1:nrow(df.high.risk)){
  
  id.temp <- df.high.risk$StudyID[i]
  df.high.risk.temp <- df.high.risk %>% filter(StudyID == id.temp)
  
  if(nrow(df[which(df$StudyID == id.temp),]) != 0){
    # assign team's checking results into the current df 
    
    if(df.high.risk.temp$risk_factor_anemia == 1){df[which(df$StudyID == id.temp),]$risk_factor_anemia <- 1}
    if(df.high.risk.temp$risk_factor_pulmonary == 1){df[which(df$StudyID == id.temp),]$risk_factor_pulmonary <- 1}
    if(df.high.risk.temp$risk_factor_cardiac == 1){df[which(df$StudyID == id.temp),]$risk_factor_cardiac < 1}
    if(df.high.risk.temp$risk_factor_down == 1){df[which(df$StudyID == id.temp),]$risk_factor_down <- 1}
    if(df.high.risk.temp$risk_factor_immunodeficiency == 1){df[which(df$StudyID == id.temp),]$risk_factor_immunodeficiency <- 1}
    df[which(df$StudyID == id.temp),]$risk_factor_small_for_gestage <- df.high.risk.temp$risk_factor_small_for_gestage
    
  }
  
}
```


```{r}

## create a risk factor for gest age < 37 weeks (preterm) or >= 37 weeks
df <- df %>% 
  mutate(risk_factor_gestagelessthan37wks = case_when(risk_factor_gestage == "preterm" ~ 1,
                                                       risk_factor_gestage %in% c(
                                                         "early term", "full term",
                                                         "late term", "post term"
                                                       ) ~ 0))
```

<br>

### Table `r tab.counter`. After incorporating team's checking of risk factors and deleting records without risk factors detected, summarize extracted risk factors again.
  * Note that each record can have multiple risk factors. 
```{r}
tab.counter <- tab.counter + 1

data.frame(
  anemia = nrow(df %>% filter(risk_factor_anemia == 1)),
  immunodeficiency = nrow(df %>% filter(risk_factor_immunodeficiency == 1)),
  cardiac = nrow(df %>% filter(risk_factor_cardiac == 1)),
  pulmonary_disease = nrow(df %>% filter(risk_factor_pulmonary == 1)),
  down_syndrome = nrow(df %>% filter(risk_factor_down == 1)),
  small_for_gestage = nrow(df %>% filter(risk_factor_small_for_gestage == 1)),
  gestage_lessthan37wks = nrow(df %>% filter(risk_factor_gestagelessthan37wks == 1))
) %>%
  pivot_longer(cols = 1:7, names_to = "risk_factor", values_to = "n_records") %>%
  arrange(desc(n_records)) %>%
  mutate(perc = round(n_records / nrow(df)*100,1)) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

```

<br>

### Table `r tab.counter`. Check if a record has at least one risk factor
#### Generate this new variable to be risk_factor_atleastone.
```{r echo = T}
tab.counter <- tab.counter + 1

df <- df %>%
  mutate(risk_factor_atleastone = case_when(risk_factor_anemia == 1 |
                                            # risk_factor_asthma == 1 |
                                            # risk_factor_liver == 1 |
                                            risk_factor_immunodeficiency == 1 |
                                            risk_factor_cardiac == 1 |
                                            risk_factor_pulmonary == 1 | 
                                            risk_factor_down == 1 |
                                            # risk_factor_wheezing == 1 |
                                            # risk_factor_environmental == 1 |
                                            risk_factor_small_for_gestage == 1 |
                                            risk_factor_gestagelessthan37wks == 1 ~ 1,
                                            TRUE ~ 0))

df %>% count(risk_factor_atleastone) %>% 
  mutate(perc = round(n / nrow(df)*100,1)) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```




<br>

### Table `r tab.counter`. Summarize extracted respiratory symptoms
Each record can have multiple symptoms.
```{r}
tab.counter <- tab.counter + 1

data.frame(
  symp_URT_distress = nrow(df %>% filter(symp_URT_distress == 1)),
  symp_LRT_distress = nrow(df %>% filter(symp_LRT_distress == 1)), 
  symp_fever = nrow(df %>% filter(symp_fever == 1)),
  symp_cough = nrow(df %>% filter(symp_cough == 1)),
  symp_wheezing = nrow(df %>% filter(symp_wheezing == 1)),
  symp_breathing = nrow(df %>% filter(symp_breathing == 1)),
  symp_bronchiolitis = nrow(df %>% filter(symp_bronchiolitis == 1)),
  symp_sepsis = nrow(df %>% filter(symp_sepsis == 1))
) %>%
  pivot_longer(cols = 1:8, names_to = "symp", values_to = "n_records") %>%
  arrange(desc(n_records)) %>%
  mutate(perc = round(n_records / nrow(df)*100,1)) %>% 
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))

```

<br>

<!-- ### Table `r tab.counter`. There are records missing diagnosis details: -->
<!-- #### aka. records that are missing for all following variables: -->
<!--   * Primary Problem -->
<!--   * ED Dx -->
<!--   * Admit Dx -->
<!--   * Hospital Problem List -->

<!-- This table is a subset of table 20 above. (all records here are from outpatient) For these records we can't be sure these are hospitalizations related to respiratory infection. -->
<!-- ```{r} -->
<!-- tab.counter <- tab.counter + 1 -->

<!-- df %>% filter(is.na(`ED Dx`) & is.na(`Admit Dx`) & is.na(`Primary Problem`) & is.na(`Hospital Problem List`)) %>% -->
<!--   filter(`Fever?` == "No" & recent_temp <= 38) %>% -->
<!--   dplyr::select(StudyID, `Fever?`, recent_temp, `Medical History`, `Problem List` -->
<!--          , icu_admitted, encounter_type -->
<!--          # `Primary Problem`, `ED Dx`, `Admit Dx`, `Hospital Problem List` -->
<!--          ) %>%  -->
<!--   reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), -->
<!--             columns = list( -->
<!--     `Medical History` = colDef(width = 500), -->
<!--     `Problem List` = colDef(width = 600)) -->
<!--     ) -->
<!-- ``` -->


### Mom RSV vax
Generate binary variable mom_rsv_vaxed to indicate the infant's mother was vaccinated
```{r}
df <- df %>% 
  mutate(mom_rsv_vaxed = ifelse(!is.na(`Mom RSV vax`), 1, NA)) %>% 
  mutate(mom_rsv_vaxed_date = as.Date(`Mom RSV vax date`))

n_temp <- df %>% filter(mom_rsv_vaxed == 1) %>% nrow()
```

There are `r n_temp` records whose mom received RSV maternal vaccine. (self report)

<br>


### Read in Nirsevimab tab from excel
This tab contains nirsevimab information, if there is discordance between the main tab and this tab about the nirsevimab, use this tab's information. (There is no duplicate in the nirsevimab tab).
```{r}
df.nir <- read_excel("/Users/hmx/OneDrive - Yale University/Hanmeng RSV VE/data/RSV_deid_2024_may.xlsx", sheet = "nirsevimab")

# merge nirsevimab tab with main tab 
df <- df %>% dplyr::select(-`mAb Date`, - Nirsevimab) %>% 
  left_join(df.nir %>% dplyr::select(-`IMM Entry Date`), by = "StudyID")
```

### Figure `r fig.counter`. See how many mAb were administered after sample collection
#### Generate new variable days_btw_mab_collection (mAb date - collection date), >0 means immunization after sample collection.
(days_btw_mab_collection can be used to see how protection from mAb wanes over time.)
```{r}
fig.counter <- fig.counter + 1

df <- df %>% 
  mutate(mab_date = as.Date(`mAb date`)) %>%
  mutate(days_btw_mab_collection = as.numeric(as.Date(`mAb date`) - collection_date)) 

df %>% 
  filter(!is.na(days_btw_mab_collection)) %>%
  dplyr::select(StudyID, collection_date, mab_date, days_btw_mab_collection) %>%
  ggplot() + 
  geom_histogram(aes(x = days_btw_mab_collection), color = "black", fill ="white") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed") +
  xlab("days_btw_mab_collection\n (Date of mAb - date of collection)") + theme_classic() +
  annotate("text", x = 50, y = 45 , label = "---> mAb immunization \nAFTER sample collection", color = "red")
```

### Those who received mAb within 7 days before sample collection OR received on/after date of collection:
#### (TBC) how do we define exposure? those who are immunized with mAb before sample collection date or those who are immunized >7 days before sample collection date?
```{r}
df %>% 
  filter(!is.na(days_btw_mab_collection)) %>%
  filter(days_btw_mab_collection >= -7) %>%
  arrange(days_btw_mab_collection) %>%
  dplyr::select(StudyID,  days_btw_mab_collection,mab_date, collection_date) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px")) 
  
```


<br>

### Table `r tab.counter`. Nirsevimab status
#### Generated new categorical variables rsv_mab_detailed, to have values of 
  * 50mg before collection (days_btw_mab_collection < 0)
  * 100mg before collection (days_btw_mab_collection < 0)
  * 50mg after collection (days_btw_mab_collection >= 0)
  * 100mg after collection (days_btw_mab_collection >= 0)
  * no mAb recorded but with last hepB vax recorded
  * no mAb recorded and no last hepB vax recorded
  
```{r}
df <- df %>% 
  mutate(rsv_mab_detailed = case_when(`Nirsevimab info` == "RSV, MAB, NIRSEVIMAB-ALIP, 50 MG/0.5 ML, FOR PATIENTS < 5 KG [306]" & 
                              days_btw_mab_collection < 0 ~  "50mg before collection",
                             `Nirsevimab info` == "RSV, MAB, NIRSEVIMAB-ALIP, 100 MG/ML, FOR PATIENTS >= 5 KG [307]" &
                              days_btw_mab_collection < 0 ~ "100mg before collection",
                             `Nirsevimab info` == "RSV, MAB, NIRSEVIMAB-ALIP, 50 MG/0.5 ML, FOR PATIENTS < 5 KG [306]" & 
                              days_btw_mab_collection >= 0 ~  "50mg after collection",
                             `Nirsevimab info` == "RSV, MAB, NIRSEVIMAB-ALIP, 100 MG/ML, FOR PATIENTS >= 5 KG [307]" &
                              days_btw_mab_collection >= 0 ~ "100mg after collection",
                             is.na(`Nirsevimab info`) & !is.na(`Hep B Imm Last Given`) ~ "no mAb recorded but with last hepB vax recorded",
                             is.na(`Nirsevimab info`) & is.na(`Hep B Imm Last Given`) ~ "no mAb recorded and no last hepB vax recorded"))

df %>% count(rsv_mab_detailed) %>% rename(n_records = n) %>%
  mutate(perc = round(n_records/nrow(df)*100,1)) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```

#### Generated new binary variable rsv_mab from rsv_mab_detailed, to indicate if the record took mAb before collection (TBC), which is to be used as exposure in the analysis:
  * 50mg before collection ---> 1
  * 100mg before collection ---> 1
  * 50mg after collection ---> 0
  * 100mg after collection ---> 0
  * no mAb recorded but with last hepB vax recorded ---> 0
  * no mAb recorded and no last hepB vax recorded ---> 0
  
```{r}
df <- df %>% 
  mutate(rsv_mab = case_when(rsv_mab_detailed %in% c("50mg before collection",
                                                     "100mg before collection") ~ 1,
                             rsv_mab_detailed %in% c("50mg after collection",
                                                     "100mg after collection",
                                                     "no mAb recorded but with last hepB vax recorded",
                                                     "no mAb recorded and no last hepB vax recorded") ~ 0))

df %>% count(rsv_mab) %>% rename(n_records = n) %>%
  mutate(perc = round(n_records/nrow(df)*100,1)) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```
<br>

### Figure `r fig.counter`. Age at mAb 
Generate new variable age_at_mab_in_days (calculated as mAb date in nir tab - DOB )
The figure below only includes records with rsv_mab == 1:
```{r}
fig.counter <- fig.counter + 1

df <- df %>% 
  mutate(age_at_mab_in_days = as.numeric(as.Date(`mAb date`) - as.Date(DOB) ))

df %>% 
  filter(rsv_mab == 1) %>%
  ggplot() +
  geom_histogram(aes(x = age_at_mab_in_days), color = "black", fill = "white") + theme_classic()
```

<br>

### Read in oxygen volume tab and merge with main tab
```{r}
df.oxygen <- read_excel("/Users/hmx/OneDrive - Yale University/Hanmeng RSV VE/data/RSV_deid_2024_may.xlsx", sheet = "oxygen")

# merge oxygen data with main tab
df <- df %>% 
  left_join(df.oxygen, by = "StudyID")
```

### Figure `r fig.counter`. Maximum oxygen flow rate
#### Generate new variable max_oxygen_flowrate (unit: L/min), which threshold to use to indicate severe outcome? (after discussing, 1.5L/min can be used as a threshold to indicate severe disease.)
  * Also need to note that, there is no date in the oxygen tab, so for those patients with multiple visits, we cannot sure which record should be linked with the oxygen order.
```{r}
fig.counter <- fig.counter + 1

df <- df %>% mutate(max_oxygen_flowrate = as.numeric(gsub("Max. of flowsheet CPM S22 R INV FLOW (L/MIN) (OXYGEN THERAPY): ", "",
                                                      `Extreme Flowsheet Value`, fixed = TRUE)))

df %>% ggplot() +
  geom_histogram(aes(x = max_oxygen_flowrate), color = "black", fill = "white") + theme_classic() +
  geom_vline(xintercept = median(df$max_oxygen_flowrate, na.rm = T), color = "red", linetype = "dashed") +
  annotate("text", x = 16, y = 120, label = paste0("median=", median(df$max_oxygen_flowrate, na.rm = T)), color = "red")

```
#### Also, from "Order Questions" variable in the oxygen tab, extract whether there was CPAP (continuous positive airway pressure), BiPAP (Bilevel positive airway pressure), HFNC (high-flow nasal cannula)... ordered for each records, if there was, this is also an indication of severe disease.

<br>

#### Then, patients with max_oxygen_flowrate > 1.5L/min and patients who ordered high flow oxygen (based on order questions) were deemed "used high flow oxygen", generate a new variable called highflow_oxygen.
```{r}
pattern_oxygen <- paste(c("cpap",
                          "Bi-level",
                          "HFNC"),
                        collapse = "|")
df <- df %>% 
  mutate(ordered_highflow = case_when(grepl(pattern_oxygen, `Order Questions`, ignore.case = T) ~ 1, 
                                      grepl(pattern_oxygen, `Order Questions`, ignore.case = T) == FALSE & !is.na(`Order Questions`) ~ 0))

# max > 1.5 L/min or ordered high flow
df <-  df %>% 
  mutate(highflow_oxygen = case_when((max_oxygen_flowrate > 1.5 | ordered_highflow == 1) | 
                                      (is.na(max_oxygen_flowrate) & ordered_highflow == 1) ~  1, 
                                     (max_oxygen_flowrate <= 1.5 & ordered_highflow == 0) | 
                                      (is.na(max_oxygen_flowrate) & ordered_highflow == 0) ~ 0))

df %>% count(highflow_oxygen) %>% 
   reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"))
```

```{r eval = F}
# check recoded oxygen variables
# temp <-df %>% filter(highflow_oxygen == 1) %>% 
#   select(StudyID, `Order Questions`, ordered_highflow, `Extreme Flowsheet Value`, max_oxygen_flowrate)
```


<br>
<br>
<br>



### For each testing record, generate unique testID
#### If a patient was tested multiple times, the testID will has values of StudyID_nthTest (e.g. 99999999_1, 9999999_2..), the suffix indicates the nth test of the patient, ordered by date of sample collection.
Also generated n_tests for each StudyID, to indicate the number of tests this individual took,
and generated new variable nth_test to indicate this is the nth test of the same individual patient.
```{r}
df <- df %>% 
  group_by(StudyID) %>%
  arrange(collection_date) %>%
  mutate(n_tests = n()) %>% 
  mutate(testID = paste0(StudyID, "_", 1:n_tests)) %>%
  arrange(StudyID) 

# also generate variable nth_test to indicate this is the nth test of the same patient
df <- df %>% as.data.frame() %>% mutate(nth_test = str_sub(testID, -1))
```



### Table `r tab.counter`. Time since earliest collection for each patient
#### if an individual has multiple tests, for each test, generate new variables:
  * days_since_earliest_collection: the time elapse since the earliest test (in days, if this is the first test of a patient, take 0)
  * days_since_last_collection: time elapse since the most recent test (in days, if this is the first test of a patient, take 0)
  * days_to_next_collection: time to next collection (in days, if this is the last test of a patient, take 0).
```{r}
tab.counter <- tab.counter + 1

df <- df %>% 
  group_by(StudyID) %>%
  mutate(days_since_earliest_collection = as.numeric(collection_date - min(collection_date))) %>%
  as.data.frame()

df <- df %>% 
  group_by(StudyID) %>%
  mutate(days_since_last_collection = case_when(days_since_earliest_collection == 0 ~ 0,
                                                days_since_earliest_collection > 0 ~ 
                                                  as.numeric(collection_date - lag(collection_date)))) %>%
  as.data.frame()

df <- df %>% 
  group_by(StudyID) %>%
  mutate(days_to_next_collection = case_when(nth_test == n_tests ~ 0,
                                             nth_test < n_tests ~ 
                                               as.numeric( lead(collection_date) - collection_date )
                                               )) %>% 
  as.data.frame()
  


df %>% filter( days_since_earliest_collection > 0) %>%
  ggplot() + geom_histogram(aes(x = days_since_earliest_collection), color = "black", fill = "white") + theme_classic()
```

<br>

### Table `r tab.counter`. There are several individuals with more than one testing results on the same day. (TBC)
  * 130582917,130759159: removed the emergency one and kept the inpatient one.
  * 130618601: kept the one collected in emergency department
  * 130696938,130701204,130726098,130751253,130755351: the two records are very similar, kept the one collected in "BH FAIRFIELD URGENT CARE".
```{r}
tab.counter <- tab.counter + 1
temp_id <- (df %>% group_by(StudyID, collection_date) %>% count() %>% filter(n>1))$StudyID 

df %>% filter(StudyID %in% temp_id) %>%
  dplyr::select(StudyID, collection_date, `Collection Department`, positive_viruses, rsv_mab, encounter_type, `Admit Date`) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"),
            groupBy = "StudyID", defaultExpanded = T)

df <- df %>% 
  # 130582917 (emergency)
  filter(StudyID != 130582917 | `Encounter Type` != "Emergency") %>%
  # 130618601 (keep the one from emergency department) 
  filter(StudyID != 130618601 | `Collection Department` != "LMH EMERGENCY DEPARTMENT") %>%
  # 130696938 
  filter(StudyID != 130696938 | collection_date != as.Date("2023-12-21") | `Collection Department` != "YNH EMERGENCY PEDIATRIC") %>%
  # 130701204
  filter(StudyID != 130701204 | collection_date != as.Date("2024-3-29") | `Collection Department` != "BH EMERGENCY DEPARTMENT") %>%
  # 130726098
  filter(StudyID != 130726098 | `Accession #` != "23Y-280VI0020") %>%
  # 130751253 
  filter(StudyID != 130751253 | `Collection Department` != "BH EMERGENCY DEPARTMENT") %>%
  # 130755351
  filter(StudyID != 130755351 | collection_date != as.Date("2024-3-14") | `Accession #` != "24B-074MI0425") %>%
  # 130759159
  filter(StudyID != 130759159 | collection_date != as.Date("2024-1-13") | `Encounter Type` != "Emergency") 
  
```


<br>


### Remove redundant testing records
(reference: https://pubmed.ncbi.nlm.nih.gov/36454733/)
For some patients, they were tested multiple time. Delete testing records that have repetitive results or results that could be deemed as "false-negative" before a positive test.


#### For positive tests results: 
  * If tested positive for RSV more than once within 14 days (difference of testing date <= 14 days), keep only one earliest RSV+ record.
  
##### Table `r tab.counter` Those with more than one positive tests within 14 days:
```{r echo = T}
tab.counter <- tab.counter + 1

# those with more than 1 positive tests
id.temp <- (df %>% filter(positive_rsv == 1) %>% group_by(StudyID) %>% count() %>% filter(n > 1))$StudyID

# those with 2 positive tests <= 14 days apart
id.temp <- (df %>% filter(StudyID %in% id.temp) %>% filter(positive_rsv == 1) %>% 
  group_by(StudyID) %>% mutate(interval = as.numeric(collection_date - lag(collection_date)) ) %>% 
  filter(interval <= 14))$StudyID
  
df %>% filter(StudyID %in% id.temp) %>% 
  dplyr::select(StudyID, collection_date, positive_rsv, rsv_mab, encounter_type, icu_admitted, testID) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"),
            groupBy = "StudyID")

# only keep the earliest RSV+ record or keep the RSV+ admitted to hospital
df <- df %>% filter(testID %in% c("130599389_2",
                                  "130624850_1",
                                  "130636329_1",
                                  "130637768_2",
                                  "130641930_1",
                                  "130678023_4",
                                  "130678388_1",
                                  "130700197_2",
                                  "130707737_1",
                                  "130717977_1",
                                  "130741333_2",
                                  "130743252_2",
                                  "130771847_1"
                                  ) == F)

# 3263 left
```

<br>

#### Now process tested negative records: 

```{r echo = T}
### Records that have more than one testing records 
id_multi_tests <- (df %>% group_by(StudyID) %>% count() %>% filter(n > 1))$StudyID # those who had multiple tests
df.multi.tests <- df %>% filter(StudyID %in% id_multi_tests) %>% arrange(StudyID, `Collection Date`)

# those with multiple tests that we need to look at
a <- df.multi.tests %>% dplyr::select(StudyID, testID, n_tests, positive_rsv, `mAb date`,
             collection_date, `Admit Date`, `Hosp LoS`,  `Collection Department`, sample_source,
             tested_viruses, positive_viruses, `Encounter Type`, encounter_type,
            icu_admitted, date_icu_admit, icu_los_hours, 
             `Fever?`, `Problem List`, `Primary Problem`, `ED Dx`, `Admit Dx`,`Hospital Problem List`
             ) 

#######################################
# First look at patients with two tests
#######################################

# keep those with two tests that are >14 days apart
testID.temp <- (a %>% group_by(StudyID) %>% mutate(n_tests_temp = n()) %>% filter(n_tests_temp == 2) %>%
  group_by(StudyID) %>% mutate(interval = as.numeric( max(collection_date) - min(collection_date))) %>%
  filter(interval > 14))$testID
a <- a %>% filter(testID %in% testID.temp == F)  

# those with two tests that are <= 14 days apart
# 1) if there is a positive test, keep only the positive test 
testID.toremove1 <- (a %>% group_by(StudyID) %>% mutate(n_tests_temp = n()) %>% filter(n_tests_temp == 2) %>%
  group_by(StudyID) %>% mutate(interval = as.numeric(max(collection_date) - min(collection_date))) %>%
  filter(interval <= 14) %>% 
  group_by(StudyID) %>% filter(max(positive_rsv) - min(positive_rsv) == 1) %>%
  filter(positive_rsv == 0))$testID

# 2) if the two both are negative tests:
# 2.1) if have different encounter_type (one inpatient, one outpatient record), keep the inpatient one
testID.toremove2 <- (a %>% group_by(StudyID) %>% mutate(n_tests_temp = n()) %>% filter(n_tests_temp == 2) %>%
  group_by(StudyID) %>% mutate(interval = as.numeric(max(collection_date) - min(collection_date))) %>%
  filter(interval <= 14) %>% 
  group_by(StudyID) %>% filter(max(positive_rsv) == 0) %>%
  mutate(n = n_distinct(encounter_type)) %>%
  dplyr::select(testID, positive_rsv, encounter_type, n, `mAb date`) %>% 
  filter(n == 2 & encounter_type == "outpatient"))$testID

# 2.2) if the two testing records have same encounter_type,  keep the earlier negative test 
testID.toremove3 <- (a %>% group_by(StudyID) %>% mutate(n_tests_temp = n()) %>% filter(n_tests_temp == 2) %>%
  group_by(StudyID) %>% mutate(interval = as.numeric(max(collection_date) - min(collection_date))) %>%
  filter(interval <= 14) %>% 
  group_by(StudyID) %>% filter(max(positive_rsv) == 0) %>%
  mutate(n = n_distinct(encounter_type)) %>%
  dplyr::select(testID, collection_date, positive_rsv, encounter_type, n) %>% 
  filter(n == 1) %>%
  group_by(StudyID) %>%
  filter(collection_date == max(collection_date)))$testID

df <- df %>% filter(testID %in% c(testID.toremove1, testID.toremove2, testID.toremove3) == F)



#######################################
# Then look at patients with three tests
#######################################
a <- df %>% group_by(StudyID) %>% mutate(n_tests_temp = n()) %>% filter(n_tests_temp == 3) %>% ungroup() 

# records with test1 and test2 within 14 days OR test2 and test3 within 14 days
temp <- a %>% group_by(StudyID) %>%
  filter(as.numeric(median(collection_date) - min(collection_date)) <= 14  |
           as.numeric(max(collection_date) - median(collection_date)) <= 14) %>% 
  dplyr::select(testID, collection_date, positive_rsv, encounter_type, rsv_mab, icu_admitted) 

# Manually checked these and remove records
testID.toremove <- c(
                     # repeated RSV- record (we want to keep the earlier one)
                     "130575661_2", 
                     "130620929_2", 
                     "130623083_2", 
                     "130623828_2", 
                     "130626581_3",
                     "130634844_3",
                     "130642933_3",
                     "130658437_3",
                     "130665947_3",
                     "130679674_2",
                     "130710408_3",
                     "130746903_2",
                     "130751613_2",
                     # repeated RSV- record in outpatient
                     "130632441_2",
                     "130657344_1",
                     "130665962_2",
                     "130702757_1",
                     "130709863_2",
                     "130715070_1",
                     "130751754_2",
                     "130780764_3",
                     # earlier RSV- followed by RSV+ 
                     "130700254_1",
                     "130740342_1",
                     "130744029_1",
                     # RSV- right after RSV+
                     "130728751_3",
                     # transfer to ICU
                     "130739690_1",
                     "130739690_3"
                     )
df <- df %>% filter(testID %in% testID.toremove == F)


#######################################
# Then look at patients with >3 tests
#######################################
a <- df %>% group_by(StudyID) %>% mutate(n_tests_temp = n()) %>% filter(n_tests_temp > 3) %>% ungroup()

temp <- a %>% group_by(StudyID) %>%
  dplyr::select(testID, collection_date, positive_rsv, encounter_type, rsv_mab, icu_admitted) 

# Manually checked these and remove records
testID.toremove <- c(
  # RSV- followed by RSV+ 
  "130577503_1",
  # repeated RSV- record
  "130577503_4",
  "130606175_2",
  "130609940_1",
  "130609940_3",
  "130624871_4",
  "130635378_2",
  "130643173_4",
  "130654546_2",
  "130666500_2",
  "130705659_2",
  "130705659_3",
  "130709635_2",
  "130709635_3",
  "130719972_4",
  "130719972_6",
  "130749578_3",
  "130752957_2",
  "130757819_2",
  "130757819_4",
  # earlier RSV- outpatient later admitted
  "130603130_1",
  "130644922_1",
  "130734145_1",
  # repeated RSV- in outpatient
  "130603130_3",
  # RSV- later admitted to ICU
  "130749578_1"
)

df <- df %>% filter(testID %in% testID.toremove == F)

```

### Remove the records from states other than NY CT RI (added on 8.12.2024)

```{r echo = T}
df <- df %>% filter(`Home State` %in% c("NY", "CT", "RI")) # removed 37 records
```

### we decided to only keep the first positive case of each patient in the main analysis (added on 8.13.2024)
```{r}
id.pos <- (df %>% filter(positive_rsv == 1) %>% group_by(StudyID) %>% count() %>% filter(n>1))$StudyID

id.pos.toremove <- 
  (df %>% filter(StudyID %in% id.pos) %>% 
  dplyr::select(StudyID, collection_date, encounter_type, testID) %>%
  arrange(StudyID, collection_date) %>% 
  group_by(StudyID) %>% filter(collection_date != min(collection_date)))$testID 
  
df <- df %>% filter(testID %in% id.pos.toremove == F)

```


### Save the cleaned dataset to be used for analyses.

```{r echo = T}
if(save_recoded_dataset){
  write.csv(df, "../../data/clean_data/df.mab.csv", row.names = F)
}

# colnames <- as.data.frame(colnames(df))
# write.csv(colnames, "../../data/clean_data/dictionary.csv", row.names = F)

```


### Table `r tab.counter` Take a look at number of tested positive and tested negative records
```{r}
tab.counter <- tab.counter + 1
df %>% count(positive_rsv) %>% 
  mutate(perc = round(n/nrow(df)*100, 1)) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px")) 
```

<br>

### Table `r tab.counter`. There are patients who contributed two one RSV+ records
#### These RSV+ records are all > 14 days apart, thus kept them.
```{r}
tab.counter <- tab.counter + 1

# there are several patients who contributed two RSV+ records:
id_multi_rsv_positive <- (df %>% group_by(StudyID) %>% count(positive_rsv) %>% filter(positive_rsv == 1) %>% filter(n>1))$StudyID

df %>% filter(StudyID %in% id_multi_rsv_positive) %>% 
  dplyr::select(StudyID, testID, collection_date, positive_viruses) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px"), 
            groupBy = "StudyID") 
```

<br>
<br>

### Table `r tab.counter`. briefly look at risk factors by mAb status
```{r}
tab.counter <- tab.counter + 1
library(table1)
# table1(): https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html


pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a standard 2-sample t-test
        p <- t.test(y ~ g)$p.value
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g))$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}


table1( ~ factor(Sex) + 
          age_at_test_in_months + 
          factor(encounter_type) +
          factor(insurance_type) +
          factor(risk_factor_atleastone) 
        | positive_rsv, data = df, overall= F,
          extra.col=list(`P-value`=pvalue))

```


<br>


### Generate data for sensitive analysis
#### Instead of defining "vaccinated" as being vaccinated before date of sample collection, in the sensitive analysis, use an alternative definition for "vaccinated": only those vaccinated >= 7 days before the sample collection date. After changing the definition, 13 originally considered "vaccinated" individuals converted to "unvaccinated group". 
```{r}
df.ssa <- df %>% 
  mutate(rsv_mab_ssa = ifelse(days_btw_mab_collection <= -7, 1, 0)) %>%
  mutate(rsv_mab_ssa = ifelse(is.na(rsv_mab_ssa), 0, rsv_mab_ssa))

df.ssa %>% count(rsv_mab_ssa) %>%
  reactable(style = list(color = "black", `font-family` = "Georgia", `font-size` = "15px")) 

# also need to change the defintion of dosage 
df.ssa <- df.ssa %>% 
  mutate(rsv_mab_detailed = case_when(rsv_mab_ssa == 1 & 
                                        rsv_mab_detailed == "50mg before collection" ~ "50mg before collection",
                                      rsv_mab_ssa == 1 & 
                                        rsv_mab_detailed == "100mg before collection" ~ "100mg before collection",
                                      rsv_mab_ssa == 0 & 
                                        rsv_mab_detailed == "50mg before collection" ~ "50mg after collection",
                                      rsv_mab_ssa == 0 & 
                                        rsv_mab_detailed == "100mg before collection" ~ "100mg after collection"))



```

```{r echo = T}
if(save_recoded_dataset){
  write.csv(df.ssa, "../../data/clean_data/df.mab.vaxdefinition.csv", row.names = F)
}

# colnames <- as.data.frame(colnames(df))
# write.csv(colnames, "../../data/clean_data/dictionary.csv", row.names = F)

```

<br>









